# üîê Escrow Service - Pagos en Garant√≠a - Matriz de Procesos

> **Servicio:** EscrowService  
> **Puerto:** 5047  
> **√öltima actualizaci√≥n:** Enero 25, 2026  
> **Estado:** ‚ùå **DESCARTADO - NO APLICA AL MODELO DE NEGOCIO**  
> **Estado de Implementaci√≥n:** üö´ N/A - DESCARTADO

---

## ‚ö†Ô∏è AUDITOR√çA DE ACCESO UI (Enero 25, 2026)

| Proceso   | Backend       | UI Access | Observaci√≥n         |
| --------- | ------------- | --------- | ------------------- |
| ESCROW-\* | üö´ Descartado | üö´ N/A    | No aplica al modelo |

### Rutas UI Existentes ‚úÖ

- Ninguna - Servicio descartado

### Rutas UI Faltantes üî¥

- Ninguna - OKLA no procesa pagos entre compradores y vendedores

**Verificaci√≥n Backend:** EscrowService **DESCARTADO** - OKLA es plataforma de publicidad, no marketplace transaccional.

---

## ‚ö†Ô∏è IMPORTANTE: SERVICIO DESCARTADO

### Raz√≥n de Descarte

Este servicio fue planificado asumiendo incorrectamente que OKLA ser√≠a un **marketplace transaccional** donde la plataforma procesar√≠a pagos de veh√≠culos entre compradores y vendedores.

### Modelo Correcto de OKLA

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   MODELO DE NEGOCIO OKLA                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                        ‚îÇ
‚îÇ   OKLA ES UNA PLATAFORMA DE PUBLICIDAD, NO UN MARKETPLACE              ‚îÇ
‚îÇ   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê              ‚îÇ
‚îÇ                                                                        ‚îÇ
‚îÇ   ‚úÖ Dealers PAGAN a OKLA: Suscripci√≥n mensual RD$2,900-14,900        ‚îÇ
‚îÇ   ‚úÖ Sellers PAGAN a OKLA: Publicaci√≥n √∫nica RD$1,500                  ‚îÇ
‚îÇ                                                                        ‚îÇ
‚îÇ   ‚ùå OKLA NO procesa pagos de veh√≠culos                                ‚îÇ
‚îÇ   ‚ùå OKLA NO retiene dinero de compradores                             ‚îÇ
‚îÇ   ‚ùå OKLA NO transfiere dinero a vendedores                            ‚îÇ
‚îÇ   ‚ùå OKLA NO cobra comisi√≥n por ventas                                 ‚îÇ
‚îÇ                                                                        ‚îÇ
‚îÇ   LA TRANSACCI√ìN DEL VEH√çCULO OCURRE DIRECTAMENTE:                     ‚îÇ
‚îÇ   Comprador ‚îÄ‚îÄ‚îÄ[Paga en efectivo/banco]‚îÄ‚îÄ‚îÄ> Vendedor                  ‚îÇ
‚îÇ                                                                        ‚îÇ
‚îÇ   OKLA solo conecta compradores con vendedores (publicidad)            ‚îÇ
‚îÇ                                                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Por qu√© Escrow NO aplica

| Caracter√≠stica de Escrow     | Por qu√© NO aplica a OKLA                  |
| ---------------------------- | ----------------------------------------- |
| Retener dinero del comprador | OKLA no recibe dinero de compradores      |
| Liberar fondos al vendedor   | OKLA no transfiere dinero a vendedores    |
| Disputas de transacci√≥n      | Las disputas son entre comprador-vendedor |
| Comisi√≥n por transacci√≥n     | OKLA cobra suscripci√≥n fija, no comisi√≥n  |
| Verificaci√≥n de entrega      | La entrega es entre comprador-vendedor    |

### Alternativas para Compradores

Si OKLA quisiera ofrecer protecci√≥n a compradores en el futuro, las opciones ser√≠an:

1. **Partnership con servicio de escrow externo** (ej: Escrow.com)
2. **Verificaci√≥n pre-compra** (inspecci√≥n mec√°nica, historial)
3. **Garant√≠a OKLA** (cobertura limitada post-venta)

Pero ninguna de estas implica que OKLA procese pagos de veh√≠culos.

---

## üìä Resumen de Implementaci√≥n

| Componente                  | Total | Implementado | Pendiente | Estado                |
| --------------------------- | ----- | ------------ | --------- | --------------------- |
| **Controllers**             | 1     | 0            | 0         | ‚ùå DESCARTADO         |
| **ESC-CREATE-\*** (Crear)   | 4     | 0            | 0         | ‚ùå DESCARTADO         |
| **ESC-FUND-\*** (Fondos)    | 4     | 0            | 0         | ‚ùå DESCARTADO         |
| **ESC-REL-\*** (Liberar)    | 4     | 0            | 0         | ‚ùå DESCARTADO         |
| **ESC-DISP-\*** (Disputas)  | 4     | 0            | 0         | ‚ùå DESCARTADO         |
| **ESC-REF-\*** (Reembolsos) | 3     | 0            | 0         | ‚ùå DESCARTADO         |
| **TOTAL**                   | 20    | 0            | 0         | ‚ùå NO SE IMPLEMENTAR√Å |

---

## üìö Documentaci√≥n Hist√≥rica (Solo Referencia)

> **NOTA:** El contenido a continuaci√≥n se mantiene solo como referencia hist√≥rica.
> Este servicio NO se implementar√°.

---

## 1. Informaci√≥n General (DESCARTADO)

### 1.1 Descripci√≥n

Sistema de pagos en garant√≠a (escrow) para transacciones de alto valor entre compradores y vendedores. El dinero se retiene hasta que ambas partes confirman la transacci√≥n satisfactoria, protegiendo tanto al comprador como al vendedor.

### 1.2 Flujo de Escrow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      FLUJO DE ESCROW                                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                          ‚îÇ
‚îÇ   COMPRADOR                 OKLA (Escrow)              VENDEDOR          ‚îÇ
‚îÇ   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ               ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ          ‚îÇ
‚îÇ                                                                          ‚îÇ
‚îÇ   1. Inicia compra                                                       ‚îÇ
‚îÇ      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> 2. Crea Escrow Account                            ‚îÇ
‚îÇ                              ‚îÇ                                           ‚îÇ
‚îÇ   3. Deposita fondos         ‚îÇ                                           ‚îÇ
‚îÇ      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> 4. Retiene dinero                                 ‚îÇ
‚îÇ                              ‚îÇ                                           ‚îÇ
‚îÇ                       5. Notifica pago ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>                    ‚îÇ
‚îÇ                              ‚îÇ                                           ‚îÇ
‚îÇ                              ‚îÇ        6. Entrega veh√≠culo               ‚îÇ
‚îÇ                              ‚îÇ  <‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                    ‚îÇ
‚îÇ                              ‚îÇ                                           ‚îÇ
‚îÇ   7. Confirma recepci√≥n      ‚îÇ                                           ‚îÇ
‚îÇ      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> 8. Verifica ambas partes                          ‚îÇ
‚îÇ                              ‚îÇ                                           ‚îÇ
‚îÇ                       9. Libera fondos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>  10. Recibe pago   ‚îÇ
‚îÇ                                                                          ‚îÇ
‚îÇ   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê   ‚îÇ
‚îÇ                                                                          ‚îÇ
‚îÇ   PROTECCI√ìN:                                                            ‚îÇ
‚îÇ   ‚Ä¢ Comprador: Dinero seguro hasta recibir veh√≠culo                     ‚îÇ
‚îÇ   ‚Ä¢ Vendedor: Pago garantizado una vez entregado                        ‚îÇ
‚îÇ   ‚Ä¢ Disputas: OKLA media y decide                                       ‚îÇ
‚îÇ                                                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 1.3 Dependencias

| Servicio            | Prop√≥sito                 |
| ------------------- | ------------------------- |
| BillingService      | Procesamiento de pagos    |
| UserService         | Verificaci√≥n de identidad |
| VehiclesSaleService | Datos del veh√≠culo        |
| NotificationService | Comunicaciones            |
| InvoicingService    | Facturaci√≥n               |
| LegalService        | Documentos legales        |

---

## 2. Endpoints API

### 2.1 EscrowController

| M√©todo | Endpoint                            | Descripci√≥n         | Auth | Roles       |
| ------ | ----------------------------------- | ------------------- | ---- | ----------- |
| `POST` | `/api/escrow`                       | Crear escrow        | ‚úÖ   | User        |
| `GET`  | `/api/escrow/{id}`                  | Obtener escrow      | ‚úÖ   | Participant |
| `GET`  | `/api/escrow/my`                    | Mis escrows         | ‚úÖ   | User        |
| `POST` | `/api/escrow/{id}/fund`             | Depositar fondos    | ‚úÖ   | Buyer       |
| `POST` | `/api/escrow/{id}/confirm-delivery` | Confirmar entrega   | ‚úÖ   | Seller      |
| `POST` | `/api/escrow/{id}/confirm-receipt`  | Confirmar recepci√≥n | ‚úÖ   | Buyer       |
| `POST` | `/api/escrow/{id}/release`          | Liberar fondos      | ‚úÖ   | System      |
| `POST` | `/api/escrow/{id}/dispute`          | Abrir disputa       | ‚úÖ   | Participant |
| `POST` | `/api/escrow/{id}/cancel`           | Cancelar            | ‚úÖ   | Participant |

### 2.2 DisputesController

| M√©todo | Endpoint                             | Descripci√≥n       | Auth | Roles              |
| ------ | ------------------------------------ | ----------------- | ---- | ------------------ |
| `GET`  | `/api/escrow/disputes`               | Listar disputas   | ‚úÖ   | Admin              |
| `GET`  | `/api/escrow/disputes/{id}`          | Ver disputa       | ‚úÖ   | Participant, Admin |
| `POST` | `/api/escrow/disputes/{id}/evidence` | Agregar evidencia | ‚úÖ   | Participant        |
| `POST` | `/api/escrow/disputes/{id}/resolve`  | Resolver disputa  | ‚úÖ   | Admin              |

---

## 3. Entidades y Enums

### 3.1 EscrowStatus (Enum)

```csharp
public enum EscrowStatus
{
    Created = 0,              // Escrow creado, esperando fondos
    Funded = 1,               // Fondos depositados
    InTransit = 2,            // Veh√≠culo en proceso de entrega
    DeliveryConfirmed = 3,    // Vendedor confirm√≥ entrega
    ReceiptConfirmed = 4,     // Comprador confirm√≥ recepci√≥n
    Released = 5,             // Fondos liberados al vendedor
    Disputed = 6,             // En disputa
    Refunded = 7,             // Fondos devueltos al comprador
    Cancelled = 8,            // Cancelado
    Expired = 9               // Expir√≥ sin completar
}
```

### 3.2 DisputeReason (Enum)

```csharp
public enum DisputeReason
{
    VehicleNotAsDescribed = 0,    // Veh√≠culo diferente a descripci√≥n
    VehicleNotReceived = 1,       // No recibi√≥ el veh√≠culo
    MechanicalIssues = 2,         // Problemas mec√°nicos ocultos
    DocumentationIssues = 3,      // Problemas con documentos
    SellerUnresponsive = 4,       // Vendedor no responde
    BuyerNotPaying = 5,           // Comprador no completa pago
    Other = 99                    // Otro
}
```

### 3.3 EscrowTransaction (Entidad)

```csharp
public class EscrowTransaction
{
    public Guid Id { get; set; }
    public string EscrowNumber { get; set; }      // ESC-2026-00001
    public EscrowStatus Status { get; set; }

    // Participantes
    public Guid BuyerId { get; set; }
    public Guid SellerId { get; set; }
    public Guid VehicleId { get; set; }

    // Montos
    public decimal VehiclePrice { get; set; }
    public decimal EscrowFee { get; set; }        // 1.5% del precio
    public decimal TotalAmount { get; set; }
    public string Currency { get; set; }

    // Estado de fondos
    public bool FundsPending { get; set; }
    public bool FundsReceived { get; set; }
    public DateTime? FundsReceivedAt { get; set; }
    public bool FundsReleased { get; set; }
    public DateTime? FundsReleasedAt { get; set; }

    // Confirmaciones
    public bool SellerConfirmedDelivery { get; set; }
    public DateTime? DeliveryConfirmedAt { get; set; }
    public bool BuyerConfirmedReceipt { get; set; }
    public DateTime? ReceiptConfirmedAt { get; set; }

    // Disputa
    public Guid? DisputeId { get; set; }

    // Cuenta bancaria de liberaci√≥n
    public string? SellerBankAccount { get; set; }
    public string? SellerBankName { get; set; }

    // Tiempos
    public DateTime CreatedAt { get; set; }
    public DateTime ExpiresAt { get; set; }       // 7 d√≠as para completar
    public DateTime? CompletedAt { get; set; }
    public DateTime? CancelledAt { get; set; }
    public string? CancellationReason { get; set; }
}
```

### 3.4 EscrowDispute (Entidad)

```csharp
public class EscrowDispute
{
    public Guid Id { get; set; }
    public Guid EscrowId { get; set; }
    public Guid InitiatedBy { get; set; }         // Buyer o Seller
    public DisputeReason Reason { get; set; }
    public string Description { get; set; }

    // Estado
    public DisputeStatus Status { get; set; }

    // Evidencia
    public List<DisputeEvidence> Evidence { get; set; }

    // Resoluci√≥n
    public Guid? ResolvedBy { get; set; }
    public DisputeResolution? Resolution { get; set; }
    public decimal? RefundAmount { get; set; }
    public decimal? ReleaseAmount { get; set; }
    public string? ResolutionNotes { get; set; }

    // Timestamps
    public DateTime CreatedAt { get; set; }
    public DateTime? ResolvedAt { get; set; }
}
```

---

## 4. Procesos Detallados

### 4.1 ESC-001: Crear Escrow

| Campo       | Valor                      |
| ----------- | -------------------------- |
| **ID**      | ESC-001                    |
| **Nombre**  | Iniciar Transacci√≥n Escrow |
| **Actor**   | Comprador                  |
| **Trigger** | POST /api/escrow           |

#### Flujo del Proceso

| Paso | Acci√≥n                     | Sistema             | Validaci√≥n           |
| ---- | -------------------------- | ------------------- | -------------------- |
| 1    | Comprador ve veh√≠culo      | Frontend            | VehicleDetail        |
| 2    | Click "Comprar con Escrow" | Frontend            | Modal                |
| 3    | Revisar t√©rminos           | Frontend            | Aceptar T&C          |
| 4    | Confirmar precio           | Frontend            | Con fee              |
| 5    | Validar comprador KYC      | UserService         | Identidad verificada |
| 6    | Validar vendedor           | UserService         | Cuenta activa        |
| 7    | Calcular fee               | EscrowService       | 1.5%                 |
| 8    | Crear escrow               | Database            | Status = Created     |
| 9    | Notificar vendedor         | NotificationService | Email + Push         |
| 10   | Generar instrucciones      | EscrowService       | Para dep√≥sito        |
| 11   | Publicar evento            | RabbitMQ            | escrow.created       |

#### Request

```json
{
  "vehicleId": "uuid",
  "sellerId": "uuid",
  "agreedPrice": 1500000.0,
  "currency": "DOP",
  "deliveryMethod": "InPerson",
  "deliveryLocation": "Sucursal Santo Domingo",
  "buyerNotes": "Disponible para recoger el s√°bado"
}
```

#### Response

```json
{
  "id": "uuid",
  "escrowNumber": "ESC-2026-00001",
  "status": "Created",
  "vehiclePrice": 1500000.0,
  "escrowFee": 22500.0,
  "totalAmount": 1522500.0,
  "expiresAt": "2026-01-28T12:00:00Z",
  "paymentInstructions": {
    "bankName": "Banco Popular Dominicano",
    "accountNumber": "****5678",
    "accountName": "OKLA Escrow Account",
    "reference": "ESC-2026-00001"
  }
}
```

---

### 4.2 ESC-002: Depositar Fondos

| Campo       | Valor                      |
| ----------- | -------------------------- |
| **ID**      | ESC-002                    |
| **Nombre**  | Depositar Fondos en Escrow |
| **Actor**   | Comprador                  |
| **Trigger** | POST /api/escrow/{id}/fund |

#### Flujo del Proceso

| Paso | Acci√≥n                   | Sistema             | Validaci√≥n           |
| ---- | ------------------------ | ------------------- | -------------------- |
| 1    | Comprador elige m√©todo   | Frontend            | Transferencia/Stripe |
| 2    | Si transferencia         | Bank                | ACH/Wire             |
| 3    | Si Stripe/AZUL           | BillingService      | Procesar pago        |
| 4    | Verificar monto completo | EscrowService       | == totalAmount       |
| 5    | Actualizar escrow        | Database            | Status = Funded      |
| 6    | Retener fondos           | Account             | Cuenta escrow        |
| 7    | Notificar vendedor       | NotificationService | "Fondos recibidos"   |
| 8    | Notificar comprador      | NotificationService | Confirmaci√≥n         |
| 9    | Iniciar timer            | EscrowService       | 7 d√≠as para entregar |
| 10   | Publicar evento          | RabbitMQ            | escrow.funded        |

---

### 4.3 ESC-003: Confirmar Entrega

| Campo       | Valor                                  |
| ----------- | -------------------------------------- |
| **ID**      | ESC-003                                |
| **Nombre**  | Vendedor Confirma Entrega              |
| **Actor**   | Vendedor                               |
| **Trigger** | POST /api/escrow/{id}/confirm-delivery |

#### Flujo del Proceso

| Paso | Acci√≥n                    | Sistema             | Validaci√≥n                |
| ---- | ------------------------- | ------------------- | ------------------------- |
| 1    | Vendedor entrega veh√≠culo | Presencial          | F√≠sicamente               |
| 2    | Accede a app              | Mobile/Web          | Autenticado               |
| 3    | Buscar escrow activo      | EscrowService       | Status = Funded           |
| 4    | Click "Confirmar Entrega" | Frontend            | Con foto                  |
| 5    | Subir foto del momento    | MediaService        | Evidencia                 |
| 6    | Firmar digitalmente       | EscrowService       | Timestamp                 |
| 7    | Actualizar escrow         | Database            | DeliveryConfirmed         |
| 8    | Notificar comprador       | NotificationService | "Confirma recepci√≥n"      |
| 9    | Iniciar timer             | EscrowService       | 48h para confirmar        |
| 10   | Publicar evento           | RabbitMQ            | escrow.delivery_confirmed |

---

### 4.4 ESC-004: Confirmar Recepci√≥n y Liberar

| Campo       | Valor                                 |
| ----------- | ------------------------------------- |
| **ID**      | ESC-004                               |
| **Nombre**  | Comprador Confirma y Libera Fondos    |
| **Actor**   | Comprador                             |
| **Trigger** | POST /api/escrow/{id}/confirm-receipt |

#### Flujo del Proceso

| Paso | Acci√≥n                         | Sistema             | Validaci√≥n                |
| ---- | ------------------------------ | ------------------- | ------------------------- |
| 1    | Comprador recibe veh√≠culo      | Presencial          | Inspecci√≥n                |
| 2    | Verifica condici√≥n             | Comprador           | Vs descripci√≥n            |
| 3    | Si satisfecho                  | Frontend            | "Confirmar"               |
| 4    | Confirmar recepci√≥n            | EscrowService       | Status = ReceiptConfirmed |
| 5    | Verificar ambas confirmaciones | EscrowService       | Delivery + Receipt        |
| 6    | Calcular monto a liberar       | EscrowService       | Precio - fee              |
| 7    | Iniciar transferencia          | BillingService      | Al vendedor               |
| 8    | Actualizar escrow              | Database            | Status = Released         |
| 9    | Enviar comprobante             | NotificationService | A ambos                   |
| 10   | Marcar veh√≠culo vendido        | VehiclesSaleService | Status = Sold             |
| 11   | Generar factura                | InvoicingService    | Para ambos                |
| 12   | Publicar evento                | RabbitMQ            | escrow.completed          |

---

### 4.5 ESC-005: Abrir Disputa

| Campo       | Valor                         |
| ----------- | ----------------------------- |
| **ID**      | ESC-005                       |
| **Nombre**  | Abrir Disputa de Escrow       |
| **Actor**   | Comprador/Vendedor            |
| **Trigger** | POST /api/escrow/{id}/dispute |

#### Flujo del Proceso

| Paso | Acci√≥n                      | Sistema             | Validaci√≥n          |
| ---- | --------------------------- | ------------------- | ------------------- |
| 1    | Participante inicia disputa | Frontend            | Raz√≥n + descripci√≥n |
| 2    | Subir evidencia inicial     | MediaService        | Fotos, docs         |
| 3    | Crear disputa               | Database            | Status = Open       |
| 4    | Pausar liberaci√≥n           | EscrowService       | Fondos retenidos    |
| 5    | Notificar contraparte       | NotificationService | Email urgente       |
| 6    | Notificar admin             | NotificationService | Ticket creado       |
| 7    | Actualizar escrow           | Database            | Status = Disputed   |
| 8    | Dar 48h para responder      | EscrowService       | Timer               |
| 9    | Publicar evento             | RabbitMQ            | escrow.disputed     |

#### Request

```json
{
  "reason": "VehicleNotAsDescribed",
  "description": "El veh√≠culo tiene da√±os significativos en el motor que no fueron mencionados en la descripci√≥n.",
  "evidence": [
    {
      "type": "image",
      "url": "https://...",
      "description": "Foto del motor con da√±os"
    },
    {
      "type": "document",
      "url": "https://...",
      "description": "Reporte de mec√°nico"
    }
  ],
  "requestedResolution": "FullRefund"
}
```

---

### 4.6 ESC-006: Resolver Disputa

| Campo       | Valor                                  |
| ----------- | -------------------------------------- |
| **ID**      | ESC-006                                |
| **Nombre**  | Resolver Disputa                       |
| **Actor**   | Admin                                  |
| **Trigger** | POST /api/escrow/disputes/{id}/resolve |

#### Opciones de Resoluci√≥n

| Resoluci√≥n      | Descripci√≥n                           |
| --------------- | ------------------------------------- |
| `RefundFull`    | 100% al comprador                     |
| `ReleaseFull`   | 100% al vendedor                      |
| `Split`         | Dividir fondos                        |
| `RefundPartial` | Parte al comprador, parte al vendedor |
| `Escalate`      | Escalar a legal                       |

#### Flujo del Proceso

| Paso | Acci√≥n                        | Sistema             | Validaci√≥n              |
| ---- | ----------------------------- | ------------------- | ----------------------- |
| 1    | Admin revisa caso             | Dashboard           | Evidencias              |
| 2    | Contactar partes si necesario | Admin               | Llamadas/emails         |
| 3    | Tomar decisi√≥n                | Admin               | Con justificaci√≥n       |
| 4    | Ingresar resoluci√≥n           | Dashboard           | Montos + notas          |
| 5    | Ejecutar resoluci√≥n           | EscrowService       | Transferencias          |
| 6    | Si refund                     | BillingService      | Al comprador            |
| 7    | Si release                    | BillingService      | Al vendedor             |
| 8    | Cerrar disputa                | Database            | Status = Resolved       |
| 9    | Actualizar escrow             | Database            | Refunded/Released       |
| 10   | Notificar partes              | NotificationService | Resultado               |
| 11   | Publicar evento               | RabbitMQ            | escrow.dispute_resolved |

---

## 5. Reglas de Negocio

### 5.1 Fees

| Concepto      | Valor           |
| ------------- | --------------- |
| Fee de escrow | 1.5% del precio |
| Fee m√≠nimo    | RD$ 5,000       |
| Fee m√°ximo    | RD$ 75,000      |

### 5.2 Tiempos

| Evento                    | Tiempo L√≠mite                               |
| ------------------------- | ------------------------------------------- |
| Dep√≥sito de fondos        | 48 horas                                    |
| Entrega despu√©s de fondos | 7 d√≠as                                      |
| Confirmaci√≥n de recepci√≥n | 48 horas                                    |
| Liberaci√≥n autom√°tica     | 48h despu√©s de delivery (si no hay disputa) |
| Expiraci√≥n de escrow      | 14 d√≠as total                               |

### 5.3 Requisitos

| Requisito           | Comprador | Vendedor |
| ------------------- | --------- | -------- |
| KYC verificado      | ‚úÖ        | ‚úÖ       |
| Email verificado    | ‚úÖ        | ‚úÖ       |
| Tel√©fono verificado | ‚úÖ        | ‚úÖ       |
| Cuenta bancaria     | ‚ùå        | ‚úÖ       |

---

## 6. Eventos RabbitMQ

| Evento                      | Exchange        | Payload                           |
| --------------------------- | --------------- | --------------------------------- |
| `escrow.created`            | `escrow.events` | `{ escrowId, buyerId, sellerId }` |
| `escrow.funded`             | `escrow.events` | `{ escrowId, amount }`            |
| `escrow.delivery_confirmed` | `escrow.events` | `{ escrowId }`                    |
| `escrow.receipt_confirmed`  | `escrow.events` | `{ escrowId }`                    |
| `escrow.completed`          | `escrow.events` | `{ escrowId, releasedAmount }`    |
| `escrow.disputed`           | `escrow.events` | `{ escrowId, disputeId }`         |
| `escrow.refunded`           | `escrow.events` | `{ escrowId, amount }`            |
| `escrow.expired`            | `escrow.events` | `{ escrowId }`                    |

---

## 7. M√©tricas

```
# Escrows
escrow_created_total
escrow_completed_total
escrow_disputed_total
escrow_refunded_total
escrow_volume_total{currency="DOP|USD"}

# Tiempos
escrow_time_to_fund_hours
escrow_time_to_delivery_days
escrow_time_to_complete_days

# Disputas
escrow_disputes_total{reason="...", resolution="..."}
escrow_dispute_resolution_time_days
```

---

## 8. Configuraci√≥n

```json
{
  "Escrow": {
    "FeePercent": 1.5,
    "MinFee": 5000,
    "MaxFee": 75000,
    "FundingTimeoutHours": 48,
    "DeliveryTimeoutDays": 7,
    "ReceiptTimeoutHours": 48,
    "AutoReleaseAfterDeliveryHours": 48,
    "ExpirationDays": 14
  }
}
```

---

## üìö Referencias

- [01-billing-service.md](01-billing-service.md) - Pagos
- [02-stripe-payment.md](02-stripe-payment.md) - Stripe
- [03-azul-payment.md](03-azul-payment.md) - AZUL
- [04-invoicing-service.md](04-invoicing-service.md) - Facturaci√≥n
