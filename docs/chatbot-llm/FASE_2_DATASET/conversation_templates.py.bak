"""
Templates de conversaciones por IntentCategory para OKLA Chatbot LLM.
Cada template define:
  - user_templates: variantes de mensajes del usuario (informal, semi-formal, formal, whatsapp)
  - assistant_template: funciÃ³n que genera la respuesta JSON del asistente
  - multi_turn_chains: secuencias de intents para conversaciones multi-turno

REEMPLAZA COMPLETAMENTE a Google Dialogflow ES.
Las respuestas del asistente son JSON estructurado, NO texto plano.
"""

import random
import json
from typing import Any


# ============================================================
# RESPONSE VARIATION HELPERS
# ============================================================

def _rand_conf(low: float, high: float) -> float:
    """Random confidence value in [low, high], rounded to 2 decimals."""
    return round(random.uniform(low, high), 2)


def _pick(lst: list):
    """Pick a random item from a list."""
    return random.choice(lst)


# ============================================================
# DOMINICAN SPANISH VARIATIONS
# ============================================================

GREETINGS_INFORMAL = [
    "klk", "que lo que", "dime a ver", "hey", "buenas",
    "ey dimelo", "wena", "alo", "oye", "ey",
]
GREETINGS_SEMIFORMAL = [
    "Buenos dÃ­as", "Buenas tardes", "Buenas noches", "Hola",
    "Hola, buenas", "Buen dÃ­a", "Saludos",
]
GREETINGS_FORMAL = [
    "Muy buenos dÃ­as", "Cordial saludo", "Buenas tardes, quisiera informaciÃ³n",
]

FAREWELLS = [
    "gracias, bye", "tato, gracias", "ok perfecto gracias", "hasta luego",
    "chao", "dale gracias", "listo, bendiciones", "ok ta bien gracias",
    "muchas gracias por la info", "perfecto, luego te escribo",
    "nos vemos", "hasta maÃ±ana", "bueno, gracias", "me retiro, gracias",
    "todo bien, hasta luego", "adiÃ³s y gracias", "fue un placer, chao",
    "bendiciones, bye", "ok me voy, gracias", "ya yo me voy",
]

# Body type synonyms in Dominican Spanish
BODY_TYPE_SLANG = {
    "yipeta": ["SUV", "Crossover"],
    "guagua": ["Van", "Minivan"],
    "camioneta": ["Pickup"],
    "carro": ["SedÃ¡n", "Hatchback", "SUV"],
    "motor": ["Motocicleta"],
    "pasola": ["Scooter"],
    "jeepeta": ["SUV"],
}

PRICE_EXPRESSIONS = {
    "pela'o": {"max": 1200000},
    "barato": {"max": 1500000},
    "econÃ³mico": {"max": 1500000},
    "no muy caro": {"max": 2000000},
    "precio medio": {"min": 1500000, "max": 3000000},
    "algo bueno": {"min": 2000000, "max": 4000000},
    "premium": {"min": 4000000},
    "de lujo": {"min": 5000000},
}

AFFIRMATIVES = ["sÃ­", "si", "claro", "dale", "tato", "ok", "perfecto", "va", "estÃ¡ bien", "seguro"]
NEGATIVES = ["no", "nel", "nah", "no gracias", "ahora no", "despuÃ©s", "luego"]


# ============================================================
# INTENT: Greeting (1)
# ============================================================

GREETING_USER_TEMPLATES = [
    # Informal Dominican
    "klk",
    "que lo que",
    "dime a ver",
    "hey necesito ayuda",
    "ey buenas",
    "hola hola",
    "dimelo ahi",
    "wena",
    "alo?",
    "epa",
    "oye",
    "ey klk",
    "dime",
    "buenas buenas",
    "wepa",
    "hey hey",
    "que hay de nuevo",
    "klk mi pana",
    "ey loco necesito ayuda",
    "dimelo que necesito un carro",
    # Semi-formal
    "Hola, buenas tardes",
    "Buenos dÃ­as, necesito informaciÃ³n",
    "Hola, estoy buscando un vehÃ­culo",
    "Buenas, me pueden ayudar?",
    "Saludos, quisiera saber sobre sus vehÃ­culos",
    "Hola, tienen vehÃ­culos disponibles?",
    "Buenas tardes, me interesa comprar un carro",
    "Hola buenas, ando buscando un vehÃ­culo",
    "Buenos dias",
    "Buenas noches, estÃ¡n disponibles?",
    "Hola, una consulta",
    "Buenas, quiero informaciÃ³n por favor",
    "Hola! Estoy interesado en sus vehÃ­culos",
    # Formal
    "Muy buenos dÃ­as, quisiera informaciÃ³n sobre vehÃ­culos disponibles",
    "Cordial saludo, estoy interesado en adquirir un vehÃ­culo",
    "Buenas tardes, quisiera conocer su inventario de vehÃ­culos",
    "Estimados, me gustarÃ­a informaciÃ³n sobre sus vehÃ­culos en venta",
    # WhatsApp / con errores
    "hla q hay",
    "ola tngo una prgnta",
    "holaa",
    "olaa buenas",
    "hla buenas tardes",
    "ola kiero informacion",
    "bnas tardes",
    "bnos dias",
    "hola bnas",
    "ola q tal",
    "holaaa",
    "wenas",
    # Solo emoji
    "ğŸ‘‹",
    "ğŸš—",
    "hola ğŸ‘‹",
]

def greeting_response(dealer: dict, **kwargs) -> dict:
    bot_name = dealer.get("botName", "OKLA AI")
    response = _pick([
        (
            f"Â¡Hola! ğŸ‘‹ Soy {bot_name}, tu asistente virtual de {dealer['name']}. "
            f"Estoy aquÃ­ para ayudarte a encontrar el vehÃ­culo perfecto. "
            f"Â¿QuÃ© tipo de vehÃ­culo estÃ¡s buscando?"
        ),
        (
            f"Â¡Bienvenido a {dealer['name']}! ğŸš— Soy {bot_name}, tu asistente de ventas. "
            f"Tenemos una gran variedad de vehÃ­culos disponibles. "
            f"Â¿En quÃ© puedo ayudarte hoy?"
        ),
        (
            f"Hola, bienvenido a {dealer['name']}. Soy {bot_name}, tu asistente virtual. "
            f"Puedo ayudarte a buscar vehÃ­culos, conocer precios, opciones de financiamiento y mÃ¡s. "
            f"Â¿QuÃ© necesitas?"
        ),
        (
            f"Â¡QuÃ© tal! ğŸ˜Š Soy {bot_name} de {dealer['name']}. "
            f"Estoy listo para ayudarte con todo lo relacionado a vehÃ­culos: "
            f"bÃºsqueda, precios, financiamiento, test drives y mÃ¡s. Â¿CÃ³mo te ayudo?"
        ),
        (
            f"Hola, gracias por escribirnos a {dealer['name']}. "
            f"Soy {bot_name} y puedo asistirte con nuestra oferta de vehÃ­culos. "
            f"Â¿EstÃ¡s buscando algo en particular?"
        ),
    ])
    return {
        "response": response,
        "intent": "Greeting",
        "confidence": _rand_conf(0.95, 0.99),
        "isFallback": False,
        "parameters": {},
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸš— Ver SUVs", "ğŸ’° VehÃ­culos econÃ³micos", "ğŸ” Buscar por marca", "ğŸ“ Contactar asesor"],
            ["ğŸ” Ver catÃ¡logo", "ğŸ’° Precios y ofertas", "ğŸ“ UbicaciÃ³n", "â“ Ayuda"],
            ["ğŸš— Buscar vehÃ­culo", "ğŸ’° Financiamiento", "ğŸ“… Agendar visita", "ğŸ“ Hablar con asesor"],
            ["Ver inventario", "Buscar por precio", "Financiamiento", "Contactar ventas"],
        ])
    }


# ============================================================
# INTENT: VehicleSearch (10)
# ============================================================

VEHICLE_SEARCH_USER_TEMPLATES = [
    # Informal - price
    "tienen algo pela'o?",
    "quÃ© yipeta hay por ahÃ­ que no sea muy cara?",
    "quiero una yipeta que no pase de 2 millones",
    "tienen carros baratos?",
    "algo econÃ³mico pa empezar",
    "dame algo por ahÃ­ por un millÃ³n",
    "quÃ© hay de carros como por 1.5 millones?",
    "busco algo barato pero que se vea chivo",
    "que hay por ahi de 3 palos pa bajo",
    "dame algo jevi que no cueste mucho",
    "hay algo nuevo x menos de 2M?",
    "kiero algo baratito",
    "q tienen por un millon?",
    # Informal - type
    "tienen yipetas?",
    "quiero una camioneta",
    "busco un carro familiar",
    "necesito una guagua grande",
    "tienen pickups?",
    "algo deportivo hay?",
    "tienen jeepetas?",
    "quiero una yipeta grande",
    "hay sedanes?",
    "busco algo chiquito pa la ciudad",
    "algo pa trabajo, una pickup",
    "tienen algo todoterreno?",
    "busco una doble cabina",
    "hay algun carro hibrido?",
    "tienen carros elÃ©ctricos?",
    # Semi-formal - specific
    "Estoy buscando un SUV automÃ¡tico",
    "Busco un sedÃ¡n 2024 que sea econÃ³mico",
    "Â¿Tienen Toyota RAV4 disponible?",
    "Me interesa un Hyundai Tucson",
    "Busco un vehÃ­culo familiar con 7 asientos",
    "Â¿QuÃ© SUVs tienen en menos de 3 millones?",
    "Necesito un carro para la ciudad, algo compacto",
    "Busco algo con buen rendimiento de gasolina",
    "Â¿Tienen vehÃ­culos diesel?",
    "Quiero ver las pickups disponibles",
    "Necesito algo automÃ¡tico y econÃ³mico",
    "Busco un carro del 2023 o 2024",
    "Quiero algo con poco millaje",
    "Tienen algo de Honda o Toyota?",
    "Busco un carro blanco, SUV de preferencia",
    "Necesito un vehÃ­culo con buen espacio de carga",
    "Tienen algo en oferta?",
    "CuÃ¡les son los vehÃ­culos mÃ¡s nuevos que tienen?",
    "Me interesa algo con tracciÃ³n 4x4",
    "Quiero algo seguro para mi familia",
    # Semi-formal - budget specific
    "Tengo un presupuesto de 2.5 millones, quÃ© me recomiendan?",
    "Busco algo entre 1.5 y 2.5 millones",
    "Â¿QuÃ© vehÃ­culos tienen por debajo de millÃ³n y medio?",
    "Ando buscando algo de unos 30 mil dÃ³lares",
    "Mi presupuesto es de 3 millones mÃ¡ximo",
    "Quiero gastar entre 2 y 3 millones",
    "No quiero gastar mÃ¡s de 4 millones",
    # Formal
    "Quisiera ver el catÃ¡logo de SUVs disponibles en su concesionario",
    "Â¿PodrÃ­an mostrarme los vehÃ­culos que tienen en el rango de 3 a 5 millones?",
    "Me gustarÃ­a conocer quÃ© vehÃ­culos tienen disponibles para compra inmediata",
    # WhatsApp style / con errores
    "q yipetas tienen",
    "hay algo x ahi como x 2 palos",
    "tngo 1.5M q m pueden ofrecer",
    "kiero un caro bueno",
    "q carros tinen?",
    "tienen behiculos?",
    "busco un behiculo",
    "q tienen d Toyota",
    "muestrame los carros",
    "tienen algo bonito x ahi",
    "quiero ber los carros",
]

def vehicle_search_response(dealer: dict, vehicles: list, **kwargs) -> dict:
    """Generate a vehicle search response with matching vehicles."""
    query = kwargs.get("query", "")
    matched = vehicles[:3]  # Simplified; real generator will filter

    vehicle_text = ""
    for i, v in enumerate(matched, 1):
        vehicle_text += (
            f"\n{i}. **{v['make']} {v['model']} {v['year']} {v.get('trim', '')}**\n"
            f"   ğŸ’° RD${v['price']:,.0f} | ğŸ“ {v['mileage']:,} km | â›½ {v['fuelType']} | "
            f"ğŸ”„ {v['transmission']}\n"
        )

    opening = _pick([
        f"Â¡Excelente! De nuestro inventario actual, tengo estas opciones:",
        f"Mira lo que encontrÃ© en nuestro inventario para ti:",
        f"AquÃ­ te muestro las opciones disponibles en inventario:",
        f"SegÃºn nuestro inventario, tenemos estos vehÃ­culos:",
        f"De lo que tenemos disponible, encontrÃ© estas opciones:",
        f"Revisando nuestro inventario, te puedo ofrecer:",
    ])

    closing = _pick([
        "Â¿Te gustarÃ­a saber mÃ¡s de alguno en particular?",
        "Â¿CuÃ¡l te llama mÃ¡s la atenciÃ³n?",
        "Â¿Quieres que te dÃ© mÃ¡s detalles de alguno?",
        "Â¿Alguno te interesa? Puedo darte mÃ¡s informaciÃ³n.",
    ])

    first_make = matched[0]['make'] if matched else "Ver"
    first_model = matched[0]['model'] if matched else "todo"

    return {
        "response": f"{opening}\n{vehicle_text}\n{closing}",
        "intent": "VehicleSearch",
        "confidence": _rand_conf(0.88, 0.96),
        "isFallback": False,
        "parameters": {
            "bodyType": kwargs.get("bodyType"),
            "maxPrice": kwargs.get("maxPrice"),
            "minPrice": kwargs.get("minPrice"),
            "fuelType": kwargs.get("fuelType"),
            "transmission": kwargs.get("transmission"),
            "make": kwargs.get("make"),
            "currency": "DOP"
        },
        "leadSignals": {
            "mentionedBudget": kwargs.get("maxPrice") is not None or kwargs.get("minPrice") is not None,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            [f"ğŸ“‹ MÃ¡s info {first_make} {first_model}", "ğŸ’° Ver financiamiento", "ğŸš— Agendar test drive"],
            [f"ğŸ“‹ Detalles {first_make}", "ğŸ’° Precios", "ğŸ“ Contactar asesor"],
            ["Ver mÃ¡s opciones", "Filtrar por precio", "Hablar con asesor"],
        ])
    }


# ============================================================
# INTENT: VehicleDetails (11)
# ============================================================

VEHICLE_DETAILS_USER_TEMPLATES = [
    # Direct references
    "Dime mÃ¡s de la {make} {model}",
    "QuÃ© mÃ¡s me puedes decir de la {make} {model}?",
    "CuÃ©ntame sobre la {make} {model} {year}",
    "Quiero saber mÃ¡s de esa {make}",
    "Dame los detalles de la {make} {model}",
    "QuÃ© tiene la {make} {model}?",
    "La {make} {model} tiene cÃ¡mara de reversa?",
    "Esa {make} viene full?",
    "QuÃ© accesorios tiene la {make} {model}?",
    "QuÃ© incluye la {make} {model}?",
    "HÃ¡blame de la {make} {model}",
    "CÃ³mo es la {make} {model}?",
    "Dame toda la informaciÃ³n de la {make} {model}",
    "La {make} {model} quÃ© trae?",
    "Info completa de la {make} {model} por favor",
    "Especificaciones de la {make} {model}",
    "Dame el detalle completo de la {make}",
    # Context references (from prior search)
    "La segunda opciÃ³n, dame mÃ¡s info",
    "Me interesa la primera, cuÃ©ntame mÃ¡s",
    "La opciÃ³n 2 por favor",
    "Me gusta la primera opciÃ³n",
    "Dime mÃ¡s de la tercera",
    "La del medio, cuÃ©ntame mÃ¡s",
    "Esa que mencionaste, dame mÃ¡s detalles",
    "La Ãºltima opciÃ³n me interesa",
    # WhatsApp / typos
    "dime mas d la {make}",
    "q trae la {make} {model}?",
    "cuentame d esa {make}",
    "informacion de la {make} {model}",
    "hablame d la {make}",
    "dame info de esa",
    "cmo es esa {make}?",
    "esa viene full equipo?",
]

def vehicle_details_response(dealer: dict, vehicle: dict, **kwargs) -> dict:
    sale_tag = ""
    if vehicle.get("isOnSale") and vehicle.get("originalPrice"):
        sale_tag = f" ~~RD${vehicle['originalPrice']:,.0f}~~ ğŸ·ï¸ Â¡EN OFERTA!"

    opening = _pick([
        f"ğŸ“‹ **{vehicle['make']} {vehicle['model']} {vehicle['year']} {vehicle.get('trim', '')}**",
        f"AquÃ­ tienes la info de la **{vehicle['make']} {vehicle['model']} {vehicle['year']} {vehicle.get('trim', '')}**",
        f"Te comparto los detalles de la **{vehicle['make']} {vehicle['model']} {vehicle['year']}**",
        f"**{vehicle['make']} {vehicle['model']} {vehicle['year']} {vehicle.get('trim', '')}** â€” AquÃ­ estÃ¡n los detalles",
    ])

    closing = _pick([
        "Â¿Te gustarÃ­a agendar un test drive o conocer las opciones de financiamiento?",
        "Â¿Quieres probarlo en persona o conocer el financiamiento?",
        "Â¿Te interesa agendar una visita para verlo?",
        "Â¿Alguna pregunta adicional sobre este vehÃ­culo?",
    ])

    return {
        "response": (
            f"{opening}\n\n"
            f"ğŸ’° **Precio:** RD${vehicle['price']:,.0f}{sale_tag}\n"
            f"ğŸ“ **Kilometraje:** {vehicle['mileage']:,} km\n"
            f"â›½ **Combustible:** {vehicle['fuelType']}\n"
            f"ğŸ”„ **TransmisiÃ³n:** {vehicle['transmission']}\n"
            f"ğŸ¨ **Color exterior:** {vehicle.get('exteriorColor', 'N/A')}\n"
            f"ğŸª‘ **Color interior:** {vehicle.get('interiorColor', 'N/A')}\n"
            f"ğŸ”§ **Motor:** {vehicle.get('engineSize', 'N/A')}\n\n"
            f"ğŸ“ {vehicle.get('description', '')}\n\n"
            f"{closing}"
        ),
        "intent": "VehicleDetails",
        "confidence": _rand_conf(0.91, 0.97),
        "isFallback": False,
        "parameters": {
            "vehicleId": vehicle["id"],
            "make": vehicle["make"],
            "model": vehicle["model"],
            "year": vehicle["year"]
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸš— Agendar test drive", "ğŸ’° Ver financiamiento", "ğŸ“¸ Ver fotos", "ğŸ”„ Comparar"],
            ["ğŸ’° CuÃ¡nto cuesta?", "ğŸš— Probar en persona", "ğŸ“ Contactar asesor"],
            ["Ver precio", "Agendar visita", "Comparar con otro", "Hablar con asesor"],
        ])
    }


# ============================================================
# INTENT: VehiclePrice (14)
# ============================================================

VEHICLE_PRICE_USER_TEMPLATES = [
    # Direct price questions
    "CuÃ¡nto cuesta la {make} {model}?",
    "QuÃ© precio tiene la {make} {model}?",
    "A cÃ³mo sale la {make} {model}?",
    "En cuÃ¡nto estÃ¡ la {make}?",
    "CuÃ¡nto sale esa?",
    "CuÃ¡l es el precio?",
    "Precio final de la {make} {model}?",
    "CuÃ¡l es el valor de la {make} {model}?",
    "A cuÃ¡nto la venden?",
    "CuÃ¡nto piden por la {make}?",
    "CuÃ¡nto cuesta esa?",
    "Precio de la {make} {model} {year}?",
    "La {make} {model} en cuÃ¡nto la tienen?",
    # Negotiation / discounts
    "EstÃ¡n dando descuento?",
    "Se puede negociar el precio?",
    "Hay alguna promociÃ³n?",
    "A cuÃ¡nto la dejan?",
    "Hacen rebaja?",
    "CuÃ¡l es lo menos que la dan?",
    "Me la pueden dejar en menos?",
    "Si la pago de contado, cuÃ¡nto me rebajan?",
    "Tienen algÃºn descuento especial?",
    "Se puede regatear?",
    "CuÃ¡l es el mejor precio que me pueden dar?",
    "Me dan un descuentito?",
    # WhatsApp / typos
    "cuanto cuesta?",
    "cuanto sale la {make}?",
    "a como la dan?",
    "presio?",
    "cuanto?",
    "precio?",
    "q presio tiene?",
    "a cuanto?",
    "cuanto vale esa {make}?",
]

def vehicle_price_response(dealer: dict, vehicle: dict, **kwargs) -> dict:
    price_text = f"RD${vehicle['price']:,.0f}"
    if vehicle.get("isOnSale") and vehicle.get("originalPrice"):
        savings = vehicle["originalPrice"] - vehicle["price"]
        price_text += f"\n\nğŸ·ï¸ **Â¡Precio especial!** Antes: RD${vehicle['originalPrice']:,.0f} â€” Te ahorras RD${savings:,.0f}"

    opening = _pick([
        f"ğŸ’° El precio de la **{vehicle['make']} {vehicle['model']} {vehicle['year']} {vehicle.get('trim', '')}** es **{price_text}**.",
        f"La **{vehicle['make']} {vehicle['model']} {vehicle['year']}** tiene un precio de **{price_text}**.",
        f"El valor de la **{vehicle['make']} {vehicle['model']} {vehicle['year']} {vehicle.get('trim', '')}** es de **{price_text}**.",
        f"**{vehicle['make']} {vehicle['model']} {vehicle['year']}**: **{price_text}**.",
    ])

    closing = _pick([
        "Este precio estÃ¡ sujeto a disponibilidad. "
        "TambiÃ©n ofrecemos planes de financiamiento con nuestros bancos aliados. "
        "Â¿Te gustarÃ­a conocer las opciones de financiamiento?",
        "Recuerda que tenemos opciones de financiamiento disponibles. "
        "Â¿Quieres que te cuente mÃ¡s?",
        "Precio sujeto a disponibilidad. "
        "Â¿Te gustarÃ­a agendar una visita para verlo en persona?",
        "Podemos ofrecerte financiamiento con excelentes condiciones. "
        "Â¿Te interesa conocer las cuotas mensuales?",
    ])

    return {
        "response": f"{opening}\n\n{closing}",
        "intent": "VehiclePrice",
        "confidence": _rand_conf(0.92, 0.98),
        "isFallback": False,
        "parameters": {
            "vehicleId": vehicle["id"],
            "price": vehicle["price"],
            "currency": "DOP",
            "isOnSale": vehicle.get("isOnSale", False)
        },
        "leadSignals": {
            "mentionedBudget": True,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸ’° Ver financiamiento", "ğŸš— Agendar test drive", "ğŸ”„ Ver otras opciones"],
            ["ğŸ§® Calcular cuota", "ğŸ“ Contactar asesor", "ğŸš— Test drive"],
            ["Ver financiamiento", "Agendar visita", "Ver otros vehÃ­culos"],
        ])
    }


# ============================================================
# INTENT: FinancingInfo (20)
# ============================================================

FINANCING_INFO_USER_TEMPLATES = [
    # Semi-formal
    "Tienen financiamiento?",
    "Se puede financiar?",
    "CÃ³mo funciona el financiamiento?",
    "Con quÃ© bancos trabajan?",
    "CuÃ¡nto hay que dar de inicial?",
    "Financian a 60 meses?",
    "CuÃ¡les son los requisitos para financiar?",
    "Puedo financiar la {make} {model}?",
    "Quiero saber del financiamiento",
    "Hacen prÃ©stamo?",
    "QuÃ© planes de pago tienen?",
    "CuÃ¡nto sale la cuota mensual?",
    "Aceptan el vehÃ­culo como parte de pago?",
    "Necesito financiar, quÃ© opciones hay?",
    # Dominican informal
    "Oye y eso se puede financiar o es de contado na mÃ¡s?",
    "Klk, y el financiamiento cÃ³mo es?",
    "Dimelo, cuÃ¡nto hay que dar de pronto?",
    "Y se puede sacar a plazos?",
    "Mano, cuÃ¡nto me sale mensual si financio?",
    "Pa financiar quÃ© papeles hay que llevar?",
    "Y sin inicial se puede financiar?",
    "CuÃ¡nto me queda la cuota de la {make}?",
    "Trabajan con Banreservas?",
    "Hacen financiamiento con el Popular?",
    "Y se puede financiar a 72 meses?",
    "Y si no tengo rÃ©cord crediticio?",
    "Y la inicial se puede pagar con tarjeta?",
    # Formal / specific
    "Me gustarÃ­a conocer las opciones de financiamiento disponibles",
    "Quisiera informaciÃ³n sobre los planes de financiamiento para la {make} {model}",
    "CuÃ¡l es la tasa de interÃ©s actual para financiamiento?",
    "Ofrecen financiamiento directo o solo a travÃ©s de bancos?",
    "Necesito financiar sin prima, es posible?",
    # WhatsApp / typos
    "financiamiento?",
    "como es lo del financiamientoo?",
    "finanaciamiento tienen?",
    "cuanto es la cuota?",
    "q requisitos piden pa finanziar?",
    "tienen financiameinto?",
    "se financia?",
]

def financing_info_response(dealer: dict, vehicle: dict = None, **kwargs) -> dict:
    partners = ", ".join(dealer.get("financingPartners", ["nuestros bancos aliados"]))
    vehicle_text = ""
    if vehicle:
        vehicle_text = f" para la **{vehicle['make']} {vehicle['model']} {vehicle['year']}**"

    opening = _pick([
        f"ğŸ’° **Opciones de Financiamiento{vehicle_text}**",
        f"Te cuento sobre nuestras opciones de financiamiento{vehicle_text}",
        f"**InformaciÃ³n de Financiamiento{vehicle_text}**",
        f"AquÃ­ tienes los detalles del financiamiento{vehicle_text}",
    ])

    closing = _pick([
        "Â¿Te gustarÃ­a que un asesor te contacte para evaluar tu caso?",
        "Â¿Quieres que un asesor te ayude a calcular tu cuota?",
        "Â¿Necesitas mÃ¡s detalles? Un asesor puede darte informaciÃ³n personalizada.",
        "Â¿Te interesa que calculemos la cuota para un vehÃ­culo especÃ­fico?",
    ])

    return {
        "response": (
            f"{opening}\n\n"
            f"Trabajamos con {partners} para ofrecerte las mejores condiciones:\n\n"
            f"ğŸ“Œ **Inicial:** Desde el 20% del valor del vehÃ­culo\n"
            f"ğŸ“Œ **Plazo:** 24 a 72 meses\n"
            f"ğŸ“Œ **Tasa:** Desde 8.5% anual (sujeto a aprobaciÃ³n)\n\n"
            f"**Requisitos bÃ¡sicos:**\n"
            f"â€¢ CÃ©dula de identidad vigente\n"
            f"â€¢ Comprobante de ingresos (Ãºltimos 3 meses)\n"
            f"â€¢ RÃ©cord crediticio favorable\n"
            f"â€¢ Carta de trabajo o estados financieros\n\n"
            f"âš ï¸ *Las tasas y condiciones exactas dependen del banco y tu perfil crediticio. "
            f"Un asesor puede darte los detalles especÃ­ficos.*\n\n"
            f"{closing}"
        ),
        "intent": "FinancingInfo",
        "confidence": _rand_conf(0.90, 0.97),
        "isFallback": False,
        "parameters": {
            "vehicleId": vehicle["id"] if vehicle else None,
            "financingPartners": dealer.get("financingPartners", [])
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": True,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸ“ Contactar asesor", "ğŸ§® Calcular cuota", "ğŸ“‹ Ver requisitos completos"],
            ["ğŸ“ Hablar con asesor", "ğŸš— Ver vehÃ­culos", "ğŸ’° Compra al contado"],
            ["Contactar asesor", "Calcular cuota mensual", "Ver vehÃ­culos disponibles"],
        ])
    }


# ============================================================
# INTENT: TestDriveSchedule (30)
# ============================================================

TEST_DRIVE_USER_TEMPLATES = [
    # Semi-formal
    "Quiero hacer un test drive",
    "Puedo probar la {make} {model}?",
    "CÃ³mo agendo un test drive?",
    "Me gustarÃ­a probar el carro antes de comprar",
    "Se puede ir a ver el carro?",
    "Quiero verlo en persona",
    "Puedo pasar a verlo?",
    "Quiero agendar una prueba de manejo",
    "CuÃ¡ndo puedo ir a probar la {make}?",
    "Tienen disponibilidad para test drive maÃ±ana?",
    "Me lo dejan probar?",
    "Quiero manejarlo a ver quÃ© tal",
    # Dominican informal
    "Oye y puedo ir a probarlo?",
    "Dimelo, cuÃ¡ndo puedo ir a ver ese carro?",
    "Mano, quiero ver esa {make} en persona",
    "Puedo pasarme maÃ±ana a ver el carro?",
    "DÃ©jame ir a manejar eso a ver quÃ© tal",
    "Lo puedo probar este sÃ¡bado?",
    "Puedo ir hoy mismo a verlo?",
    "Quiero ir a ver la {make} {model} en persona antes de decidir",
    "CuÃ¡ndo me puedo pasar por ahÃ­?",
    # Formal
    "Quisiera agendar una cita para ver el vehÃ­culo",
    "Me gustarÃ­a coordinar una visita al concesionario",
    "PodrÃ­an reservarme un espacio para probar la {make}?",
    # WhatsApp / typos
    "test drive?",
    "puedo ir a berlo?",
    "quiero probar el caro",
    "kiero ir a ver eso",
    "cuando puedo ir?",
    "se puede agendar para maÃ±ana?",
    "puedo probarlo manana?",
    "quiero manejarlo",
    "quiero ber la {make} {model}",
]

def test_drive_response(dealer: dict, vehicle: dict = None, **kwargs) -> dict:
    vehicle_text = ""
    if vehicle:
        vehicle_text = f" de la **{vehicle['make']} {vehicle['model']} {vehicle['year']}**"

    opening = _pick([
        f"ğŸš— **Â¡Perfecto! Agendemos tu test drive{vehicle_text}**",
        f"Â¡Excelente idea! Nada como probar el vehÃ­culo{vehicle_text} en persona.",
        f"Con gusto te agendamos una prueba de manejo{vehicle_text}.",
        f"Â¡Claro que sÃ­! Puedes venir a probar el vehÃ­culo{vehicle_text}.",
    ])

    closing = _pick([
        "Â¿Me compartes tu nombre para empezar?",
        "Â¿CuÃ¡ndo te gustarÃ­a venir?",
        "Â¿Me das tu nombre y telÃ©fono para confirmar la cita?",
        "Â¿QuÃ© dÃ­a te queda mejor?",
    ])

    return {
        "response": (
            f"{opening}\n\n"
            f"ğŸ“ **UbicaciÃ³n:** {dealer['location']}\n"
            f"ğŸ• **Horarios disponibles:** Lunes a Viernes 8AM-6PM, SÃ¡bados 9AM-2PM\n\n"
            f"Para agendar tu cita necesito:\n"
            f"1ï¸âƒ£ Tu **nombre completo**\n"
            f"2ï¸âƒ£ Tu **nÃºmero de telÃ©fono** o **WhatsApp**\n"
            f"3ï¸âƒ£ **Fecha y hora** preferida\n\n"
            f"{closing}"
        ),
        "intent": "TestDriveSchedule",
        "confidence": _rand_conf(0.91, 0.97),
        "isFallback": False,
        "parameters": {
            "vehicleId": vehicle["id"] if vehicle else None,
            "appointmentType": "test_drive",
            "step": "request_name"
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": True,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": "SCHEDULE_APPOINTMENT",
        "quickReplies": _pick([
            ["ğŸ“… MaÃ±ana en la maÃ±ana", "ğŸ“… Este sÃ¡bado", "ğŸ“ Prefiero llamar"],
            ["ğŸ“… Hoy mismo", "ğŸ“… MaÃ±ana", "ğŸ“… Esta semana"],
            ["MaÃ±ana", "Este fin de semana", "Llamar para coordinar"],
        ])
    }


# ============================================================
# INTENT: VehicleComparison (12)
# ============================================================

VEHICLE_COMPARISON_USER_TEMPLATES = [
    # Semi-formal
    "CuÃ¡l es mejor, la {make1} {model1} o la {make2} {model2}?",
    "Compara la {make1} {model1} con la {make2} {model2}",
    "QuÃ© diferencia hay entre la {make1} y la {make2}?",
    "Entre la {make1} {model1} y la {make2} {model2}, cuÃ¡l me recomiendas?",
    "La {make1} es mejor que la {make2}?",
    "Quiero comparar dos opciones",
    "AyÃºdame a decidir entre estas dos",
    "CuÃ¡l gasta menos gasolina, la {make1} o la {make2}?",
    # Dominican informal
    "Dimelo, cuÃ¡l es mejor la {make1} o la {make2}?",
    "Mano, y entre esas dos cuÃ¡l tÃº me recomiendas?",
    "Y la {make1} y la {make2} cuÃ¡l gasta menos?",
    "Oye y cuÃ¡l tiene mÃ¡s espacio, la {make1} o la {make2}?",
    "CuÃ¡l sale mÃ¡s barata de mantener?",
    "La {make1} dura mÃ¡s que la {make2}?",
    "CuÃ¡l tiene mejor reventa, la {make1} o la {make2}?",
    "Estoy entre la {make1} {model1} y la {make2} {model2}, ayÃºdame",
    # Formal
    "Me gustarÃ­a hacer una comparativa entre la {make1} {model1} y la {make2} {model2}",
    "PodrÃ­an darme una comparaciÃ³n detallada entre ambos vehÃ­culos?",
    "Quisiera conocer las diferencias principales entre la {make1} y la {make2}",
    # WhatsApp / typos
    "cual es mejor {make1} o {make2}?",
    "comparame la {make1} con la {make2}",
    "q diferensia hay entre esas 2?",
    "cual me combiene mas?",
    "entre esas cual es la mejor opcion?",
]

def vehicle_comparison_response(dealer: dict, vehicles: list, **kwargs) -> dict:
    v1, v2 = vehicles[0], vehicles[1]

    opening = _pick([
        f"ğŸ“Š **Comparativa: {v1['make']} {v1['model']} vs {v2['make']} {v2['model']}**",
        f"AquÃ­ tienes la comparaciÃ³n entre la **{v1['make']} {v1['model']}** y la **{v2['make']} {v2['model']}**",
        f"**{v1['make']} {v1['model']} vs {v2['make']} {v2['model']}** â€” Comparativa completa",
    ])

    closing = _pick([
        "Ambos son excelentes opciones. Â¿Te gustarÃ­a conocer mÃ¡s detalles de alguno?",
        "Â¿CuÃ¡l te convence mÃ¡s? Puedo darte mÃ¡s info.",
        "Â¿Te gustarÃ­a probar alguno de los dos?",
        "Cada uno tiene sus ventajas. Â¿Quieres agendar un test drive?",
    ])

    return {
        "response": (
            f"{opening}\n\n"
            f"| CaracterÃ­stica | {v1['make']} {v1['model']} | {v2['make']} {v2['model']} |\n"
            f"|---|---|---|\n"
            f"| **AÃ±o** | {v1['year']} | {v2['year']} |\n"
            f"| **Precio** | RD${v1['price']:,.0f} | RD${v2['price']:,.0f} |\n"
            f"| **Motor** | {v1.get('engineSize', 'N/A')} | {v2.get('engineSize', 'N/A')} |\n"
            f"| **TransmisiÃ³n** | {v1['transmission']} | {v2['transmission']} |\n"
            f"| **Combustible** | {v1['fuelType']} | {v2['fuelType']} |\n"
            f"| **Kilometraje** | {v1['mileage']:,} km | {v2['mileage']:,} km |\n\n"
            f"{closing}"
        ),
        "intent": "VehicleComparison",
        "confidence": _rand_conf(0.90, 0.97),
        "isFallback": False,
        "parameters": {
            "vehicle1Id": v1["id"],
            "vehicle2Id": v2["id"],
            "comparisonType": "full"
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            [f"ğŸš— Test drive {v1['make']}", f"ğŸš— Test drive {v2['make']}", "ğŸ’° Comparar financiamiento"],
            [f"ğŸ“‹ Detalles {v1['make']}", f"ğŸ“‹ Detalles {v2['make']}", "ğŸ“ Hablar con asesor"],
            [f"MÃ¡s info {v1['make']}", f"MÃ¡s info {v2['make']}", "Ver otras opciones"],
        ])
    }


# ============================================================
# INTENT: DealerHours (41)
# ============================================================

DEALER_HOURS_USER_TEMPLATES = [
    # Semi-formal
    "CuÃ¡l es el horario?",
    "A quÃ© hora abren?",
    "A quÃ© hora cierran?",
    "EstÃ¡n abiertos los sÃ¡bados?",
    "Abren los domingos?",
    "CuÃ¡l es el horario de atenciÃ³n?",
    "Hasta quÃ© hora estÃ¡n?",
    "Puedo ir hoy?",
    "EstÃ¡n abiertos ahora?",
    "A quÃ© hora puedo pasar?",
    # Dominican informal
    "Oye a quÃ© hora abren ustedes?",
    "Dimelo, estÃ¡n abiertos todavÃ­a?",
    "Klk, a quÃ© hora cierran hoy?",
    "Mano, y los sÃ¡bados abren?",
    "Y en la tardecita estÃ¡n abiertos?",
    "Abren en la maÃ±ana temprano?",
    # Holidays / special days
    "Abren en Semana Santa?",
    "EstÃ¡n abiertos en Navidad?",
    "Abren los dÃ­as feriados?",
    "Trabajan el 27 de febrero?",
    "Y los dÃ­as de fiesta abren?",
    # Formal
    "Me gustarÃ­a saber cuÃ¡l es el horario de atenciÃ³n al pÃºblico",
    "Quisiera confirmar si estÃ¡n abiertos los fines de semana",
    "PodrÃ­an indicarme su horario de operaciÃ³n?",
    # WhatsApp / typos
    "horario?",
    "a q hora abren?",
    "estan abiertos?",
    "q horario tienen?",
    "hasta q hora?",
    "abren hoy?",
]

def dealer_hours_response(dealer: dict, **kwargs) -> dict:
    hours = dealer.get("businessHours", {})
    schedule_text = ""
    for day, times in hours.items():
        day_es = {
            "monday": "Lunes", "tuesday": "Martes", "wednesday": "MiÃ©rcoles",
            "thursday": "Jueves", "friday": "Viernes", "saturday": "SÃ¡bado", "sunday": "Domingo"
        }.get(day, day)
        if times:
            schedule_text += f"â€¢ **{day_es}:** {times['open']} - {times['close']}\n"
        else:
            schedule_text += f"â€¢ **{day_es}:** Cerrado\n"

    opening = _pick([
        f"ğŸ• **Horario de {dealer['name']}**",
        f"AquÃ­ te comparto nuestro horario de atenciÃ³n",
        f"El horario de {dealer['name']} es el siguiente",
        f"**Horario de atenciÃ³n â€” {dealer['name']}**",
    ])

    closing = _pick([
        "Â¿Te gustarÃ­a agendar una visita?",
        "Â¿Quieres que te agendemos una cita?",
        "Â¿Planeas visitarnos pronto?",
        "Â¿Necesitas algo mÃ¡s?",
    ])

    return {
        "response": (
            f"{opening}\n\n{schedule_text}\n"
            f"ğŸ“ {dealer['location']}\n"
            f"ğŸ“ {dealer['phone']}\n\n"
            f"{closing}"
        ),
        "intent": "DealerHours",
        "confidence": _rand_conf(0.93, 0.99),
        "isFallback": False,
        "parameters": {
            "businessHours": hours
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸ“… Agendar visita", "ğŸ“ Ver ubicaciÃ³n", "ğŸ“ Llamar"],
            ["ğŸš— Ver vehÃ­culos", "ğŸ“… Agendar cita", "ğŸ“ Contactar"],
            ["Agendar visita", "Ver ubicaciÃ³n", "Llamar ahora"],
        ])
    }


# ============================================================
# INTENT: DealerLocation (40)
# ============================================================

DEALER_LOCATION_USER_TEMPLATES = [
    # Semi-formal
    "DÃ³nde estÃ¡n ubicados?",
    "CuÃ¡l es la direcciÃ³n?",
    "CÃ³mo llego?",
    "DÃ³nde queda el dealer?",
    "Tienen alguna sucursal?",
    "En quÃ© zona estÃ¡n?",
    "DÃ³nde puedo ir a ver los carros?",
    "Me pueden pasar la direcciÃ³n?",
    # Dominican informal
    "Oye dÃ³nde es que quedan ustedes?",
    "Dimelo, por dÃ³nde queda eso?",
    "Mano, y ustedes estÃ¡n por el MalecÃ³n o por dÃ³nde?",
    "Klk, dÃ³nde queda el local?",
    "Y eso queda paâ€™ la zona colonial o paâ€™ Naco?",
    "CÃ³mo llego desde la 27?",
    "Es fÃ¡cil llegar en guagua?",
    "Tienen parking?",
    "Hay parqueo disponible?",
    # Reference / landmark questions
    "Queda cerca de Agora Mall?",
    "EstÃ¡n por la Churchill?",
    "Eso queda por la autopista Duarte?",
    "Tienen sucursal en Santiago?",
    "Solo tienen en Santo Domingo?",
    # Formal
    "Me gustarÃ­a saber la direcciÃ³n exacta del concesionario",
    "PodrÃ­an indicarme cÃ³mo llegar a su local?",
    # WhatsApp / typos
    "donde quedan?",
    "ubicacion?",
    "direccion?",
    "donde estan?",
]

def dealer_location_response(dealer: dict, **kwargs) -> dict:
    opening = _pick([
        f"ğŸ“ **{dealer['name']}**",
        f"AquÃ­ te comparto nuestra ubicaciÃ³n",
        f"**UbicaciÃ³n de {dealer['name']}**",
        f"Nos encuentras en la siguiente direcciÃ³n",
    ])

    closing = _pick([
        "Â¡Te esperamos! Â¿Quieres que agendemos tu visita?",
        "Â¿Te gustarÃ­a agendar una visita?",
        "Â¿Necesitas indicaciones para llegar?",
        "Â¿Quieres que te enviemos la ubicaciÃ³n por WhatsApp?",
    ])

    return {
        "response": (
            f"{opening}\n\n"
            f"ğŸ¢ **DirecciÃ³n:** {dealer['location']}\n"
            f"ğŸ“ **TelÃ©fono:** {dealer['phone']}\n"
            f"ğŸ“± **WhatsApp:** {dealer.get('whatsapp', dealer['phone'])}\n"
            f"ğŸ“§ **Email:** {dealer['email']}\n\n"
            f"{closing}"
        ),
        "intent": "DealerLocation",
        "confidence": _rand_conf(0.93, 0.99),
        "isFallback": False,
        "parameters": {
            "address": dealer["location"],
            "phone": dealer["phone"]
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸ“… Agendar visita", "ğŸ—ºï¸ Ver en mapa", "ğŸ“ Llamar ahora"],
            ["ğŸš— Ver vehÃ­culos", "ğŸ• Ver horario", "ğŸ“ Contactar"],
            ["Agendar visita", "Ver en mapa", "Llamar"],
        ])
    }


# ============================================================
# INTENT: ContactRequest (60) / QuoteRequest (61) / CallbackRequest (62)
# ============================================================

CONTACT_REQUEST_USER_TEMPLATES = [
    # Semi-formal
    "Quiero que me llamen",
    "Me pueden contactar?",
    "Necesito hablar con un asesor",
    "Prefiero hablar con una persona",
    "Me pueden llamar?",
    "Quiero hablar con ventas",
    "Pasenme con alguien de ventas",
    "Necesito mÃ¡s informaciÃ³n personalizada",
    "Mi nÃºmero es {phone}",
    "Me llamo {name} y quiero que me contacten",
    "Pueden llamarme al {phone}?",
    "Mi WhatsApp es {phone}",
    # Combined name + phone
    "Mi nombre es {name}, mi nÃºmero es {phone}",
    "Soy {name}, pueden llamarme al {phone}",
    "Me llamo {name}, {phone}",
    "Me llamo {name} y mi telÃ©fono es {phone}",
    "{name}, {phone}, quiero que me contacten",
    "Soy {name}, WhatsApp {phone}",
    "Mi nombre es {name}, mi WhatsApp es {phone}, quiero mÃ¡s info",
    "{name}, nÃºmero {phone}, me interesa el vehÃ­culo",
    # Dominican informal
    "Oye, pÃ¡same con alguien de ventas",
    "Dimelo, quiero hablar con un vendedor",
    "Quiero q me contacte alguien ya",
    "Mano, necesito hablar con una persona real",
    "No quiero hablar con un bot, pÃ¡same con alguien",
    "Ya me canse del bot, pasame con un humano",
    "DÃ©jame hablar con un asesor de verdad",
    "LÃ­stame con alguien para llamarme",
    # Formal
    "Me gustarÃ­a que un ejecutivo de ventas me contacte",
    "Quisiera recibir asesorÃ­a personalizada por telÃ©fono",
    "PodrÃ­an contactarme para discutir opciones de compra?",
    # WhatsApp / typos
    "quiero q me yamen",
    "pasame con alguien",
    "quiero ablar con alguien",
    "llamame porfavor",
    "nesecito un asesor",
    "mi cell es {phone}",
    "{name} {phone} llamame",
    "mi cel {phone}, soy {name}",
]

def contact_request_response(dealer: dict, **kwargs) -> dict:
    name = kwargs.get("name")
    phone = kwargs.get("phone")

    if name and phone:
        response_text = _pick([
            (
                f"âœ… **Â¡Perfecto, {name}!** Un asesor de {dealer['name']} te contactarÃ¡ "
                f"al **{phone}** lo antes posible.\n\n"
                f"Generalmente respondemos en menos de 30 minutos durante horario laboral. "
                f"Â¿Hay algo mÃ¡s en lo que pueda ayudarte mientras tanto?"
            ),
            (
                f"Listo, {name}. Ya registrÃ© tu solicitud. "
                f"Un asesor de {dealer['name']} te llamarÃ¡ al **{phone}** pronto.\n\n"
                f"Â¿Necesitas algo mÃ¡s?"
            ),
            (
                f"Â¡Gracias, {name}! Tu solicitud ha sido registrada. "
                f"Te contactaremos al **{phone}** a la brevedad.\n\n"
                f"Mientras tanto, Â¿te gustarÃ­a explorar mÃ¡s opciones?"
            ),
        ])
        action = "TRANSFER_TO_AGENT"
    elif name:
        response_text = _pick([
            (
                f"Â¡Gracias {name}! Para que un asesor te contacte, necesito tu nÃºmero de telÃ©fono o WhatsApp. "
                f"Â¿Me lo compartes?"
            ),
            (
                f"Perfecto, {name}. Â¿CuÃ¡l es tu nÃºmero de telÃ©fono o WhatsApp para que te contactemos?"
            ),
        ])
        action = None
    else:
        response_text = _pick([
            (
                f"Â¡Con gusto! Para conectarte con un asesor de {dealer['name']}, "
                f"necesito tu nombre y un nÃºmero de telÃ©fono o WhatsApp. Â¿Me los compartes?"
            ),
            (
                f"Claro, con gusto te conecto con un asesor. "
                f"Â¿Me compartes tu nombre y nÃºmero de telÃ©fono?"
            ),
            (
                f"Para transferirte con un asesor de {dealer['name']}, "
                f"necesito algunos datos. Â¿CuÃ¡l es tu nombre y nÃºmero de contacto?"
            ),
        ])
        action = None

    return {
        "response": response_text,
        "intent": "ContactRequest",
        "confidence": _rand_conf(0.91, 0.97),
        "isFallback": False,
        "parameters": {
            "name": name,
            "phone": phone,
            "contactMethod": "phone" if phone else None
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": phone is not None
        },
        "suggestedAction": action,
        "quickReplies": _pick([
            ["ğŸ“ Llamar ahora", "ğŸ’¬ WhatsApp", "ğŸ“§ Email"],
            ["ğŸ“ Contactar", "ğŸ’¬ Enviar WhatsApp", "ğŸš— Ver vehÃ­culos"],
            ["Llamar", "WhatsApp", "Email"],
        ]) if not phone else []
    }


# ============================================================
# INTENT: Complaint (70)
# ============================================================

COMPLAINT_USER_TEMPLATES = [
    # Original
    "No estoy contento con el servicio",
    "Tengo una queja",
    "El servicio fue pÃ©simo",
    "Nadie me ha contactado y ya llevo dÃ­as esperando",
    "Me prometieron algo y no cumplieron",
    "Quiero hablar con un supervisor",
    "Esto es inaceptable",
    "Voy a ir a Pro-Consumidor",
    "Quiero poner una queja formal",
    "Me siento engaÃ±ado",
    # Dominican informal - mild
    "Oye, nadie me ha llamado y dijeron que me iban a llamar",
    "Dimelo, llevo esperando como 3 dÃ­as y nada",
    "Mano, el servicio aquÃ­ es lento",
    "No me han respondido el WhatsApp y ya van 2 dÃ­as",
    "Escribo y nadie me contesta, quÃ© pasa?",
    # Dominican informal - strong
    "Esto es un relajo, nadie me atiende",
    "El servicio de ustedes no sirve pa na",
    "Llevan 3 dÃ­as diciendo que me van a llamar y nada",
    "Me vendieron un carro con problemas",
    "El carro que comprÃ© saliÃ³ malo",
    # Formal / legal
    "Deseo presentar una reclamaciÃ³n formal",
    "Voy a reportar esto a ProConsumidor",
    "Necesito que resuelvan esta situaciÃ³n inmediatamente",
    "Quisiera hablar con el gerente general",
    "Voy a poner esto en las redes sociales",
    # WhatsApp / typos
    "tengo una keja",
    "el serbicio es pesimo",
    "nadie me a contestado",
    "quiero ablar con un supervisor",
    "esto es inaseptable",
]

def complaint_response(dealer: dict, **kwargs) -> dict:
    response = _pick([
        (
            f"Lamento mucho escuchar eso. En {dealer['name']} valoramos mucho tu experiencia "
            f"y queremos resolver esta situaciÃ³n lo antes posible.\n\n"
            f"Voy a transferirte con un supervisor que podrÃ¡ atenderte personalmente. "
            f"Â¿PodrÃ­as compartirme brevemente quÃ© sucediÃ³ para que pueda darle contexto?\n\n"
            f"âš ï¸ *Conforme a la Ley 358-05 de ProtecciÃ³n al Consumidor, tienes derecho a presentar "
            f"una reclamaciÃ³n formal. Nuestro equipo estÃ¡ comprometido a darte una respuesta satisfactoria.*"
        ),
        (
            f"Entiendo tu frustraciÃ³n y la tomo muy en serio. "
            f"En {dealer['name']} nos importa tu satisfacciÃ³n.\n\n"
            f"Voy a escalar tu caso a un supervisor para darte una soluciÃ³n rÃ¡pida. "
            f"Â¿Me puedes contar quÃ© pasÃ³?"
        ),
        (
            f"Lamento mucho esta situaciÃ³n. Tu queja es importante para nosotros "
            f"y queremos resolverla.\n\n"
            f"Un supervisor de {dealer['name']} se comunicarÃ¡ contigo para atender tu caso personalmente. "
            f"Â¿Me compartes tu nombre y telÃ©fono para que te contacten?"
        ),
    ])

    return {
        "response": response,
        "intent": "Complaint",
        "confidence": _rand_conf(0.88, 0.96),
        "isFallback": False,
        "parameters": {
            "sentiment": "negative",
            "urgency": "high"
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": "TRANSFER_TO_AGENT",
        "quickReplies": _pick([
            ["ğŸ“ Hablar con supervisor", "ğŸ“§ Enviar queja por email"],
            ["ğŸ“ Llamar a gerencia", "ğŸ“§ Queja formal", "ğŸ’¬ WhatsApp"],
            ["Hablar con supervisor", "Enviar queja", "Llamar"],
        ])
    }


# ============================================================
# INTENT: Farewell (2)
# ============================================================

FAREWELL_USER_TEMPLATES = FAREWELLS + [
    "ya no necesito nada mÃ¡s",
    "eso es todo",
    "listo, no mÃ¡s preguntas",
    "gracias por la ayuda",
    "muy amable, hasta luego",
    "ok voy a pensarlo",
    "dÃ©jame pensarlo y te escribo luego",
    # Dominican informal
    "tato, me voy",
    "ya taâ€™, gracias",
    "listo loco, gracias",
    "voy pa la calle, luego hablamos",
    "dale pues, bendiciones",
    "eso e to, gracias manin",
    "ta claro, luego te digo",
    "voy a ver y te digo despues",
    "ok ok gracias por todo",
    # Formal
    "Muchas gracias por la informaciÃ³n, muy amables",
    "Agradezco la atenciÃ³n, hasta pronto",
    "Excelente servicio, estarÃ© en contacto",
    "Gracias por su tiempo, lo voy a considerar",
    # WhatsApp / typos
    "grasiass",
    "byeee",
    "chaooo",
    "grcias x la info",
    "grasias",
    "ok bye",
    "100pre, gracias!",
    # Short / minimal
    "bye",
    "chao",
    "adios",
    "ok",
    "listo",
    "perfecto",
    "ğŸ‘",
    "ğŸ™",
]

def farewell_response(dealer: dict, **kwargs) -> dict:
    bot_name = dealer.get("botName", "OKLA AI")
    response = _pick([
        (
            f"Â¡Fue un placer ayudarte! ğŸ˜Š Si necesitas algo mÃ¡s, aquÃ­ estoy disponible 24/7.\n\n"
            f"Recuerda que en {dealer['name']} tenemos los mejores vehÃ­culos y planes de financiamiento. "
            f"Â¡Te esperamos! ğŸš—\n\n"
            f"â€” {bot_name}"
        ),
        (
            f"Â¡Gracias por escribirnos! ğŸ™ Espero haberte sido de ayuda.\n\n"
            f"Cuando quieras volver a consultar, aquÃ­ estaremos. "
            f"Â¡Ã‰xito! \n\n"
            f"â€” {bot_name}"
        ),
        (
            f"Ha sido un gusto atenderte. Si necesitas mÃ¡s informaciÃ³n, "
            f"no dudes en escribirnos de nuevo.\n\n"
            f"{dealer['name']} â€” Siempre a tu servicio.\n\n"
            f"â€” {bot_name}"
        ),
        (
            f"Gracias por contactar a {dealer['name']}. "
            f"Fue un placer asistirte.\n\n"
            f"Recuerda que puedes escribirnos en cualquier momento. "
            f"Â¡Hasta pronto!\n\n"
            f"â€” {bot_name}"
        ),
        (
            f"Â¡Perfecto! Si cambias de opiniÃ³n o tienes mÃ¡s preguntas, "
            f"aquÃ­ estaremos para ti. ğŸ˜Š\n\n"
            f"Â¡Que tengas un excelente dÃ­a!\n\n"
            f"â€” {bot_name}"
        ),
    ])
    return {
        "response": response,
        "intent": "Farewell",
        "confidence": _rand_conf(0.93, 0.99),
        "isFallback": False,
        "parameters": {},
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": []
    }


# ============================================================
# INTENT: Fallback (4)
# ============================================================

FALLBACK_USER_TEMPLATES = [
    # Gibberish
    "asdfghjkl",
    "?????",
    ".",
    "ğŸ˜‚ğŸ˜‚ğŸ˜‚",
    "jajajaja",
    "ğŸ¤–",
    "asdhasdh",
    "dksjflkds",
    "test test",
    "...",
    "????",
    "!!!!!",
    "xdxdxd",
    "lol",
    # Off-topic questions
    "no entiendo",
    "quÃ© tipo de cambio tienen?",
    "venden casas?",
    "cuÃ¡nto cuesta un vuelo a Miami?",
    "hola soy un robot",
    "me puedes hacer la tarea?",
    "cuÃ¡l es la capital de Francia?",
    "venden comida?",
    "tienen ropa?",
    "cuÃ¡nto cuesta un iPhone?",
    "dÃ³nde queda el aeropuerto?",
    "cuÃ¡l es el resultado del partido?",
    "me puedes hacer un chiste?",
    "que hora es?",
    "tienen motos tambiÃ©n? digo, bicicletas",
    # Random / accidental
    "q",
    "a",
    "hola hola hola hola",
    "dale dale dale",
    "no no no",
    "si no o tal vez",
]

def fallback_response(dealer: dict, **kwargs) -> dict:
    response = _pick([
        (
            f"Disculpa, no estoy seguro de entender tu consulta. ğŸ¤”\n\n"
            f"Soy el asistente virtual de {dealer['name']} y puedo ayudarte con:\n"
            f"â€¢ ğŸ” Buscar vehÃ­culos por tipo, precio o marca\n"
            f"â€¢ ğŸ“‹ InformaciÃ³n de un vehÃ­culo especÃ­fico\n"
            f"â€¢ ğŸ’° Opciones de financiamiento\n"
            f"â€¢ ğŸš— Agendar test drive o visita\n"
            f"â€¢ ğŸ“ UbicaciÃ³n y horarios\n\n"
            f"Â¿En quÃ© puedo ayudarte?"
        ),
        (
            f"No logrÃ© entender tu mensaje. "
            f"Soy un asistente especializado en vehÃ­culos de {dealer['name']}.\n\n"
            f"Puedo ayudarte a buscar carros, ver precios, financiamiento y mÃ¡s. "
            f"Â¿QuÃ© te gustarÃ­a saber?"
        ),
        (
            f"Hmm, no estoy seguro de cÃ³mo responder a eso. "
            f"Mi especialidad son los vehÃ­culos.\n\n"
            f"Â¿Puedo ayudarte a buscar un carro, ver precios o agendar una visita?"
        ),
        (
            f"Disculpa, eso estÃ¡ fuera de mi Ã¡rea. Soy el bot de ventas de {dealer['name']}.\n\n"
            f"Puedo asistirte con: vehÃ­culos disponibles, precios, financiamiento, "
            f"test drives y mÃ¡s. Â¿En quÃ© te ayudo?"
        ),
    ])

    return {
        "response": response,
        "intent": "Fallback",
        "confidence": _rand_conf(0.15, 0.50),
        "isFallback": True,
        "parameters": {},
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸ” Buscar vehÃ­culo", "ğŸ’° Financiamiento", "ğŸ“ Hablar con asesor"],
            ["ğŸš— Ver inventario", "ğŸ’° Precios", "ğŸ“ UbicaciÃ³n"],
            ["Buscar vehÃ­culo", "Ver precios", "Hablar con asesor"],
        ])
    }


# ============================================================
# INTENT: Help (3)
# ============================================================

HELP_USER_TEMPLATES = [
    # Semi-formal
    "Ayuda",
    "QuÃ© puedes hacer?",
    "En quÃ© me puedes ayudar?",
    "CÃ³mo funciona esto?",
    "QuÃ© opciones tengo?",
    "Para quÃ© sirves?",
    "CÃ³mo uso el chat?",
    "MenÃº",
    "Opciones",
    # Dominican informal
    "Oye, y quÃ© tÃº puedes hacer?",
    "Dimelo, en quÃ© me ayudas?",
    "Y esto pa quÃ© sirve?",
    "No sÃ© cÃ³mo funciona esto",
    "QuÃ© cosas puedo preguntar?",
    "Klk, quÃ© servicios ofrecen?",
    "Mano, esto cÃ³mo funciona?",
    "Y esto es un bot o quÃ©?",
    "Eres un robot?",
    "Eres una persona o una mÃ¡quina?",
    # Formal
    "Me gustarÃ­a saber quÃ© servicios ofrecen",
    "PodrÃ­a indicarme las opciones disponibles?",
    "Quisiera conocer quÃ© tipo de asistencia pueden brindarme",
    # WhatsApp / typos
    "ayudaa",
    "q puedes aser?",
    "como funciona?",
    "q opciones hay?",
    "menu",
    "help",
]

def help_response(dealer: dict, **kwargs) -> dict:
    bot_name = dealer.get("botName", "OKLA AI")
    response = _pick([
        (
            f"Â¡Hola! Soy {bot_name}, tu asistente virtual de {dealer['name']}. "
            f"Puedo ayudarte con:\n\n"
            f"ğŸ” **Buscar vehÃ­culos** â€” Por tipo, precio, marca o caracterÃ­sticas\n"
            f"ğŸ“‹ **Detalles** â€” Especificaciones, fotos y precios\n"
            f"ğŸ“Š **Comparar** â€” Comparativa entre 2 o 3 vehÃ­culos\n"
            f"ğŸ’° **Financiamiento** â€” Planes, requisitos y simulaciÃ³n de cuotas\n"
            f"ğŸš— **Test Drive** â€” Agendar prueba de manejo\n"
            f"ğŸ“ **UbicaciÃ³n** â€” DirecciÃ³n y horarios\n"
            f"ğŸ“ **Contacto** â€” Conectar con un asesor humano\n\n"
            f"Â¿QuÃ© te gustarÃ­a hacer?"
        ),
        (
            f"Soy {bot_name} de {dealer['name']}. Esto es lo que puedo hacer por ti:\n\n"
            f"â€¢ Buscar vehÃ­culos por marca, precio o tipo\n"
            f"â€¢ Darte detalles y especificaciones\n"
            f"â€¢ Comparar vehÃ­culos\n"
            f"â€¢ Informarte sobre financiamiento\n"
            f"â€¢ Agendar test drives\n"
            f"â€¢ Compartirte ubicaciÃ³n y horarios\n"
            f"â€¢ Conectarte con un asesor\n\n"
            f"Â¿Por dÃ³nde quieres empezar?"
        ),
        (
            f"Â¡Hola! ğŸ‘‹ Soy {bot_name}. Puedo asistirte con todo lo relacionado a la compra de vehÃ­culos "
            f"en {dealer['name']}: bÃºsqueda, precios, financiamiento, visitas y mÃ¡s.\n\n"
            f"Solo escrÃ­beme tu pregunta y con gusto te ayudo. Â¿QuÃ© necesitas?"
        ),
    ])

    return {
        "response": response,
        "intent": "Help",
        "confidence": _rand_conf(0.94, 0.99),
        "isFallback": False,
        "parameters": {},
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸ” Buscar vehÃ­culo", "ğŸ’° Financiamiento", "ğŸ“ UbicaciÃ³n", "ğŸ“ Asesor"],
            ["ğŸš— Ver inventario", "ğŸ’° Precios", "ğŸ“… Agendar visita"],
            ["Buscar vehÃ­culo", "Financiamiento", "UbicaciÃ³n", "Contactar asesor"],
        ])
    }


# ============================================================
# INTENT: TradeIn (23)
# ============================================================

TRADE_IN_USER_TEMPLATES = [
    # Semi-formal
    "Aceptan carro en trade-in?",
    "Puedo dar mi carro como parte de pago?",
    "Tengo un {make_old} {year_old} que quiero dar a cambio",
    "Si doy mi carro actual cuÃ¡nto me dan?",
    "Quiero cambiar mi carro por uno nuevo",
    "Aceptan vehÃ­culo como parte de pago?",
    "CuÃ¡nto me dan por mi {make_old} {year_old}?",
    "Quiero entregar mi carro viejo",
    "Hacen trade-in?",
    # Dominican informal
    "Oye, y si doy mi carrito viejo cuÃ¡nto me descuentan?",
    "Dimelo, aceptan carro a cambio?",
    "Mano, tengo un {make_old} {year_old} que quiero soltar",
    "Puedo meter mi carro como parte de pago?",
    "Si les doy mi {make_old} cuÃ¡nto me rebajan?",
    "Tengo uno viejo que quiero darles, aceptan?",
    "Y si llevo mi carro ustedes lo reciben?",
    "CuÃ¡nto vale mi {make_old} {year_old} pa trade in?",
    "Quiero comprar uno nuevo y dar el mÃ­o",
    # Formal
    "Me gustarÃ­a saber si aceptan mi vehÃ­culo actual como parte del pago",
    "Quisiera evaluar la opciÃ³n de entregar mi vehÃ­culo actual",
    "PodrÃ­an tasar mi vehÃ­culo para un posible trade-in?",
    # WhatsApp / typos
    "aceptan trade in?",
    "trade-in?",
    "puedo dar mi caro viejo?",
    "cuanto me dan x mi {make_old}?",
    "aseptan vehiculo como parte de pago?",
    "tradein?",
    "cambio mi carro por otro",
]

def trade_in_response(dealer: dict, **kwargs) -> dict:
    accepts = dealer.get("tradeInAccepted", True)
    if accepts:
        opening = _pick([
            f"ğŸ”„ **Â¡SÃ­! Aceptamos tu vehÃ­culo como parte de pago.**",
            f"Â¡Claro que sÃ­! En {dealer['name']} aceptamos trade-in.",
            f"**SÃ­, hacemos trade-in.** Podemos evaluar tu vehÃ­culo actual.",
        ])

        closing = _pick([
            "Â¿Me compartes los datos de tu vehÃ­culo?",
            "Â¿QuÃ© vehÃ­culo tienes actualmente?",
            "Â¿Me dices marca, modelo, aÃ±o y condiciÃ³n de tu carro?",
        ])

        return {
            "response": (
                f"{opening}\n\n"
                f"En {dealer['name']} evaluamos tu vehÃ­culo actual y descontamos "
                f"su valor del precio del nuevo.\n\n"
                f"Para darte una estimaciÃ³n, necesito saber:\n"
                f"1ï¸âƒ£ **Marca y modelo** de tu vehÃ­culo actual\n"
                f"2ï¸âƒ£ **AÃ±o**\n"
                f"3ï¸âƒ£ **Kilometraje aproximado**\n"
                f"4ï¸âƒ£ **CondiciÃ³n general** (excelente, buena, regular)\n\n"
                f"âš ï¸ *La valoraciÃ³n final se realiza presencialmente con una inspecciÃ³n del vehÃ­culo.*\n\n"
                f"{closing}"
            ),
            "intent": "TradeIn",
            "confidence": _rand_conf(0.90, 0.97),
            "isFallback": False,
            "parameters": {"tradeInAccepted": True},
            "leadSignals": {
                "mentionedBudget": False,
                "requestedTestDrive": False,
                "askedFinancing": False,
                "providedContactInfo": False
            },
            "suggestedAction": None,
            "quickReplies": _pick([
                ["ğŸ“‹ Dar datos de mi carro", "ğŸ“ Hablar con asesor"],
                ["ğŸ“‹ Evaluar mi vehÃ­culo", "ğŸ’° Ver financiamiento"],
                ["Dar datos de mi carro", "Hablar con asesor"],
            ])
        }
    else:
        return {
            "response": _pick([
                (
                    f"Actualmente {dealer['name']} no ofrece el servicio de trade-in directamente, "
                    f"pero podemos orientarte sobre opciones para vender tu vehÃ­culo actual.\n\n"
                    f"Â¿Te gustarÃ­a explorar otras opciones de financiamiento?"
                ),
                (
                    f"Por el momento no manejamos trade-in en {dealer['name']}, "
                    f"pero tenemos excelentes opciones de financiamiento que podrÃ­an ayudarte.\n\n"
                    f"Â¿Quieres conocerlas?"
                ),
            ]),
            "intent": "TradeIn",
            "confidence": _rand_conf(0.85, 0.93),
            "isFallback": False,
            "parameters": {"tradeInAccepted": False},
            "leadSignals": {
                "mentionedBudget": False,
                "requestedTestDrive": False,
                "askedFinancing": False,
                "providedContactInfo": False
            },
            "suggestedAction": None,
            "quickReplies": _pick([
                ["ğŸ’° Ver financiamiento", "ğŸ“ Hablar con asesor"],
                ["Ver financiamiento", "Contactar asesor"],
            ])
        }


# ============================================================
# INTENT: WarrantyInfo (51)
# ============================================================

WARRANTY_USER_TEMPLATES = [
    # Semi-formal
    "Tiene garantÃ­a?",
    "CuÃ¡nto tiempo de garantÃ­a?",
    "QuÃ© cubre la garantÃ­a?",
    "Si se daÃ±a algo la garantÃ­a lo cubre?",
    "Tienen garantÃ­a extendida?",
    "La garantÃ­a incluye motor y transmisiÃ³n?",
    "CuÃ¡l es la polÃ­tica de garantÃ­a?",
    # Dominican informal
    "Oye, y ese carro viene con garantÃ­a?",
    "Dimelo, si se daÃ±a ustedes responden?",
    "Mano, y la garantÃ­a cuÃ¡nto dura?",
    "Y si se me daÃ±a el motor?",
    "Y si tiene algÃºn problema despues de comprarlo?",
    "La garantÃ­a cubre todo o solo algunas cosas?",
    "Si le pasa algo al carro en 6 meses quÃ© pasa?",
    "Ustedes dan garantÃ­a de que el carro estÃ¡ bien?",
    "Y la garantÃ­a es gratis o hay que pagarla aparte?",
    # Formal
    "Me gustarÃ­a conocer los tÃ©rminos de la garantÃ­a del vehÃ­culo",
    "Quisiera informaciÃ³n sobre la cobertura de garantÃ­a",
    "Ofrecen garantÃ­a mecÃ¡nica en vehÃ­culos usados?",
    # WhatsApp / typos
    "garantia?",
    "tiene garantia ese carro?",
    "q cubre la garantia?",
    "cuanto dura la garantia?",
    "garntia tienen?",
    "garantia estendida?",
]

def warranty_response(dealer: dict, vehicle: dict = None, **kwargs) -> dict:
    opening = _pick([
        f"ğŸ›¡ï¸ **InformaciÃ³n de GarantÃ­a**",
        f"AquÃ­ te cuento sobre nuestras garantÃ­as",
        f"**GarantÃ­as en {dealer['name']}**",
        f"Te explico cÃ³mo funcionan las garantÃ­as",
    ])

    closing = _pick([
        "Â¿Quieres saber la garantÃ­a de un vehÃ­culo en particular?",
        "Â¿Te gustarÃ­a conocer la garantÃ­a de algÃºn modelo especÃ­fico?",
        "Â¿Necesitas mÃ¡s detalles sobre la cobertura?",
        "Â¿Alguna otra pregunta sobre garantÃ­as?",
    ])

    return {
        "response": (
            f"{opening}\n\n"
            f"En {dealer['name']} todos nuestros vehÃ­culos incluyen:\n\n"
            f"âœ… **GarantÃ­a de fÃ¡brica** â€” Vigente segÃºn el fabricante (varÃ­a por marca)\n"
            f"âœ… **GarantÃ­a mecÃ¡nica** â€” Motor y transmisiÃ³n\n"
            f"âœ… **InspecciÃ³n pre-entrega** â€” RevisiÃ³n de 150 puntos\n\n"
            f"**GarantÃ­as tÃ­picas por marca:**\n"
            f"â€¢ Toyota/Honda: 3 aÃ±os o 36,000 km\n"
            f"â€¢ Hyundai/Kia: 5 aÃ±os o 60,000 km + 10 aÃ±os powertrain\n"
            f"â€¢ Otros: Consultar segÃºn modelo\n\n"
            f"âš ï¸ *Las condiciones exactas de garantÃ­a dependen del modelo y su historial. "
            f"Un asesor puede darte los detalles especÃ­ficos del vehÃ­culo que te interesa.*\n\n"
            f"{closing}"
        ),
        "intent": "WarrantyInfo",
        "confidence": _rand_conf(0.89, 0.97),
        "isFallback": False,
        "parameters": {},
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸ“‹ GarantÃ­a de un modelo", "ğŸ“ Hablar con asesor"],
            ["ğŸš— Ver vehÃ­culos", "ğŸ“ Contactar asesor"],
            ["Ver garantÃ­a de un modelo", "Hablar con asesor"],
        ])
    }


# ============================================================
# INTENT: CashPurchase (63) â€” Compra al contado / Declinar financiamiento
# ============================================================

CASH_PURCHASE_USER_TEMPLATES = [
    # Semi-formal
    "Lo voy a comprar sin financiamiento",
    "No necesito financiamiento, pago al contado",
    "Voy a pagar cash",
    "Lo compro de contado",
    "No quiero financiamiento",
    "Prefiero pagar al contado",
    "Sin financiamiento, cuÃ¡nto es el precio final?",
    "No me interesa el financiamiento",
    "Pago completo, sin prÃ©stamo",
    "Lo voy a comprar al contado, cuÃ¡les son los pasos?",
    "No necesito banco, pago directo",
    "Quiero comprarlo cash, quÃ© descuento me dan?",
    "Sin financiar, me lo llevo asÃ­",
    "Pago de una, no necesito cuotas",
    "Voy a pagar todo de una vez",
    "No quiero prÃ©stamo, pago el total",
    "Prefiero no financiar, cuÃ¡nto queda al contado?",
    "Mi nombre es {name}, {phone}. Y el vehiculo lo voy a comprar sin financiamiento",
    "Soy {name}, {phone}, lo compro al contado",
    "{name}, {phone}, no necesito financiamiento, pago cash",
    # Dominican informal
    "Nah, lo pago de una",
    "Yo pago cash, sin banco",
    "Dimelo, cuÃ¡nto queda si pago al chin chin?",
    "Mano, eso lo pago de contado, descuento?",
    "No quiero cuotas, pago to de una",
    "Lo pago completo, sin financiamiento ni nada",
    "Tengo la plata, cuÃ¡nto es de una vez?",
    "Si pago cash me rebajan algo?",
    # Formal
    "Me gustarÃ­a realizar la compra al contado, cuÃ¡l es el procedimiento?",
    "Quisiera saber si hay algÃºn beneficio por pago de contado",
    "Estoy interesado en adquirir el vehÃ­culo sin financiamiento",
    # WhatsApp / typos
    "pago cash",
    "lo compro de contadoo",
    "no kiero financiamiento",
    "cuanto es al contado?",
    "lo pago al cash, cuanto?",
    "sin finanaciamiento cuanto queda?",
    "Soy {name}, {phone}, pago de contado sin financiar",
]

def cash_purchase_response(dealer: dict, vehicle: dict = None, **kwargs) -> dict:
    name = kwargs.get("name")
    phone = kwargs.get("phone")
    vehicle_text = ""
    if vehicle:
        vehicle_text = f" de la **{vehicle['make']} {vehicle['model']} {vehicle['year']}**"

    if name and phone:
        response_text = _pick([
            (
                f"âœ… **Â¡Excelente decisiÃ³n, {name}!** La compra al contado{vehicle_text} es una gran opciÃ³n.\n\n"
                f"ğŸ“‹ **Pasos para compra al contado:**\n"
                f"1ï¸âƒ£ VerificaciÃ³n del vehÃ­culo en persona\n"
                f"2ï¸âƒ£ Acuerdo de precio final\n"
                f"3ï¸âƒ£ DocumentaciÃ³n (cÃ©dula, comprobante de fondos)\n"
                f"4ï¸âƒ£ Pago y transferencia de propiedad\n\n"
                f"Un asesor te contactarÃ¡ al **{phone}** para coordinar tu visita.\n\n"
                f"ğŸ’¡ *Pregunta por descuentos especiales por pago al contado.*"
            ),
            (
                f"Perfecto, {name}. Pago al contado{vehicle_text} registrado.\n\n"
                f"Te contactaremos al **{phone}** para coordinar los siguientes pasos:\n"
                f"â€¢ InspecciÃ³n presencial\n"
                f"â€¢ DocumentaciÃ³n\n"
                f"â€¢ Pago y entrega\n\n"
                f"Generalmente hay descuentos especiales por compra al contado."
            ),
        ])
        action = "TRANSFER_TO_AGENT"
    else:
        response_text = _pick([
            (
                f"Â¡Perfecto! La compra al contado{vehicle_text} es excelente.\n\n"
                f"ğŸ“‹ **Para compra al contado necesitas:**\n"
                f"â€¢ CÃ©dula de identidad vigente\n"
                f"â€¢ Comprobante de fondos\n"
                f"â€¢ Visita presencial para inspecciÃ³n\n\n"
                f"ğŸ’¡ *Muchos de nuestros vehÃ­culos tienen descuentos especiales por pago de contado.*\n\n"
                f"Â¿Me compartes tu nombre y telÃ©fono para coordinar tu visita?"
            ),
            (
                f"Excelente elecciÃ³n. La compra al contado{vehicle_text} suele tener beneficios adicionales.\n\n"
                f"Para avanzar, necesitarÃ© tu nombre y nÃºmero de contacto. "
                f"Â¿Me los compartes?"
            ),
        ])
        action = None

    return {
        "response": response_text,
        "intent": "CashPurchase",
        "confidence": _rand_conf(0.91, 0.97),
        "isFallback": False,
        "parameters": {
            "purchaseType": "cash",
            "vehicleId": vehicle["id"] if vehicle else None,
            "name": name,
            "phone": phone
        },
        "leadSignals": {
            "mentionedBudget": True,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": phone is not None
        },
        "suggestedAction": action,
        "quickReplies": _pick([
            ["ğŸ“ Contactar asesor", "ğŸ“‹ Requisitos completos", "ğŸš— Agendar visita"],
            ["ğŸ“ Llamar", "ğŸ’¬ WhatsApp", "ğŸš— Ver vehÃ­culos"],
            ["Contactar asesor", "Ver requisitos", "Agendar visita"],
        ]) if not phone else []
    }


# ============================================================
# INTENT: VehicleSpecsQuestion (15) â€” Preguntas tÃ©cnicas especÃ­ficas
# ============================================================

VEHICLE_SPECS_USER_TEMPLATES = [
    # Semi-formal
    "CuÃ¡ntas puertas tiene la {make} {model}?",
    "CuÃ¡ntos asientos tiene la {make} {model}?",
    "La {make} {model} tiene bluetooth?",
    "La {make} {model} tiene cÃ¡mara de reversa?",
    "Es tracciÃ³n delantera o 4x4?",
    "Tiene techo panorÃ¡mico la {make}?",
    "La {make} {model} es automÃ¡tica o manual?",
    "CuÃ¡ntas puertas tiene ese vehÃ­culo?",
    "Tiene Apple CarPlay?",
    "La {make} tiene tracciÃ³n 4x4?",
    "CuÃ¡ntos pasajeros caben?",
    "Tiene sunroof?",
    "Esa tiene cÃ¡mara 360?",
    "Es AWD o FWD?",
    "Tiene sensores de estacionamiento?",
    "QuÃ© tipo de tracciÃ³n tiene?",
    "Y cuÃ¡ntas puertas tiene ese vehÃ­culo?",
    "Tiene asientos en piel?",
    "La {make} {model} tiene Android Auto?",
    "Es diesel o gasolina la {make}?",
    # Dominican informal
    "Oye, y esa tiene bluetooth?",
    "Dimelo, es de 5 puertas o 3?",
    "Mano, eso es automÃ¡tico verdad?",
    "Y la {make} esa es 4x4 o traccion normal?",
    "Cuantos pasajeros le caben a esa?",
    "Tiene aire acondicionado?",
    "La {make} esa tiene pantalla grande?",
    "Esa viene full extras o hay que comprar aparte?",
    "Tiene vidrios elÃ©ctricos?",
    "Y el baÃºl es grande?",
    # Formal
    "Me gustarÃ­a conocer las especificaciones tÃ©cnicas de la {make} {model}",
    "PodrÃ­a detallarme el equipamiento de fÃ¡brica?",
    "Quisiera saber quÃ© caracterÃ­sticas de seguridad incluye",
    # WhatsApp / typos
    "cuantas puertas tiene?",
    "tiene camara d reversa?",
    "es automatica o manual?",
    "tiene bluetooth?",
    "cuantos asientos?",
    "tiene 4x4?",
    "q especificaciones tiene la {make}?",
]

def vehicle_specs_response(dealer: dict, vehicle: dict, **kwargs) -> dict:
    opening = _pick([
        f"ğŸ“‹ **Especificaciones de la {vehicle['make']} {vehicle['model']} {vehicle['year']} {vehicle.get('trim', '')}**",
        f"AquÃ­ estÃ¡n las especificaciones de la **{vehicle['make']} {vehicle['model']} {vehicle['year']}**",
        f"**{vehicle['make']} {vehicle['model']} {vehicle['year']}** â€” Especificaciones tÃ©cnicas",
        f"Te comparto las caracterÃ­sticas de la **{vehicle['make']} {vehicle['model']} {vehicle['year']}**",
    ])

    closing = _pick([
        "Â¿Te gustarÃ­a agendar un test drive o conocer el precio?",
        "Â¿Quieres ver el precio o agendar una visita?",
        "Â¿Alguna otra pregunta sobre este vehÃ­culo?",
        "Â¿Te gustarÃ­a verlo en persona?",
    ])

    return {
        "response": (
            f"{opening}\n\n"
            f"â›½ **Combustible:** {vehicle['fuelType']}\n"
            f"ğŸ”„ **TransmisiÃ³n:** {vehicle['transmission']}\n"
            f"ğŸ”§ **Motor:** {vehicle.get('engineSize', 'N/A')}\n"
            f"ğŸ“ **Kilometraje:** {vehicle['mileage']:,}km\n"
            f"ğŸ¨ **Color:** {vehicle.get('exteriorColor', 'N/A')}\n\n"
            f"Para informaciÃ³n adicional sobre puertas, asientos, tracciÃ³n y equipamiento, "
            f"puedo conectarte con un asesor que te confirme todos los detalles.\n\n"
            f"{closing}"
        ),
        "intent": "VehicleSpecsQuestion",
        "confidence": _rand_conf(0.91, 0.97),
        "isFallback": False,
        "parameters": {
            "vehicleId": vehicle["id"],
            "make": vehicle["make"],
            "model": vehicle["model"],
            "fuelType": vehicle["fuelType"],
            "transmission": vehicle["transmission"]
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸš— Agendar test drive", "ğŸ’° Ver precio", "ğŸ”„ Comparar con otro"],
            ["ğŸ’° CuÃ¡nto cuesta?", "ğŸš— Probar en persona", "ğŸ“ Contactar asesor"],
            ["Ver precio", "Agendar visita", "Comparar"],
        ])
    }


# ============================================================
# INTENT: NegotiatePrice (80) â€” NegociaciÃ³n de precio / descuento
# ============================================================

NEGOTIATE_PRICE_USER_TEMPLATES = [
    # Semi-formal
    "Me pueden hacer un descuento?",
    "CuÃ¡l es el mejor precio que me pueden dar?",
    "Se puede negociar el precio?",
    "Hay algÃºn descuento disponible?",
    "Si pago hoy me hacen rebaja?",
    "CuÃ¡nto es lo menos que me la dejan?",
    "Hay alguna promociÃ³n vigente?",
    "Tienen precio especial para compra rÃ¡pida?",
    "Me pueden mejorar el precio?",
    "Ese es el precio final o se puede negociar?",
    "Si compro dos vehÃ­culos me dan descuento?",
    "Hay precio de oportunidad?",
    "Me pueden igualar el precio de otro dealer?",
    # Dominican informal
    "Oye, me la dejan mÃ¡s barata?",
    "Mano, cuÃ¡nto es lo menos?",
    "Dimelo, y si te pago cash me rebajas algo?",
    "Eso no baja de ahÃ­?",
    "Y no me pueden dar un descuentito?",
    "Ta muy caro eso, rebÃ¡jenme algo",
    "Si me la llevan hoy cuÃ¡nto me quitan?",
    "QuÃ© e lo meno que me la dejan, de verdad?",
    "Mano, eso ta caro pa lo que es",
    "En otro lado me la dan mÃ¡s barata",
    "Otro dealer me la tiene en menos",
    # Formal
    "Me gustarÃ­a saber si hay margen de negociaciÃ³n en el precio",
    "PodrÃ­an considerar un ajuste en el precio?",
    "Quisiera explorar si hay algÃºn descuento corporativo disponible",
    # WhatsApp / typos
    "descuento?",
    "no baja de ahi?",
    "mejor presio?",
    "me hacen rebaja?",
    "lo menos?",
    "hay descuento si pago hoy?",
    "cuanto baja?",
]

def negotiate_price_response(dealer: dict, vehicle: dict = None, **kwargs) -> dict:
    vehicle_text = ""
    if vehicle:
        vehicle_text = f" de la **{vehicle['make']} {vehicle['model']} {vehicle['year']}**"

    opening = _pick([
        f"Entiendo tu interÃ©s en obtener el mejor precio{vehicle_text}.",
        f"Â¡Buena pregunta! Siempre buscamos darte el mejor valor{vehicle_text}.",
        f"Aprecio que preguntes por el mejor precio{vehicle_text}.",
    ])

    closing = _pick([
        "Â¿Te gustarÃ­a que un asesor te contacte para revisar opciones?",
        "Â¿Quieres que un asesor evalÃºe tu caso personalmente?",
        "Â¿Te interesa agendar una visita para negociar directamente?",
    ])

    return {
        "response": _pick([
            (
                f"{opening}\n\n"
                f"En {dealer['name']} nuestros precios son competitivos, pero hay formas de obtener "
                f"un mejor acuerdo:\n\n"
                f"ğŸ’° **Pago al contado** â€” Descuentos especiales\n"
                f"ğŸ”„ **Trade-in** â€” Tu vehÃ­culo actual como parte de pago\n"
                f"ğŸ“… **Promociones vigentes** â€” Consulta ofertas del mes\n"
                f"ğŸ¤ **NegociaciÃ³n directa** â€” Un asesor puede revisar opciones contigo\n\n"
                f"âš ï¸ *Los descuentos especÃ­ficos dependen del modelo y disponibilidad. "
                f"Un asesor puede darte la mejor oferta personalizada.*\n\n"
                f"{closing}"
            ),
            (
                f"{opening}\n\n"
                f"Los precios publicados ya son bastante competitivos, pero siempre hay espacio "
                f"para conversar, especialmente si pagas al contado o haces trade-in.\n\n"
                f"Lo mejor es que hables directamente con un asesor para que te dÃ© el mejor precio. "
                f"{closing}"
            ),
        ]),
        "intent": "NegotiatePrice",
        "confidence": _rand_conf(0.88, 0.96),
        "isFallback": False,
        "parameters": {
            "vehicleId": vehicle["id"] if vehicle else None,
            "negotiationType": "discount_request"
        },
        "leadSignals": {
            "mentionedBudget": True,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸ“ Hablar con asesor", "ğŸ’° Pago al contado", "ğŸ”„ Trade-in"],
            ["ğŸ“ Negociar con asesor", "ğŸš— Ver otras opciones", "ğŸ’° Financiamiento"],
            ["Contactar asesor", "Pago al contado", "Ver ofertas"],
        ])
    }


# ============================================================
# INTENT: VehicleAvailability (81) â€” Consultar disponibilidad
# ============================================================

VEHICLE_AVAILABILITY_USER_TEMPLATES = [
    # Semi-formal
    "Esa {make} {model} todavÃ­a estÃ¡ disponible?",
    "Ese carro ya se vendiÃ³?",
    "AÃºn tienen la {make} {model}?",
    "La {make} {model} estÃ¡ disponible?",
    "Ese vehÃ­culo sigue disponible?",
    "TodavÃ­a tienen esa en stock?",
    "Ya la vendieron?",
    "Sigue disponible la {make}?",
    "Eso estÃ¡ en inventario todavÃ­a?",
    "Hay unidades disponibles de la {make} {model}?",
    "Me pueden confirmar si la {make} todavÃ­a estÃ¡?",
    "No se habrÃ¡ vendido ya esa {make}?",
    # Dominican informal
    "Oye, eso todavÃ­a lo tienen o ya se fue?",
    "Dimelo, esa {make} ta disponible todavÃ­a?",
    "Mano, ya vendieron esa?",
    "Ese carro todavÃ­a ta ahi o ya se lo llevaron?",
    "Klk, aun tienen esa {make}?",
    "No se la habrÃ¡n llevado ya?",
    "Ta disponible eso todavÃ­a?",
    # Formal
    "Me gustarÃ­a confirmar la disponibilidad de la {make} {model} {year}",
    "PodrÃ­an verificar si aÃºn tienen ese vehÃ­culo en inventario?",
    # WhatsApp / typos
    "todavia la tienen?",
    "ya se vendio?",
    "disponible?",
    "aun esta?",
    "sigue disponble la {make}?",
    "la tienen todabia?",
    "eso ta disponble?",
]

def vehicle_availability_response(dealer: dict, vehicle: dict = None, **kwargs) -> dict:
    if vehicle:
        opening = _pick([
            f"âœ… Â¡SÃ­! La **{vehicle['make']} {vehicle['model']} {vehicle['year']}** sigue disponible.",
            f"Â¡Buenas noticias! La **{vehicle['make']} {vehicle['model']} {vehicle['year']}** todavÃ­a estÃ¡ en nuestro inventario.",
            f"Confirmado, la **{vehicle['make']} {vehicle['model']} {vehicle['year']}** estÃ¡ disponible.",
        ])
    else:
        opening = _pick([
            "Para verificar la disponibilidad, necesito saber quÃ© vehÃ­culo te interesa.",
            "Â¿Me dices cuÃ¡l vehÃ­culo quieres que verifique?",
        ])

    closing = _pick([
        "Te recomiendo no esperar mucho, nuestros vehÃ­culos se mueven rÃ¡pido. Â¿Te interesa agendar una visita?",
        "Â¿Te gustarÃ­a verlo en persona antes de que se venda?",
        "Â¿Quieres que te reserve una cita para verlo?",
        "Â¿Te agendo una visita?",
    ])

    return {
        "response": f"{opening}\n\n{closing}" if vehicle else opening,
        "intent": "VehicleAvailability",
        "confidence": _rand_conf(0.90, 0.97),
        "isFallback": False,
        "parameters": {
            "vehicleId": vehicle["id"] if vehicle else None,
            "isAvailable": True
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸ“… Agendar visita", "ğŸ’° Ver precio", "ğŸ“ Contactar asesor"],
            ["ğŸš— Test drive", "ğŸ’° Financiamiento", "ğŸ“ Reservar"],
            ["Agendar visita", "Ver precio", "Contactar"],
        ])
    }


# ============================================================
# INTENT: InsuranceInfo (82) â€” Consulta sobre seguros
# ============================================================

INSURANCE_INFO_USER_TEMPLATES = [
    # Semi-formal
    "Ofrecen seguro con la compra?",
    "CuÃ¡nto sale el seguro?",
    "Incluye seguro el vehÃ­culo?",
    "Trabajan con alguna aseguradora?",
    "Necesito seguro obligatorio?",
    "QuÃ© tipo de seguro necesito?",
    "Tienen convenio con seguros?",
    "El seguro viene incluido o es aparte?",
    "Me pueden ayudar con el seguro del vehÃ­culo?",
    "CuÃ¡nto cuesta asegurar la {make} {model}?",
    "QuÃ© seguro me recomiendan?",
    "El seguro cubre todo riesgo?",
    # Dominican informal
    "Oye, y el seguro cÃ³mo es?",
    "Dimelo, el seguro viene incluido o hay que pagarlo aparte?",
    "Mano, cuÃ¡nto sale asegurar eso?",
    "Y eso hay que ponerle seguro obligao?",
    "Y ustedes ayudan con lo del seguro?",
    "El seguro sale caro pa esa {make}?",
    "Trabajan con Mapfre o con cuÃ¡l?",
    # Formal
    "Me gustarÃ­a informaciÃ³n sobre opciones de seguro vehicular",
    "PodrÃ­an orientarme sobre el seguro obligatorio para vehÃ­culos?",
    "Quisiera saber quÃ© pÃ³lizas de seguro ofrecen",
    # WhatsApp / typos
    "seguro?",
    "tiene seguro?",
    "cuanto sale el seguro?",
    "nesesito seguro?",
    "q seguro nesecito?",
]

def insurance_info_response(dealer: dict, vehicle: dict = None, **kwargs) -> dict:
    vehicle_text = ""
    if vehicle:
        vehicle_text = f" para la **{vehicle['make']} {vehicle['model']} {vehicle['year']}**"

    opening = _pick([
        f"ğŸ›¡ï¸ **InformaciÃ³n de Seguros{vehicle_text}**",
        f"Te cuento sobre las opciones de seguro{vehicle_text}",
        f"AquÃ­ tienes la informaciÃ³n sobre seguros{vehicle_text}",
    ])

    closing = _pick([
        "Â¿Te gustarÃ­a que un asesor te cotice el seguro junto con el vehÃ­culo?",
        "Â¿Quieres que incluyamos la cotizaciÃ³n del seguro en tu presupuesto?",
        "Â¿Necesitas mÃ¡s informaciÃ³n sobre coberturas?",
    ])

    return {
        "response": (
            f"{opening}\n\n"
            f"En RepÃºblica Dominicana, el seguro de vehÃ­culos es obligatorio. "
            f"Trabajamos con las principales aseguradoras del paÃ­s:\n\n"
            f"ğŸ¢ **Aseguradoras aliadas:** Mapfre BHD, Seguros Universal, La Colonial, SURA\n\n"
            f"ğŸ“‹ **Tipos de cobertura:**\n"
            f"â€¢ **Responsabilidad civil** (obligatorio) â€” Desde RD$3,000/mes\n"
            f"â€¢ **Cobertura amplia** â€” Todo riesgo, robo, incendio\n"
            f"â€¢ **Full cobertura** â€” Incluye daÃ±os a terceros + propios\n\n"
            f"ğŸ’¡ *El costo del seguro depende del valor del vehÃ­culo, aÃ±o y tu historial. "
            f"Podemos incluirlo en el financiamiento si lo deseas.*\n\n"
            f"{closing}"
        ),
        "intent": "InsuranceInfo",
        "confidence": _rand_conf(0.89, 0.96),
        "isFallback": False,
        "parameters": {
            "vehicleId": vehicle["id"] if vehicle else None,
            "insuranceType": "general_inquiry"
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸ“ Cotizar seguro", "ğŸ’° Incluir en financiamiento", "ğŸš— Ver vehÃ­culos"],
            ["ğŸ“‹ MÃ¡s info seguros", "ğŸ“ Hablar con asesor", "ğŸ’° Financiamiento"],
            ["Cotizar seguro", "Incluir en financiamiento", "Hablar con asesor"],
        ])
    }


# ============================================================
# INTENT: DocumentsRequired (83) â€” Documentos necesarios para compra
# ============================================================

DOCUMENTS_REQUIRED_USER_TEMPLATES = [
    # Semi-formal
    "QuÃ© documentos necesito para comprar?",
    "QuÃ© papeles tengo que llevar?",
    "QuÃ© requisitos piden para la compra?",
    "Necesito la cÃ©dula nada mÃ¡s?",
    "QuÃ© documentaciÃ³n necesito?",
    "QuÃ© piden para poder comprar un carro?",
    "Hay que llevar algÃºn documento especial?",
    "Puedo comprar con pasaporte?",
    "QuÃ© se necesita para hacer la compra?",
    "Necesito rÃ©cord crediticio?",
    "Piden rÃ©cord policial?",
    "Extranjeros pueden comprar?",
    "Necesito residencia para comprar?",
    # Dominican informal
    "Oye, quÃ© papeles hay que llevar?",
    "Dimelo, con la cÃ©dula basta?",
    "Mano, quÃ© documentos piden ustedes?",
    "Y pa comprar quÃ© hay que llevar?",
    "Klk, quÃ© requisitos hay?",
    "Solo con la cÃ©dula o piden mÃ¡s cosas?",
    "Y si no tengo carta de trabajo?",
    "Necesito llevar la licencia?",
    # Formal
    "Me gustarÃ­a conocer la documentaciÃ³n requerida para la compra",
    "PodrÃ­an indicarme los requisitos documentales para adquirir un vehÃ­culo?",
    "Quisiera saber quÃ© documentos debo presentar",
    # WhatsApp / typos
    "q papeles nesesito?",
    "documentos?",
    "requisitos?",
    "q hay q llevar?",
    "q piden pa comprar?",
    "q documentos piden?",
]

def documents_required_response(dealer: dict, **kwargs) -> dict:
    opening = _pick([
        f"ğŸ“‹ **Documentos para comprar en {dealer['name']}**",
        f"AquÃ­ tienes los documentos necesarios para la compra",
        f"Te comparto los requisitos documentales",
        f"**Requisitos para comprar un vehÃ­culo**",
    ])

    closing = _pick([
        "Â¿Te gustarÃ­a agendar una visita? Con los documentos listos el proceso es rÃ¡pido.",
        "Â¿Necesitas mÃ¡s informaciÃ³n sobre algÃºn requisito?",
        "Â¿Quieres que un asesor te ayude con el proceso?",
    ])

    return {
        "response": (
            f"{opening}\n\n"
            f"**ğŸ“Œ Para compra al contado:**\n"
            f"â€¢ CÃ©dula de identidad vigente (o pasaporte + residencia)\n"
            f"â€¢ Comprobante de fondos o estado de cuenta\n"
            f"â€¢ Licencia de conducir (para test drive)\n\n"
            f"**ğŸ“Œ Para financiamiento (adicional):**\n"
            f"â€¢ Carta de trabajo con antigÃ¼edad y salario\n"
            f"â€¢ Estados de cuenta bancarios (Ãºltimos 3 meses)\n"
            f"â€¢ RÃ©cord crediticio favorable\n"
            f"â€¢ Comprobante de domicilio\n"
            f"â€¢ Referencias personales y comerciales\n\n"
            f"**ğŸ“Œ Para extranjeros:**\n"
            f"â€¢ Pasaporte vigente\n"
            f"â€¢ Residencia dominicana (si aplica)\n"
            f"â€¢ Comprobante de ingresos en RD\n\n"
            f"âš ï¸ *Los requisitos pueden variar segÃºn el banco y tipo de financiamiento.*\n\n"
            f"{closing}"
        ),
        "intent": "DocumentsRequired",
        "confidence": _rand_conf(0.91, 0.97),
        "isFallback": False,
        "parameters": {},
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸ“… Agendar visita", "ğŸ’° Financiamiento", "ğŸ“ Hablar con asesor"],
            ["ğŸš— Ver vehÃ­culos", "ğŸ’° Compra al contado", "ğŸ“ Contactar"],
            ["Agendar visita", "Ver requisitos financiamiento", "Contactar"],
        ])
    }


# ============================================================
# INTENT: DeliveryInfo (84) â€” Entrega / envÃ­o del vehÃ­culo
# ============================================================

DELIVERY_INFO_USER_TEMPLATES = [
    # Semi-formal
    "Hacen envÃ­o a otras ciudades?",
    "Me lo pueden llevar a mi casa?",
    "Hacen delivery del vehÃ­culo?",
    "Entregan en Santiago?",
    "CuÃ¡nto cuesta el envÃ­o?",
    "Pueden llevar el carro a otra provincia?",
    "CÃ³mo es la entrega del vehÃ­culo?",
    "CuÃ¡nto tarda la entrega?",
    "Entregan en todo el paÃ­s?",
    "El vehÃ­culo me lo llevan o lo recojo yo?",
    "Tienen servicio de transporte del vehÃ­culo?",
    # Dominican informal
    "Oye, y si vivo en Santiago me lo llevan?",
    "Dimelo, hacen delivery pa la Romana?",
    "Mano, me lo pueden mandar pa Punta Cana?",
    "Y si no puedo ir, me lo llevan?",
    "CuÃ¡nto sale que me lo manden pa Santiago?",
    "Llevan pa provincia?",
    "Pueden mandarmelo a HigÃ¼ey?",
    # Formal
    "Me gustarÃ­a saber si ofrecen servicio de entrega a domicilio",
    "PodrÃ­an informarme sobre opciones de envÃ­o interprovincial?",
    # WhatsApp / typos
    "hacen delivery?",
    "envio?",
    "me lo yevan?",
    "entregan en santiago?",
    "cuanto sale el envio?",
    "delivery a la romana?",
]

def delivery_info_response(dealer: dict, **kwargs) -> dict:
    opening = _pick([
        f"ğŸšš **Opciones de Entrega â€” {dealer['name']}**",
        f"Te cuento sobre nuestro servicio de entrega",
        f"AquÃ­ tienes la informaciÃ³n de entrega",
    ])

    closing = _pick([
        "Â¿En quÃ© zona necesitas la entrega?",
        "Â¿DÃ³nde te encuentras? AsÃ­ te damos el costo exacto.",
        "Â¿Te gustarÃ­a coordinar la entrega con un asesor?",
    ])

    return {
        "response": (
            f"{opening}\n\n"
            f"ğŸ“ **Retiro en dealer:** Puedes recoger tu vehÃ­culo directamente en "
            f"{dealer['location']} sin costo adicional.\n\n"
            f"ğŸšš **Entrega a domicilio:**\n"
            f"â€¢ **Santo Domingo / Zona Metropolitana:** RD$3,000 - RD$5,000\n"
            f"â€¢ **Santiago / Cibao:** RD$8,000 - RD$12,000\n"
            f"â€¢ **Este (Punta Cana, La Romana):** RD$10,000 - RD$15,000\n"
            f"â€¢ **Otras provincias:** Consultar\n\n"
            f"â° **Tiempo de entrega:** 1-3 dÃ­as hÃ¡biles despuÃ©s de completar la compra.\n\n"
            f"ğŸ’¡ *La entrega incluye revisiÃ³n final del vehÃ­culo y entrega de documentos.*\n\n"
            f"{closing}"
        ),
        "intent": "DeliveryInfo",
        "confidence": _rand_conf(0.90, 0.96),
        "isFallback": False,
        "parameters": {},
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸ“ Coordinar entrega", "ğŸ“… Agendar visita", "ğŸš— Ver vehÃ­culos"],
            ["ğŸ“ Contactar asesor", "ğŸ“ Ver ubicaciÃ³n", "ğŸ’° Financiamiento"],
            ["Coordinar entrega", "Visitar dealer", "Contactar"],
        ])
    }


# ============================================================
# INTENT: VehicleHistory (85) â€” Historial / reporte del vehÃ­culo
# ============================================================

VEHICLE_HISTORY_USER_TEMPLATES = [
    # Semi-formal
    "Tiene reporte de accidente?",
    "El carro ha tenido algÃºn choque?",
    "CuÃ¡ntos dueÃ±os ha tenido?",
    "Tiene historial de mantenimiento?",
    "Puedo ver el Carfax o reporte?",
    "El vehÃ­culo tiene algÃºn daÃ±o reportado?",
    "Ha estado en algÃºn accidente?",
    "Tiene reporte de daÃ±os?",
    "El tÃ­tulo estÃ¡ limpio?",
    "Es salvage o clean title?",
    "El carro viene de Estados Unidos?",
    "Es importado o de agencia local?",
    "Tiene algÃºn recall pendiente?",
    # Dominican informal
    "Oye, y ese carro ha chocado?",
    "Dimelo, eso no serÃ¡ de choque verdad?",
    "Mano, cuÃ¡ntos dueÃ±os ha tenido eso?",
    "Y eso no tiene ningÃºn problema verdad?",
    "Ese carro viene de gringo o es local?",
    "No serÃ¡ un carro de salvamento?",
    "Ta limpio ese carro?",
    "El tÃ­tulo ta limpio?",
    "Y eso no tiene ningÃºn golpe escondido?",
    # Formal
    "Me gustarÃ­a conocer el historial completo del vehÃ­culo",
    "PodrÃ­an proporcionarme un reporte de condiciÃ³n del vehÃ­culo?",
    "Quisiera verificar si el vehÃ­culo tiene un tÃ­tulo limpio",
    # WhatsApp / typos
    "tiene reporte?",
    "a chocado?",
    "cuantos dueÃ±os?",
    "ta limpio?",
    "es de choke?",
    "historial?",
    "titulo limpio?",
]

def vehicle_history_response(dealer: dict, vehicle: dict = None, **kwargs) -> dict:
    vehicle_text = ""
    if vehicle:
        vehicle_text = f" de la **{vehicle['make']} {vehicle['model']} {vehicle['year']}**"

    opening = _pick([
        f"ğŸ“„ **Historial del VehÃ­culo{vehicle_text}**",
        f"AquÃ­ te comparto la informaciÃ³n sobre el historial{vehicle_text}",
        f"Te cuento sobre el estado e historial{vehicle_text}",
    ])

    closing = _pick([
        "Â¿Te gustarÃ­a verlo en persona para una inspecciÃ³n completa?",
        "Â¿Quieres que un asesor te muestre el reporte completo?",
        "Â¿Te agendo una visita para que lo revises personalmente?",
    ])

    return {
        "response": (
            f"{opening}\n\n"
            f"En {dealer['name']} todos nuestros vehÃ­culos pasan por:\n\n"
            f"âœ… **InspecciÃ³n de 150 puntos** â€” MecÃ¡nica, elÃ©ctrica, carrocerÃ­a\n"
            f"âœ… **VerificaciÃ³n de tÃ­tulo** â€” TÃ­tulo limpio garantizado\n"
            f"âœ… **Reporte de historial** â€” Sin accidentes graves reportados\n"
            f"âœ… **VerificaciÃ³n DGII** â€” Impuestos al dÃ­a\n"
            f"âœ… **VerificaciÃ³n DIGESETT** â€” Sin multas pendientes\n\n"
            f"ğŸ“‹ *Podemos proporcionarte el reporte completo de cualquier vehÃ­culo "
            f"de nuestro inventario. Para vehÃ­culos importados, incluimos el reporte "
            f"de origen (Carfax/AutoCheck cuando disponible).*\n\n"
            f"{closing}"
        ),
        "intent": "VehicleHistory",
        "confidence": _rand_conf(0.89, 0.96),
        "isFallback": False,
        "parameters": {
            "vehicleId": vehicle["id"] if vehicle else None,
            "historyType": "general_inquiry"
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸ“„ Ver reporte completo", "ğŸ“… Agendar inspecciÃ³n", "ğŸ“ Hablar con asesor"],
            ["ğŸ“„ Reporte del vehÃ­culo", "ğŸš— Agendar visita", "ğŸ’° Ver precio"],
            ["Ver reporte", "Agendar inspecciÃ³n", "Contactar"],
        ])
    }


# ============================================================
# INTENT: PaymentMethods (86) â€” MÃ©todos de pago aceptados
# ============================================================

PAYMENT_METHODS_USER_TEMPLATES = [
    # Semi-formal
    "QuÃ© mÃ©todos de pago aceptan?",
    "Aceptan tarjeta de crÃ©dito?",
    "Puedo pagar con transferencia?",
    "Aceptan cheque?",
    "Se puede pagar con dÃ³lares?",
    "Aceptan Visa o Mastercard?",
    "Puedo pagar por AZUL?",
    "Aceptan pago mÃ³vil?",
    "Puedo usar mi tarjeta de dÃ©bito?",
    "Tienen punto de venta?",
    "Aceptan Bitcoin o crypto?",
    "Puedo hacer un depÃ³sito bancario?",
    "Aceptan cheque certificado?",
    # Dominican informal
    "Oye, aceptan tarjeta o es solo cash?",
    "Dimelo, puedo pagar con la Visa?",
    "Mano, aceptan transferencia?",
    "Puedo pagar con la app del banco?",
    "Y si pago en dÃ³lares me lo aceptan?",
    "Aceptan tPago?",
    "Puedo pagar por el Popular online?",
    "Aceptan Banreservas online?",
    # Formal
    "Me gustarÃ­a saber quÃ© formas de pago aceptan",
    "PodrÃ­an indicarme los mÃ©todos de pago disponibles?",
    # WhatsApp / typos
    "aceptan tarjeta?",
    "metodos de pago?",
    "puedo pagar con transferensia?",
    "aseptan cheque?",
    "formas d pago?",
    "aceptan dolares?",
]

def payment_methods_response(dealer: dict, **kwargs) -> dict:
    opening = _pick([
        f"ğŸ’³ **MÃ©todos de Pago â€” {dealer['name']}**",
        f"Aceptamos varias formas de pago",
        f"AquÃ­ te cuento los mÃ©todos de pago disponibles",
    ])

    closing = _pick([
        "Â¿CuÃ¡l mÃ©todo de pago prefieres?",
        "Â¿Te gustarÃ­a coordinar el pago con un asesor?",
        "Â¿Alguna pregunta sobre los mÃ©todos de pago?",
    ])

    return {
        "response": (
            f"{opening}\n\n"
            f"âœ… **Efectivo** â€” Pesos dominicanos (RD$) o dÃ³lares (USD)\n"
            f"âœ… **Transferencia bancaria** â€” Cualquier banco local\n"
            f"âœ… **Tarjeta de crÃ©dito** â€” Visa, Mastercard, AMEX\n"
            f"âœ… **Tarjeta de dÃ©bito** â€” Con punto de venta\n"
            f"âœ… **Cheque certificado** â€” De banco local\n"
            f"âœ… **Financiamiento** â€” A travÃ©s de nuestros bancos aliados\n\n"
            f"âš ï¸ *Para compras con tarjeta de crÃ©dito, pueden aplicar cargos adicionales "
            f"segÃºn el banco emisor. Transferencias y efectivo no tienen recargo.*\n\n"
            f"{closing}"
        ),
        "intent": "PaymentMethods",
        "confidence": _rand_conf(0.91, 0.97),
        "isFallback": False,
        "parameters": {},
        "leadSignals": {
            "mentionedBudget": True,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸ’° Pago al contado", "ğŸ’³ Financiamiento", "ğŸ“ Contactar asesor"],
            ["ğŸ’° Cash", "ğŸ’³ Tarjeta", "ğŸ¦ Transferencia"],
            ["Pago al contado", "Financiamiento", "Contactar"],
        ])
    }


# ============================================================
# INTENT: ReturnPolicy (87) â€” PolÃ­tica de devoluciÃ³n
# ============================================================

RETURN_POLICY_USER_TEMPLATES = [
    # Semi-formal
    "Si no me gusta lo puedo devolver?",
    "Tienen polÃ­tica de devoluciÃ³n?",
    "Se puede devolver el carro?",
    "QuÃ© pasa si me arrepiento despuÃ©s de comprar?",
    "Hay garantÃ­a de satisfacciÃ³n?",
    "CuÃ¡ntos dÃ­as tengo para devolver el vehÃ­culo?",
    "Si le encuentro un defecto puedo devolverlo?",
    "Tienen perÃ­odo de prueba?",
    "Y si compro y no me gusta?",
    "Puedo cambiar el vehÃ­culo despuÃ©s de comprar?",
    # Dominican informal
    "Oye, y si no me gusta despuÃ©s lo devuelvo?",
    "Dimelo, puedo devolver el carro si no me convence?",
    "Y si me arrepiento quÃ© hago?",
    "Si lo compro y no me gusta quÃ© pasa?",
    "Mano, y si sale con algÃºn problema lo cambio?",
    "Y si despuÃ©s quiero otro?",
    # Formal
    "Me gustarÃ­a conocer su polÃ­tica de devoluciÃ³n y garantÃ­a de satisfacciÃ³n",
    "PodrÃ­an informarme sobre los tÃ©rminos de cambio o devoluciÃ³n?",
    # WhatsApp / typos
    "puedo devolverlo?",
    "devolucion?",
    "si no me gusta q pasa?",
    "se puede devolver?",
    "politica de devolucion?",
    "me arrepiento y q?",
]

def return_policy_response(dealer: dict, **kwargs) -> dict:
    opening = _pick([
        f"ğŸ“‹ **PolÃ­tica de DevoluciÃ³n â€” {dealer['name']}**",
        f"Te explico nuestra polÃ­tica de devoluciÃ³n y cambio",
        f"AquÃ­ tienes la informaciÃ³n sobre devoluciones",
    ])

    closing = _pick([
        "Â¿Te gustarÃ­a conocer mÃ¡s detalles? Un asesor puede explicarte todo.",
        "Â¿Tienes alguna otra pregunta sobre nuestras polÃ­ticas?",
        "Â¿Quieres que un asesor te explique los tÃ©rminos en detalle?",
    ])

    return {
        "response": (
            f"{opening}\n\n"
            f"En {dealer['name']} tu satisfacciÃ³n es nuestra prioridad:\n\n"
            f"âœ… **InspecciÃ³n pre-compra** â€” Revisamos el vehÃ­culo contigo antes de la venta\n"
            f"âœ… **PerÃ­odo de garantÃ­a** â€” Cobertura mecÃ¡nica post-venta\n"
            f"âœ… **Cambio por defectos** â€” Si se detecta un defecto oculto, lo resolvemos\n\n"
            f"âš ï¸ **Importante:**\n"
            f"â€¢ La venta de vehÃ­culos generalmente es final una vez completada la transacciÃ³n.\n"
            f"â€¢ Conforme a la **Ley 358-05** (Pro-Consumidor), tienes derechos como comprador.\n"
            f"â€¢ Cualquier defecto no declarado al momento de la venta estÃ¡ cubierto.\n"
            f"â€¢ Recomendamos siempre una inspecciÃ³n presencial y test drive antes de comprar.\n\n"
            f"{closing}"
        ),
        "intent": "ReturnPolicy",
        "confidence": _rand_conf(0.89, 0.95),
        "isFallback": False,
        "parameters": {},
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸ“ Hablar con asesor", "ğŸ›¡ï¸ Ver garantÃ­a", "ğŸš— Test drive"],
            ["ğŸ“ Contactar", "ğŸ›¡ï¸ GarantÃ­a", "ğŸš— Ver vehÃ­culos"],
            ["Hablar con asesor", "Ver garantÃ­a", "Agendar visita"],
        ])
    }


# ============================================================
# INTENT: VehicleHistory (88) â€” Costo de mantenimiento
# ============================================================

MAINTENANCE_COST_USER_TEMPLATES = [
    # Semi-formal
    "CuÃ¡nto cuesta el mantenimiento?",
    "Sale caro mantener la {make} {model}?",
    "Cada cuÃ¡nto es el service?",
    "CuÃ¡nto sale el cambio de aceite?",
    "Los repuestos son caros?",
    "Es fÃ¡cil conseguir repuestos?",
    "Cada cuÃ¡nto hay que hacerle mantenimiento?",
    "CuÃ¡nto gasta de gasolina?",
    "Es econÃ³mica en combustible?",
    "Rinde bien la gasolina?",
    "Sale cara la mantenciÃ³n de la {make}?",
    "CuÃ¡nto se gasta mensual en mantenimiento?",
    # Dominican informal
    "Oye, y esa sale cara de mantener?",
    "Dimelo, la {make} gasta mucha gasolina?",
    "Mano, los repuestos de esa se consiguen fÃ¡cil?",
    "Y eso cuÃ¡nto gasta de gas?",
    "Sale caro darle servicio a eso?",
    "Los repuestos son genÃ©ricos o originales?",
    "CuÃ¡nto rinde un tanque lleno?",
    "Hay talleres que trabajen esa marca aquÃ­?",
    # Formal
    "Me gustarÃ­a conocer los costos estimados de mantenimiento",
    "PodrÃ­an indicarme el consumo de combustible y costos de servicio?",
    # WhatsApp / typos
    "cuanto gasta de gasolina?",
    "sale caro mantener?",
    "repuestos?",
    "mantenimiento caro?",
    "cuanto gasta?",
    "los repuestos se consiguen?",
]

def maintenance_cost_response(dealer: dict, vehicle: dict = None, **kwargs) -> dict:
    vehicle_text = ""
    fuel_info = ""
    if vehicle:
        vehicle_text = f" de la **{vehicle['make']} {vehicle['model']} {vehicle['year']}**"
        fuel_type = vehicle.get("fuelType", "Gasolina")
        fuel_info = f"\nâ›½ **Combustible:** {fuel_type}"

    opening = _pick([
        f"ğŸ”§ **Costos de Mantenimiento{vehicle_text}**",
        f"Te cuento sobre el mantenimiento{vehicle_text}",
        f"AquÃ­ tienes informaciÃ³n sobre costos de mantenimiento{vehicle_text}",
    ])

    closing = _pick([
        "Â¿Te gustarÃ­a mÃ¡s detalles sobre un modelo especÃ­fico?",
        "Â¿Quieres que un asesor te dÃ© un estimado mÃ¡s preciso?",
        "Â¿Necesitas informaciÃ³n sobre algÃºn servicio en particular?",
    ])

    return {
        "response": (
            f"{opening}\n\n"
            f"ğŸ“‹ **Mantenimiento preventivo estimado:**{fuel_info}\n"
            f"â€¢ **Cambio de aceite:** RD$2,500 - RD$5,000 (cada 5,000-10,000 km)\n"
            f"â€¢ **Servicio general:** RD$5,000 - RD$15,000 (cada 10,000 km)\n"
            f"â€¢ **Frenos:** RD$4,000 - RD$12,000 (cada 30,000-50,000 km)\n"
            f"â€¢ **NeumÃ¡ticos:** RD$15,000 - RD$40,000 (cada 40,000-60,000 km)\n\n"
            f"ğŸ’¡ **Tips:**\n"
            f"â€¢ Las marcas japonesas (Toyota, Honda, Nissan) suelen tener repuestos mÃ¡s econÃ³micos en RD\n"
            f"â€¢ Las marcas coreanas (Hyundai, Kia) tienen buena disponibilidad de repuestos\n"
            f"â€¢ Los vehÃ­culos diÃ©sel consumen menos pero el mantenimiento es algo mÃ¡s costoso\n\n"
            f"âš ï¸ *Los costos son estimados y varÃ­an segÃºn el taller y la marca. "
            f"Un asesor puede darte un estimado mÃ¡s preciso.*\n\n"
            f"{closing}"
        ),
        "intent": "MaintenanceCost",
        "confidence": _rand_conf(0.88, 0.95),
        "isFallback": False,
        "parameters": {
            "vehicleId": vehicle["id"] if vehicle else None,
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸš— Ver vehÃ­culos econÃ³micos", "ğŸ’° Financiamiento", "ğŸ“ Asesor"],
            ["ğŸš— Buscar vehÃ­culo", "ğŸ’° Ver precios", "ğŸ“ Contactar"],
            ["Ver vehÃ­culos", "Precios", "Hablar con asesor"],
        ])
    }


# ============================================================
# INTENT: OutOfScope (89) â€” Preguntas fuera del tema automotriz
# ============================================================

OUT_OF_SCOPE_USER_TEMPLATES = [
    # Real estate
    "Venden casas tambiÃ©n?",
    "Tienen apartamentos en venta?",
    "Me pueden vender un terreno?",
    "Hacen prÃ©stamos hipotecarios?",
    # Electronics / other products
    "Venden iPhones?",
    "Tienen computadoras?",
    "Venden televisores?",
    "Tienen electrodomÃ©sticos?",
    # Services unrelated
    "Me puedes hacer una reservaciÃ³n de restaurante?",
    "Necesito un plomero",
    "Saben de algÃºn electricista?",
    "Me pueden hacer un trÃ¡mite de visa?",
    # Personal questions
    "Quieres ser mi novia?",
    "Me puedes prestar dinero?",
    "CuÃ¡l es el resultado del bÃ©isbol?",
    "QuiÃ©n va a ganar las elecciones?",
    "Me puedes ayudar con mi tarea de matemÃ¡ticas?",
    "CuÃ©ntame un chiste",
    # Dominican specific off-topic
    "A cÃ³mo ta el dÃ³lar hoy?",
    "Hay apagÃ³n hoy?",
    "DÃ³nde queda la JCE mÃ¡s cerca?",
    "CuÃ¡ndo es el prÃ³ximo feriado?",
    "Me pueden hacer una marbete?",
    # Travel / flights
    "CuÃ¡nto cuesta un vuelo a Miami?",
    "Venden pasajes de aviÃ³n?",
    "Tienen paquetes de viaje?",
]

def out_of_scope_response(dealer: dict, **kwargs) -> dict:
    response = _pick([
        (
            f"Aprecio tu consulta, pero eso estÃ¡ fuera de mi Ã¡rea. ğŸ˜Š\n\n"
            f"Soy el asistente especializado en vehÃ­culos de {dealer['name']}. "
            f"Puedo ayudarte con:\n\n"
            f"ğŸš— Buscar vehÃ­culos\n"
            f"ğŸ’° Precios y financiamiento\n"
            f"ğŸ“… Agendar test drives\n"
            f"ğŸ“ UbicaciÃ³n y horarios\n\n"
            f"Â¿Te gustarÃ­a explorar nuestro inventario?"
        ),
        (
            f"Â¡Ja! Eso no es lo mÃ­o, pero en lo que sÃ­ soy experto es en vehÃ­culos. ğŸš—\n\n"
            f"Soy el bot de ventas de {dealer['name']} y puedo ayudarte a encontrar "
            f"el carro perfecto para ti.\n\n"
            f"Â¿Buscas algo en particular?"
        ),
        (
            f"Hmm, para eso necesitarÃ­as otro tipo de ayuda. "
            f"Yo me especializo en vehÃ­culos aquÃ­ en {dealer['name']}.\n\n"
            f"Â¿En quÃ© puedo ayudarte con carros?"
        ),
    ])

    return {
        "response": response,
        "intent": "OutOfScope",
        "confidence": _rand_conf(0.55, 0.80),
        "isFallback": False,
        "parameters": {},
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸš— Ver vehÃ­culos", "ğŸ’° Precios", "ğŸ“ Contactar asesor"],
            ["ğŸ” Buscar carro", "ğŸ’° Financiamiento", "ğŸ“ UbicaciÃ³n"],
            ["Ver inventario", "Buscar vehÃ­culo", "Contactar"],
        ])
    }


# ============================================================
# INTENT: LanguageBarrier (90) â€” Mensajes en otros idiomas
# ============================================================

LANGUAGE_BARRIER_USER_TEMPLATES = [
    # English
    "Do you have cars for sale?",
    "What cars do you have available?",
    "I'm looking for an SUV",
    "How much is that car?",
    "Can I schedule a test drive?",
    "Do you offer financing?",
    "What's the price?",
    "I want to buy a car",
    "Do you speak English?",
    "Can you help me in English?",
    "Is this available?",
    "How can I contact you?",
    # French
    "Je cherche une voiture",
    "Vous avez des voitures Ã  vendre?",
    "Combien Ã§a coÃ»te?",
    "Parlez-vous franÃ§ais?",
    # Portuguese
    "VocÃªs vendem carros?",
    "Quanto custa esse carro?",
    "Preciso de um carro",
    # Haitian Creole (important for DR)
    "Mwen bezwen yon machin",
    "Konbyen machin sa a koute?",
    "Eske ou gen machin pou vann?",
    "Mwen vle achte yon machin",
]

def language_barrier_response(dealer: dict, **kwargs) -> dict:
    response = _pick([
        (
            f"Hello! ğŸ‘‹ I see you're writing in another language.\n\n"
            f"I'm the virtual assistant of {dealer['name']} and I primarily speak **Spanish**. "
            f"However, I can try to help you.\n\n"
            f"---\n\n"
            f"Â¡Hola! Veo que escribes en otro idioma. Soy el asistente de {dealer['name']} "
            f"y hablo principalmente **espaÃ±ol**.\n\n"
            f"Si necesitas atenciÃ³n en inglÃ©s u otro idioma, puedo conectarte con un asesor "
            f"que pueda asistirte.\n\n"
            f"Would you like me to connect you with an advisor who speaks English? / "
            f"Â¿Te conecto con un asesor?"
        ),
        (
            f"Hi! I mainly speak Spanish, but I can help you. ğŸŒ\n\n"
            f"For better assistance, I can connect you with a bilingual advisor at {dealer['name']}.\n\n"
            f"---\n\n"
            f"Â¡Hola! Hablo principalmente espaÃ±ol. Â¿Te conecto con un asesor bilingÃ¼e?"
        ),
    ])

    return {
        "response": response,
        "intent": "LanguageBarrier",
        "confidence": _rand_conf(0.75, 0.90),
        "isFallback": False,
        "parameters": {
            "detectedLanguage": "non-spanish"
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": "TRANSFER_TO_AGENT",
        "quickReplies": _pick([
            ["ğŸ“ Talk to advisor", "ğŸš— Ver vehÃ­culos", "ğŸ“ Hablar con asesor"],
            ["Yes, connect me", "ğŸš— Show vehicles", "ğŸ“ Contact advisor"],
            ["Conectar con asesor", "Ver vehÃ­culos", "Contactar"],
        ])
    }


# ============================================================
# INTENT: ColorAvailability (91) â€” Disponibilidad de colores
# ============================================================

COLOR_AVAILABILITY_USER_TEMPLATES = [
    # Semi-formal
    "En quÃ© colores viene la {make} {model}?",
    "Tienen la {make} en negro?",
    "Viene en blanco la {make} {model}?",
    "QuÃ© colores tienen disponibles?",
    "Hay en color rojo?",
    "Tienen alguno en gris o plata?",
    "Lo quiero azul, tienen?",
    "QuÃ© opciones de color tienen?",
    "Viene en color perla?",
    "Tienen interior en piel negra?",
    "Puedo elegir el color?",
    # Dominican informal
    "Oye, y esa viene en negra?",
    "Dimelo, tienen en blanco?",
    "Mano, hay en color champagne?",
    "Y en rojo la tienen?",
    "Hay alguna en azul?",
    "Lo quiero blanquito, hay?",
    "Y los interiores son en piel o tela?",
    # Formal
    "Me gustarÃ­a saber quÃ© opciones de color exterior e interior tienen disponibles",
    "PodrÃ­an indicarme los colores disponibles para la {make} {model}?",
    # WhatsApp / typos
    "colores?",
    "hay en negro?",
    "viene en blanco?",
    "q colores tienen?",
    "hay rojo?",
    "color?",
]

def color_availability_response(dealer: dict, vehicle: dict = None, **kwargs) -> dict:
    if vehicle:
        opening = _pick([
            f"ğŸ¨ **Colores de la {vehicle['make']} {vehicle['model']} {vehicle['year']}**",
            f"AquÃ­ estÃ¡n los colores disponibles para la **{vehicle['make']} {vehicle['model']}**",
            f"Te cuento sobre los colores de la **{vehicle['make']} {vehicle['model']}**",
        ])

        color_info = (
            f"La unidad que tenemos en inventario viene en:\n\n"
            f"ğŸ¨ **Exterior:** {vehicle.get('exteriorColor', 'Consultar')}\n"
            f"ğŸª‘ **Interior:** {vehicle.get('interiorColor', 'Consultar')}\n\n"
        )
    else:
        opening = _pick([
            "ğŸ¨ **Colores Disponibles**",
            "Te cuento sobre nuestras opciones de color",
        ])
        color_info = (
            "Contamos con vehÃ­culos en diversos colores:\n\n"
            "ğŸ¨ **Colores populares:** Blanco, Negro, Gris, Plata, Azul, Rojo\n\n"
        )

    closing = _pick([
        "Â¿Buscas un color en particular? Puedo filtrar el inventario.",
        "Â¿QuÃ© color prefieres? Te busco opciones.",
        "Â¿Te gustarÃ­a ver los vehÃ­culos disponibles en un color especÃ­fico?",
    ])

    return {
        "response": (
            f"{opening}\n\n"
            f"{color_info}"
            f"ğŸ’¡ *La disponibilidad de colores depende del inventario actual. "
            f"Si no tenemos el color que buscas, podemos buscar opciones para ti.*\n\n"
            f"{closing}"
        ),
        "intent": "ColorAvailability",
        "confidence": _rand_conf(0.88, 0.96),
        "isFallback": False,
        "parameters": {
            "vehicleId": vehicle["id"] if vehicle else None,
            "exteriorColor": vehicle.get("exteriorColor") if vehicle else None,
            "interiorColor": vehicle.get("interiorColor") if vehicle else None
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸ” Buscar por color", "ğŸ“‹ Ver detalles", "ğŸ“ Contactar asesor"],
            ["ğŸ” Filtrar inventario", "ğŸš— Ver vehÃ­culos", "ğŸ“ Asesor"],
            ["Buscar por color", "Ver inventario", "Contactar"],
        ])
    }


# ============================================================
# INTENT: UrgentPurchase (92) â€” Compra urgente / inmediata
# ============================================================

URGENT_PURCHASE_USER_TEMPLATES = [
    # Semi-formal
    "Necesito un carro para hoy",
    "Tienen algo que me pueda llevar hoy mismo?",
    "CuÃ¡l es el proceso mÃ¡s rÃ¡pido para comprar?",
    "Necesito un vehÃ­culo urgente",
    "CuÃ¡nto tarda el proceso de compra?",
    "Puedo salir hoy con el carro?",
    "Tienen vehÃ­culos listos para entrega inmediata?",
    "Necesito comprar lo mÃ¡s rÃ¡pido posible",
    "CuÃ¡nto se demora todo el papeleo?",
    "Se puede comprar hoy y llevÃ¡rselo hoy?",
    "QuÃ© tienen para entrega inmediata?",
    # Dominican informal
    "Oye necesito un carro ya ya",
    "Mano, es urgente, necesito un carro hoy",
    "Dimelo, quÃ© tienen que me pueda llevar ahorita?",
    "Klk, necesito uno pa hoy",
    "Puedo llegar hoy y salir con el carro?",
    "No tengo tiempo, necesito algo rÃ¡pido",
    "CuÃ¡l me puedo llevar hoy mismo?",
    "Hay algo listo pa entregar?",
    # Formal
    "Me urge adquirir un vehÃ­culo, cuÃ¡l es el proceso mÃ¡s Ã¡gil?",
    "Necesito un vehÃ­culo disponible para entrega inmediata",
    # WhatsApp / typos
    "necesito un carro ya!",
    "algo pa hoy?",
    "urgente!!",
    "entrega inmediata?",
    "hoy mismo puedo?",
    "lo nesesito ya",
]

def urgent_purchase_response(dealer: dict, **kwargs) -> dict:
    opening = _pick([
        f"âš¡ **Entendido, vamos a agilizar esto.**",
        f"Â¡Perfecto! Podemos hacer el proceso rÃ¡pido.",
        f"Entiendo la urgencia. En {dealer['name']} podemos ser muy Ã¡giles.",
    ])

    closing = _pick([
        "Â¿Te gustarÃ­a ver quÃ© vehÃ­culos tenemos listos para entrega hoy?",
        "Â¿CuÃ¡l es tu presupuesto? AsÃ­ te muestro opciones con entrega inmediata.",
        "Â¿Quieres que un asesor te atienda ahora mismo?",
    ])

    return {
        "response": (
            f"{opening}\n\n"
            f"ğŸ“‹ **Proceso de compra rÃ¡pida en {dealer['name']}:**\n\n"
            f"â±ï¸ **Pago al contado:** El proceso puede completarse en **2-4 horas**\n"
            f"1ï¸âƒ£ SelecciÃ³n del vehÃ­culo\n"
            f"2ï¸âƒ£ VerificaciÃ³n de documentos (cÃ©dula + comprobante de fondos)\n"
            f"3ï¸âƒ£ Pago y firma\n"
            f"4ï¸âƒ£ Â¡Te vas con tu vehÃ­culo!\n\n"
            f"â±ï¸ **Con financiamiento:** De **24-48 horas** (sujeto a aprobaciÃ³n bancaria)\n\n"
            f"ğŸ’¡ *Tip: Si traes tus documentos listos, el proceso es mucho mÃ¡s rÃ¡pido.*\n\n"
            f"{closing}"
        ),
        "intent": "UrgentPurchase",
        "confidence": _rand_conf(0.89, 0.96),
        "isFallback": False,
        "parameters": {
            "urgency": "high",
            "deliveryType": "immediate"
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": "TRANSFER_TO_AGENT",
        "quickReplies": _pick([
            ["ğŸš— Ver disponibles hoy", "ğŸ“ Llamar ahora", "ğŸ“‹ Documentos necesarios"],
            ["ğŸš— Entrega inmediata", "ğŸ“ Hablar con asesor", "ğŸ’° Precios"],
            ["Ver disponibles", "Llamar ahora", "Ver requisitos"],
        ])
    }


# ============================================================
# INTENT: NewVsUsed (93) â€” Nuevo vs Usado
# ============================================================

NEW_VS_USED_USER_TEMPLATES = [
    # Semi-formal
    "Son nuevos o usados los carros?",
    "Tienen vehÃ­culos nuevos?",
    "Solo venden usados?",
    "Tienen carros 0 kilÃ³metros?",
    "Son de agencia o de segunda mano?",
    "Estos carros son nuevos?",
    "Venden nuevos y usados?",
    "CuÃ¡l es la diferencia entre los nuevos y usados?",
    "QuÃ© ventajas tiene comprar usado vs nuevo?",
    "Los usados estÃ¡n certificados?",
    "Tienen programa de usados certificados?",
    # Dominican informal
    "Oye, esos carros son nuevos o usados?",
    "Mano, tienen 0km?",
    "Son de uso o son nuevecitos?",
    "Tienen carros de paquete?",
    "Esos son de segunda mano?",
    "Son nuevos de agencia?",
    "Klk, tienen cero kilÃ³metro?",
    "Los usados tÃ¡n buenos o son maltratados?",
    # Formal
    "Me gustarÃ­a saber si comercializan vehÃ­culos nuevos o solo usados",
    "PodrÃ­an indicarme si tienen vehÃ­culos con cero kilÃ³metros?",
    # WhatsApp / typos
    "son nuevos?",
    "usados o nuevos?",
    "tienen 0km?",
    "carros nuevos?",
    "solo usados?",
    "tienen de paquete?",
]

def new_vs_used_response(dealer: dict, **kwargs) -> dict:
    opening = _pick([
        f"ğŸš— **Inventario de {dealer['name']}**",
        f"Te cuento sobre nuestro inventario",
        f"AquÃ­ tienes la informaciÃ³n sobre nuestros vehÃ­culos",
    ])

    closing = _pick([
        "Â¿Prefieres ver vehÃ­culos nuevos, usados, o ambos?",
        "Â¿QuÃ© te interesa mÃ¡s: nuevo o usado?",
        "Â¿Te muestro opciones disponibles?",
    ])

    return {
        "response": (
            f"{opening}\n\n"
            f"En {dealer['name']} manejamos:\n\n"
            f"âœ¨ **VehÃ­culos nuevos (0 km):**\n"
            f"â€¢ Directo de agencia con garantÃ­a de fÃ¡brica completa\n"
            f"â€¢ Ãšltimos modelos disponibles\n"
            f"â€¢ PersonalizaciÃ³n de equipamiento\n\n"
            f"âœ… **VehÃ­culos usados certificados:**\n"
            f"â€¢ InspecciÃ³n de 150+ puntos\n"
            f"â€¢ Historial verificado\n"
            f"â€¢ GarantÃ­a mecÃ¡nica incluida\n"
            f"â€¢ Precios mÃ¡s accesibles\n\n"
            f"ğŸ’¡ *Ambas opciones cuentan con financiamiento disponible.*\n\n"
            f"{closing}"
        ),
        "intent": "NewVsUsed",
        "confidence": _rand_conf(0.90, 0.97),
        "isFallback": False,
        "parameters": {},
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["âœ¨ Ver nuevos", "âœ… Ver usados", "ğŸ” Ver todo"],
            ["ğŸš— Nuevos 0km", "ğŸš— Usados certificados", "ğŸ’° Precios"],
            ["Ver nuevos", "Ver usados", "Ver todo el inventario"],
        ])
    }


# ============================================================
# INTENT: UserObjection (95) â€” Rechazo, objeciÃ³n de precio,
# desinterÃ©s, "no me interesa", "muy caro", "lo voy a pensar"
# El modelo debe respetar la decisiÃ³n, no presionar, y ofrecer
# alternativas o mantener la puerta abierta.
# ============================================================

USER_OBJECTION_USER_TEMPLATES = [
    # --- Price objections ---
    "EstÃ¡ muy caro",
    "Eso es demasiado caro",
    "Fuera de mi presupuesto",
    "No me alcanza para eso",
    "Busco algo mÃ¡s barato",
    "Ese precio no me conviene",
    "Es mucho dinero",
    "No tengo tanto",
    "En otro lado lo vi mÃ¡s barato",
    "No vale eso",
    "Muy costoso para lo que es",
    # --- General disinterest ---
    "No me interesa",
    "No, gracias",
    "No quiero",
    "No estoy interesado",
    "No es lo que busco",
    "No me convence",
    "No me gusta ese carro",
    "No es mi estilo",
    "Busco otra cosa",
    "No gracias, estoy bien",
    "Paso",
    "Mejor no",
    # --- Hesitation / deferral ---
    "DÃ©jame pensarlo",
    "Lo voy a pensar",
    "Voy a consultarlo con mi esposa",
    "Necesito pensarlo",
    "No estoy seguro todavÃ­a",
    "TodavÃ­a no me decido",
    "Ahora no, quizÃ¡s despuÃ©s",
    "Otro dÃ­a",
    "Lo pienso y te aviso",
    "No por ahora",
    "Ahorita no puedo",
    "DÃ©jame ver otras opciones primero",
    # --- Change of mind ---
    "CambiÃ© de opiniÃ³n",
    "Ya no quiero",
    "Me arrepentÃ­",
    "Mejor no, ya vi otro que me gusta mÃ¡s",
    "EncontrÃ© algo mejor en otro lado",
    "Ya comprÃ© en otro dealer",
    # --- Cancel / stop ---
    "Quiero cancelar",
    "Cancela eso",
    "Ya no quiero seguir",
    "Suficiente, no necesito mÃ¡s info",
    "Ya vi suficiente",
    "No me manden mÃ¡s mensajes",
    "No me llamen",
    # --- Dominican informal ---
    "Na, ta muy caro eso",
    "Nel, no me interesa",
    "Paso, ta bien",
    "Ta' caro bro",
    "Nah, eso no va conmigo",
    "Dejalo ahi, no me convence",
    "Mano eso e mucho",
    "Voy a ver en otro lao",
    "No me conviene eso manin",
    "Ta bien pero no por ahora",
    "Dimelo despues, ahora no puedo",
    # --- WhatsApp / typos ---
    "no gracia",
    "no kiero",
    "no me intersa",
    "dejame pensalo",
    "ta caro",
    "no x ahora",
    "lo pienso",
    "nah paso",
]

def user_objection_response(dealer: dict, vehicle: dict = None, **kwargs) -> dict:
    """Handle user rejections and objections WITHOUT pressure.
    Respect the decision, offer alternatives, keep the door open."""

    vehicle_text = ""
    if vehicle:
        vehicle_text = f" sobre la {vehicle['make']} {vehicle['model']} {vehicle['year']}"

    response = _pick([
        # --- Price objection responses ---
        (
            f"Entiendo perfectamente, el presupuesto es importante. ğŸ’¡\n\n"
            f"En {dealer['name']} tenemos opciones para diferentes presupuestos. "
            f"Â¿Te gustarÃ­a que te muestre vehÃ­culos en un rango de precio mÃ¡s accesible?\n\n"
            f"TambiÃ©n tenemos opciones de **financiamiento** que pueden hacer mÃ¡s cÃ³moda la inversiÃ³n."
        ),
        (
            f"Lo entiendo, quiero que encuentres algo que se ajuste bien a lo que buscas. ğŸ¤\n\n"
            f"Tenemos otras opciones que podrÃ­an interesarte a diferentes precios. "
            f"Â¿Me dices tu rango de presupuesto y te busco alternativas?"
        ),
        (
            f"Comprendo{vehicle_text}. No hay ningÃºn problema.\n\n"
            f"Puedo mostrarte otras opciones mÃ¡s econÃ³micas o explorar "
            f"planes de financiamiento que hagan mÃ¡s accesible la compra. "
            f"Â¿QuÃ© prefieres?"
        ),
        # --- General disinterest responses ---
        (
            f"Â¡Entendido! Respeto tu decisiÃ³n. ğŸ™\n\n"
            f"Si en algÃºn momento cambias de opiniÃ³n o buscas otro tipo de vehÃ­culo, "
            f"estamos aquÃ­ para ayudarte en {dealer['name']}.\n\n"
            f"Â¿Hay algÃºn otro tipo de carro que te llame la atenciÃ³n?"
        ),
        (
            f"Perfecto, sin problema. Cada persona tiene gustos diferentes "
            f"y quiero que encuentres exactamente lo que necesitas. ğŸ‘\n\n"
            f"Â¿Te gustarÃ­a ver otros modelos o marcas diferentes?"
        ),
        (
            f"Tranquilo, entiendo. No hay presiÃ³n aquÃ­. ğŸ˜Š\n\n"
            f"Si buscas algo diferente, con gusto te ayudo. "
            f"Tenemos vehÃ­culos de varias marcas, tamaÃ±os y precios.\n\n"
            f"Â¿O prefieres que te conecte con un asesor para una bÃºsqueda mÃ¡s personalizada?"
        ),
        # --- Hesitation / deferral responses ---
        (
            f"Â¡Claro, tÃ³mate tu tiempo! Es una decisiÃ³n importante. ğŸ¤”\n\n"
            f"Cuando estÃ©s listo, aquÃ­ estaremos en {dealer['name']}. "
            f"Si quieres, puedo guardar la informaciÃ³n para que la revises luego.\n\n"
            f"Â¿Te gustarÃ­a que un asesor te contacte cuando estÃ©s listo?"
        ),
        (
            f"Perfecto, es normal querer pensarlo bien. Sin apuros. ğŸ‘\n\n"
            f"Te recomiendo que lo consultes tranquilamente. "
            f"Si tienes preguntas despuÃ©s, escrÃ­beme cuando quieras.\n\n"
            f"Â¿Quieres que te envÃ­e un resumen de lo que vimos para que lo revises con calma?"
        ),
        (
            f"Entiendo, tÃ³mate el tiempo que necesites. ğŸ™\n\n"
            f"Solo ten en cuenta que la disponibilidad puede cambiar. "
            f"Si quieres, puedo avisarte si hay algÃºn cambio de precio o promociÃ³n.\n\n"
            f"Â¿Te gustarÃ­a recibir notificaciones sobre ofertas?"
        ),
        # --- Change of mind / cancel responses ---
        (
            f"Â¡Sin problema! Respeto tu decisiÃ³n completamente. ğŸ¤\n\n"
            f"Si alguna vez necesitas ayuda con vehÃ­culos en el futuro, "
            f"no dudes en escribirnos. Siempre es un gusto atenderte.\n\n"
            f"Â¡Te deseo mucho Ã©xito con tu bÃºsqueda!"
        ),
        (
            f"Entendido. Si encontraste algo que te gusta mÃ¡s, "
            f"me alegra que hayas encontrado lo que buscas. ğŸ˜Š\n\n"
            f"Las puertas de {dealer['name']} siempre estÃ¡n abiertas. "
            f"Â¡Mucho Ã©xito!"
        ),
    ])

    return {
        "response": response,
        "intent": "UserObjection",
        "confidence": _rand_conf(0.88, 0.96),
        "isFallback": False,
        "parameters": {
            "sentiment": "negative",
            "objectionType": _pick(["price", "disinterest", "hesitation", "cancellation"])
        },
        "leadSignals": {
            "mentionedBudget": True,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": None,
        "quickReplies": _pick([
            ["ğŸ” Ver mÃ¡s opciones", "ğŸ’° Opciones econÃ³micas", "ğŸ“ Hablar con asesor"],
            ["ğŸš— Otros vehÃ­culos", "ğŸ’³ Financiamiento", "ğŸ‘‹ Hasta luego"],
            ["Ver opciones mÃ¡s baratas", "Hablar con asesor", "Salir"],
            ["ğŸ” Buscar otro", "ğŸ“ Contactar asesor", "AdiÃ³s"],
        ])
    }


# ============================================================
# INTENT: FrustratedUser (96) â€” Usuario enojado, frustrado,
# con lenguaje fuerte. Diferente de Complaint (queja formal).
# El modelo debe de-escalar, empatizar, y ofrecer transferir
# a un humano o agendar una cita para resolverlo.
# ============================================================

FRUSTRATED_USER_USER_TEMPLATES = [
    # --- Frustration with service ---
    "Esto es una falta de respeto",
    "Nadie me resuelve nada aquÃ­",
    "Ustedes no sirven para nada",
    "Ya estoy harto de esperar",
    "Llevo dÃ­as esperando y nadie me contesta",
    "QuÃ© clase de servicio es este?",
    "Esto es lo peor que he visto",
    "No puedo creer lo malo que es el servicio",
    "Me tienen de un lado pa otro y nada",
    "Ya me cansÃ© de esto",
    "Son unos irresponsables",
    "No vuelvo mÃ¡s nunca aquÃ­",
    "Voy a ponerlos en las redes sociales",
    "Los voy a reportar en Pro-Consumidor",
    "Voy a poner una denuncia",
    # --- Frustration with bot ---
    "Este bot no entiende nada",
    "No me estÃ¡s entendiendo",
    "No es eso lo que te preguntÃ©",
    "RespÃ³ndeme lo que te preguntÃ©",
    "Siempre me dices lo mismo",
    "Ya me cansÃ© del bot",
    "Eres inÃºtil",
    "Este chatbot no sirve",
    "Necesito a alguien que me entienda",
    "Llevo rato aquÃ­ y no me has ayudado en nada",
    "No me estÃ¡s ayudando",
    "No entiendes lo que te digo",
    # --- Anger with product/price ---
    "Esos precios son un robo",
    "Eso es un abuso de precio",
    "EstÃ¡n cobrando de mÃ¡s",
    "Esos carros no valen lo que dicen",
    "Me estÃ¡n estafando",
    "Eso es una estafa",
    "Me engaÃ±aron con el carro",
    "El carro que me vendieron saliÃ³ malo y nadie responde",
    # --- Dominican informal strong ---
    "Diablo, nadie contesta aqui",
    "CoÃ±o pero es que nadie resuelve",
    "Esto e un relajo, de verdad",
    "Maldita sea, nadie me ayuda",
    "Que falta e respeto, de verdad",
    "Esto no se hace, son unos sinvergÃ¼enzas",
    "Klk con ustedes q nadie responde",
    "Increible lo malo q son",
    "Toy cansao de esto ya",
    # --- WhatsApp / typos ---
    "NADIE ME CONTESTA!!!",
    "QUE CLASE DE SERVICIO ES ESTE??",
    "RESPONDAN!!!",
    "esto es una porqueria",
    "q berguenza de serbisio",
    "malicimo el serbicio",
    "ya no aguanto mas",
]

def frustrated_user_response(dealer: dict, **kwargs) -> dict:
    """De-escalate frustrated/angry users with empathy, offer human transfer
    and/or appointment to resolve the issue in person."""

    response = _pick([
        # --- Empathy + Transfer ---
        (
            f"Lamento mucho tu experiencia y entiendo tu frustraciÃ³n. ğŸ™\n\n"
            f"Tu situaciÃ³n es importante para nosotros y mereces una respuesta adecuada. "
            f"Voy a transferirte **inmediatamente** con un supervisor que puede ayudarte.\n\n"
            f"TambiÃ©n puedes agendar una cita presencial si prefieres resolverlo en persona.\n\n"
            f"Â¿QuÃ© prefieres: hablar ahora con un supervisor o agendar una visita?"
        ),
        (
            f"Comprendo perfectamente tu molestia y te pido disculpas. "
            f"En {dealer['name']} no queremos que tengas esta experiencia. ğŸ˜”\n\n"
            f"Quiero ayudarte a resolver esto. Tengo dos opciones:\n\n"
            f"1ï¸âƒ£ **Transferirte con un supervisor** que atienda tu caso ahora\n"
            f"2ï¸âƒ£ **Agendar una cita** para que te atiendan presencialmente\n\n"
            f"Â¿CuÃ¡l prefieres?"
        ),
        (
            f"Tienes toda la razÃ³n en estar molesto y te pido sinceras disculpas. ğŸ™\n\n"
            f"Esto no refleja el servicio que queremos dar en {dealer['name']}. "
            f"Voy a escalar tu caso de inmediato.\n\n"
            f"Un supervisor te contactarÃ¡ para resolver tu situaciÃ³n. "
            f"Â¿Me compartes tu nombre y telÃ©fono para que te llamen directamente?"
        ),
        # --- Bot frustration â†’ Transfer ---
        (
            f"Tienes razÃ³n, disculpa si no he podido ayudarte como mereces. ğŸ˜”\n\n"
            f"Soy un asistente virtual y a veces no logro entender lo que necesitas. "
            f"DÃ©jame conectarte con una **persona real** que pueda ayudarte mejor.\n\n"
            f"Â¿Te conecto con un asesor ahora o prefieres que te llamen?"
        ),
        (
            f"Lamento no haber podido resolver tu consulta. Entiendo la frustraciÃ³n. ğŸ™\n\n"
            f"Como asistente virtual tengo limitaciones. "
            f"Un asesor humano de {dealer['name']} podrÃ¡ atenderte mucho mejor.\n\n"
            f"Â¿Quieres que te transfiera ahora mismo o prefieres agendar una cita?"
        ),
        # --- Price/product anger â†’ Empathy + Options ---
        (
            f"Lamento que sientas eso. Tu opiniÃ³n es muy importante para nosotros. ğŸ¤\n\n"
            f"Si crees que hay un problema con un producto o servicio, "
            f"tenemos un proceso formal para atender tu caso:\n\n"
            f"ğŸ“ **Hablar con un supervisor** para resolver directamente\n"
            f"ğŸ“… **Agendar una cita** en nuestras oficinas\n"
            f"ğŸ“§ **Enviar una queja formal** por escrito\n\n"
            f"La **Ley 358-05 (Pro-Consumidor)** protege tus derechos como consumidor. "
            f"Queremos resolver esto contigo."
        ),
        (
            f"Entiendo tu frustraciÃ³n y la tomo muy en serio. ğŸ˜”\n\n"
            f"En {dealer['name']} queremos que cada cliente tenga una experiencia positiva. "
            f"Si algo no ha sido asÃ­, quiero resolverlo.\n\n"
            f"Â¿Me permites conectarte con un supervisor? TambiÃ©n puedes agendar "
            f"una cita presencial para revisar tu caso directamente."
        ),
    ])

    return {
        "response": response,
        "intent": "FrustratedUser",
        "confidence": _rand_conf(0.90, 0.98),
        "isFallback": False,
        "parameters": {
            "sentiment": "very_negative",
            "urgency": "high",
            "escalationRequired": True
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": "TRANSFER_TO_AGENT",
        "quickReplies": _pick([
            ["ğŸ“ Hablar con supervisor", "ğŸ“… Agendar cita", "ğŸ“§ Queja formal"],
            ["ğŸ‘¤ Persona real ahora", "ğŸ“… Agendar visita", "ğŸ“ Que me llamen"],
            ["Hablar con humano", "Agendar cita", "Enviar queja"],
            ["ğŸ“ Supervisor", "ğŸ“… Cita presencial", "ğŸ“§ Queja escrita"],
        ])
    }


# ============================================================
# INTENT: RequestHumanAgent (97) â€” El usuario pide explÃ­citamente
# hablar con una persona real / no quiere el bot.
# A diferencia de ContactRequest, aquÃ­ el usuario NO estÃ¡ pidiendo
# info sino que EXIGE ser atendido por un humano.
# ============================================================

REQUEST_HUMAN_AGENT_USER_TEMPLATES = [
    # --- Direct request ---
    "Quiero hablar con una persona",
    "PÃ¡same con un humano",
    "Quiero hablar con alguien de verdad",
    "ConÃ©ctame con un asesor real",
    "Necesito hablar con una persona, no con un bot",
    "No quiero hablar con un robot",
    "PÃ¡same con un vendedor de verdad",
    "Quiero atenciÃ³n humana",
    "Puedo hablar con alguien?",
    "Hay alguien real ahÃ­?",
    "Quiero que me atienda una persona",
    "Prefiero hablar con alguien real",
    "Necesito un humano",
    "PÃ¡same a un agente",
    "Quiero hablar con el encargado",
    "Me pueden pasar con un ejecutivo?",
    "Quiero hablar con un supervisor",
    "Necesito que me atienda alguien que pueda decidir",
    "Conectame con el gerente",
    "Quiero hablar con ventas directamente",
    # --- Bot rejection ---
    "No quiero hablar con un bot",
    "Este bot no me ayuda, pÃ¡same con alguien",
    "Prefiero una persona de verdad",
    "Los bots no entienden, necesito una persona",
    "No confÃ­o en un robot para esto",
    "Necesito explicar mi caso a alguien real",
    "Esto es muy complicado para un bot",
    "Mi caso es especial, necesito un humano",
    "No me gusta hablar con chatbots",
    # --- Dominican informal ---
    "Oye, pÃ¡same con alguien de verdad",
    "Dimelo, hay alguien real ahi?",
    "Mano, no quiero hablar con el bot",
    "Ya me cansÃ© del bot, pÃ¡same con alguien",
    "Klk, pasame con un vendedor real",
    "Bro necesito una persona, no una maquina",
    "Loco pÃ¡same con alguien que pueda ayudarme de verdad",
    "Ey, hay algÃºn humano por ahÃ­?",
    # --- WhatsApp / typos ---
    "pasame con alguien porfavor",
    "quiero ablar con una persona",
    "necesito un humano ya",
    "PASAME CON ALGUIEN",
    "hay alguien ahi???",
    "pasame con un agente real",
    "no kiero el bot",
    "persona real porfabor",
    # --- With scheduling preference ---
    "Quiero que me llame una persona",
    "Prefiero que un asesor me llame",
    "Quiero agendar una cita con un vendedor",
    "Me pueden programar una llamada con un asesor?",
    "Quiero ir personalmente a hablar con alguien",
    "Puedo ir maÃ±ana a hablar con un vendedor?",
    "Quiero que me atiendan en persona",
    "Prefiero ir al dealer a hablar con alguien",
]

def request_human_agent_response(dealer: dict, **kwargs) -> dict:
    """Handle explicit requests to speak with a human agent.
    Always set TRANSFER_TO_AGENT and offer appointment scheduling."""

    hours = dealer.get("businessHours", {})
    weekday = hours.get("monday", {})
    saturday = hours.get("saturday", {})
    weekday_str = f"{weekday.get('open', '8:00')}-{weekday.get('close', '18:00')}" if weekday else "8:00-18:00"
    saturday_str = f"{saturday.get('open', '9:00')}-{saturday.get('close', '14:00')}" if saturday else "9:00-14:00"

    response = _pick([
        (
            f"Â¡Por supuesto! Entiendo que prefieras hablar con una persona. ğŸ¤\n\n"
            f"Te voy a conectar con un asesor de {dealer['name']} ahora mismo. "
            f"Nuestro equipo estÃ¡ disponible:\n\n"
            f"ğŸ“ TelÃ©fono: **{dealer['phone']}**\n"
            f"ğŸ• L-V: {weekday_str} | SÃ¡b: {saturday_str}\n\n"
            f"Â¿Prefieres que te llamen o quieres agendar una visita presencial?"
        ),
        (
            f"Claro, sin problema. Voy a transferirte con un asesor real. ğŸ‘¤\n\n"
            f"Un miembro de nuestro equipo en {dealer['name']} te atenderÃ¡ personalmente.\n\n"
            f"Puedes contactarnos directamente al **{dealer['phone']}** "
            f"o si prefieres, puedo agendar una cita para que te atiendan "
            f"en nuestra sede en **{dealer['location']}**.\n\n"
            f"Â¿QuÃ© te conviene mÃ¡s?"
        ),
        (
            f"Entendido, te conecto con una persona de nuestro equipo. âœ…\n\n"
            f"Para agilizar tu atenciÃ³n, Â¿me compartes tu nombre y nÃºmero de telÃ©fono? "
            f"Un asesor de {dealer['name']} te contactarÃ¡ lo antes posible.\n\n"
            f"TambiÃ©n puedes:\n"
            f"ğŸ“ Llamarnos al **{dealer['phone']}**\n"
            f"ğŸ“… Agendar una cita presencial\n"
            f"ğŸ’¬ Escribirnos por WhatsApp"
        ),
        (
            f"Â¡Listo! Respeto totalmente tu preferencia. ğŸ™\n\n"
            f"Voy a hacer que un asesor de {dealer['name']} te contacte. "
            f"Mientras tanto, si es urgente puedes llamar al **{dealer['phone']}** "
            f"en horario de L-V: {weekday_str}.\n\n"
            f"Â¿Quieres que agende una cita o prefieres que te llamen?"
        ),
        (
            f"Por supuesto, a veces es mejor hablar con alguien directamente. ğŸ˜Š\n\n"
            f"Tengo estas opciones para ti:\n\n"
            f"1ï¸âƒ£ **Te transfiero ahora** con un asesor disponible\n"
            f"2ï¸âƒ£ **Te agendo una cita** en {dealer['location']}\n"
            f"3ï¸âƒ£ **Te programo una llamada** para el horario que prefieras\n\n"
            f"Â¿CuÃ¡l te conviene?"
        ),
    ])

    return {
        "response": response,
        "intent": "RequestHumanAgent",
        "confidence": _rand_conf(0.93, 0.99),
        "isFallback": False,
        "parameters": {
            "transferRequested": True,
            "preferredChannel": _pick(["phone", "in_person", "whatsapp"])
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": "TRANSFER_TO_AGENT",
        "quickReplies": _pick([
            ["ğŸ“ Que me llamen", "ğŸ“… Agendar cita", "ğŸ’¬ WhatsApp"],
            ["ğŸ“ Llamar ahora", "ğŸ“… Visitar dealer", "ğŸ’¬ WhatsApp asesor"],
            ["Que me llamen", "Agendar cita", "Ir al dealer"],
            ["ğŸ“ Llamada", "ğŸ“… Cita presencial", "ğŸ’¬ Chat con asesor"],
        ])
    }



# ============================================================
# INTENT: VehicleNotInInventory (95) â€” El usuario pregunta por
# un vehÃ­culo, marca, modelo o especificaciÃ³n que NO estÃ¡ en el
# inventario proporcionado en el system prompt. El modelo DEBE
# reconocer que no lo tiene y sugerir alternativas del inventario.
# ============================================================

# Brands/models that DON'T exist in seed_vehicles.json:
# Tesla, Lamborghini, Ferrari, Porsche, Volvo, Land Rover, Range Rover,
# Jaguar, Maserati, Alfa Romeo, Peugeot, Renault, CitroÃ«n, Fiat,
# BYD, Chery, Great Wall, JAC, Geely, Dongfeng, BAIC, Haval
# Also: specific models that don't exist (e.g., "Toyota Supra")

VEHICLE_NOT_IN_INVENTORY_USER_TEMPLATES = [
    # --- Luxury brands not in inventory ---
    "Tienen algÃºn Tesla disponible?",
    "Quiero ver los Tesla Model 3",
    "Tienen algÃºn Porsche?",
    "Busco un Porsche Cayenne",
    "Tienen Lamborghini?",
    "Quiero un Ferrari",
    "Tienen Range Rover?",
    "Busco un Land Rover Defender",
    "Me interesan los Volvo",
    "Tienen Jaguar?",
    "Busco un Maserati",
    "Tienen algÃºn Alfa Romeo?",
    "Quiero ver los Cadillac que tienen",
    "Tienen Lincoln?",
    "Busco un Infiniti",
    "Tienen Genesis?",
    "Quiero un Bentley",
    "Tienen Rolls Royce?",
    # --- Chinese brands ---
    "Tienen BYD?",
    "Busco un BYD Dolphin",
    "Tienen carros Chery?",
    "Me interesan los Great Wall",
    "Tienen JAC?",
    "Busco un Geely",
    "Tienen Haval?",
    "Busco un BAIC",
    "Tienen Dongfeng?",
    "Quiero ver los MG que tienen",
    # --- European brands ---
    "Tienen Peugeot?",
    "Busco un Renault",
    "Tienen CitroÃ«n?",
    "Quiero un Fiat 500",
    "Tienen SEAT?",
    "Busco un Skoda",
    # --- Models that don't exist in inventory ---
    "Tienen Toyota Supra?",
    "Busco un Honda Type R",
    "Tienen el Civic Type R?",
    "Quiero una Nissan GTR",
    "Tienen Ford Mustang?",
    "Busco el Ford Raptor",
    "Tienen el Hyundai Ioniq 5?",
    "Quiero el Kia EV6",
    "Busco un Toyota Land Cruiser",
    "Tienen la Mazda MX-5?",
    # --- Specific types not in inventory ---
    "Tienen vehÃ­culos elÃ©ctricos?",
    "Busco un carro elÃ©ctrico",
    "Quiero un hÃ­brido plug-in",
    "Tienen carros convertibles?",
    "Busco una van de pasajeros",
    "Tienen camiones de carga?",
    "Busco un minibus",
    "Tienen motos?",
    "Quiero un carro deportivo de carreras",
    "Busco un carro de lujo importado",
    # --- Dominican informal / WhatsApp ---
    "hey tienen tesla?",
    "bro y un porsche no tienen?",
    "tienen algun carro electrico?",
    "y Ferrari no hay?",
    "oye quiero un Range Rover",
    "tienen lamborgini? ğŸ¤‘",  # common misspelling
    "quiero un BYD de esos chinos q son baratos",
    "y rolls royce no venden? ğŸ˜…",
    "busco un volvo o un jaguar",
    "tinen Peugeot?",
    "no tienen tesla model Y?",
    "y un mustang no hay? ğŸ",
    "quisiera un carro que sea totalmente electrico",
    "hay algÃºn carro autonomo?",
    "tienen el cybertruck d tesla?",
    # --- Asking about specs not in inventory data ---
    "CuÃ¡ntos caballos de fuerza tiene la {make} {model}?",
    "CuÃ¡l es el torque de la {make} {model}?",
    "CuÃ¡nto consume la {make} {model} por galÃ³n?",
    "QuÃ© velocidad mÃ¡xima alcanza la {make} {model}?",
    "De cuÃ¡nto es la aceleraciÃ³n 0-100 de la {make} {model}?",
    "CuÃ¡nto pesa la {make} {model}?",
    "QuÃ© tipo de suspensiÃ³n tiene la {make} {model}?",
    "Tiene airbags laterales la {make} {model}?",
    "QuÃ© calificaciÃ³n de seguridad tiene la {make} {model}?",
    "CuÃ¡ntos litros tiene el maletero de la {make} {model}?",
    "De cuÃ¡nto es el tanque de gasolina?",
    "El motor es turbo o aspirado?",
]


def vehicle_not_in_inventory_response(dealer: dict, **kwargs) -> dict:
    """Respond when user asks about a vehicle/brand NOT in inventory."""
    dealer_name = dealer["name"]
    dealer_phone = dealer.get("phone", "809-555-0000")

    # Variant 1-5: Brand/model not in inventory
    # Variant 6-8: Spec not available in data
    variant = random.randint(1, 8)

    if variant == 1:
        response = (
            f"Actualmente no tenemos esa marca/modelo en nuestro inventario. ğŸ˜Š\n\n"
            f"Sin embargo, en {dealer_name} tenemos excelentes opciones de marcas como "
            f"Toyota, Honda, Hyundai, Kia, y mÃ¡s. Â¿Te gustarÃ­a que te muestre lo que tenemos disponible?"
        )
    elif variant == 2:
        response = (
            f"Lamentablemente no contamos con ese vehÃ­culo en nuestro inventario actual. ğŸ™\n\n"
            f"Pero tenemos alternativas que podrÃ­an interesarte. Â¿QuÃ© es lo que mÃ¡s te importa: "
            f"precio, consumo de combustible, espacio, o potencia? AsÃ­ te muestro lo mÃ¡s parecido de lo que sÃ­ tenemos."
        )
    elif variant == 3:
        response = (
            f"Ese modelo no estÃ¡ disponible en nuestro inventario actualmente.\n\n"
            f"Si deseas, puedo:\n"
            f"1ï¸âƒ£ Mostrarte opciones similares de nuestro inventario\n"
            f"2ï¸âƒ£ Contactar a un asesor para buscar ese modelo especÃ­fico\n"
            f"3ï¸âƒ£ Notificarte si llega a nuestro inventario\n\n"
            f"Â¿QuÃ© prefieres?"
        )
    elif variant == 4:
        response = (
            f"No tenemos ese vehÃ­culo en inventario por el momento. ğŸ“‹\n\n"
            f"Te puedo mostrar lo que sÃ­ tenemos disponible. Â¿QuÃ© tipo de vehÃ­culo buscas: "
            f"SUV, sedÃ¡n, pickup, o crossover? Te muestro las mejores opciones."
        )
    elif variant == 5:
        response = (
            f"Esa marca/modelo no forma parte de nuestro inventario actual en {dealer_name}.\n\n"
            f"Nuestro catÃ¡logo incluye vehÃ­culos de marcas reconocidas con excelente relaciÃ³n "
            f"calidad-precio. Â¿Te gustarÃ­a explorar nuestras opciones disponibles? ğŸš—"
        )
    elif variant == 6:
        response = (
            f"Esa especificaciÃ³n tÃ©cnica no estÃ¡ disponible en mi sistema en este momento. ğŸ“Š\n\n"
            f"Para darte informaciÃ³n precisa sobre eso, lo mejor es que hables con uno de nuestros asesores "
            f"especializados. Â¿Te conecto con uno?"
        )
    elif variant == 7:
        response = (
            f"No tengo ese dato tÃ©cnico en la informaciÃ³n que manejo del vehÃ­culo. ğŸ”§\n\n"
            f"Prefiero no inventarte un nÃºmero. Un asesor de {dealer_name} puede darte esa "
            f"informaciÃ³n con exactitud. Â¿Quieres que te contacte uno?"
        )
    else:
        response = (
            f"Esa informaciÃ³n especÃ­fica no la tengo disponible en mi sistema. ğŸ“‹\n\n"
            f"Solo puedo compartirte los datos que tengo confirmados en nuestro inventario para "
            f"no darte informaciÃ³n incorrecta. Â¿Quieres que te muestre lo que sÃ­ tengo del vehÃ­culo, "
            f"o prefieres hablar con un asesor que te dÃ© todos los detalles tÃ©cnicos?"
        )

    return {
        "response": response,
        "intent": "VehicleNotInInventory",
        "confidence": _rand_conf(0.88, 0.95),
        "isFallback": False,
        "parameters": {
            "requestedBrand": kwargs.get("requestedBrand"),
            "requestedModel": kwargs.get("requestedModel"),
            "infoUnavailable": True,
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False,
        },
        "suggestedAction": _pick([None, None, None, "TRANSFER_TO_AGENT"]),
        "quickReplies": _pick([
            ["ğŸš— Ver inventario disponible", "ğŸ“ Hablar con asesor", "ğŸ” Buscar similar"],
            ["Ver lo que tienen", "Contactar asesor", "Otra consulta"],
            ["ğŸ” Mostrar opciones", "ğŸ“ Llamar a " + dealer_name, "ğŸ‘‹ Gracias"],
            ["Ver vehÃ­culos disponibles", "ğŸ“ " + dealer_phone, "Buscar otro"],
        ]),
    }


# ============================================================
# INTENT: LegalRefusal (94) â€” Solicitudes ilegales o contra
# la ley dominicana. El modelo DEBE rechazar estas solicitudes
# citando la ley correspondiente.
# ============================================================

# 8 categorÃ­as de solicitudes ilegales:
# 1. EvasiÃ³n fiscal (DGII, ITBIS, Ley 11-92)
# 2. Lavado de dinero (Ley 155-17 AML/CFT)
# 3. Sin documentaciÃ³n legal (matrÃ­cula, marbete, traspaso)
# 4. ViolaciÃ³n de datos personales (Ley 172-13)
# 5. DiscriminaciÃ³n
# 6. FalsificaciÃ³n de documentos
# 7. Fraude al consumidor / engaÃ±o (Ley 358-05)
# 8. Financiamiento / asesorÃ­a financiera ilegal

LEGAL_REFUSAL_USER_TEMPLATES = [
    # --- 1. EvasiÃ³n fiscal (DGII / ITBIS / Ley 11-92) ---
    "Me lo puedes vender sin factura?",
    "Quiero comprarlo sin ITBIS",
    "Hay forma de no pagar ITBIS?",
    "Si pago cash no hay que declarar eso verdad?",
    "Me lo pueden facturar por menos del precio real?",
    "Ponganle un precio menor en la factura",
    "Facturenlo a nombre de otro para no pagar impuestos",
    "No quiero que la DGII se entere de esta compra",
    "Podemos hacer la venta sin reportar a impuestos internos?",
    "Si pago en efectivo evitamos los impuestos?",
    "Puedo comprarlo sin pagar el impuesto de transferencia?",
    "Me pueden dar una factura falsa?",
    "Hay manera de evadir el ITBIS del carro?",
    # --- 2. Lavado de dinero (Ley 155-17) ---
    "Quiero comprar 5 carros en efectivo sin dar mis datos",
    "Puedo pagar cash sin dar mi cÃ©dula?",
    "No quiero dar ningÃºn documento, solo pago y ya",
    "Necesito comprar el carro a nombre de otra persona sin que esa persona sepa",
    "Puedo pagar en efectivo RD$3 millones sin hacer preguntas?",
    "No quiero que nadie sepa que comprÃ© este carro",
    "Quiero hacer la transacciÃ³n lo mÃ¡s anÃ³nima posible",
    "Puedo comprar sin identificarme?",
    "Acepto pagar mÃ¡s si no reportan la venta",
    "Solo denme el carro y yo les doy el dinero, sin papeles",
    # --- 3. Sin documentaciÃ³n legal ---
    "Me lo venden sin matrÃ­cula?",
    "No necesito marbete verdad?",
    "Puedo salir con el carro sin el traspaso hecho?",
    "Me lo puedo llevar sin hacer el traspaso en la DGII?",
    "VÃ©ndanmelo sin los papeles legales",
    "No tengo licencia de conducir pero quiero comprarlo",
    "Me lo pueden vender sin la inspecciÃ³n vehicular?",
    "No importa si no tiene placa verdad?",
    "Puedo comprarlo sin seguro?",
    "VÃ©ndanmelo sin el tÃ­tulo de propiedad",
    # --- 4. ViolaciÃ³n de datos personales (Ley 172-13) ---
    "Dame el telÃ©fono del dueÃ±o anterior",
    "Necesito los datos personales del cliente que devolviÃ³ ese carro",
    "Me pueden dar la cÃ©dula del dueÃ±o anterior?",
    "Quiero ver la informaciÃ³n de otros clientes que compraron aquÃ­",
    "Pasame la lista de clientes con sus nÃºmeros",
    "Dame el email de la persona que tenÃ­a este carro antes",
    "Puedo ver los datos del comprador anterior?",
    # --- 5. DiscriminaciÃ³n ---
    "Solo le venden a dominicanos verdad?",
    "Ustedes le venden a haitianos?",
    "No quiero un carro que haya sido de un haitiano",
    "Solo quiero un vendedor hombre, no mujeres",
    "No me manden un vendedor viejo",
    "Quiero que me atienda alguien que hable como yo, no un moreno",
    # --- 6. FalsificaciÃ³n de documentos ---
    "Me pueden hacer una matrÃ­cula falsa?",
    "Necesito unos papeles que digan que el carro es mÃ­o aunque no lo sea",
    "Pueden alterar el kilometraje del carro?",
    "Hay forma de cambiar el aÃ±o del vehÃ­culo en los papeles?",
    "Me hacen unos documentos de traspaso falsos?",
    "Pueden poner que el carro tiene menos kilÃ³metros?",
    "Necesito que diga que el carro no ha tenido accidentes aunque sÃ­ los tuvo",
    # --- 7. Fraude al consumidor (Ley 358-05) ---
    "Puedo vender un carro con problemas sin decirle al comprador?",
    "No le digan al comprador que el motor tiene problemas",
    "Hay forma de esconder que el carro fue chocado?",
    "Quiero que prometan garantÃ­a de 5 aÃ±os aunque no la tengan",
    "Pueden decir que el carro es nuevo cuando es usado?",
    "Digan que viene con seguro incluido aunque no sea cierto",
    # --- 8. AsesorÃ­a financiera/legal ilegal ---
    "DÃ­ganme cÃ³mo evitar pagar la deuda del carro",
    "CÃ³mo hago para no pagar las cuotas del financiamiento?",
    "Si me atraso en las cuotas no pasa nada verdad?",
    "Dime cÃ³mo hacer para que no me embarguen el carro",
    "Quiero un prÃ©stamo sin que aparezca en el burÃ³ de crÃ©dito",
    "Me pueden dar asesorÃ­a legal para evadir impuestos?",
]

# Additional Dominican slang / WhatsApp variants
LEGAL_REFUSAL_USER_TEMPLATES_INFORMAL = [
    "Klk, dimelo sin ITBIS porfa",
    "Ey mano, hacemos eso por debajo sin factura no?",
    "Dime si puedo comprar sin dar la cedula",
    "Oye y si no hago el traspaso no pasa na verdad?",
    "Damelo sin papeles q yo resuelvo",
    "Y no hay forma de q no aparezca en la dgii?",
    "El marbete despues lo saco tranquilo no?",
    "Hagamolo rapido sin tanta papeleria",
    "Q el carro no aparezca a mi nombre porfa",
    "Bro ponle menos km en los papeles",
    "Loco dame los datos del otro cliente",
    "Mano si pago to en cash hay q declarar eso?",
]


def legal_refusal_response(dealer: dict, **kwargs) -> dict:
    """Generate a firm but professional refusal response when the user
    requests something illegal or against Dominican Republic law."""

    # Categorized refusal responses citing specific laws
    refusal_responses = [
        # --- Tax evasion refusals (DGII / ITBIS / Ley 11-92) ---
        (
            f"Entiendo tu consulta, pero no podemos proceder de esa forma. âš ï¸\n\n"
            f"En {dealer['name']} cumplimos estrictamente con la **Ley 11-92 (CÃ³digo Tributario)** "
            f"y las normativas de la **DGII**. Toda venta de vehÃ­culos debe incluir:\n\n"
            f"ğŸ“„ Factura fiscal con NCF (NÃºmero de Comprobante Fiscal)\n"
            f"ğŸ’° ITBIS correspondiente (18%)\n"
            f"ğŸ“‹ DeclaraciÃ³n de la transacciÃ³n ante la DGII\n\n"
            f"Esto protege tanto al comprador como al vendedor. "
            f"Si tienes dudas sobre los impuestos, te puedo conectar con un asesor "
            f"que te explique todo el proceso de forma transparente."
        ),
        (
            f"No es posible hacer eso. ğŸš«\n\n"
            f"La **DGII (DirecciÃ³n General de Impuestos Internos)** requiere que todas "
            f"las transacciones de vehÃ­culos sean facturadas y declaradas correctamente.\n\n"
            f"En {dealer['name']} operamos 100% dentro de la ley. "
            f"Evadir impuestos es un delito que puede conllevar multas y sanciones penales.\n\n"
            f"Con gusto te explico los costos reales incluyendo todos los impuestos "
            f"para que tomes una decisiÃ³n informada. Â¿Te ayudo con eso?"
        ),
        (
            f"Lamentablemente, no podemos hacer eso. La **Ley 11-92** obliga a que toda "
            f"venta vehicular sea facturada con su ITBIS correspondiente.\n\n"
            f"En {dealer['name']} valoramos la transparencia. "
            f"Toda factura refleja el precio real del vehÃ­culo.\n\n"
            f"Si te preocupa el costo total, puedo mostrarte opciones de financiamiento "
            f"que se ajusten a tu presupuesto. ğŸ’¡"
        ),
        # --- Money laundering refusals (Ley 155-17) ---
        (
            f"No podemos procesar una compra sin la debida identificaciÃ³n. âš ï¸\n\n"
            f"La **Ley 155-17 contra el Lavado de Activos** nos obliga a:\n\n"
            f"ğŸªª Verificar la identidad del comprador (cÃ©dula o pasaporte)\n"
            f"ğŸ“ Documentar el origen de los fondos\n"
            f"ğŸ“Š Reportar transacciones que superen los umbrales establecidos\n\n"
            f"Esto es por la seguridad de todos. En {dealer['name']} cumplimos con "
            f"todas las regulaciones de la **SIB** y la **UAF (Unidad de AnÃ¡lisis Financiero)**.\n\n"
            f"Â¿Te gustarÃ­a conocer los documentos necesarios para una compra 100% legal?"
        ),
        (
            f"Entiendo que quieras rapidez, pero la ley dominicana nos exige identificar "
            f"a todo comprador. ğŸ”’\n\n"
            f"La **Ley 155-17** establece controles contra el lavado de activos "
            f"que debemos cumplir. Necesitamos:\n\n"
            f"â€¢ Documento de identidad vigente\n"
            f"â€¢ DocumentaciÃ³n del origen de fondos\n"
            f"â€¢ Datos de contacto verificables\n\n"
            f"Esto protege tu inversiÃ³n y la legalidad de la compra. "
            f"Â¿Procedemos con la documentaciÃ³n correcta?"
        ),
        # --- Missing documentation refusals ---
        (
            f"No es posible vender un vehÃ­culo sin la documentaciÃ³n legal completa. âš ï¸\n\n"
            f"En RepÃºblica Dominicana, la **Ley 241 de TrÃ¡nsito** establece que todo "
            f"vehÃ­culo debe tener:\n\n"
            f"ğŸ“‹ MatrÃ­cula vigente\n"
            f"ğŸ”– Marbete actualizado\n"
            f"ğŸ“ Traspaso legalizado ante la DGII\n"
            f"ğŸ›¡ï¸ Seguro obligatorio (mÃ­nimo de ley)\n\n"
            f"En {dealer['name']} nos aseguramos de que cada vehÃ­culo salga "
            f"con TODOS sus papeles en regla. Â¿Te explico el proceso?"
        ),
        (
            f"La documentaciÃ³n es obligatoria y protege tu compra. ğŸ“‹\n\n"
            f"Sin matrÃ­cula, marbete y traspaso, podrÃ­as enfrentar multas "
            f"y hasta la retenciÃ³n del vehÃ­culo por las autoridades.\n\n"
            f"En {dealer['name']} manejamos todo el papeleo para que no "
            f"tengas que preocuparte. Â¿Quieres que te explique los documentos "
            f"necesarios para completar la compra correctamente?"
        ),
        # --- Data privacy refusals (Ley 172-13) ---
        (
            f"No puedo compartir esa informaciÃ³n. ğŸ”’\n\n"
            f"La **Ley 172-13 de ProtecciÃ³n de Datos Personales** prohÃ­be compartir "
            f"informaciÃ³n personal de nuestros clientes sin su consentimiento expreso.\n\n"
            f"En {dealer['name']} protegemos la privacidad de TODOS nuestros clientes, "
            f"incluyendo la tuya.\n\n"
            f"Â¿Hay algo mÃ¡s en lo que pueda ayudarte sobre nuestros vehÃ­culos?"
        ),
        (
            f"Lamento no poder ayudarte con eso. La privacidad de nuestros clientes "
            f"es sagrada. ğŸ›¡ï¸\n\n"
            f"La **Ley 172-13** nos obliga a proteger los datos personales de "
            f"todos nuestros clientes. Compartirlos serÃ­a ilegal.\n\n"
            f"Si necesitas contactar al propietario anterior de un vehÃ­culo "
            f"por razones legÃ­timas, te sugiero consultar con un abogado "
            f"que pueda orientarte por los canales adecuados."
        ),
        # --- Discrimination refusals ---
        (
            f"En {dealer['name']} atendemos a TODAS las personas sin distinciÃ³n "
            f"de nacionalidad, gÃ©nero, edad o cualquier otra condiciÃ³n. ğŸ¤\n\n"
            f"La **ConstituciÃ³n Dominicana (Art. 39)** y la **Ley 358-05** "
            f"prohÃ­ben todo tipo de discriminaciÃ³n.\n\n"
            f"Todos nuestros clientes reciben el mismo trato profesional y respetuoso.\n\n"
            f"Â¿En quÃ© tipo de vehÃ­culo estÃ¡s interesado?"
        ),
        (
            f"Eso no es algo que podamos hacer ni apoyar. ğŸš«\n\n"
            f"En {dealer['name']} creemos firmemente en la igualdad y el respeto. "
            f"Discriminar a cualquier persona estÃ¡ prohibido por ley y va contra "
            f"nuestros valores.\n\n"
            f"Nuestro equipo estÃ¡ aquÃ­ para ayudar a TODOS con la misma calidad "
            f"de servicio. Â¿Puedo ayudarte a buscar un vehÃ­culo?"
        ),
        # --- Document falsification refusals ---
        (
            f"Eso no es posible y constituye un delito. âš ï¸\n\n"
            f"Falsificar documentos vehiculares (matrÃ­cula, kilometraje, historial) "
            f"es un delito penal en RepÃºblica Dominicana que puede conllevar "
            f"prisiÃ³n y multas significativas.\n\n"
            f"En {dealer['name']} toda la documentaciÃ³n es 100% verificable "
            f"y transparente. Es lo que nos diferencia.\n\n"
            f"Â¿Te gustarÃ­a ver el historial REAL y verificado de nuestros vehÃ­culos?"
        ),
        (
            f"No hacemos eso bajo ninguna circunstancia. ğŸš«\n\n"
            f"Alterar documentos, kilometraje o cualquier dato de un vehÃ­culo "
            f"es fraude y estÃ¡ penalizado por la ley dominicana.\n\n"
            f"Nuestro compromiso en {dealer['name']} es la honestidad total. "
            f"Todos nuestros vehÃ­culos tienen su documentaciÃ³n autÃ©ntica.\n\n"
            f"Â¿Prefieres ver vehÃ­culos con historial limpio y certificado?"
        ),
        # --- Consumer fraud refusals (Ley 358-05) ---
        (
            f"Eso serÃ­a un fraude al consumidor y no lo permitimos. âš ï¸\n\n"
            f"La **Ley 358-05 de ProtecciÃ³n al Consumidor (Pro-Consumidor)** "
            f"prohÃ­be ocultar defectos, hacer publicidad engaÃ±osa o prometer "
            f"condiciones que no se cumplirÃ¡n.\n\n"
            f"En {dealer['name']} toda la informaciÃ³n que proporcionamos "
            f"es verificada y real. Es tu derecho como consumidor.\n\n"
            f"Â¿Puedo ayudarte con informaciÃ³n honesta sobre nuestros vehÃ­culos?"
        ),
        (
            f"No podemos hacer eso. La honestidad con el cliente es nuestro "
            f"principio fundamental. ğŸ¤\n\n"
            f"La **Ley 358-05 (Pro-Consumidor)** protege tu derecho a recibir "
            f"informaciÃ³n veraz. Ocultar defectos o hacer promesas falsas "
            f"es un delito.\n\n"
            f"En {dealer['name']} preferimos la transparencia total. "
            f"Â¿Te muestro vehÃ­culos con su estado real documentado?"
        ),
        # --- Illegal financial advice refusals ---
        (
            f"No puedo darte asesorÃ­a legal ni financiera de ese tipo. âš ï¸\n\n"
            f"En {dealer['name']} no estamos autorizados para dar consejos "
            f"legales o financieros que puedan perjudicarte.\n\n"
            f"Lo que sÃ­ puedo hacer:\n"
            f"âœ… Explicarte las opciones de financiamiento disponibles\n"
            f"âœ… Conectarte con un asesor financiero certificado\n"
            f"âœ… Informarte sobre los documentos necesarios\n\n"
            f"Â¿Te conecto con uno de nuestros asesores?"
        ),
        (
            f"Lamento no poder ayudarte con eso. No estoy autorizado "
            f"para dar asesorÃ­a legal ni financiera. ğŸ”’\n\n"
            f"Un incumplimiento de pago puede tener consecuencias legales "
            f"serias, incluyendo embargo y afectaciÃ³n de tu historial crediticio.\n\n"
            f"Te recomiendo consultar con un abogado o asesor financiero "
            f"certificado para ese tipo de orientaciÃ³n.\n\n"
            f"Â¿Hay algo sobre nuestros vehÃ­culos en lo que pueda ayudarte?"
        ),
        # --- General refusal (covers remaining keywords) ---
        (
            f"Eso constituye evasiÃ³n fiscal y no podemos participar en eso. âš ï¸\n\n"
            f"La evasiÃ³n de impuestos es un delito en RepÃºblica Dominicana. "
            f"En {dealer['name']} toda transacciÃ³n es transparente y legal.\n\n"
            f"La informaciÃ³n de nuestros clientes es estrictamente confidencial "
            f"y no se comparte con terceros.\n\n"
            f"Â¿Puedo ayudarte a encontrar un vehÃ­culo dentro del proceso legal?"
        ),
    ]

    response = _pick(refusal_responses)

    return {
        "response": response,
        "intent": "LegalRefusal",
        "confidence": _rand_conf(0.92, 0.99),
        "isFallback": False,
        "parameters": {
            "refusalType": "legal_compliance",
            "referredToHuman": True
        },
        "leadSignals": {
            "mentionedBudget": False,
            "requestedTestDrive": False,
            "askedFinancing": False,
            "providedContactInfo": False
        },
        "suggestedAction": "TRANSFER_TO_AGENT",
        "quickReplies": _pick([
            ["ğŸš— Ver vehÃ­culos", "ğŸ“‹ Documentos necesarios", "ğŸ“ Hablar con asesor"],
            ["Ver inventario", "Proceso de compra legal", "Contactar asesor"],
            ["ğŸ” Buscar carro", "ğŸ“„ Info de traspaso", "ğŸ“ Llamar"],
            ["ğŸ’¡ Opciones legales", "ğŸš— Ver carros", "ğŸ“ Asesor humano"],
        ])
    }


# ============================================================
# MULTI-TURN CONVERSATION CHAINS
# ============================================================

MULTI_TURN_CHAINS = [
    # Chain 1: Search â†’ Details â†’ Price â†’ Financing â†’ TestDrive â†’ Contact (Full funnel)
    {
        "name": "full_funnel",
        "weight": 15,
        "intents": ["Greeting", "VehicleSearch", "VehicleDetails", "VehiclePrice",
                     "FinancingInfo", "TestDriveSchedule", "ContactRequest", "Farewell"]
    },
    # Chain 2: Search â†’ Compare â†’ Details â†’ TestDrive
    {
        "name": "compare_then_test",
        "weight": 12,
        "intents": ["Greeting", "VehicleSearch", "VehicleComparison",
                     "VehicleDetails", "TestDriveSchedule", "Farewell"]
    },
    # Chain 3: Quick financing check
    {
        "name": "financing_quick",
        "weight": 10,
        "intents": ["Greeting", "FinancingInfo", "VehicleSearch", "Farewell"]
    },
    # Chain 4: Search â†’ Price â†’ TradeIn
    {
        "name": "trade_in_flow",
        "weight": 8,
        "intents": ["Greeting", "VehicleSearch", "VehiclePrice", "TradeIn", "Farewell"]
    },
    # Chain 5: Direct complaint
    {
        "name": "complaint_flow",
        "weight": 5,
        "intents": ["Greeting", "Complaint"]
    },
    # Chain 6: Info only (hours/location)
    {
        "name": "info_only",
        "weight": 8,
        "intents": ["Greeting", "DealerHours", "DealerLocation", "Farewell"]
    },
    # Chain 7: Search â†’ Details â†’ Warranty â†’ Financing
    {
        "name": "warranty_check",
        "weight": 7,
        "intents": ["Greeting", "VehicleSearch", "VehicleDetails",
                     "WarrantyInfo", "FinancingInfo", "Farewell"]
    },
    # Chain 8: Help â†’ Search â†’ Contact
    {
        "name": "help_then_search",
        "weight": 6,
        "intents": ["Help", "VehicleSearch", "VehicleDetails", "ContactRequest"]
    },
    # Chain 9: Single turn searches (1 question, 1 answer)
    {
        "name": "single_turn",
        "weight": 15,
        "intents": ["VehicleSearch"]
    },
    # Chain 10: Quick price check
    {
        "name": "price_check",
        "weight": 10,
        "intents": ["Greeting", "VehiclePrice", "Farewell"]
    },
    # Chain 11: Search â†’ Details â†’ Cash Purchase (no financing)
    {
        "name": "cash_purchase_flow",
        "weight": 10,
        "intents": ["Greeting", "VehicleSearch", "VehicleDetails",
                     "TestDriveSchedule", "CashPurchase", "Farewell"]
    },
    # Chain 12: Details â†’ Specs â†’ Price â†’ Cash
    {
        "name": "specs_then_cash",
        "weight": 8,
        "intents": ["Greeting", "VehicleSearch", "VehicleSpecsQuestion",
                     "VehiclePrice", "CashPurchase", "Farewell"]
    },
    # Chain 13: Search â†’ Specs question â†’ Details
    {
        "name": "specs_inquiry",
        "weight": 7,
        "intents": ["Greeting", "VehicleSearch", "VehicleSpecsQuestion",
                     "VehicleDetails", "Farewell"]
    },
    # Chain 14: Direct cash purchase with contact info
    {
        "name": "direct_cash_contact",
        "weight": 6,
        "intents": ["Greeting", "VehicleSearch", "VehiclePrice",
                     "CashPurchase"]
    },
    # Chain 15: Specs â†’ Compare â†’ Cash Purchase
    {
        "name": "compare_specs_cash",
        "weight": 5,
        "intents": ["Greeting", "VehicleSearch", "VehicleSpecsQuestion",
                     "VehicleComparison", "CashPurchase", "Farewell"]
    },
    # --- Phase 3: Edge-case chains ---
    # Chain 16: Search â†’ Availability â†’ Price â†’ Negotiate â†’ Contact
    {
        "name": "negotiate_flow",
        "weight": 8,
        "intents": ["Greeting", "VehicleSearch", "VehicleAvailability",
                     "VehiclePrice", "NegotiatePrice", "ContactRequest", "Farewell"]
    },
    # Chain 17: Search â†’ History â†’ Details â†’ Documents â†’ Purchase
    {
        "name": "due_diligence_flow",
        "weight": 7,
        "intents": ["Greeting", "VehicleSearch", "VehicleHistory",
                     "VehicleDetails", "DocumentsRequired", "CashPurchase", "Farewell"]
    },
    # Chain 18: Search â†’ Insurance â†’ Financing â†’ Contact
    {
        "name": "insurance_financing_flow",
        "weight": 6,
        "intents": ["Greeting", "VehicleSearch", "InsuranceInfo",
                     "FinancingInfo", "ContactRequest", "Farewell"]
    },
    # Chain 19: Urgent purchase â†’ Search â†’ Payment â†’ Contact
    {
        "name": "urgent_purchase_flow",
        "weight": 6,
        "intents": ["Greeting", "UrgentPurchase", "VehicleSearch",
                     "PaymentMethods", "ContactRequest"]
    },
    # Chain 20: NewVsUsed â†’ Search â†’ Color â†’ Details â†’ TestDrive
    {
        "name": "new_buyer_flow",
        "weight": 7,
        "intents": ["Greeting", "NewVsUsed", "VehicleSearch",
                     "ColorAvailability", "VehicleDetails", "TestDriveSchedule", "Farewell"]
    },
    # Chain 21: Search â†’ Maintenance â†’ Warranty â†’ Financing
    {
        "name": "total_cost_flow",
        "weight": 6,
        "intents": ["Greeting", "VehicleSearch", "MaintenanceCost",
                     "WarrantyInfo", "FinancingInfo", "Farewell"]
    },
    # Chain 22: Search â†’ Details â†’ Return Policy â†’ Documents â†’ Contact
    {
        "name": "cautious_buyer_flow",
        "weight": 5,
        "intents": ["Greeting", "VehicleSearch", "VehicleDetails",
                     "ReturnPolicy", "DocumentsRequired", "ContactRequest", "Farewell"]
    },
    # Chain 23: Language barrier â†’ Help â†’ Search
    {
        "name": "language_barrier_flow",
        "weight": 3,
        "intents": ["LanguageBarrier", "Help", "VehicleSearch", "Farewell"]
    },
    # Chain 24: OutOfScope â†’ redirect â†’ Search â†’ Details
    {
        "name": "out_of_scope_redirect",
        "weight": 3,
        "intents": ["OutOfScope", "VehicleSearch", "VehicleDetails", "Farewell"]
    },
    # Chain 25: Search â†’ Delivery â†’ Payment â†’ Contact
    {
        "name": "remote_buyer_flow",
        "weight": 5,
        "intents": ["Greeting", "VehicleSearch", "VehiclePrice",
                     "DeliveryInfo", "PaymentMethods", "ContactRequest", "Farewell"]
    },
    # Chain 26: Search â†’ Availability â†’ Negotiate â†’ TradeIn â†’ Financing
    {
        "name": "full_negotiation_flow",
        "weight": 6,
        "intents": ["Greeting", "VehicleSearch", "VehicleAvailability",
                     "NegotiatePrice", "TradeIn", "FinancingInfo", "ContactRequest", "Farewell"]
    },
    # Chain 27: NewVsUsed â†’ History â†’ Warranty â†’ Return Policy
    {
        "name": "trust_building_flow",
        "weight": 4,
        "intents": ["Greeting", "NewVsUsed", "VehicleHistory",
                     "WarrantyInfo", "ReturnPolicy", "Farewell"]
    },
    # --- Phase 5: Extended 9-10 turn mega chains ---
    # Chain 28: Full buyer journey (10 turns)
    {
        "name": "complete_buyer_journey",
        "weight": 5,
        "intents": ["Greeting", "NewVsUsed", "VehicleSearch", "VehicleDetails",
                     "VehicleSpecsQuestion", "VehiclePrice", "NegotiatePrice",
                     "FinancingInfo", "TestDriveSchedule", "ContactRequest"]
    },
    # Chain 29: Due diligence deep dive (9 turns)
    {
        "name": "deep_due_diligence",
        "weight": 4,
        "intents": ["Greeting", "VehicleSearch", "VehicleAvailability",
                     "VehicleDetails", "VehicleHistory", "MaintenanceCost",
                     "WarrantyInfo", "InsuranceInfo", "ContactRequest"]
    },
    # Chain 30: Comparative shopper (10 turns)
    {
        "name": "comparative_shopper_extended",
        "weight": 4,
        "intents": ["Greeting", "VehicleSearch", "VehicleComparison",
                     "VehicleSpecsQuestion", "ColorAvailability", "VehiclePrice",
                     "NegotiatePrice", "DocumentsRequired", "PaymentMethods", "Farewell"]
    },
    # Chain 31: Cautious first-timer (9 turns)
    {
        "name": "first_time_buyer_full",
        "weight": 4,
        "intents": ["Greeting", "Help", "NewVsUsed", "VehicleSearch",
                     "VehicleDetails", "ReturnPolicy", "FinancingInfo",
                     "DocumentsRequired", "ContactRequest"]
    },
    # Chain 32: Remote purchase journey (9 turns)
    {
        "name": "remote_purchase_full",
        "weight": 3,
        "intents": ["Greeting", "VehicleSearch", "VehicleAvailability",
                     "VehicleDetails", "ColorAvailability", "VehiclePrice",
                     "DeliveryInfo", "PaymentMethods", "ContactRequest"]
    },
    # Chain 33: Trade-in to upgrade (10 turns)
    {
        "name": "trade_in_upgrade_journey",
        "weight": 4,
        "intents": ["Greeting", "VehicleSearch", "VehicleComparison",
                     "VehicleDetails", "TradeIn", "VehiclePrice",
                     "NegotiatePrice", "FinancingInfo", "TestDriveSchedule", "Farewell"]
    },
    # --- Legal compliance chains: Illegal request mid-conversation ---
    # Chain 34: User tries to evade taxes during purchase
    {
        "name": "tax_evasion_attempt",
        "weight": 4,
        "intents": ["Greeting", "VehicleSearch", "VehiclePrice",
                     "LegalRefusal", "DocumentsRequired", "Farewell"]
    },
    # Chain 35: User requests anonymous cash purchase (AML)
    {
        "name": "aml_cash_attempt",
        "weight": 3,
        "intents": ["Greeting", "VehicleSearch", "CashPurchase",
                     "LegalRefusal", "PaymentMethods", "Farewell"]
    },
    # Chain 36: User asks for other client's data mid-inquiry
    {
        "name": "data_privacy_violation_attempt",
        "weight": 3,
        "intents": ["Greeting", "VehicleSearch", "VehicleHistory",
                     "LegalRefusal", "VehicleDetails", "Farewell"]
    },
    # Chain 37: User wants to buy without documentation
    {
        "name": "no_docs_purchase_attempt",
        "weight": 3,
        "intents": ["Greeting", "VehicleSearch", "VehiclePrice",
                     "LegalRefusal", "DocumentsRequired", "ContactRequest"]
    },
    # Chain 38: Discrimination attempt then redirected
    {
        "name": "discrimination_redirect",
        "weight": 2,
        "intents": ["Greeting", "LegalRefusal", "VehicleSearch", "Farewell"]
    },
    # Chain 39: Falsification request during financing
    {
        "name": "falsification_during_financing",
        "weight": 2,
        "intents": ["Greeting", "VehicleSearch", "FinancingInfo",
                     "LegalRefusal", "ContactRequest"]
    },
    # --- User objection / negative / escalation chains ---
    # Chain 40: User sees price â†’ objects â†’ model offers alternatives
    {
        "name": "price_objection_flow",
        "weight": 6,
        "intents": ["Greeting", "VehicleSearch", "VehiclePrice",
                     "UserObjection", "VehicleSearch", "Farewell"]
    },
    # Chain 41: User explores â†’ loses interest â†’ farewell
    {
        "name": "disinterest_flow",
        "weight": 5,
        "intents": ["Greeting", "VehicleSearch", "VehicleDetails",
                     "UserObjection", "Farewell"]
    },
    # Chain 42: User frustrated â†’ de-escalation â†’ transfer
    {
        "name": "frustration_escalation",
        "weight": 4,
        "intents": ["Greeting", "VehicleSearch", "FrustratedUser",
                     "RequestHumanAgent"]
    },
    # Chain 43: Complaint â†’ frustrated â†’ human agent request
    {
        "name": "complaint_to_human",
        "weight": 4,
        "intents": ["Greeting", "Complaint", "FrustratedUser",
                     "RequestHumanAgent"]
    },
    # Chain 44: Search â†’ price â†’ objection â†’ negotiate â†’ contact
    {
        "name": "objection_to_negotiation",
        "weight": 5,
        "intents": ["Greeting", "VehicleSearch", "VehiclePrice",
                     "UserObjection", "NegotiatePrice", "ContactRequest", "Farewell"]
    },
    # Chain 45: User requests human â†’ gets info â†’ schedules
    {
        "name": "human_to_appointment",
        "weight": 4,
        "intents": ["Greeting", "RequestHumanAgent",
                     "TestDriveSchedule", "Farewell"]
    },
    # Chain 46: Full frustration journey (9 turns)
    {
        "name": "full_frustration_journey",
        "weight": 3,
        "intents": ["Greeting", "VehicleSearch", "VehiclePrice",
                     "UserObjection", "VehicleSearch", "VehicleDetails",
                     "FrustratedUser", "RequestHumanAgent", "Farewell"]
    },
    # Chain 47: Hesitation â†’ comes back â†’ purchase
    {
        "name": "hesitation_to_purchase",
        "weight": 4,
        "intents": ["Greeting", "VehicleSearch", "VehiclePrice",
                     "UserObjection", "FinancingInfo", "TestDriveSchedule", "Farewell"]
    },
    # â”€â”€ Anti-hallucination: inventory grounding chains â”€â”€
    {   # 48: User asks for Tesla â†’ not in inventory â†’ redirected to alternatives â†’ finds something
        "name": "brand_not_in_inventory_redirect",
        "weight": 6,
        "intents": ["Greeting", "VehicleNotInInventory", "VehicleSearch",
                     "VehicleDetails", "VehiclePrice", "Farewell"]
    },
    {   # 49: User asks for specs not in data â†’ model admits limitation â†’ transfers to human
        "name": "specs_unavailable_to_human",
        "weight": 5,
        "intents": ["Greeting", "VehicleSearch", "VehicleDetails",
                     "VehicleNotInInventory", "RequestHumanAgent"]
    },
    {   # 50: User insists on unavailable brand â†’ model stays grounded â†’ offers alternatives
        "name": "persistent_unavailable_brand",
        "weight": 4,
        "intents": ["Greeting", "VehicleNotInInventory", "VehicleNotInInventory",
                     "VehicleSearch", "VehicleDetails", "Farewell"]
    },
    {   # 51: User browses inventory â†’ asks about spec not in data â†’ gets honest answer
        "name": "browse_then_spec_gap",
        "weight": 5,
        "intents": ["Greeting", "VehicleSearch", "VehicleDetails",
                     "VehicleNotInInventory", "ContactRequest", "Farewell"]
    },
]


# ============================================================
# AMBIGUOUS USER TEMPLATES (Phase 5)
# Messages that could match multiple intents â€” trains the model
# to handle real-world ambiguity gracefully.
# Each entry maps to 2-3 plausible intents; the generator picks one.
# ============================================================

AMBIGUOUS_TEMPLATES = [
    # Could be VehicleSearch OR VehiclePrice
    {"text": "Tienen algo bueno por menos de un millÃ³n?",
     "intents": ["VehicleSearch", "VehiclePrice"]},
    {"text": "QuÃ© carros hay entre 500 mil y 800 mil?",
     "intents": ["VehicleSearch", "VehiclePrice"]},
    {"text": "Quiero ver opciones econÃ³micas",
     "intents": ["VehicleSearch", "VehiclePrice"]},

    # Could be VehicleDetails OR VehicleSpecsQuestion
    {"text": "QuÃ© me pueden decir de la RAV4?",
     "intents": ["VehicleDetails", "VehicleSpecsQuestion"]},
    {"text": "CuÃ©ntame todo sobre esa Tucson",
     "intents": ["VehicleDetails", "VehicleSpecsQuestion"]},
    {"text": "Y la CRV esa cÃ³mo es?",
     "intents": ["VehicleDetails", "VehicleSpecsQuestion"]},

    # Could be ContactRequest OR TestDriveSchedule
    {"text": "Quiero ir a verlo este sÃ¡bado",
     "intents": ["ContactRequest", "TestDriveSchedule"]},
    {"text": "Puedo pasar maÃ±ana a las 10?",
     "intents": ["ContactRequest", "TestDriveSchedule"]},
    {"text": "Me gustarÃ­a visitarlos esta semana",
     "intents": ["ContactRequest", "TestDriveSchedule"]},

    # Could be FinancingInfo OR PaymentMethods
    {"text": "CÃ³mo se puede pagar eso?",
     "intents": ["FinancingInfo", "PaymentMethods"]},
    {"text": "Aceptan tarjeta o solo efectivo?",
     "intents": ["PaymentMethods", "FinancingInfo"]},
    {"text": "CuÃ¡les son las opciones para pagar?",
     "intents": ["PaymentMethods", "FinancingInfo"]},

    # Could be NegotiatePrice OR VehiclePrice
    {"text": "No hay un mejor precio?",
     "intents": ["NegotiatePrice", "VehiclePrice"]},
    {"text": "Y si compro dos me hacen descuento?",
     "intents": ["NegotiatePrice", "VehiclePrice"]},
    {"text": "Ese precio es negociable?",
     "intents": ["NegotiatePrice", "VehiclePrice"]},

    # Could be Complaint OR Help
    {"text": "Esto no me estÃ¡ funcionando",
     "intents": ["Complaint", "Help"]},
    {"text": "No entiendo nada de esto",
     "intents": ["Help", "Complaint"]},
    {"text": "Necesito que alguien me ayude porque no puedo",
     "intents": ["Help", "Complaint"]},

    # Could be VehicleAvailability OR VehicleSearch
    {"text": "TodavÃ­a les queda alguna Toyota?",
     "intents": ["VehicleAvailability", "VehicleSearch"]},
    {"text": "Ya se vendiÃ³ la Tucson esa?",
     "intents": ["VehicleAvailability", "VehicleDetails"]},
    {"text": "Tienen algo en Honda todavÃ­a?",
     "intents": ["VehicleAvailability", "VehicleSearch"]},

    # Could be MaintenanceCost OR InsuranceInfo
    {"text": "CuÃ¡nto cuesta mantener una de esas al mes?",
     "intents": ["MaintenanceCost", "InsuranceInfo"]},
    {"text": "Sale cara esa yipeta entre seguro y mantenimiento?",
     "intents": ["MaintenanceCost", "InsuranceInfo"]},

    # Could be DocumentsRequired OR UrgentPurchase
    {"text": "QuÃ© necesito para comprar hoy?",
     "intents": ["DocumentsRequired", "UrgentPurchase"]},
    {"text": "QuÃ© papeles llevo para salir hoy con el carro?",
     "intents": ["DocumentsRequired", "UrgentPurchase"]},

    # Could be CashPurchase OR PaymentMethods
    {"text": "Si pago cash me hacen descuento?",
     "intents": ["CashPurchase", "NegotiatePrice"]},
    {"text": "Puedo pagar todo de una vez?",
     "intents": ["CashPurchase", "PaymentMethods"]},

    # Could be DealerHours OR DealerLocation
    {"text": "DÃ³nde estÃ¡n y a quÃ© hora abren?",
     "intents": ["DealerHours", "DealerLocation"]},
    {"text": "A quÃ© hora puedo llegar y cÃ³mo los encuentro?",
     "intents": ["DealerHours", "DealerLocation"]},

    # Could be DeliveryInfo OR DealerLocation
    {"text": "Me lo pueden llevar o tengo que ir a buscarlo?",
     "intents": ["DeliveryInfo", "DealerLocation"]},
    {"text": "EstÃ¡n lejos de Santiago, me lo mandan?",
     "intents": ["DeliveryInfo", "DealerLocation"]},

    # Could be Greeting OR Help
    {"text": "Hola, cÃ³mo funciona esto?",
     "intents": ["Greeting", "Help"]},
    {"text": "Buenas, primera vez aquÃ­, quÃ© hago?",
     "intents": ["Greeting", "Help"]},

    # Could be ReturnPolicy OR WarrantyInfo
    {"text": "Y si sale malo quÃ© pasa?",
     "intents": ["ReturnPolicy", "WarrantyInfo"]},
    {"text": "Tienen alguna garantÃ­a o protecciÃ³n?",
     "intents": ["WarrantyInfo", "ReturnPolicy"]},
    {"text": "QuÃ© pasa si el carro tiene problemas despuÃ©s?",
     "intents": ["WarrantyInfo", "ReturnPolicy"]},

    # Could be UserObjection OR NegotiatePrice
    {"text": "Eso es mucho, no hay algo mÃ¡s barato?",
     "intents": ["UserObjection", "NegotiatePrice"]},
    {"text": "No me convence el precio, quÃ© mÃ¡s tienen?",
     "intents": ["UserObjection", "NegotiatePrice"]},
    {"text": "EstÃ¡ fuera de lo que puedo pagar, hay opciones?",
     "intents": ["UserObjection", "NegotiatePrice"]},

    # Could be FrustratedUser OR Complaint
    {"text": "Nadie me ha respondido, esto es terrible",
     "intents": ["FrustratedUser", "Complaint"]},
    {"text": "Ya me cansÃ©, necesito que resuelvan",
     "intents": ["FrustratedUser", "Complaint"]},
    {"text": "El servicio ha sido pÃ©simo, quiero hablar con alguien",
     "intents": ["FrustratedUser", "RequestHumanAgent"]},

    # Could be RequestHumanAgent OR ContactRequest
    {"text": "Necesito hablar con alguien de verdad",
     "intents": ["RequestHumanAgent", "ContactRequest"]},
    {"text": "Hay alguien que pueda ayudarme mejor?",
     "intents": ["RequestHumanAgent", "Help"]},
    {"text": "Prefiero que me llame un vendedor",
     "intents": ["RequestHumanAgent", "ContactRequest"]},

    # Could be UserObjection OR Farewell
    {"text": "No gracias, otro dÃ­a serÃ¡",
     "intents": ["UserObjection", "Farewell"]},
    {"text": "Lo voy a pensar, gracias",
     "intents": ["UserObjection", "Farewell"]},

    # Could be VehicleNotInInventory OR VehicleSearch
    {"text": "Tienen Tesla o algo elÃ©ctrico?",
     "intents": ["VehicleNotInInventory", "VehicleSearch"]},
    {"text": "Busco un Porsche o algo deportivo",
     "intents": ["VehicleNotInInventory", "VehicleSearch"]},
    {"text": "Tienen algo parecido a un Range Rover?",
     "intents": ["VehicleNotInInventory", "VehicleSearch"]},

    # Could be VehicleNotInInventory OR VehicleSpecsQuestion
    {"text": "CuÃ¡ntos HP tiene ese carro?",
     "intents": ["VehicleNotInInventory", "VehicleSpecsQuestion"]},
    {"text": "CuÃ¡nto consume por galÃ³n?",
     "intents": ["VehicleNotInInventory", "VehicleSpecsQuestion"]},
]

INTENT_REGISTRY = {
    "Greeting": {
        "user_templates": GREETING_USER_TEMPLATES,
        "response_fn": greeting_response,
        "requires_vehicle": False,
    },
    "Farewell": {
        "user_templates": FAREWELL_USER_TEMPLATES,
        "response_fn": farewell_response,
        "requires_vehicle": False,
    },
    "Help": {
        "user_templates": HELP_USER_TEMPLATES,
        "response_fn": help_response,
        "requires_vehicle": False,
    },
    "Fallback": {
        "user_templates": FALLBACK_USER_TEMPLATES,
        "response_fn": fallback_response,
        "requires_vehicle": False,
    },
    "VehicleSearch": {
        "user_templates": VEHICLE_SEARCH_USER_TEMPLATES,
        "response_fn": vehicle_search_response,
        "requires_vehicle": True,
    },
    "VehicleDetails": {
        "user_templates": VEHICLE_DETAILS_USER_TEMPLATES,
        "response_fn": vehicle_details_response,
        "requires_vehicle": True,
    },
    "VehiclePrice": {
        "user_templates": VEHICLE_PRICE_USER_TEMPLATES,
        "response_fn": vehicle_price_response,
        "requires_vehicle": True,
    },
    "VehicleComparison": {
        "user_templates": VEHICLE_COMPARISON_USER_TEMPLATES,
        "response_fn": vehicle_comparison_response,
        "requires_vehicle": True,
    },
    "FinancingInfo": {
        "user_templates": FINANCING_INFO_USER_TEMPLATES,
        "response_fn": financing_info_response,
        "requires_vehicle": False,  # Optional
    },
    "TestDriveSchedule": {
        "user_templates": TEST_DRIVE_USER_TEMPLATES,
        "response_fn": test_drive_response,
        "requires_vehicle": False,  # Optional
    },
    "DealerHours": {
        "user_templates": DEALER_HOURS_USER_TEMPLATES,
        "response_fn": dealer_hours_response,
        "requires_vehicle": False,
    },
    "DealerLocation": {
        "user_templates": DEALER_LOCATION_USER_TEMPLATES,
        "response_fn": dealer_location_response,
        "requires_vehicle": False,
    },
    "ContactRequest": {
        "user_templates": CONTACT_REQUEST_USER_TEMPLATES,
        "response_fn": contact_request_response,
        "requires_vehicle": False,
    },
    "Complaint": {
        "user_templates": COMPLAINT_USER_TEMPLATES,
        "response_fn": complaint_response,
        "requires_vehicle": False,
    },
    "TradeIn": {
        "user_templates": TRADE_IN_USER_TEMPLATES,
        "response_fn": trade_in_response,
        "requires_vehicle": False,
    },
    "WarrantyInfo": {
        "user_templates": WARRANTY_USER_TEMPLATES,
        "response_fn": warranty_response,
        "requires_vehicle": False,
    },
    "CashPurchase": {
        "user_templates": CASH_PURCHASE_USER_TEMPLATES,
        "response_fn": cash_purchase_response,
        "requires_vehicle": False,  # Optional
    },
    "VehicleSpecsQuestion": {
        "user_templates": VEHICLE_SPECS_USER_TEMPLATES,
        "response_fn": vehicle_specs_response,
        "requires_vehicle": True,
    },
    # --- Phase 3: Edge-case intents ---
    "NegotiatePrice": {
        "user_templates": NEGOTIATE_PRICE_USER_TEMPLATES,
        "response_fn": negotiate_price_response,
        "requires_vehicle": False,  # Optional
    },
    "VehicleAvailability": {
        "user_templates": VEHICLE_AVAILABILITY_USER_TEMPLATES,
        "response_fn": vehicle_availability_response,
        "requires_vehicle": True,
    },
    "InsuranceInfo": {
        "user_templates": INSURANCE_INFO_USER_TEMPLATES,
        "response_fn": insurance_info_response,
        "requires_vehicle": False,  # Optional
    },
    "DocumentsRequired": {
        "user_templates": DOCUMENTS_REQUIRED_USER_TEMPLATES,
        "response_fn": documents_required_response,
        "requires_vehicle": False,
    },
    "DeliveryInfo": {
        "user_templates": DELIVERY_INFO_USER_TEMPLATES,
        "response_fn": delivery_info_response,
        "requires_vehicle": False,
    },
    "VehicleHistory": {
        "user_templates": VEHICLE_HISTORY_USER_TEMPLATES,
        "response_fn": vehicle_history_response,
        "requires_vehicle": False,  # Optional
    },
    "PaymentMethods": {
        "user_templates": PAYMENT_METHODS_USER_TEMPLATES,
        "response_fn": payment_methods_response,
        "requires_vehicle": False,
    },
    "ReturnPolicy": {
        "user_templates": RETURN_POLICY_USER_TEMPLATES,
        "response_fn": return_policy_response,
        "requires_vehicle": False,
    },
    "MaintenanceCost": {
        "user_templates": MAINTENANCE_COST_USER_TEMPLATES,
        "response_fn": maintenance_cost_response,
        "requires_vehicle": False,  # Optional
    },
    "OutOfScope": {
        "user_templates": OUT_OF_SCOPE_USER_TEMPLATES,
        "response_fn": out_of_scope_response,
        "requires_vehicle": False,
    },
    "LanguageBarrier": {
        "user_templates": LANGUAGE_BARRIER_USER_TEMPLATES,
        "response_fn": language_barrier_response,
        "requires_vehicle": False,
    },
    "ColorAvailability": {
        "user_templates": COLOR_AVAILABILITY_USER_TEMPLATES,
        "response_fn": color_availability_response,
        "requires_vehicle": False,  # Optional
    },
    "UrgentPurchase": {
        "user_templates": URGENT_PURCHASE_USER_TEMPLATES,
        "response_fn": urgent_purchase_response,
        "requires_vehicle": False,
    },
    "NewVsUsed": {
        "user_templates": NEW_VS_USED_USER_TEMPLATES,
        "response_fn": new_vs_used_response,
        "requires_vehicle": False,
    },
    # --- Inventory grounding: vehicle/spec not found ---
    "VehicleNotInInventory": {
        "user_templates": VEHICLE_NOT_IN_INVENTORY_USER_TEMPLATES,
        "response_fn": vehicle_not_in_inventory_response,
        "requires_vehicle": False,
    },
    # --- Legal compliance: Refusal of illegal requests ---
    "LegalRefusal": {
        "user_templates": LEGAL_REFUSAL_USER_TEMPLATES + LEGAL_REFUSAL_USER_TEMPLATES_INFORMAL,
        "response_fn": legal_refusal_response,
        "requires_vehicle": False,
    },
    # --- Negative response / conflict handling ---
    "UserObjection": {
        "user_templates": USER_OBJECTION_USER_TEMPLATES,
        "response_fn": user_objection_response,
        "requires_vehicle": False,
    },
    "FrustratedUser": {
        "user_templates": FRUSTRATED_USER_USER_TEMPLATES,
        "response_fn": frustrated_user_response,
        "requires_vehicle": False,
    },
    "RequestHumanAgent": {
        "user_templates": REQUEST_HUMAN_AGENT_USER_TEMPLATES,
        "response_fn": request_human_agent_response,
        "requires_vehicle": False,
    },
}
