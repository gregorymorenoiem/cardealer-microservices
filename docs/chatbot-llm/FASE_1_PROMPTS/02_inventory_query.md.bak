# ğŸ“ Prompt 02 â€” Consulta de Inventario

> **Fase:** 1 â€” DiseÃ±o de Prompts  
> **Ãšltima actualizaciÃ³n:** Febrero 15, 2026

---

## 1. Nombre y Rol

**Inventory Query Prompt** â€” Interpreta bÃºsquedas naturales del usuario, filtra el inventario inyectado como contexto, y presenta resultados con disclaimers legales. Se inyecta como mensaje `system` adicional cuando se detecta intenciÃ³n de bÃºsqueda de vehÃ­culos.

---

## 2. Trigger

- **CuÃ¡ndo se ejecuta:** Cuando el intent detectado es `VehicleSearch`, `VehicleDetails`, `VehicleAvailability`, `VehiclePrice`, `VehicleFeatures` o cuando el usuario menciona marca, modelo, tipo o presupuesto.
- **QuÃ© lo activa:** El `SendMessageCommandHandler` detecta que el mensaje del usuario contiene bÃºsqueda vehicular y agrega este prompt + inventario filtrado como contexto adicional.

---

## 3. Variables DinÃ¡micas Requeridas

| Variable                  | Fuente                                      | Tipo   | Ejemplo                  |
| ------------------------- | ------------------------------------------- | ------ | ------------------------ |
| `{{inventory_json}}`      | `IInventorySyncService.SearchVehiclesAsync` | JSON   | Array de ChatbotVehicle  |
| `{{total_available}}`     | Conteo de vehÃ­culos activos                 | int    | 47                       |
| `{{dealer_name}}`         | ChatbotConfiguration                        | string | "Auto Toyota Dominicana" |
| `{{financing_available}}` | ChatbotConfiguration                        | bool   | true                     |
| `{{trade_in_available}}`  | ChatbotConfiguration                        | bool   | true                     |

---

## 4. Texto Completo del Prompt

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
INSTRUCCIONES DE CONSULTA DE INVENTARIO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

El usuario estÃ¡ buscando un vehÃ­culo. Debes interpretar su consulta en lenguaje natural y filtrar los resultados del inventario que se te proporciona.

REGLAS DE INTERPRETACIÃ“N:
1. Traduce modismos dominicanos a categorÃ­as:
   - "yipeta" / "jeepeta" â†’ SUV, Crossover
   - "guagua" â†’ Van, Minivan, SUV grande
   - "carro" â†’ Sedan, Hatchback, Coupe (genÃ©rico)
   - "motor" / "moto" â†’ Motocicleta
   - "pasola" â†’ Scooter
   - "pickup" / "camioneta" â†’ Pickup, Truck
   - "pela'o" / "econÃ³mico" / "barato" â†’ Precio bajo (< 1,000,000 DOP)
   - "de lujo" / "premium" â†’ Precio alto (> 3,000,000 DOP)
   - "familiar" â†’ SUV, Minivan, 5+ puertas, amplio espacio

2. Interpreta necesidades implÃ­citas:
   - "que no gaste mucha gasolina" â†’ Filtrar por fuelType: "HÃ­brido", "DiÃ©sel" o motor pequeÃ±o (<2.0L)
   - "para la ciudad" â†’ Sedan, Hatchback, transmisiÃ³n automÃ¡tica
   - "para trabajo" â†’ Pickup, Van, capacidad de carga
   - "primer carro" â†’ Precio bajo, econÃ³mico, fÃ¡cil manejo

3. Rangos de precio (en DOP):
   - Si dice "como X" â†’ rango Â±15% (ej: "como 2 millones" = 1,700,000 - 2,300,000)
   - Si dice "hasta X" / "mÃ¡ximo X" â†’ 0 a X
   - Si dice "desde X" / "mÃ­nimo X" â†’ X en adelante
   - Si dice "entre X y Y" â†’ rango exacto
   - Si menciona USD â†’ convertir a DOP (tasa aprox 1 USD = 59 DOP)

FORMATO DE PRESENTACIÃ“N:
- Muestra mÃ¡ximo 3-4 vehÃ­culos relevantes.
- Para cada vehÃ­culo incluye: marca, modelo, aÃ±o, precio (DOP), tipo, transmisiÃ³n, combustible, kilometraje, 1-2 features destacados.
- Ordena por relevancia a la bÃºsqueda del usuario (no solo precio).
- Si hay mÃ¡s resultados, menciona: "Tenemos X opciones mÃ¡s que podrÃ­an interesarte."

EJEMPLO DE FORMATO DE RESPUESTA PARA VEHÃCULOS:
"Basado en lo que buscas, te recomiendo estas opciones:

ğŸš— **Toyota RAV4 2024** â€” RD$2,850,000*
   SUV | AutomÃ¡tica | Gasolina | 0 km
   âœ… Apple CarPlay, CÃ¡mara de reversa

ğŸš— **Hyundai Tucson 2023** â€” RD$1,950,000*
   SUV | AutomÃ¡tica | Gasolina | 12,000 km
   âœ… Sensor de estacionamiento, Android Auto

*Precios de referencia sujetos a confirmaciÃ³n. No incluyen traspaso ni impuestos. Consulta con nuestro equipo para cotizaciÃ³n oficial."

DISCLAIMERS OBLIGATORIOS (Ley 358-05):
- SIEMPRE agregar: "*Precio de referencia sujeto a confirmaciÃ³n."
- SIEMPRE agregar: "No incluyen traspaso ni impuestos."
- NUNCA decir "precio final", "precio garantizado", "oferta especial" sin autorizaciÃ³n humana.
- NUNCA inventar especificaciones que no estÃ©n en el inventario.
- Si el vehÃ­culo no tiene precio listado, decir: "Consulta el precio con nuestro equipo de ventas."

SI NO HAY RESULTADOS:
"No encontrÃ© vehÃ­culos que coincidan exactamente con lo que buscas en nuestro inventario actual de {{total_available}} unidades.

Te sugiero:
- Ampliar tu rango de presupuesto
- Considerar otras marcas/modelos similares
- Hablar con un asesor que pueda buscar opciones adicionales

Â¿Te gustarÃ­a que te conecte con un asesor?"

INVENTARIO DISPONIBLE (datos reales del dealer {{dealer_name}}):

{{inventory_json}}
```

---

## 5. Ejemplo Real de Input/Output

### Input:

```json
{
  "userMessage": "Quiero una yipeta familiar que no gaste mucha gasolina, tengo como 2 millones",
  "inventory": [
    {
      "vehicleId": "abc-123",
      "brand": "Hyundai",
      "model": "Tucson",
      "year": 2023,
      "price": 1950000,
      "type": "SUV",
      "fuelType": "Gasolina",
      "transmission": "AutomÃ¡tica",
      "mileage": 12000,
      "features": ["Sensor de estacionamiento", "Android Auto"]
    },
    {
      "vehicleId": "def-456",
      "brand": "Toyota",
      "model": "RAV4",
      "year": 2024,
      "price": 2850000,
      "type": "SUV",
      "fuelType": "Gasolina",
      "transmission": "AutomÃ¡tica",
      "mileage": 0,
      "features": ["Apple CarPlay", "CÃ¡mara de reversa"]
    },
    {
      "vehicleId": "ghi-789",
      "brand": "Kia",
      "model": "Sportage",
      "year": 2023,
      "price": 1750000,
      "type": "SUV",
      "fuelType": "Gasolina",
      "transmission": "AutomÃ¡tica",
      "mileage": 8000,
      "features": ["Pantalla tÃ¡ctil", "Bluetooth"]
    }
  ]
}
```

### Output:

```json
{
  "response": "Â¡Con gusto te ayudo! ğŸš— Con un presupuesto de RD$2,000,000 tenemos excelentes opciones de SUV familiar:\n\nğŸš— **Kia Sportage 2023** â€” RD$1,750,000*\n   SUV | AutomÃ¡tica | Gasolina | 8,000 km\n   âœ… Pantalla tÃ¡ctil, Bluetooth\n\nğŸš— **Hyundai Tucson 2023** â€” RD$1,950,000*\n   SUV | AutomÃ¡tica | Gasolina | 12,000 km\n   âœ… Sensor de estacionamiento, Android Auto\n\nAmbas son amplias, cÃ³modas para familia y con buen consumo de combustible.\n\n*Precios de referencia sujetos a confirmaciÃ³n. No incluyen traspaso ni impuestos. Consulta con nuestro equipo para cotizaciÃ³n oficial.\n\nÂ¿Te gustarÃ­a agendar una visita para verlas en persona?",
  "intent": "VehicleSearch",
  "confidence": 0.94,
  "isFallback": false,
  "parameters": {
    "vehicleType": "SUV",
    "priceRange": "0-2300000",
    "purpose": "family",
    "fuelPreference": "efficient"
  },
  "leadSignals": {
    "mentionedBudget": true,
    "requestedTestDrive": false,
    "askedFinancing": false,
    "providedContactInfo": false
  },
  "suggestedAction": null,
  "quickReplies": [
    "Ver Kia Sportage",
    "Ver Hyundai Tucson",
    "Agendar visita",
    "MÃ¡s opciones"
  ]
}
```

---

## 6. Notas de ImplementaciÃ³n (.NET 8)

### InyecciÃ³n de inventario en el prompt:

```csharp
// En LlmService.cs â€” Construir contexto de inventario

private async Task<string> BuildInventoryContext(
    Guid configurationId,
    string userMessage,
    CancellationToken ct)
{
    // 1. Buscar vehÃ­culos relevantes al query del usuario
    var vehicles = await _inventorySyncService.SearchVehiclesAsync(
        configurationId, userMessage, limit: 10, ct);

    // 2. Si no hay resultados de bÃºsqueda, obtener destacados
    if (!vehicles.Any())
        vehicles = await _inventorySyncService.GetFeaturedVehiclesAsync(
            configurationId, limit: 5, ct);

    // 3. Serializar a JSON compacto para el prompt
    var inventoryJson = JsonSerializer.Serialize(vehicles.Select(v => new {
        v.Id,
        brand = v.Make,
        model = v.Model,
        v.Year,
        v.Price,
        type = v.BodyType,
        v.FuelType,
        v.Transmission,
        v.Mileage,
        v.Colors,
        v.IsAvailable,
        features = v.Features // Si existe campo de features
    }), new JsonSerializerOptions { WriteIndented = false });

    return inventoryJson;
}

// 4. Insertar en el prompt
private string InjectInventoryPrompt(string inventoryJson, int totalAvailable, string dealerName)
{
    return _inventoryPromptTemplate
        .Replace("{{inventory_json}}", inventoryJson)
        .Replace("{{total_available}}", totalAvailable.ToString())
        .Replace("{{dealer_name}}", dealerName);
}
```

### Flujo en `SendMessageCommandHandler`:

```csharp
// Si el intent parece vehicular, agregar inventario como contexto
var messages = new List<LlmMessage>
{
    new("system", BuildSystemPrompt(config, inventorySummary)),
    // Agregar historial de conversaciÃ³n
    ...previousMessages,
    new("user", request.Message)
};

// Si el mensaje del usuario contiene keywords de bÃºsqueda,
// inyectar el prompt de inventario como sistema adicional
if (IsVehicleSearchIntent(request.Message))
{
    var inventoryContext = await BuildInventoryContext(config.Id, request.Message, ct);
    messages.Insert(1, new("system", InjectInventoryPrompt(inventoryContext, totalCount, config.Name)));
}
```
