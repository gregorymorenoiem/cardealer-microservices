# ğŸ” Diagramas de Flujo de AutenticaciÃ³n

> **Tiempo estimado:** 10 minutos (referencia)
> **Prerrequisitos:** Entender NextAuth.js, JWT, OAuth
> **Ãšltima actualizaciÃ³n:** Enero 31, 2026

---

## ğŸ“‹ OBJETIVO

Documentar visualmente todos los flujos de autenticaciÃ³n:

- Login con credenciales
- Login con OAuth (Google, Facebook, Apple)
- Registro de usuario
- Refresh de tokens
- Logout
- RecuperaciÃ³n de contraseÃ±a
- VerificaciÃ³n de email/telÃ©fono

---

## ğŸ”„ FLUJO 1: Login con Email/Password

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        LOGIN CON CREDENCIALES                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Usuario  â”‚â”€â”€â”€â–¶â”‚  /login     â”‚â”€â”€â”€â–¶â”‚  NextAuth   â”‚â”€â”€â”€â–¶â”‚  AuthService   â”‚  â”‚
â”‚  â”‚ ingresa  â”‚    â”‚  Page       â”‚    â”‚  (Next.js)  â”‚    â”‚  (Backend)     â”‚  â”‚
â”‚  â”‚ email +  â”‚    â”‚             â”‚    â”‚             â”‚    â”‚                â”‚  â”‚
â”‚  â”‚ password â”‚    â”‚             â”‚    â”‚             â”‚    â”‚                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                  â”‚                    â”‚           â”‚
â”‚                         â”‚ 1. Submit form   â”‚                    â”‚           â”‚
â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚           â”‚
â”‚                         â”‚                  â”‚ 2. POST /api/auth/ â”‚           â”‚
â”‚                         â”‚                  â”‚    login           â”‚           â”‚
â”‚                         â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚           â”‚
â”‚                         â”‚                  â”‚                    â”‚           â”‚
â”‚                         â”‚                  â”‚                    â”‚ 3. Validarâ”‚
â”‚                         â”‚                  â”‚                    â”‚ credenciales
â”‚                         â”‚                  â”‚                    â”‚           â”‚
â”‚                         â”‚                  â”‚ 4. Devolver JWT +  â”‚           â”‚
â”‚                         â”‚                  â”‚    Refresh Token   â”‚           â”‚
â”‚                         â”‚                  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚
â”‚                         â”‚                  â”‚                    â”‚           â”‚
â”‚                         â”‚                  â”‚ 5. Crear sesiÃ³n    â”‚           â”‚
â”‚                         â”‚                  â”‚    NextAuth        â”‚           â”‚
â”‚                         â”‚                  â”‚                    â”‚           â”‚
â”‚                         â”‚ 6. Redirect a    â”‚                    â”‚           â”‚
â”‚                         â”‚    /dashboard    â”‚                    â”‚           â”‚
â”‚                         â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚           â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CÃ³digo del Flujo

```typescript
// 1. Usuario llena formulario en LoginPage
const onSubmit = async (data: LoginFormData) => {
  const result = await signIn("credentials", {
    email: data.email,
    password: data.password,
    redirect: false,
  });

  if (result?.error) {
    setError("Credenciales invÃ¡lidas");
    return;
  }

  // 6. Redirect exitoso
  router.push(callbackUrl || "/dashboard");
};

// 2-5. NextAuth maneja internamente la comunicaciÃ³n con AuthService
// Ver: src/lib/auth/config.ts -> CredentialsProvider
```

---

## ğŸ”„ FLUJO 2: Login con OAuth (Google)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          LOGIN CON GOOGLE                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Usuario  â”‚â”€â”€â–¶â”‚ /login   â”‚â”€â”€â–¶â”‚   Google    â”‚â”€â”€â–¶â”‚NextAuthâ”‚â”€â”€â–¶â”‚AuthServiceâ”‚ â”‚
â”‚  â”‚ click    â”‚   â”‚ Page     â”‚   â”‚   OAuth     â”‚   â”‚        â”‚   â”‚(Backend) â”‚ â”‚
â”‚  â”‚ "Google" â”‚   â”‚          â”‚   â”‚             â”‚   â”‚        â”‚   â”‚          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚       â”‚              â”‚               â”‚               â”‚             â”‚        â”‚
â”‚       â”‚  1. Click    â”‚               â”‚               â”‚             â”‚        â”‚
â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶               â”‚               â”‚             â”‚        â”‚
â”‚       â”‚              â”‚ 2. Redirect   â”‚               â”‚             â”‚        â”‚
â”‚       â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶               â”‚             â”‚        â”‚
â”‚       â”‚              â”‚               â”‚               â”‚             â”‚        â”‚
â”‚       â”‚              â”‚  3. Usuario   â”‚               â”‚             â”‚        â”‚
â”‚       â”‚              â”‚  autoriza app â”‚               â”‚             â”‚        â”‚
â”‚       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚             â”‚        â”‚
â”‚       â”‚              â”‚               â”‚               â”‚             â”‚        â”‚
â”‚       â”‚              â”‚ 4. Callback   â”‚               â”‚             â”‚        â”‚
â”‚       â”‚              â”‚    con code   â”‚               â”‚             â”‚        â”‚
â”‚       â”‚              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚             â”‚        â”‚
â”‚       â”‚              â”‚               â”‚ 5. Exchange  â”‚             â”‚        â”‚
â”‚       â”‚              â”‚               â”‚    code for  â”‚             â”‚        â”‚
â”‚       â”‚              â”‚               â”‚    tokens    â”‚             â”‚        â”‚
â”‚       â”‚              â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶             â”‚        â”‚
â”‚       â”‚              â”‚               â”‚               â”‚ 6. Upsert  â”‚        â”‚
â”‚       â”‚              â”‚               â”‚               â”‚    user    â”‚        â”‚
â”‚       â”‚              â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶        â”‚
â”‚       â”‚              â”‚               â”‚               â”‚             â”‚        â”‚
â”‚       â”‚              â”‚               â”‚               â”‚ 7. Return  â”‚        â”‚
â”‚       â”‚              â”‚               â”‚               â”‚    JWT     â”‚        â”‚
â”‚       â”‚              â”‚               â”‚               â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚       â”‚              â”‚               â”‚               â”‚             â”‚        â”‚
â”‚       â”‚              â”‚ 8. Redirect   â”‚               â”‚             â”‚        â”‚
â”‚       â”‚              â”‚    /dashboard â”‚               â”‚             â”‚        â”‚
â”‚       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CÃ³digo del Flujo

```typescript
// 1. Click en botÃ³n de Google
<Button onClick={() => signIn('google', { callbackUrl: '/dashboard' })}>
  <GoogleIcon /> Continuar con Google
</Button>

// 2-8. NextAuth maneja todo el flujo OAuth automÃ¡ticamente
// ConfiguraciÃ³n en src/lib/auth/config.ts:
providers: [
  GoogleProvider({
    clientId: process.env.GOOGLE_CLIENT_ID!,
    clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
  }),
]
```

---

## ğŸ”„ FLUJO 3: Registro de Usuario

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         REGISTRO DE USUARIO                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  PASO 1: Formulario                                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Usuario  â”‚â”€â”€â”€â–¶â”‚  /registro  â”‚â”€â”€â”€â–¶â”‚  AuthService   â”‚                      â”‚
â”‚  â”‚ completa â”‚    â”‚  Page       â”‚    â”‚  POST /api/    â”‚                      â”‚
â”‚  â”‚ form     â”‚    â”‚             â”‚    â”‚  auth/register â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                              â”‚                              â”‚
â”‚                                              â–¼                              â”‚
â”‚                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                                     â”‚ Crear usuario  â”‚                      â”‚
â”‚                                     â”‚ (unverified)   â”‚                      â”‚
â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                              â”‚                              â”‚
â”‚  PASO 2: VerificaciÃ³n Email                  â”‚                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â–¼                              â”‚
â”‚                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚ Enviar email   â”‚                      â”‚
â”‚  â”‚ Usuario  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ con cÃ³digo OTP â”‚                      â”‚
â”‚  â”‚ recibe   â”‚                       â”‚ (6 dÃ­gitos)    â”‚                      â”‚
â”‚  â”‚ email    â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                               â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Usuario  â”‚â”€â”€â”€â–¶â”‚ /verificar- â”‚â”€â”€â”€â–¶â”‚  AuthService   â”‚                      â”‚
â”‚  â”‚ ingresa  â”‚    â”‚ email       â”‚    â”‚  POST /api/    â”‚                      â”‚
â”‚  â”‚ cÃ³digo   â”‚    â”‚             â”‚    â”‚  auth/verify   â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                              â”‚                              â”‚
â”‚                                              â–¼                              â”‚
â”‚                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                                     â”‚ Marcar email   â”‚                      â”‚
â”‚                                     â”‚ como verificadoâ”‚                      â”‚
â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                              â”‚                              â”‚
â”‚  PASO 3: Login AutomÃ¡tico                    â”‚                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â–¼                              â”‚
â”‚                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                                     â”‚ Auto-login con â”‚                      â”‚
â”‚                                     â”‚ JWT generado   â”‚                      â”‚
â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                              â”‚                              â”‚
â”‚                                              â–¼                              â”‚
â”‚                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                                     â”‚ Redirect a     â”‚                      â”‚
â”‚                                     â”‚ /dashboard     â”‚                      â”‚
â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CÃ³digo del Flujo

```typescript
// Paso 1: Registro
const onSubmit = async (data: RegisterFormData) => {
  const response = await api.post("/api/auth/register", data);

  if (response.success) {
    // Guardar email para verificaciÃ³n
    setEmail(data.email);
    router.push("/verificar-email");
  }
};

// Paso 2: VerificaciÃ³n
const onVerify = async (code: string) => {
  const response = await api.post("/api/auth/verify-email", {
    email,
    code,
  });

  if (response.success) {
    // Paso 3: Auto-login
    await signIn("credentials", {
      email,
      password: originalPassword, // guardado temporalmente
      redirect: true,
      callbackUrl: "/dashboard",
    });
  }
};
```

---

## ğŸ”„ FLUJO 4: Refresh de Token

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          REFRESH DE TOKEN                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Token vÃ¡lido por: 15 minutos                                               â”‚
â”‚  Refresh token vÃ¡lido por: 7 dÃ­as                                           â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    TIMELINE                                          â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  0min     5min     10min    14min    15min    16min                 â”‚    â”‚
â”‚  â”‚  â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€                  â”‚    â”‚
â”‚  â”‚    â”‚       â”‚        â”‚        â”‚        â”‚        â”‚                    â”‚    â”‚
â”‚  â”‚  Login   Request  Request  Check    Token   Auto                   â”‚    â”‚
â”‚  â”‚  âœ“       âœ“        âœ“        expiry   expired refresh                â”‚    â”‚
â”‚  â”‚                            trigger                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â”‚  FLUJO AUTOMÃTICO:                                                          â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Request  â”‚â”€â”€â”€â–¶â”‚  NextAuth   â”‚â”€â”€â”€â–¶â”‚  AuthService   â”‚                      â”‚
â”‚  â”‚ cualquierâ”‚    â”‚  JWT        â”‚    â”‚  POST /api/    â”‚                      â”‚
â”‚  â”‚ API      â”‚    â”‚  Callback   â”‚    â”‚  auth/refresh  â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                         â”‚                    â”‚                              â”‚
â”‚                         â”‚ 1. Verificar       â”‚                              â”‚
â”‚                         â”‚    expiraciÃ³n      â”‚                              â”‚
â”‚                         â”‚                    â”‚                              â”‚
â”‚                         â”‚ 2. Si expira en    â”‚                              â”‚
â”‚                         â”‚    < 1min, refresh â”‚                              â”‚
â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                              â”‚
â”‚                         â”‚                    â”‚                              â”‚
â”‚                         â”‚ 3. Nuevo access    â”‚                              â”‚
â”‚                         â”‚    token           â”‚                              â”‚
â”‚                         â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                              â”‚
â”‚                         â”‚                    â”‚                              â”‚
â”‚                         â”‚ 4. Actualizar      â”‚                              â”‚
â”‚                         â”‚    sesiÃ³n          â”‚                              â”‚
â”‚                         â”‚                    â”‚                              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CÃ³digo del Flujo

```typescript
// filepath: src/lib/auth/config.ts
callbacks: {
  async jwt({ token, user, account }) {
    // Login inicial
    if (account && user) {
      return {
        accessToken: user.accessToken,
        refreshToken: user.refreshToken,
        accessTokenExpires: user.accessTokenExpires,
        user: user,
      };
    }

    // Token todavÃ­a vÃ¡lido
    if (Date.now() < (token.accessTokenExpires as number) - 60000) {
      return token;
    }

    // Token por expirar, refrescar
    return refreshAccessToken(token);
  },
},

async function refreshAccessToken(token: JWT) {
  try {
    const response = await fetch(`${API_URL}/api/auth/refresh`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        refreshToken: token.refreshToken,
      }),
    });

    const refreshedTokens = await response.json();

    if (!response.ok) throw refreshedTokens;

    return {
      ...token,
      accessToken: refreshedTokens.accessToken,
      accessTokenExpires: refreshedTokens.expiresAt,
      refreshToken: refreshedTokens.refreshToken ?? token.refreshToken,
    };
  } catch (error) {
    return {
      ...token,
      error: 'RefreshAccessTokenError',
    };
  }
}
```

---

## ğŸ”„ FLUJO 5: Logout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              LOGOUT                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Usuario  â”‚â”€â”€â”€â–¶â”‚  signOut()  â”‚â”€â”€â”€â–¶â”‚  AuthService   â”‚â”€â”€â”€â–¶â”‚  Redirect  â”‚   â”‚
â”‚  â”‚ click    â”‚    â”‚  NextAuth   â”‚    â”‚  POST /api/    â”‚    â”‚  /login    â”‚   â”‚
â”‚  â”‚ logout   â”‚    â”‚             â”‚    â”‚  auth/logout   â”‚    â”‚            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                    â”‚                              â”‚
â”‚                         â”‚ 1. Llamar          â”‚                              â”‚
â”‚                         â”‚    signOut()       â”‚                              â”‚
â”‚                         â”‚                    â”‚                              â”‚
â”‚                         â”‚ 2. Invalidar       â”‚                              â”‚
â”‚                         â”‚    refresh token   â”‚                              â”‚
â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                              â”‚
â”‚                         â”‚                    â”‚                              â”‚
â”‚                         â”‚ 3. Limpiar         â”‚                              â”‚
â”‚                         â”‚    cookies/storage â”‚                              â”‚
â”‚                         â”‚                    â”‚                              â”‚
â”‚                         â”‚ 4. Limpiar stores  â”‚                              â”‚
â”‚                         â”‚    (Zustand)       â”‚                              â”‚
â”‚                         â”‚                    â”‚                              â”‚
â”‚                         â”‚ 5. Redirect a      â”‚                              â”‚
â”‚                         â”‚    /login          â”‚                              â”‚
â”‚                         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CÃ³digo del Flujo

```typescript
// Componente de logout
const handleLogout = async () => {
  // 1-2. Invalidar tokens en backend
  try {
    await api.post("/api/auth/logout");
  } catch (e) {
    // Continuar aunque falle
  }

  // 3-4. Limpiar stores
  useAuthStore.getState().reset();
  useFavoritesStore.getState().reset();

  // 5. NextAuth signOut
  await signOut({
    redirect: true,
    callbackUrl: "/login",
  });
};
```

---

## ğŸ”„ FLUJO 6: RecuperaciÃ³n de ContraseÃ±a

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     RECUPERACIÃ“N DE CONTRASEÃ‘A                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  PASO 1: Solicitar Reset                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                    â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Usuario  â”‚â”€â”€â”€â–¶â”‚ /recuperar- â”‚â”€â”€â”€â–¶â”‚  AuthService   â”‚â”€â”€â”€â–¶â”‚   Email    â”‚   â”‚
â”‚  â”‚ ingresa  â”‚    â”‚ password    â”‚    â”‚  POST /api/    â”‚    â”‚   Service  â”‚   â”‚
â”‚  â”‚ email    â”‚    â”‚             â”‚    â”‚  auth/forgot   â”‚    â”‚            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                              â”‚                    â”‚         â”‚
â”‚                                              â”‚ Generar token      â”‚         â”‚
â”‚                                              â”‚ de reset (1 hora)  â”‚         â”‚
â”‚                                              â”‚                    â”‚         â”‚
â”‚                                              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶         â”‚
â”‚                                              â”‚                    â”‚         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚    Enviar email   â”‚         â”‚
â”‚  â”‚ Usuario  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚
â”‚  â”‚ recibe   â”‚                                                               â”‚
â”‚  â”‚ email    â”‚                                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                               â”‚
â”‚                                                                             â”‚
â”‚  PASO 2: Cambiar ContraseÃ±a                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Usuario  â”‚â”€â”€â”€â–¶â”‚ /reset-     â”‚â”€â”€â”€â–¶â”‚  AuthService   â”‚                      â”‚
â”‚  â”‚ click    â”‚    â”‚ password    â”‚    â”‚  POST /api/    â”‚                      â”‚
â”‚  â”‚ link     â”‚    â”‚ ?token=xxx  â”‚    â”‚  auth/reset    â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚       â”‚                                      â”‚                              â”‚
â”‚       â”‚ Ingresar nueva                       â”‚                              â”‚
â”‚       â”‚ contraseÃ±a                           â”‚                              â”‚
â”‚       â”‚                                      â”‚                              â”‚
â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                              â”‚
â”‚       â”‚                                      â”‚                              â”‚
â”‚       â”‚                              Validar token                          â”‚
â”‚       â”‚                              Actualizar password                    â”‚
â”‚       â”‚                              Invalidar token                        â”‚
â”‚       â”‚                                      â”‚                              â”‚
â”‚       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                              â”‚
â”‚       â”‚                                      â”‚                              â”‚
â”‚       â”‚ Redirect a /login                    â”‚                              â”‚
â”‚       â”‚ con mensaje de Ã©xito                 â”‚                              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ FLUJO 7: VerificaciÃ³n de TelÃ©fono

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     VERIFICACIÃ“N DE TELÃ‰FONO                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Usuario  â”‚â”€â”€â”€â–¶â”‚ /perfil/    â”‚â”€â”€â”€â–¶â”‚  AuthService   â”‚â”€â”€â”€â–¶â”‚   SMS      â”‚   â”‚
â”‚  â”‚ ingresa  â”‚    â”‚ verificar-  â”‚    â”‚  POST /api/    â”‚    â”‚   Gateway  â”‚   â”‚
â”‚  â”‚ telÃ©fono â”‚    â”‚ telefono    â”‚    â”‚  auth/verify/  â”‚    â”‚   (Twilio) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  phone/send    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚         â”‚
â”‚                                                                   â”‚         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚         â”‚
â”‚  â”‚ Usuario  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚
â”‚  â”‚ recibe   â”‚                    SMS con cÃ³digo OTP               â”‚         â”‚
â”‚  â”‚ SMS      â”‚                    (6 dÃ­gitos, 5 min expiry)        â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                               â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ Usuario  â”‚â”€â”€â”€â–¶â”‚ Input OTP   â”‚â”€â”€â”€â–¶â”‚  AuthService   â”‚                      â”‚
â”‚  â”‚ ingresa  â”‚    â”‚ Component   â”‚    â”‚  POST /api/    â”‚                      â”‚
â”‚  â”‚ cÃ³digo   â”‚    â”‚             â”‚    â”‚  auth/verify/  â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  phone/confirm â”‚                      â”‚
â”‚                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                              â”‚                              â”‚
â”‚                                              â–¼                              â”‚
â”‚                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                                     â”‚ Marcar tel.    â”‚                      â”‚
â”‚                                     â”‚ como verificadoâ”‚                      â”‚
â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”’ ESTADOS DE SESIÃ“N

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ESTADOS DE SESIÃ“N                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            â”‚
â”‚  â”‚   GUEST     â”‚ â”€â”€â”€â”€ signIn() â”€â”€â”€â”€â–¶ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚  (no auth)  â”‚                      â”‚ LOADING     â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚        â–²                                    â”‚                               â”‚
â”‚        â”‚                           success  â”‚  error                        â”‚
â”‚        â”‚                              â”‚     â”‚    â”‚                          â”‚
â”‚        â”‚                              â–¼     â–¼    â”‚                          â”‚
â”‚        â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                          â”‚
â”‚        â”‚                       â”‚AUTHENTICATEDâ”‚   â”‚                          â”‚
â”‚        â”‚                       â”‚             â”‚   â”‚                          â”‚
â”‚        â”‚                       â”‚ â€¢ user data â”‚   â”‚                          â”‚
â”‚        â”‚                       â”‚ â€¢ tokens    â”‚   â”‚                          â”‚
â”‚        â”‚                       â”‚ â€¢ role      â”‚   â”‚                          â”‚
â”‚        â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                          â”‚
â”‚        â”‚                              â”‚          â”‚                          â”‚
â”‚        â”‚                     signOut()/          â”‚                          â”‚
â”‚        â”‚                     token expired       â”‚                          â”‚
â”‚        â”‚                              â”‚          â”‚                          â”‚
â”‚        â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Hook de Estado

```typescript
// filepath: src/hooks/useAuthStatus.ts
import { useSession } from "next-auth/react";

type AuthStatus = "loading" | "authenticated" | "unauthenticated";

export function useAuthStatus() {
  const { data: session, status } = useSession();

  return {
    status: status as AuthStatus,
    isLoading: status === "loading",
    isAuthenticated: status === "authenticated",
    isGuest: status === "unauthenticated",
    user: session?.user,
    role: session?.user?.role,
    accessToken: session?.accessToken,
    hasError: session?.error === "RefreshAccessTokenError",
  };
}
```

---

## ğŸ›¡ï¸ PROTECCIÃ“N DE RUTAS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     PROTECCIÃ“N DE RUTAS (Middleware)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Request â”€â”€â–¶ Middleware â”€â”€â–¶ Verificar Auth â”€â”€â–¶ Verificar Rol â”€â”€â–¶ Page      â”‚
â”‚                                    â”‚                 â”‚                      â”‚
â”‚                              No Auth             No Permiso                 â”‚
â”‚                                    â”‚                 â”‚                      â”‚
â”‚                                    â–¼                 â–¼                      â”‚
â”‚                              /login?           /403 Forbidden               â”‚
â”‚                              callback=                                      â”‚
â”‚                              originalUrl                                    â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    MATRIZ DE PERMISOS                                â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ RUTA                      â”‚GUEST â”‚ BUYER  â”‚ SELLER â”‚ DEALER â”‚ADMINâ”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ /                         â”‚  âœ…  â”‚   âœ…   â”‚   âœ…   â”‚   âœ…   â”‚  âœ… â”‚    â”‚
â”‚  â”‚ /vehiculos                â”‚  âœ…  â”‚   âœ…   â”‚   âœ…   â”‚   âœ…   â”‚  âœ… â”‚    â”‚
â”‚  â”‚ /vehiculos/[slug]         â”‚  âœ…  â”‚   âœ…   â”‚   âœ…   â”‚   âœ…   â”‚  âœ… â”‚    â”‚
â”‚  â”‚ /login                    â”‚  âœ…  â”‚   âŒ   â”‚   âŒ   â”‚   âŒ   â”‚  âŒ â”‚    â”‚
â”‚  â”‚ /registro                 â”‚  âœ…  â”‚   âŒ   â”‚   âŒ   â”‚   âŒ   â”‚  âŒ â”‚    â”‚
â”‚  â”‚ /dashboard                â”‚  âŒ  â”‚   âœ…   â”‚   âœ…   â”‚   âœ…   â”‚  âœ… â”‚    â”‚
â”‚  â”‚ /favoritos                â”‚  âŒ  â”‚   âœ…   â”‚   âœ…   â”‚   âœ…   â”‚  âœ… â”‚    â”‚
â”‚  â”‚ /publicar                 â”‚  âŒ  â”‚   âŒ   â”‚   âœ…   â”‚   âœ…   â”‚  âœ… â”‚    â”‚
â”‚  â”‚ /dealer/*                 â”‚  âŒ  â”‚   âŒ   â”‚   âŒ   â”‚   âœ…   â”‚  âœ… â”‚    â”‚
â”‚  â”‚ /admin/*                  â”‚  âŒ  â”‚   âŒ   â”‚   âŒ   â”‚   âŒ   â”‚  âœ… â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” ALMACENAMIENTO DE TOKENS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ALMACENAMIENTO DE TOKENS                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      NextAuth Session                                 â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚  HTTP-Only      â”‚  â”‚   JWT Token     â”‚  â”‚   Zustand       â”‚       â”‚   â”‚
â”‚  â”‚  â”‚  Cookie         â”‚  â”‚   (encrypted)   â”‚  â”‚   Store         â”‚       â”‚   â”‚
â”‚  â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Session ID    â”‚  â”‚ â€¢ User info     â”‚  â”‚ â€¢ UI state      â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ CSRF token    â”‚  â”‚ â€¢ Access token  â”‚  â”‚ â€¢ Preferences   â”‚       â”‚   â”‚
â”‚  â”‚  â”‚                 â”‚  â”‚ â€¢ Refresh token â”‚  â”‚ â€¢ Cache         â”‚       â”‚   â”‚
â”‚  â”‚  â”‚                 â”‚  â”‚ â€¢ Expiry        â”‚  â”‚                 â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ ğŸ”’ Secure       â”‚  â”‚ ğŸ”’ Encrypted    â”‚  â”‚ ğŸ“¦ Memory only  â”‚       â”‚   â”‚
â”‚  â”‚  â”‚ ğŸš« No JS access â”‚  â”‚ ğŸ”„ Auto-refresh â”‚  â”‚ ğŸš® Clear on     â”‚       â”‚   â”‚
â”‚  â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚    logout       â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  âš ï¸ NUNCA ALMACENAR:                                                        â”‚
â”‚  â€¢ Tokens en localStorage (vulnerable a XSS)                                â”‚
â”‚  â€¢ Passwords en cualquier storage                                           â”‚
â”‚  â€¢ Tokens en URLs (visible en logs/history)                                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… CHECKLIST DE IMPLEMENTACIÃ“N

### Flujos Core

- [ ] Login con email/password
- [ ] Login con Google OAuth
- [ ] Login con Facebook OAuth (opcional)
- [ ] Login con Apple OAuth (opcional)
- [ ] Registro de usuario
- [ ] Registro de dealer
- [ ] VerificaciÃ³n de email
- [ ] VerificaciÃ³n de telÃ©fono
- [ ] RecuperaciÃ³n de password
- [ ] Cambio de password
- [ ] Logout

### Seguridad

- [ ] Tokens en HTTP-only cookies
- [ ] Auto-refresh de tokens
- [ ] CSRF protection
- [ ] Rate limiting en endpoints
- [ ] ProtecciÃ³n de rutas (middleware)
- [ ] ValidaciÃ³n de roles

### UX

- [ ] Loading states en todos los formularios
- [ ] Mensajes de error claros
- [ ] Redirect despuÃ©s de login
- [ ] Remember me functionality
- [ ] Session timeout warning

---

## ğŸ“š REFERENCIAS

- [NextAuth.js Documentation](https://authjs.dev/)
- [JWT Best Practices](https://auth0.com/blog/jwt-handbook/)
- [OAuth 2.0 Flows](https://oauth.net/2/)
- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
