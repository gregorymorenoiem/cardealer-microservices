# ğŸ›¡ï¸ Sprint 4: EliminaciÃ³n de Vulnerabilidades HIGH

**Fecha de inicio**: 3 de diciembre de 2025  
**DuraciÃ³n estimada**: 4-6 horas  
**Prioridad**: CRÃTICA  
**Objetivo**: Eliminar las 30 vulnerabilidades HIGH restantes del Sprint 3

---

## ğŸ¯ Objetivos del Sprint

### Objetivo Principal
Reducir las vulnerabilidades HIGH de **30 a 0** (100% de eliminaciÃ³n)

### Objetivos Secundarios
1. âœ… Actualizar todos los paquetes .NET vulnerables
2. âœ… Migrar servicios restantes a Alpine Linux
3. âœ… Actualizar imÃ¡genes base a las versiones mÃ¡s recientes
4. âœ… Implementar escaneo continuo de vulnerabilidades
5. âœ… Documentar polÃ­ticas de seguridad

---

## ğŸ“Š Estado Actual (Sprint 3)

### DistribuciÃ³n de Vulnerabilidades HIGH por Servicio

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Servicio                    â”‚ HIGH     â”‚ Origen   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ backend-authservice         â”‚ 4        â”‚ OS       â”‚
â”‚ backend-gateway             â”‚ 9        â”‚ OS + .NETâ”‚
â”‚ backend-errorservice        â”‚ 5        â”‚ OS + .NETâ”‚
â”‚ backend-notificationservice â”‚ 6        â”‚ OS + .NETâ”‚
â”‚ backend-configurationserviceâ”‚ 6        â”‚ OS       â”‚
â”‚ backend-messagebusservice   â”‚ 0        â”‚ âœ…       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TOTAL                       â”‚ 30       â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AnÃ¡lisis Detallado de Vulnerabilidades

#### Vulnerabilidades .NET (Gateway, ErrorService, NotificationService)
```
ğŸ“¦ System.Text.Json
   - CVE-2024-30105 (HIGH)
   - CVE-2024-43485 (HIGH)
   - Afecta: Gateway (2), ErrorService (1), NotificationService (2)
   - SoluciÃ³n: Actualizar a 8.0.5+

ğŸ“¦ Microsoft.Data.SqlClient (Gateway)
   - CVE-2024-0056 (HIGH)
   - SoluciÃ³n: Actualizar a 5.1.3+

ğŸ“¦ System.Formats.Asn1 (Gateway)
   - CVE-2024-38095 (HIGH)
   - SoluciÃ³n: Actualizar a 8.0.1+
```

#### Vulnerabilidades OS (Todos los servicios bookworm-slim)
```
ğŸ§ libpam-modules packages
   - libpam-modules:amd64 (1.5.2-6+deb12u1)
   - libpam-modules-bin (1.5.2-6+deb12u1)
   - libpam-runtime (1.5.2-6+deb12u1)
   - libpam0g:amd64 (1.5.2-6+deb12u1)
   - Afecta: 4 servicios bookworm-slim
   - SoluciÃ³n: Migrar a Alpine o esperar fix Debian

ğŸ§ zlib1g (CVE-2023-45853)
   - Estado: CRITICAL pero marcado "will_not_fix" por Debian
   - Afecta: Todos los bookworm-slim
   - SoluciÃ³n: Migrar a Alpine (no vulnerable)
```

---

## ğŸ“‹ User Stories

### US-4.1: Actualizar Dependencias .NET Vulnerables
**Prioridad**: CRÃTICA  
**EstimaciÃ³n**: 90 minutos  
**Responsable**: DevOps Team

**DescripciÃ³n**:
Actualizar todos los paquetes NuGet con vulnerabilidades HIGH identificadas en el escaneo de Trivy.

**Tareas**:
1. âœ… Escanear proyectos con `dotnet list package --vulnerable --include-transitive`
2. âœ… Actualizar System.Text.Json a 8.0.5+ en todos los servicios
3. âœ… Actualizar Microsoft.Data.SqlClient a 5.1.3+ (Gateway)
4. âœ… Actualizar System.Formats.Asn1 a 8.0.1+ (Gateway)
5. âœ… Crear `Directory.Packages.props` para gestiÃ³n centralizada
6. âœ… Ejecutar tests de regresiÃ³n completos
7. âœ… Reconstruir imÃ¡genes y validar

**Criterios de AceptaciÃ³n**:
- [ ] 0 paquetes .NET con vulnerabilidades HIGH
- [ ] Todos los tests pasan exitosamente
- [ ] Directory.Packages.props creado y funcionando
- [ ] ImÃ¡genes reconstruidas con paquetes actualizados

**Impacto Esperado**:
```
Gateway:              9 HIGH â†’ 4 HIGH (-5 vulnerabilidades .NET)
ErrorService:         5 HIGH â†’ 4 HIGH (-1 vulnerabilidad .NET)
NotificationService:  6 HIGH â†’ 4 HIGH (-2 vulnerabilidades .NET)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REDUCCIÃ“N ESPERADA: -8 HIGH (30 â†’ 22)
```

**Comandos**:
```powershell
# Escanear vulnerabilidades
cd backend
dotnet list AuthService/AuthService.Api/AuthService.Api.csproj package --vulnerable --include-transitive
dotnet list Gateway/Gateway.Api/Gateway.Api.csproj package --vulnerable --include-transitive
dotnet list ErrorService/ErrorService.Api/ErrorService.Api.csproj package --vulnerable --include-transitive
dotnet list NotificationService/NotificationService.Api/NotificationService.Api.csproj package --vulnerable --include-transitive

# Crear Directory.Packages.props
New-Item -Path "Directory.Packages.props" -ItemType File

# Actualizar packages especÃ­ficos
dotnet add Gateway/Gateway.Api package System.Text.Json --version 8.0.5
dotnet add Gateway/Gateway.Api package Microsoft.Data.SqlClient --version 5.1.3
dotnet add Gateway/Gateway.Api package System.Formats.Asn1 --version 8.0.1
dotnet add ErrorService/ErrorService.Api package System.Text.Json --version 8.0.5
dotnet add NotificationService/NotificationService.Api package System.Text.Json --version 8.0.5

# Rebuild y test
dotnet build
dotnet test
```

---

### US-4.2: Migrar AuthService a Alpine Linux
**Prioridad**: ALTA  
**EstimaciÃ³n**: 60 minutos  
**Responsable**: DevOps Team

**DescripciÃ³n**:
Migrar AuthService de bookworm-slim a Alpine para eliminar vulnerabilidades OS.

**Tareas**:
1. âœ… Actualizar Dockerfile de AuthService a base Alpine
2. âœ… Adaptar comandos RUN para Alpine (adduser, addgroup)
3. âœ… Reconstruir imagen
4. âœ… Validar funcionamiento con tests
5. âœ… Escanear con Trivy
6. âœ… Actualizar docker-compose.yml si necesario

**Criterios de AceptaciÃ³n**:
- [ ] AuthService usando aspnet:8.0-alpine
- [ ] Imagen construida exitosamente
- [ ] TamaÃ±o de imagen â‰¤ 350MB
- [ ] 0 vulnerabilidades HIGH/CRITICAL
- [ ] Health check funcionando

**Impacto Esperado**:
```
AuthService: 4 HIGH â†’ 0 HIGH (-4 vulnerabilidades OS)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REDUCCIÃ“N ESPERADA: -4 HIGH (22 â†’ 18)
```

**Dockerfile Template**:
```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0-alpine AS final
WORKDIR /app
EXPOSE 8080
EXPOSE 8081

RUN addgroup -g 1000 appuser && \
    adduser -D -u 1000 -G appuser appuser && \
    chown -R appuser:appuser /app

USER appuser

COPY --from=publish --chown=appuser:appuser /app/publish .

HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD dotnet /app/AuthService.Api.dll --help > /dev/null 2>&1 || exit 1

ENTRYPOINT ["dotnet", "AuthService.Api.dll"]
```

---

### US-4.3: Migrar Gateway a Alpine Linux
**Prioridad**: ALTA  
**EstimaciÃ³n**: 60 minutos  
**Responsable**: DevOps Team

**DescripciÃ³n**:
Migrar Gateway de bookworm-slim a Alpine para eliminar vulnerabilidades OS.

**Tareas**:
1. âœ… Actualizar Dockerfile de Gateway a base Alpine
2. âœ… Adaptar comandos RUN para Alpine
3. âœ… Reconstruir imagen
4. âœ… Validar funcionamiento (API Gateway crÃ­tico)
5. âœ… Escanear con Trivy
6. âœ… Tests end-to-end

**Criterios de AceptaciÃ³n**:
- [ ] Gateway usando aspnet:8.0-alpine
- [ ] Imagen construida exitosamente
- [ ] TamaÃ±o de imagen â‰¤ 350MB
- [ ] 0-2 vulnerabilidades HIGH mÃ¡ximo (solo .NET si quedan)
- [ ] Health check funcionando
- [ ] Routing a servicios backend funcional

**Impacto Esperado**:
```
Gateway: 4 HIGH (despuÃ©s US-4.1) â†’ 0 HIGH (-4 vulnerabilidades OS)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REDUCCIÃ“N ESPERADA: -4 HIGH (18 â†’ 14)
```

---

### US-4.4: Migrar ErrorService a Alpine Linux
**Prioridad**: MEDIA  
**EstimaciÃ³n**: 45 minutos  
**Responsable**: DevOps Team

**DescripciÃ³n**:
Migrar ErrorService de bookworm-slim a Alpine.

**Tareas**:
1. âœ… Actualizar Dockerfile a Alpine
2. âœ… Reconstruir y validar
3. âœ… Escanear con Trivy
4. âœ… Corregir errores de DI preexistentes (opcional)

**Criterios de AceptaciÃ³n**:
- [ ] ErrorService usando aspnet:8.0-alpine
- [ ] 0 vulnerabilidades HIGH/CRITICAL
- [ ] TamaÃ±o â‰¤ 350MB

**Impacto Esperado**:
```
ErrorService: 4 HIGH (despuÃ©s US-4.1) â†’ 0 HIGH (-4 vulnerabilidades OS)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REDUCCIÃ“N ESPERADA: -4 HIGH (14 â†’ 10)
```

---

### US-4.5: Migrar NotificationService a Alpine Linux
**Prioridad**: MEDIA  
**EstimaciÃ³n**: 45 minutos  
**Responsable**: DevOps Team

**DescripciÃ³n**:
Migrar NotificationService de bookworm-slim a Alpine.

**Tareas**:
1. âœ… Actualizar Dockerfile a Alpine
2. âœ… Reconstruir y validar
3. âœ… Escanear con Trivy
4. âœ… Corregir errores de DI preexistentes (opcional)

**Criterios de AceptaciÃ³n**:
- [ ] NotificationService usando aspnet:8.0-alpine
- [ ] 0 vulnerabilidades HIGH/CRITICAL
- [ ] TamaÃ±o â‰¤ 350MB

**Impacto Esperado**:
```
NotificationService: 4 HIGH (despuÃ©s US-4.1) â†’ 0 HIGH (-4 vulnerabilidades OS)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REDUCCIÃ“N ESPERADA: -4 HIGH (10 â†’ 6)
```

---

### US-4.6: Migrar ConfigurationService a Alpine Actualizado
**Prioridad**: BAJA  
**EstimaciÃ³n**: 30 minutos  
**Responsable**: DevOps Team

**DescripciÃ³n**:
ConfigurationService ya usa Alpine, pero validar que estÃ© en la Ãºltima versiÃ³n.

**Tareas**:
1. âœ… Verificar versiÃ³n actual de Alpine
2. âœ… Actualizar a aspnet:8.0-alpine si no estÃ¡ actualizado
3. âœ… Reconstruir y escanear
4. âœ… Validar reducciÃ³n de vulnerabilidades

**Criterios de AceptaciÃ³n**:
- [ ] ConfigurationService en aspnet:8.0-alpine latest
- [ ] â‰¤ 2 vulnerabilidades HIGH (objetivo: 0)

**Impacto Esperado**:
```
ConfigurationService: 6 HIGH â†’ 0-2 HIGH (-4 a -6 vulnerabilidades)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REDUCCIÃ“N ESPERADA: -4 HIGH promedio (6 â†’ 2)
```

---

### US-4.7: Crear SECURITY_POLICIES.md y AutomatizaciÃ³n
**Prioridad**: MEDIA  
**EstimaciÃ³n**: 45 minutos  
**Responsable**: Security Team

**DescripciÃ³n**:
Documentar polÃ­ticas de seguridad y configurar escaneo automÃ¡tico.

**Tareas**:
1. âœ… Crear SECURITY_POLICIES.md
2. âœ… Documentar procedimientos de respuesta a incidentes
3. âœ… PolÃ­ticas de rotaciÃ³n de secretos
4. âœ… Calendario de actualizaciones de contenedores
5. âœ… Script de escaneo automÃ¡tico semanal
6. âœ… Thresholds de vulnerabilidades aceptables

**Criterios de AceptaciÃ³n**:
- [ ] SECURITY_POLICIES.md creado y completo
- [ ] Script de escaneo automÃ¡tico funcionando
- [ ] Thresholds documentados: 0 CRITICAL, â‰¤5 HIGH, â‰¤20 MEDIUM

**Template SECURITY_POLICIES.md**:
```markdown
# ğŸ”’ PolÃ­ticas de Seguridad - CarDealer Microservices

## 1. GestiÃ³n de Vulnerabilidades

### Thresholds Aceptables
- **CRITICAL**: 0 (deployment bloqueado)
- **HIGH**: â‰¤5 (revisiÃ³n requerida)
- **MEDIUM**: â‰¤20 (monitoreo)
- **LOW**: Sin lÃ­mite (best effort)

### Calendario de Escaneo
- **Diario**: Escaneo automÃ¡tico en CI/CD
- **Semanal**: Escaneo completo de todas las imÃ¡genes
- **Mensual**: AuditorÃ­a de seguridad completa

### Procedimientos de RemediaciÃ³n
1. **CRITICAL**: Parchar en 24 horas
2. **HIGH**: Parchar en 7 dÃ­as
3. **MEDIUM**: Parchar en 30 dÃ­as

## 2. RotaciÃ³n de Secretos

### Calendario
- **RabbitMQ credentials**: Cada 90 dÃ­as
- **PostgreSQL passwords**: Cada 60 dÃ­as
- **API Keys**: Cada 30 dÃ­as
- **Certificates**: Cada 365 dÃ­as

### Procedimiento
[...]

## 3. Actualizaciones de Contenedores

### ImÃ¡genes Base
- **Parches seguridad**: Inmediato
- **Versiones menores**: Mensual
- **Versiones mayores**: Trimestral (con testing)

## 4. Respuesta a Incidentes

### ClasificaciÃ³n
- **P0**: Vulnerabilidad CRITICAL explotada
- **P1**: Vulnerabilidad CRITICAL descubierta
- **P2**: Vulnerabilidad HIGH explotada
- **P3**: Vulnerabilidad HIGH descubierta

### Procedimiento
[...]
```

---

### US-4.8: Escaneo Final y ValidaciÃ³n
**Prioridad**: CRÃTICA  
**EstimaciÃ³n**: 30 minutos  
**Responsable**: DevOps Team

**DescripciÃ³n**:
Ejecutar escaneo final con Trivy y validar que se alcanzÃ³ el objetivo de 0 vulnerabilidades HIGH.

**Tareas**:
1. âœ… Reconstruir todas las 6 imÃ¡genes con cambios
2. âœ… Ejecutar Trivy scan en todas las imÃ¡genes
3. âœ… Generar reporte comparativo Sprint 3 vs Sprint 4
4. âœ… Validar 0 HIGH, 0 CRITICAL
5. âœ… Documentar en SPRINT4_COMPLETION_REPORT.md

**Criterios de AceptaciÃ³n**:
- [ ] Todas las imÃ¡genes con 0 CRITICAL
- [ ] Todas las imÃ¡genes con 0 HIGH (objetivo stretch)
- [ ] Reporte comparativo generado
- [ ] MÃ©tricas documentadas

**Impacto Esperado**:
```
SPRINT 3 FINAL: 30 HIGH, 0 CRITICAL
SPRINT 4 TARGET: 0 HIGH, 0 CRITICAL âœ…
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REDUCCIÃ“N: -30 HIGH (-100%)
```

---

## ğŸ“ˆ Progreso Esperado del Sprint

### Secuencia de EjecuciÃ³n Recomendada

```
DÃ­a 1 (3-4 horas):
â”œâ”€ US-4.1: Actualizar .NET Packages (90 min)
â”‚  â””â”€ ReducciÃ³n: 30 â†’ 22 HIGH
â”œâ”€ US-4.2: Migrar AuthService a Alpine (60 min)
â”‚  â””â”€ ReducciÃ³n: 22 â†’ 18 HIGH
â””â”€ US-4.3: Migrar Gateway a Alpine (60 min)
   â””â”€ ReducciÃ³n: 18 â†’ 14 HIGH

DÃ­a 2 (2-3 horas):
â”œâ”€ US-4.4: Migrar ErrorService a Alpine (45 min)
â”‚  â””â”€ ReducciÃ³n: 14 â†’ 10 HIGH
â”œâ”€ US-4.5: Migrar NotificationService a Alpine (45 min)
â”‚  â””â”€ ReducciÃ³n: 10 â†’ 6 HIGH
â”œâ”€ US-4.6: Actualizar ConfigurationService (30 min)
â”‚  â””â”€ ReducciÃ³n: 6 â†’ 2 HIGH
â”œâ”€ US-4.7: SECURITY_POLICIES.md (45 min)
â””â”€ US-4.8: Escaneo Final (30 min)
   â””â”€ Validar: 0 HIGH objetivo alcanzado
```

### GrÃ¡fico de ReducciÃ³n Progresiva

```
Sprint 3 Final:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 30 HIGH
After US-4.1:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 22 HIGH (-27%)
After US-4.2:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 18 HIGH (-40%)
After US-4.3:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 14 HIGH (-53%)
After US-4.4:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 10 HIGH (-67%)
After US-4.5:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  6 HIGH (-80%)
After US-4.6:    â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  2 HIGH (-93%)
Sprint 4 Target: â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  0 HIGH âœ… (-100%)
```

---

## ğŸ¯ MÃ©tricas de Ã‰xito

### MÃ©tricas Primarias

| MÃ©trica | Sprint 3 | Objetivo Sprint 4 | Meta Stretch |
|---------|----------|-------------------|--------------|
| **Vulnerabilidades CRITICAL** | 0 | 0 | 0 âœ… |
| **Vulnerabilidades HIGH** | 30 | **0** | 0 ğŸ¯ |
| **Servicios 100% seguros** | 1/6 (17%) | 6/6 (100%) | 6/6 âœ… |
| **Servicios en Alpine** | 2/6 (33%) | 6/6 (100%) | 6/6 âœ… |

### MÃ©tricas Secundarias

| MÃ©trica | Sprint 3 | Objetivo Sprint 4 |
|---------|----------|-------------------|
| **TamaÃ±o promedio imÃ¡genes** | 331MB | â‰¤300MB |
| **Tiempo de escaneo Trivy** | ~5 min | ~3 min |
| **Paquetes .NET vulnerables** | ~8 | 0 |
| **OS packages vulnerables** | ~22 | 0 |

---

## ğŸ”§ Herramientas y Comandos

### Escaneo de Vulnerabilidades .NET

```powershell
# Escanear proyecto individual
dotnet list <proyecto.csproj> package --vulnerable --include-transitive

# Escanear todos los servicios
$projects = @(
    "AuthService/AuthService.Api/AuthService.Api.csproj",
    "Gateway/Gateway.Api/Gateway.Api.csproj",
    "ErrorService/ErrorService.Api/ErrorService.Api.csproj",
    "NotificationService/NotificationService.Api/NotificationService.Api.csproj",
    "ConfigurationService/ConfigurationService.Api/ConfigurationService.Api.csproj",
    "MessageBusService/MessageBusService.Api.csproj"
)

foreach ($proj in $projects) {
    Write-Host "`n=== Escaneando $proj ===" -ForegroundColor Cyan
    dotnet list $proj package --vulnerable --include-transitive
}
```

### ActualizaciÃ³n de Packages

```powershell
# MÃ©todo 1: ActualizaciÃ³n directa
dotnet add <proyecto> package <PackageName> --version <Version>

# MÃ©todo 2: Directory.Packages.props (recomendado)
# 1. Crear Directory.Packages.props en backend/
# 2. Agregar <ManagePackageVersionsCentrally>true</ManagePackageVersionsCentrally>
# 3. Listar versiones centralizadas
```

### MigraciÃ³n a Alpine

```powershell
# Template Dockerfile Alpine
$alpineTemplate = @"
FROM mcr.microsoft.com/dotnet/aspnet:8.0-alpine AS final
WORKDIR /app
EXPOSE 8080
EXPOSE 8081

RUN addgroup -g 1000 appuser && \
    adduser -D -u 1000 -G appuser appuser && \
    chown -R appuser:appuser /app

USER appuser

COPY --from=publish --chown=appuser:appuser /app/publish .

HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD dotnet /app/ServiceName.Api.dll --help > /dev/null 2>&1 || exit 1

ENTRYPOINT ["dotnet", "ServiceName.Api.dll"]
"@

# Aplicar a cada servicio (reemplazar ServiceName)
```

### Build y Escaneo

```powershell
# Build de imagen
docker build --no-cache -f <ServiceName>/Dockerfile -t backend-<servicename>:latest .

# Escaneo Trivy
trivy image --severity HIGH,CRITICAL --format table backend-<servicename>:latest

# Escaneo completo con JSON
trivy image --severity HIGH,CRITICAL --format json backend-<servicename>:latest | ConvertFrom-Json
```

### Escaneo Final Automatizado

```powershell
# Script completo para US-4.8
$services = @("authservice", "gateway", "errorservice", "notificationservice", "configurationservice", "messagebusservice")

Write-Host "`n=== ESCANEO FINAL - SPRINT 4 ===" -ForegroundColor Green

$results = @()
foreach ($svc in $services) {
    $img = "backend-$svc:latest"
    Write-Host "`nEscaneando $img..." -ForegroundColor Cyan
    
    $output = trivy image --severity HIGH,CRITICAL --format json $img 2>$null | ConvertFrom-Json
    $high = ($output.Results.Vulnerabilities | Where-Object { $_.Severity -eq "HIGH" }).Count
    $critical = ($output.Results.Vulnerabilities | Where-Object { $_.Severity -eq "CRITICAL" }).Count
    
    $results += [PSCustomObject]@{
        Service = $svc
        HIGH = $high
        CRITICAL = $critical
        Total = $high + $critical
        Status = if ($high -eq 0 -and $critical -eq 0) { "âœ… PERFECTO" } elseif ($high -le 2) { "âš ï¸ ACEPTABLE" } else { "âŒ REQUIERE TRABAJO" }
    }
}

$results | Format-Table -AutoSize

Write-Host "`nğŸ“Š RESUMEN:" -ForegroundColor Yellow
Write-Host "Total HIGH: $(($results | Measure-Object -Property HIGH -Sum).Sum)"
Write-Host "Total CRITICAL: $(($results | Measure-Object -Property CRITICAL -Sum).Sum)"
Write-Host "Servicios perfectos (0 vulnerabilities): $(($results | Where-Object { $_.Total -eq 0 }).Count)/6"

if ((($results | Measure-Object -Property Total -Sum).Sum) -eq 0) {
    Write-Host "`nğŸ‰ Â¡OBJETIVO ALCANZADO! 0 vulnerabilidades HIGH/CRITICAL" -ForegroundColor Green
}
```

---

## âš ï¸ Riesgos y Mitigaciones

### Riesgo 1: Incompatibilidades con Alpine
**Probabilidad**: Media  
**Impacto**: Alto  
**DescripciÃ³n**: Algunos paquetes .NET pueden tener problemas con Alpine (libc vs glibc)

**MitigaciÃ³n**:
- Testing exhaustivo despuÃ©s de cada migraciÃ³n
- Rollback plan: mantener Dockerfiles bookworm-slim como backup
- Usar alpine3.18+ que tiene mejor soporte .NET

---

### Riesgo 2: Breaking Changes en Package Updates
**Probabilidad**: Media  
**Impacto**: Alto  
**DescripciÃ³n**: Actualizar paquetes .NET puede introducir breaking changes

**MitigaciÃ³n**:
- Revisar changelogs de cada paquete antes de actualizar
- Actualizar solo versiones patch/minor cuando sea posible
- Ejecutar suite completa de tests despuÃ©s de actualizar
- Tener branch de backup antes de cambios

---

### Riesgo 3: Errores de DI Preexistentes
**Probabilidad**: Alta  
**Impacto**: Medio  
**DescripciÃ³n**: Algunos servicios tienen errores de DI que pueden complicar testing

**MitigaciÃ³n**:
- Corregir errores de DI como parte de US-4.2 a US-4.5
- Documentar workarounds si no se pueden corregir inmediatamente
- Separar validaciÃ³n de seguridad de validaciÃ³n funcional

---

### Riesgo 4: Vulnerabilidades OS sin Fix
**Probabilidad**: Baja  
**Impacto**: Alto  
**DescripciÃ³n**: Algunas vulnerabilidades (como zlib1g) estÃ¡n marcadas "will_not_fix"

**MitigaciÃ³n**:
- Migrar a Alpine que no tiene estas vulnerabilidades
- Documentar en SECURITY_POLICIES.md las vulnerabilidades conocidas aceptadas
- Implementar controles compensatorios (network policies, etc.)

---

## ğŸ“š DocumentaciÃ³n a Generar

### Durante el Sprint
1. âœ… **SPRINT4_PROGRESS_TRACKING.md** - Tracking diario de progreso
2. âœ… **Directory.Packages.props** - GestiÃ³n centralizada de paquetes
3. âœ… **SECURITY_POLICIES.md** - PolÃ­ticas de seguridad
4. âœ… **Dockerfiles actualizados** - 4 servicios migrados a Alpine

### Al Finalizar el Sprint
5. âœ… **SPRINT4_COMPLETION_REPORT.md** - Reporte final con mÃ©tricas
6. âœ… **SECURITY_SCAN_SPRINT4.md** - Resultados del escaneo final
7. âœ… **VULNERABILITY_COMPARISON_S3_S4.md** - Comparativa Sprint 3 vs Sprint 4
8. âœ… **SPRINTS_OVERVIEW.md actualizado** - Progreso general del proyecto

---

## ğŸ¯ DefiniciÃ³n de Completado (DoD)

### Para cada User Story
- [ ] CÃ³digo implementado y commiteado
- [ ] Tests unitarios pasando (si aplica)
- [ ] Imagen Docker construida exitosamente
- [ ] Escaneo Trivy ejecutado y documentado
- [ ] ReducciÃ³n de vulnerabilidades validada
- [ ] DocumentaciÃ³n actualizada

### Para el Sprint Completo
- [ ] Todas las US completadas
- [ ] **0 vulnerabilidades CRITICAL en todas las imÃ¡genes**
- [ ] **0 vulnerabilidades HIGH en todas las imÃ¡genes** (objetivo)
- [ ] 6/6 servicios en Alpine Linux
- [ ] SECURITY_POLICIES.md creado
- [ ] Directory.Packages.props implementado
- [ ] SPRINT4_COMPLETION_REPORT.md generado
- [ ] SPRINTS_OVERVIEW.md actualizado
- [ ] Sprint Review realizado

---

## ğŸš€ Quick Start

### Paso 1: PreparaciÃ³n
```powershell
cd C:\Users\gmoreno\source\repos\cardealer\backend

# Crear branch para Sprint 4
git checkout -b sprint-4-vulnerability-elimination

# Backup de Dockerfiles actuales
Copy-Item AuthService/Dockerfile AuthService/Dockerfile.sprint3.backup
Copy-Item Gateway/Dockerfile Gateway/Dockerfile.sprint3.backup
Copy-Item ErrorService/Dockerfile ErrorService/Dockerfile.sprint3.backup
Copy-Item NotificationService/Dockerfile NotificationService/Dockerfile.sprint3.backup
```

### Paso 2: Ejecutar US-4.1 (Actualizar .NET Packages)
```powershell
# Escanear vulnerabilidades
.\scripts\scan-dotnet-vulnerabilities.ps1

# Actualizar packages
# (Ver comandos en US-4.1)

# Build y test
dotnet build
dotnet test
```

### Paso 3: Ejecutar US-4.2 a US-4.6 (Migraciones Alpine)
```powershell
# Para cada servicio:
# 1. Actualizar Dockerfile con template Alpine
# 2. Build imagen
# 3. Escanear con Trivy
# 4. Validar funcionamiento

# Ejemplo para AuthService
docker build --no-cache -f AuthService/Dockerfile -t backend-authservice:latest .
trivy image --severity HIGH,CRITICAL backend-authservice:latest
docker-compose up -d authservice
docker logs authservice --tail 50
```

### Paso 4: Ejecutar US-4.7 (SECURITY_POLICIES.md)
```powershell
# Crear archivo (usar template en US-4.7)
New-Item -Path "SECURITY_POLICIES.md" -ItemType File

# Editar con VS Code
code SECURITY_POLICIES.md
```

### Paso 5: Ejecutar US-4.8 (Escaneo Final)
```powershell
# Usar script automatizado (ver US-4.8)
.\scripts\final-security-scan-sprint4.ps1
```

---

## ğŸ“Š Dashboard de MÃ©tricas en Tiempo Real

```powershell
# Script para tracking en tiempo real
function Get-Sprint4Progress {
    Write-Host "`n=== SPRINT 4 PROGRESS DASHBOARD ===" -ForegroundColor Green
    
    $services = @("authservice", "gateway", "errorservice", "notificationservice", "configurationservice", "messagebusservice")
    $totalHigh = 0
    $totalCritical = 0
    $perfectServices = 0
    
    foreach ($svc in $services) {
        $img = "backend-$svc:latest"
        $output = trivy image --severity HIGH,CRITICAL --format json $img 2>$null | ConvertFrom-Json
        $high = ($output.Results.Vulnerabilities | Where-Object { $_.Severity -eq "HIGH" }).Count
        $critical = ($output.Results.Vulnerabilities | Where-Object { $_.Severity -eq "CRITICAL" }).Count
        
        $totalHigh += $high
        $totalCritical += $critical
        if ($high -eq 0 -and $critical -eq 0) { $perfectServices++ }
    }
    
    $progress = [math]::Round((($perfectServices / 6) * 100), 2)
    
    Write-Host "`nğŸ“Š Vulnerabilidades Totales:"
    Write-Host "   HIGH: $totalHigh (Objetivo: 0)"
    Write-Host "   CRITICAL: $totalCritical (Objetivo: 0)"
    Write-Host "`nâœ… Servicios Perfectos: $perfectServices/6 ($progress%)"
    Write-Host "`nğŸ¯ Progreso Sprint: $progress% completado"
    
    # Progress bar
    $barLength = 40
    $filled = [math]::Round(($progress / 100) * $barLength)
    $bar = "â–ˆ" * $filled + "â–‘" * ($barLength - $filled)
    Write-Host "`n[$bar] $progress%"
}

# Ejecutar dashboard
Get-Sprint4Progress
```

---

## ğŸ‰ Resultado Final Esperado

### Sprint 3 vs Sprint 4 Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚ Sprint 1     â”‚ Sprint 3     â”‚ Sprint 4     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CRITICAL        â”‚ 6            â”‚ 0 (-100%)    â”‚ 0 âœ…         â”‚
â”‚ HIGH            â”‚ 48           â”‚ 30 (-38%)    â”‚ 0 (-100%) ğŸ‰ â”‚
â”‚ TOTAL           â”‚ 54           â”‚ 30 (-44%)    â”‚ 0 (-100%) ğŸ‰ â”‚
â”‚ Servicios Alpineâ”‚ 0            â”‚ 2            â”‚ 6 âœ…         â”‚
â”‚ TamaÃ±o promedio â”‚ 2.75GB       â”‚ 331MB        â”‚ ~280MB âœ…    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

MEJORA TOTAL: De 54 vulnerabilidades a 0 = -100% ğŸ†
```

---

**Preparado por**: GitHub Copilot AI Agent  
**Fecha**: 3 de diciembre de 2025  
**Sprint**: Sprint 4 - Vulnerability Elimination  
**VersiÃ³n**: 1.0 - Plan Inicial

---

## ğŸ”— Referencias

- [Sprint 3 Completion Report](./SPRINT3_COMPLETION_REPORT.md)
- [Sprint 3 Metrics Summary](./SPRINT3_METRICS_SUMMARY.md)
- [Sprints Overview](./SPRINTS_OVERVIEW.md)
- [Trivy Documentation](https://aquasecurity.github.io/trivy/)
- [Alpine Linux .NET Support](https://hub.docker.com/_/microsoft-dotnet-aspnet/)
