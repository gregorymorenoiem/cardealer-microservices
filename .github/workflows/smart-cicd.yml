# =============================================================================
# SMART TRIGGERS CI/CD - Monorepo Orchestrator
# =============================================================================
# Detecta quÃ© servicios cambiaron y solo ejecuta CI/CD para ellos
# Ahorra ~80% de minutos de GitHub Actions
#
# Branching Strategy:
#   - main: ProducciÃ³n (deploy automÃ¡tico a DOKS)
#   - development: Staging/IntegraciÃ³n (build + tests)
#   - sprint/*: Solo tests, no build imÃ¡genes
# =============================================================================

name: ðŸš€ Smart CI/CD

on:
  push:
    branches: [main, development]
  pull_request:
    branches: [main, development]

# Required permissions to push to GHCR
permissions:
  contents: read
  packages: write

# Evita ejecuciones duplicadas
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # STEP 1: Detectar cambios
  # ============================================
  detect-changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      # Backend services
      authservice: ${{ steps.filter.outputs.authservice }}
      userservice: ${{ steps.filter.outputs.userservice }}
      roleservice: ${{ steps.filter.outputs.roleservice }}
      errorservice: ${{ steps.filter.outputs.errorservice }}
      notificationservice: ${{ steps.filter.outputs.notificationservice }}
      vehiclessaleservice: ${{ steps.filter.outputs.vehiclessaleservice }}
      # Disabled temporarily - not in use
      # vehiclesrentservice: ${{ steps.filter.outputs.vehiclesrentservice }}
      # propertiessaleservice: ${{ steps.filter.outputs.propertiessaleservice }}
      # propertiesrentservice: ${{ steps.filter.outputs.propertiesrentservice }}
      mediaservice: ${{ steps.filter.outputs.mediaservice }}
      billingservice: ${{ steps.filter.outputs.billingservice }}
      crmservice: ${{ steps.filter.outputs.crmservice }}
      # Sprint 1 microservices
      maintenanceservice: ${{ steps.filter.outputs.maintenanceservice }}
      comparisonservice: ${{ steps.filter.outputs.comparisonservice }}
      alertservice: ${{ steps.filter.outputs.alertservice }}
      # Sprint 2 microservices
      contactservice: ${{ steps.filter.outputs.contactservice }}
      # Sprint 14 microservices
      reviewservice: ${{ steps.filter.outputs.reviewservice }}
      # Production-deployed services
      kycservice: ${{ steps.filter.outputs.kycservice }}
      auditservice: ${{ steps.filter.outputs.auditservice }}
      idempotencyservice: ${{ steps.filter.outputs.idempotencyservice }}
      adminservice: ${{ steps.filter.outputs.adminservice }}
      gateway: ${{ steps.filter.outputs.gateway }}
      # Dealer Management
      dealermanagementservice: ${{ steps.filter.outputs.dealermanagementservice }}
      # Chatbot (MLOps pipeline)
      chatbotservice: ${{ steps.filter.outputs.chatbotservice }}
      llm-server: ${{ steps.filter.outputs.llm-server }}
      # Shared libraries
      shared: ${{ steps.filter.outputs.shared }}
      # Frontend
      frontend-web: ${{ steps.filter.outputs.frontend-web }}
      # Infrastructure
      infrastructure: ${{ steps.filter.outputs.infrastructure }}

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            # Backend microservices
            authservice:
              - 'backend/AuthService/**'
              - 'backend/_Shared/**'
            userservice:
              - 'backend/UserService/**'
              - 'backend/_Shared/**'
            roleservice:
              - 'backend/RoleService/**'
              - 'backend/_Shared/**'
            errorservice:
              - 'backend/ErrorService/**'
              - 'backend/_Shared/**'
            notificationservice:
              - 'backend/NotificationService/**'
              - 'backend/_Shared/**'
            vehiclessaleservice:
              - 'backend/VehiclesSaleService/**'
              - 'backend/_Shared/**'
            # Disabled temporarily - not in use
            # vehiclesrentservice:
            #   - 'backend/VehiclesRentService/**'
            #   - 'backend/_Shared/**'
            # propertiessaleservice:
            #   - 'backend/PropertiesSaleService/**'
            #   - 'backend/_Shared/**'
            # propertiesrentservice:
            #   - 'backend/PropertiesRentService/**'
            #   - 'backend/_Shared/**'
            mediaservice:
              - 'backend/MediaService/**'
              - 'backend/_Shared/**'
            billingservice:
              - 'backend/BillingService/**'
              - 'backend/_Shared/**'
            crmservice:
              - 'backend/CRMService/**'
              - 'backend/_Shared/**'
            # Sprint 1 microservices
            maintenanceservice:
              - 'backend/MaintenanceService/**'
              - 'backend/_Shared/**'
            comparisonservice:
              - 'backend/ComparisonService/**'
              - 'backend/_Shared/**'
            alertservice:
              - 'backend/AlertService/**'
              - 'backend/_Shared/**'
            # Sprint 2 microservices
            contactservice:
              - 'backend/ContactService/**'
              - 'backend/_Shared/**'
            # Sprint 14 microservices
            reviewservice:
              - 'backend/ReviewService/**'
              - 'backend/_Shared/**'
            # Production-deployed services
            kycservice:
              - 'backend/KYCService/**'
              - 'backend/_Shared/**'
            auditservice:
              - 'backend/AuditService/**'
              - 'backend/_Shared/**'
            idempotencyservice:
              - 'backend/IdempotencyService/**'
              - 'backend/_Shared/**'
            adminservice:
              - 'backend/AdminService/**'
              - 'backend/_Shared/**'
            dealermanagementservice:
              - 'backend/DealerManagementService/**'
              - 'backend/_Shared/**'
            chatbotservice:
              - 'backend/ChatbotService/ChatbotService.Api/**'
              - 'backend/ChatbotService/ChatbotService.Application/**'
              - 'backend/ChatbotService/ChatbotService.Domain/**'
              - 'backend/ChatbotService/ChatbotService.Infrastructure/**'
              - 'backend/ChatbotService/Dockerfile'
              - 'backend/_Shared/**'
            llm-server:
              - 'backend/ChatbotService/LlmServer/**'
            gateway:
              - 'backend/Gateway/**'
            # Shared libraries (triggers rebuild of dependent services)
            shared:
              - 'backend/_Shared/**'
            # Frontend
            frontend-web:
              - 'frontend/web-next/**'
            # Infrastructure
            infrastructure:
              - 'k8s/**'
              - 'helm/**'
              - 'compose.yaml'
              - 'compose.*.yaml'

      - name: ðŸ“Š Summary of changes
        run: |
          echo "## ðŸ“Š Detected Changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| AuthService | ${{ steps.filter.outputs.authservice }} |" >> $GITHUB_STEP_SUMMARY
          echo "| UserService | ${{ steps.filter.outputs.userservice }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ErrorService | ${{ steps.filter.outputs.errorservice }} |" >> $GITHUB_STEP_SUMMARY
          echo "| MaintenanceService | ${{ steps.filter.outputs.maintenanceservice }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ComparisonService | ${{ steps.filter.outputs.comparisonservice }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AlertService | ${{ steps.filter.outputs.alertservice }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ContactService | ${{ steps.filter.outputs.contactservice }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ReviewService | ${{ steps.filter.outputs.reviewservice }} |" >> $GITHUB_STEP_SUMMARY
          echo "| KYCService | ${{ steps.filter.outputs.kycservice }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AuditService | ${{ steps.filter.outputs.auditservice }} |" >> $GITHUB_STEP_SUMMARY
          echo "| IdempotencyService | ${{ steps.filter.outputs.idempotencyservice }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AdminService | ${{ steps.filter.outputs.adminservice }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DealerManagementService | ${{ steps.filter.outputs.dealermanagementservice }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ChatbotService | ${{ steps.filter.outputs.chatbotservice }} |" >> $GITHUB_STEP_SUMMARY
          echo "| LLM Server | ${{ steps.filter.outputs.llm-server }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gateway | ${{ steps.filter.outputs.gateway }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Web | ${{ steps.filter.outputs.frontend-web }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Shared Libraries | ${{ steps.filter.outputs.shared }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # BACKEND SERVICES (Conditional)
  # ============================================

  authservice:
    name: ðŸ” AuthService
    needs: detect-changes
    if: needs.detect-changes.outputs.authservice == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: authservice
      service-path: backend/AuthService
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  userservice:
    name: ðŸ‘¤ UserService
    needs: detect-changes
    if: needs.detect-changes.outputs.userservice == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: userservice
      service-path: backend/UserService
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  roleservice:
    name: ðŸŽ­ RoleService
    needs: detect-changes
    if: needs.detect-changes.outputs.roleservice == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: roleservice
      service-path: backend/RoleService
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  errorservice:
    name: âš ï¸ ErrorService
    needs: detect-changes
    if: needs.detect-changes.outputs.errorservice == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: errorservice
      service-path: backend/ErrorService
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  notificationservice:
    name: ðŸ“¬ NotificationService
    needs: detect-changes
    if: needs.detect-changes.outputs.notificationservice == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: notificationservice
      service-path: backend/NotificationService
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  vehiclessaleservice:
    name: ðŸš— VehiclesSaleService
    needs: detect-changes
    if: needs.detect-changes.outputs.vehiclessaleservice == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: vehiclessaleservice
      service-path: backend/VehiclesSaleService
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  # Disabled temporarily - not in use (code errors pending fix)
  # vehiclesrentservice:
  #   name: ðŸš™ VehiclesRentService
  #   needs: detect-changes
  #   if: needs.detect-changes.outputs.vehiclesrentservice == 'true'
  #   uses: ./.github/workflows/_reusable-dotnet-service.yml
  #   with:
  #     service-name: vehiclesrentservice
  #     service-path: backend/VehiclesRentService
  #     run-docker-push: ${{ github.ref == 'refs/heads/main' }}
  #   secrets: inherit

  # propertiessaleservice:
  #   name: ðŸ  PropertiesSaleService
  #   needs: detect-changes
  #   if: needs.detect-changes.outputs.propertiessaleservice == 'true'
  #   uses: ./.github/workflows/_reusable-dotnet-service.yml
  #   with:
  #     service-name: propertiessaleservice
  #     service-path: backend/PropertiesSaleService
  #     run-docker-push: ${{ github.ref == 'refs/heads/main' }}
  #   secrets: inherit

  # propertiesrentservice:
  #   name: ðŸ¢ PropertiesRentService
  #   needs: detect-changes
  #   if: needs.detect-changes.outputs.propertiesrentservice == 'true'
  #   uses: ./.github/workflows/_reusable-dotnet-service.yml
  #   with:
  #     service-name: propertiesrentservice
  #     service-path: backend/PropertiesRentService
  #     run-docker-push: ${{ github.ref == 'refs/heads/main' }}
  #   secrets: inherit

  mediaservice:
    name: ðŸ“¸ MediaService
    needs: detect-changes
    if: needs.detect-changes.outputs.mediaservice == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: mediaservice
      service-path: backend/MediaService
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  billingservice:
    name: ðŸ’³ BillingService
    needs: detect-changes
    if: needs.detect-changes.outputs.billingservice == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: billingservice
      service-path: backend/BillingService
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  # ============================================
  # SPRINT 1 MICROSERVICES (New)
  # ============================================
  maintenanceservice:
    name: ðŸ› ï¸ MaintenanceService
    needs: detect-changes
    if: needs.detect-changes.outputs.maintenanceservice == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: maintenanceservice
      service-path: backend/MaintenanceService
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  comparisonservice:
    name: ðŸ”„ ComparisonService
    needs: detect-changes
    if: needs.detect-changes.outputs.comparisonservice == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: comparisonservice
      service-path: backend/ComparisonService
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  alertservice:
    name: ðŸ”” AlertService
    needs: detect-changes
    if: needs.detect-changes.outputs.alertservice == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: alertservice
      service-path: backend/AlertService
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  contactservice:
    name: ðŸ“ž ContactService
    needs: detect-changes
    if: needs.detect-changes.outputs.contactservice == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: contactservice
      service-path: backend/ContactService
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  reviewservice:
    name: â­ ReviewService
    needs: detect-changes
    if: needs.detect-changes.outputs.reviewservice == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: reviewservice
      service-path: backend/ReviewService
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  # ============================================
  # PRODUCTION-DEPLOYED SERVICES
  # ============================================
  kycservice:
    name: ðŸªª KYCService
    needs: detect-changes
    if: needs.detect-changes.outputs.kycservice == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: kycservice
      service-path: backend/KYCService
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  auditservice:
    name: ðŸ“‹ AuditService
    needs: detect-changes
    if: needs.detect-changes.outputs.auditservice == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: auditservice
      service-path: backend/AuditService
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  idempotencyservice:
    name: ðŸ”‘ IdempotencyService
    needs: detect-changes
    if: needs.detect-changes.outputs.idempotencyservice == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: idempotencyservice
      service-path: backend/IdempotencyService
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  adminservice:
    name: ðŸ›¡ï¸ AdminService
    needs: detect-changes
    if: needs.detect-changes.outputs.adminservice == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: adminservice
      service-path: backend/AdminService
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  dealermanagementservice:
    name: ðŸ¢ DealerManagementService
    needs: detect-changes
    if: needs.detect-changes.outputs.dealermanagementservice == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: dealermanagementservice
      service-path: backend/DealerManagementService
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  gateway:
    name: ðŸŒ Gateway
    needs: detect-changes
    if: needs.detect-changes.outputs.gateway == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: gateway
      service-path: backend/Gateway
      run-tests: false
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  # ============================================
  # CHATBOT (MLOps â€” dedicated pipeline)
  # ============================================
  chatbotservice:
    name: ðŸ¤– ChatbotService
    needs: detect-changes
    if: needs.detect-changes.outputs.chatbotservice == 'true'
    uses: ./.github/workflows/_reusable-dotnet-service.yml
    with:
      service-name: chatbotservice
      service-path: backend/ChatbotService
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  # ============================================
  # FRONTEND
  # ============================================
  frontend-web:
    name: ðŸŒ Frontend Web
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend-web == 'true'
    uses: ./.github/workflows/_reusable-frontend.yml
    with:
      run-docker-push: ${{ github.ref == 'refs/heads/main' }}
    secrets: inherit

  # ============================================
  # DEPLOY TO DIGITAL OCEAN (Only on main)
  # ============================================
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    continue-on-error: true  # Don't block pipeline on deploy failures
    needs:
      - authservice
      - userservice
      - roleservice
      - errorservice
      - notificationservice
      - vehiclessaleservice
      - mediaservice
      - billingservice
      - kycservice
      - auditservice
      - idempotencyservice
      - adminservice
      - dealermanagementservice
      - chatbotservice
      - gateway
      - frontend-web
    if: |
      always() && 
      github.ref == 'refs/heads/main' &&
      !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: ðŸ” Setup Kubernetes
        run: |
          doctl kubernetes cluster kubeconfig save ${{ secrets.DO_CLUSTER_NAME }}

      - name: ðŸš€ Deploy to Kubernetes
        run: |
          # Apply Kubernetes manifests in order
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/configmaps.yaml
          # NOTE: db-secrets are created dynamically by deploy-digitalocean.yml
          # Do NOT apply k8s/db-secrets.yaml (it's only a template reference)

          # Deploy infrastructure (PostgreSQL + Redis + RabbitMQ)
          kubectl apply -f k8s/infrastructure.yaml

          echo "â³ Waiting for PostgreSQL to be ready..."
          kubectl rollout status statefulset/postgres -n okla --timeout=180s || true
          sleep 15

          echo "â³ Waiting for Redis to be ready..."
          kubectl rollout status deployment/redis -n okla --timeout=60s || true

          echo "â³ Waiting for RabbitMQ to be ready..."
          kubectl rollout status deployment/rabbitmq -n okla --timeout=120s || true

          # Deploy services
          kubectl apply -f k8s/deployments.yaml
          kubectl apply -f k8s/services.yaml
          kubectl apply -f k8s/ingress.yaml

          # Deploy ChatbotService + LLM Server (separate manifest)
          kubectl apply -f k8s/chatbotservice.yaml

      - name: âœ… Verify deployment
        run: |
          kubectl rollout status deployment/frontend-web -n okla --timeout=300s
          kubectl rollout status deployment/gateway -n okla --timeout=300s
          kubectl rollout status deployment/authservice -n okla --timeout=300s
          kubectl rollout status deployment/chatbotservice -n okla --timeout=300s || true
          kubectl rollout status deployment/llm-server -n okla --timeout=600s || true

  # ============================================
  # SUMMARY
  # ============================================
  summary:
    name: ðŸ“Š Pipeline Summary
    needs:
      - detect-changes
      - authservice
      - userservice
      - roleservice
      - errorservice
      - kycservice
      - auditservice
      - idempotencyservice
      - adminservice
      - dealermanagementservice
      - chatbotservice
      - gateway
      - frontend-web
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“Š Generate summary
        run: |
          echo "## ðŸš€ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| AuthService | ${{ needs.authservice.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| UserService | ${{ needs.userservice.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| RoleService | ${{ needs.roleservice.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ErrorService | ${{ needs.errorservice.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| KYCService | ${{ needs.kycservice.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AuditService | ${{ needs.auditservice.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| IdempotencyService | ${{ needs.idempotencyservice.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AdminService | ${{ needs.adminservice.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DealerManagementService | ${{ needs.dealermanagementservice.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ChatbotService | ${{ needs.chatbotservice.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gateway | ${{ needs.gateway.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Web | ${{ needs.frontend-web.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
