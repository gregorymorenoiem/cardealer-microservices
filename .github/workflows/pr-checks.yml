# =============================================================================
# PR CHECKS - Fast Validation for Pull Requests
# =============================================================================
# Optimizado para ejecutar en ~3-5 minutos
# Solo lint, type check, y unit tests rÃ¡pidos
#
# Soporta PRs hacia:
#   - main (producciÃ³n)
#   - development (integraciÃ³n)
#   - sprint/* (trabajo de sprint)
# =============================================================================

name: ðŸ” PR Checks

on:
  pull_request:
    branches: [main, development, "sprint/**"]

# Evita ejecuciones duplicadas
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20.x"
  DOTNET_VERSION: "8.0.x"

jobs:
  # ============================================
  # STEP 1: Detectar quÃ© cambiÃ³
  # ============================================
  detect-changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
      docs-only: ${{ steps.filter.outputs.docs-only }}

    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'frontend/web/**'
              - '!frontend/web/**/*.md'
            backend:
              - 'backend/**'
              - '!backend/**/*.md'
            docs-only:
              - '**/*.md'
              - 'docs/**'

  # ============================================
  # FRONTEND CHECKS (Parallel)
  # ============================================
  frontend-checks:
    name: ðŸŒ Frontend Checks
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/web/package-lock.json

      - name: ðŸ“¦ Install dependencies
        working-directory: frontend/web
        run: npm ci --legacy-peer-deps

      - name: ðŸ” Lint
        working-directory: frontend/web
        run: npm run lint

      - name: ðŸ“ Type check
        working-directory: frontend/web
        run: npx tsc --noEmit

      - name: ðŸ§ª Unit tests
        working-directory: frontend/web
        run: npm test -- --run --reporter=verbose

  # ============================================
  # BACKEND CHECKS (Parallel)
  # ============================================
  backend-checks:
    name: ðŸ”§ Backend Checks
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ðŸ“¦ Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: ðŸ” Detect changed services
        id: changed-services
        run: |
          # Get list of changed backend directories
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep "^backend/" | cut -d'/' -f2 | sort -u | head -5)
          echo "Changed services: $CHANGED"
          echo "services=$CHANGED" >> $GITHUB_OUTPUT

      - name: ðŸ”¨ Build changed services
        run: |
          cd backend
          # Build _Shared first (dependencies)
          if [ -d "_Shared" ]; then
            dotnet build _Shared/CarDealer.Shared/CarDealer.Shared.csproj --configuration Release || true
            dotnet build _Shared/CarDealer.Contracts/CarDealer.Contracts.csproj --configuration Release || true
          fi

          # Build AuthService (core service)
          if [ -d "AuthService" ]; then
            dotnet restore AuthService/AuthService.sln
            dotnet build AuthService/AuthService.sln --no-restore --configuration Release
          fi

  # ============================================
  # PR QUALITY CHECKS
  # ============================================
  pr-quality:
    name: ðŸ“‹ PR Quality
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“Š PR Size Check
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          ADDED_LINES=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $4}' || echo "0")

          echo "ðŸ“Š PR Statistics:"
          echo "  - Changed files: $CHANGED_FILES"
          echo "  - Added lines: $ADDED_LINES"

          if [ "$CHANGED_FILES" -gt 50 ]; then
            echo "::warning::âš ï¸ Large PR with $CHANGED_FILES files. Consider splitting."
          fi

      - name: ðŸ·ï¸ Check commit messages
        run: |
          # Check if commits follow conventional commits
          git log --oneline origin/${{ github.base_ref }}...HEAD | while read line; do
            if ! echo "$line" | grep -qE "^[a-f0-9]+ (feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?:"; then
              echo "::warning::Commit doesn't follow conventional commits: $line"
            fi
          done

  # ============================================
  # SUMMARY
  # ============================================
  pr-summary:
    name: ðŸ“Š PR Summary
    needs: [detect-changes, frontend-checks, backend-checks, pr-quality]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸ” PR Checks Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.frontend-checks.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.backend-checks.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PR Quality | ${{ needs.pr-quality.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Quick checks completed!" >> $GITHUB_STEP_SUMMARY
