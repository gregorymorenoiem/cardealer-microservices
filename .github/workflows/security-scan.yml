# =============================================================================
# Security Scanning Workflow - OKLA Microservices
# Runs on PR and weekly to detect secrets, vulnerable NuGet packages, and
# common security misconfigurations.
# =============================================================================

name: Security Scan

on:
  pull_request:
    branches: [main, development]
  schedule:
    # Weekly scan on Mondays at 6:00 AM UTC
    - cron: "0 6 * * 1"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # ========================================
  # 1. Secret Scanning with Gitleaks
  # ========================================
  secret-scan:
    name: ðŸ”‘ Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: --verbose --redact

  # ========================================
  # 2. NuGet Vulnerability Scan
  # ========================================
  nuget-vuln-scan:
    name: ðŸ“¦ NuGet Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore all packages
        run: dotnet restore cardealer.sln

      - name: Check for vulnerable packages
        run: |
          echo "## ðŸ“¦ NuGet Vulnerability Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          VULN_FOUND=0

          for proj in $(find backend -name "*.csproj" -not -path "*/_DESCARTADOS/*" -not -path "*/bin/*" -not -path "*/obj/*"); do
            OUTPUT=$(dotnet list "$proj" package --vulnerable --include-transitive 2>/dev/null || true)
            if echo "$OUTPUT" | grep -qi "has the following vulnerable"; then
              echo "### âš ï¸ $proj" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$OUTPUT" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              VULN_FOUND=1
            fi
          done

          if [ "$VULN_FOUND" -eq 0 ]; then
            echo "âœ… No vulnerable packages found." >> $GITHUB_STEP_SUMMARY
          else
            echo "::warning::Vulnerable NuGet packages detected. Review the job summary."
          fi

  # ========================================
  # 3. Security Configuration Checks
  # ========================================
  config-audit:
    name: ðŸ”’ Configuration Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets in appsettings
        run: |
          echo "## ðŸ”’ Configuration Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ISSUES=0

          # Check for common secret patterns in tracked files
          echo "### Checking for hardcoded secrets..." >> $GITHUB_STEP_SUMMARY

          # API keys (but not placeholder patterns like ${...})
          MATCHES=$(grep -rn --include="*.json" --include="*.cs" --include="*.yml" --include="*.yaml" \
            -E "(sk_live_|sk_test_|SG\.[a-zA-Z0-9]{20,}|re_[a-zA-Z0-9]{20,}|AC[a-f0-9]{32})" \
            backend/ 2>/dev/null | grep -v "bin/" | grep -v "obj/" | grep -v "_DESCARTADOS/" | grep -v '\$\{' || true)

          if [ -n "$MATCHES" ]; then
            echo "âš ï¸ Potential API keys found:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$MATCHES" | head -20 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ISSUES=1
          fi

          # Check for AllowAnyOrigin (CORS misconfiguration)
          CORS_ISSUES=$(grep -rn "AllowAnyOrigin" --include="*.cs" backend/ 2>/dev/null \
            | grep -v "bin/" | grep -v "obj/" | grep -v "_DESCARTADOS/" || true)

          if [ -n "$CORS_ISSUES" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âš ï¸ CORS: AllowAnyOrigin detected" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$CORS_ISSUES" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ISSUES=1
          fi

          # Check for Swagger exposed without IsDevelopment guard
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Swagger Exposure Check" >> $GITHUB_STEP_SUMMARY

          # Check production ocelot for swagger routes
          SWAGGER_PROD=$(grep -c "swagger" backend/Gateway/Gateway.Api/ocelot.prod.json 2>/dev/null || echo "0")
          if [ "$SWAGGER_PROD" -gt 0 ]; then
            echo "âš ï¸ Swagger routes found in production gateway config" >> $GITHUB_STEP_SUMMARY
            ISSUES=1
          else
            echo "âœ… No Swagger routes in production gateway config" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$ISSUES" -eq 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All configuration checks passed." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for security headers middleware
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Headers Coverage" >> $GITHUB_STEP_SUMMARY

          TOTAL=0
          COVERED=0
          MISSING=""

          for prog in $(find backend -path "*/Api/Program.cs" -not -path "*/_DESCARTADOS/*" -not -path "*/bin/*"); do
            TOTAL=$((TOTAL + 1))
            if grep -q "UseApiSecurityHeaders" "$prog" 2>/dev/null; then
              COVERED=$((COVERED + 1))
            else
              SVC=$(echo "$prog" | sed 's|backend/||;s|/.*||')
              MISSING="$MISSING $SVC"
            fi
          done

          echo "- Total services: $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo "- With security headers: $COVERED" >> $GITHUB_STEP_SUMMARY

          if [ -n "$MISSING" ]; then
            echo "- âš ï¸ Missing:$MISSING" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âœ… All services have security headers" >> $GITHUB_STEP_SUMMARY
          fi
