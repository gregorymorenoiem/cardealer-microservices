# =============================================================================
# REUSABLE WORKFLOW: Frontend (Next.js 14) CI/CD
# =============================================================================
# Template reutilizable para frontend web (Next.js + pnpm)
# Incluye: Lint, Type Check, Tests, Build, Docker
# =============================================================================

name: Reusable Frontend CI/CD

on:
  workflow_call:
    inputs:
      node-version:
        description: "Versi√≥n de Node.js"
        required: false
        type: string
        default: "20.x"
      working-directory:
        description: "Directorio del frontend"
        required: false
        type: string
        default: "frontend/web-next"
      run-e2e-tests:
        description: "Ejecutar tests E2E"
        required: false
        type: boolean
        default: false
      run-docker-build:
        description: "Construir imagen Docker"
        required: false
        type: boolean
        default: true
      run-docker-push:
        description: "Push imagen a registry"
        required: false
        type: boolean
        default: false
      docker-registry:
        description: "Docker registry URL"
        required: false
        type: string
        default: "ghcr.io"
    secrets:
      REGISTRY_USERNAME:
        required: false
      REGISTRY_PASSWORD:
        required: false

jobs:
  # ============================================
  # JOB 1: Lint & Type Check (Fast)
  # ============================================
  lint-and-typecheck:
    name: üîç Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: üì¶ Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: üì¶ Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: üì¶ Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: pnpm install --frozen-lockfile

      - name: üîç Lint
        working-directory: ${{ inputs.working-directory }}
        run: pnpm lint

      - name: üìù Type check
        working-directory: ${{ inputs.working-directory }}
        run: pnpm typecheck

  # ============================================
  # JOB 2: Unit Tests
  # ============================================
  unit-tests:
    name: üß™ Unit Tests
    runs-on: ubuntu-latest
    needs: lint-and-typecheck

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: üì¶ Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: pnpm install --frozen-lockfile

      - name: üß™ Run unit tests
        working-directory: ${{ inputs.working-directory }}
        run: pnpm test -- --run --reporter=verbose --coverage
        continue-on-error: true

      - name: üìä Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ${{ inputs.working-directory }}/coverage
          retention-days: 7

  # ============================================
  # JOB 3: Docker Build & Push
  # ============================================
  docker:
    name: üê≥ Docker Build
    needs: unit-tests
    runs-on: ubuntu-latest
    if: always() && !cancelled() && inputs.run-docker-build
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üì¶ Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-frontend-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-frontend-

      - name: üîê Login to Container Registry
        if: inputs.run-docker-push
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.docker-registry }}
          username: ${{ secrets.REGISTRY_USERNAME || github.actor }}
          password: ${{ secrets.REGISTRY_PASSWORD || secrets.GITHUB_TOKEN }}

      - name: üè∑Ô∏è Generate version
        id: version
        run: |
          VERSION="1.0.${{ github.run_number }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: üèóÔ∏è Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ inputs.working-directory }}
          file: ${{ inputs.working-directory }}/Dockerfile
          push: ${{ inputs.run-docker-push }}
          tags: |
            ${{ inputs.docker-registry }}/${{ github.repository_owner }}/frontend-web:${{ steps.version.outputs.version }}
            ${{ inputs.docker-registry }}/${{ github.repository_owner }}/frontend-web:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            NEXT_PUBLIC_API_URL=
            NEXT_PUBLIC_SITE_URL=https://okla.com.do

      - name: üßπ Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
