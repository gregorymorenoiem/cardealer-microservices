# =============================================================================
# REUSABLE WORKFLOW: Frontend (React/Vite) CI/CD
# =============================================================================
# Template reutilizable para frontend web
# Incluye: Lint, Type Check, Tests, Build, Docker
# =============================================================================

name: Reusable Frontend CI/CD

on:
  workflow_call:
    inputs:
      node-version:
        description: 'VersiÃ³n de Node.js'
        required: false
        type: string
        default: '20.x'
      working-directory:
        description: 'Directorio del frontend'
        required: false
        type: string
        default: 'frontend/web'
      run-e2e-tests:
        description: 'Ejecutar tests E2E'
        required: false
        type: boolean
        default: false
      run-docker-build:
        description: 'Construir imagen Docker'
        required: false
        type: boolean
        default: true
      run-docker-push:
        description: 'Push imagen a registry'
        required: false
        type: boolean
        default: false
      docker-registry:
        description: 'Docker registry URL'
        required: false
        type: string
        default: 'ghcr.io'
      vite-api-url:
        description: 'VITE_API_URL para build'
        required: false
        type: string
        default: 'http://localhost:8080'
    secrets:
      REGISTRY_USERNAME:
        required: false
      REGISTRY_PASSWORD:
        required: false
      VITE_SENTRY_DSN:
        required: false
      VITE_GOOGLE_MAPS_KEY:
        required: false

jobs:
  # ============================================
  # JOB 1: Lint & Type Check (Fast)
  # ============================================
  lint-and-typecheck:
    name: ğŸ” Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: npm ci --legacy-peer-deps

      - name: ğŸ” Lint
        working-directory: ${{ inputs.working-directory }}
        run: npm run lint

      - name: ğŸ“ Type check
        working-directory: ${{ inputs.working-directory }}
        run: npx tsc --noEmit

  # ============================================
  # JOB 2: Unit Tests
  # ============================================
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: lint-and-typecheck

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: npm ci --legacy-peer-deps

      - name: ğŸ§ª Run unit tests
        working-directory: ${{ inputs.working-directory }}
        run: npm test -- --run --reporter=verbose --coverage

      - name: ğŸ“Š Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ${{ inputs.working-directory }}/coverage
          retention-days: 7

  # ============================================
  # JOB 3: Build
  # ============================================
  build:
    name: ğŸ”¨ Build
    runs-on: ubuntu-latest
    needs: unit-tests
    # Continue build even if tests fail (production deployments should still work)
    if: always() && !cancelled()
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: npm ci --legacy-peer-deps

      - name: ğŸ”¨ Build
        working-directory: ${{ inputs.working-directory }}
        env:
          VITE_API_URL: ${{ inputs.vite-api-url }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
          VITE_GOOGLE_MAPS_KEY: ${{ secrets.VITE_GOOGLE_MAPS_KEY }}
        run: npm run build

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: ${{ inputs.working-directory }}/dist
          retention-days: 7

      - name: ğŸ·ï¸ Generate version
        id: version
        run: |
          VERSION="1.0.${{ github.run_number }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  # ============================================
  # JOB 4: Docker Build & Push
  # ============================================
  docker:
    name: ğŸ³ Docker Build
    needs: build
    runs-on: ubuntu-latest
    # Continue Docker build even if tests failed, as long as build succeeded
    if: always() && !cancelled() && needs.build.result == 'success' && inputs.run-docker-build

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: ${{ inputs.working-directory }}/dist

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“¦ Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-frontend-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-frontend-

      - name: ğŸ” Login to Container Registry
        if: inputs.run-docker-push
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.docker-registry }}
          username: ${{ secrets.REGISTRY_USERNAME || github.actor }}
          password: ${{ secrets.REGISTRY_PASSWORD || secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ inputs.working-directory }}
          file: ${{ inputs.working-directory }}/Dockerfile
          push: ${{ inputs.run-docker-push }}
          tags: |
            ${{ inputs.docker-registry }}/${{ github.repository_owner }}/cardealer-web:${{ needs.build.outputs.version }}
            ${{ inputs.docker-registry }}/${{ github.repository_owner }}/cardealer-web:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          build-args: |
            VITE_API_URL=${{ inputs.vite-api-url }}

      - name: ğŸ§¹ Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
