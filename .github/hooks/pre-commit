#!/bin/sh
# =============================================================================
# PRE-COMMIT HOOK - Security Checks
# =============================================================================
# Prevents committing secrets, credentials, and sensitive data
#
# Installation:
#   cp .github/hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or use gitleaks (recommended):
#   brew install gitleaks
#   gitleaks protect --staged
# =============================================================================

echo "üîç Running pre-commit security checks..."

# Check for common secret patterns in staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

# Patterns that should NEVER be committed
SECRET_PATTERNS=(
  "password\s*[:=]\s*['\"][^'\"${}]"
  "secret\s*[:=]\s*['\"][^'\"${}]"
  "api[_-]?key\s*[:=]\s*['\"][^'\"${}]"
  "token\s*[:=]\s*['\"][^'\"${}]"
  "private[_-]?key"
  "BEGIN RSA PRIVATE KEY"
  "BEGIN OPENSSH PRIVATE KEY"
  "BEGIN EC PRIVATE KEY"
  "AKIA[0-9A-Z]{16}"
  "sk_live_[a-zA-Z0-9]+"
  "sk_test_[a-zA-Z0-9]+"
  "ghp_[a-zA-Z0-9]{36}"
  "gho_[a-zA-Z0-9]{36}"
)

FOUND_SECRETS=false

for FILE in $STAGED_FILES; do
  # Skip binary files, images, and lock files
  case "$FILE" in
    *.png|*.jpg|*.jpeg|*.gif|*.ico|*.svg|*.woff|*.woff2|*.ttf|*.eot) continue ;;
    *.lock|*lock.json|*.min.js|*.min.css) continue ;;
    k8s/secrets.template.yaml) continue ;;  # Template is allowed
  esac

  for PATTERN in "${SECRET_PATTERNS[@]}"; do
    if git show ":$FILE" 2>/dev/null | grep -iEq "$PATTERN"; then
      echo "‚ùå Potential secret found in: $FILE"
      echo "   Pattern: $PATTERN"
      FOUND_SECRETS=true
    fi
  done
done

# If gitleaks is installed, use it for comprehensive scanning
if command -v gitleaks &> /dev/null; then
  echo "üîí Running gitleaks scan..."
  if ! gitleaks protect --staged --no-banner 2>/dev/null; then
    echo "‚ùå gitleaks detected secrets in staged files!"
    FOUND_SECRETS=true
  fi
fi

# Check for k8s/secrets.yaml (should be gitignored, never committed)
for FILE in $STAGED_FILES; do
  if echo "$FILE" | grep -qE "k8s/secrets\.(yaml|yml)$" && ! echo "$FILE" | grep -q "template"; then
    echo "‚ùå BLOCKED: Attempting to commit K8s secrets file: $FILE"
    echo "   Use k8s/secrets.template.yaml instead."
    FOUND_SECRETS=true
  fi
done

# Check for build artifacts
for FILE in $STAGED_FILES; do
  if echo "$FILE" | grep -qE "(bin/Debug|bin/Release|obj/Debug|obj/Release)"; then
    echo "‚ùå BLOCKED: Build artifact detected: $FILE"
    echo "   Run: git rm --cached $FILE"
    FOUND_SECRETS=true
  fi
done

if [ "$FOUND_SECRETS" = true ]; then
  echo ""
  echo "‚õî Commit blocked due to security concerns."
  echo "   Fix the issues above or use 'git commit --no-verify' to bypass (NOT recommended)."
  exit 1
fi

echo "‚úÖ Security checks passed!"
exit 0
