# Fastlane Documentation
# https://docs.fastlane.tools

default_platform(:android)

platform :android do
  
  # Configuración
  before_all do
    ENV["FASTLANE_HIDE_CHANGELOG"] = "true"
  end

  # Lane para desarrollo
  desc "Build and deploy DEV to Firebase App Distribution"
  lane :dev do
    gradle(
      task: "clean assembleDevRelease",
      project_dir: "android/"
    )
    
    firebase_app_distribution(
      app: ENV['FIREBASE_APP_ID_ANDROID_DEV'],
      groups: "internal-testers",
      release_notes: "Development build from Fastlane",
      apk_path: "build/app/outputs/flutter-apk/app-dev-release.apk"
    )
  end

  # Lane para staging
  desc "Build and deploy STAGING to Firebase App Distribution"
  lane :staging do
    gradle(
      task: "clean assembleStagingRelease",
      project_dir: "android/"
    )
    
    firebase_app_distribution(
      app: ENV['FIREBASE_APP_ID_ANDROID_STAGING'],
      groups: "qa-testers",
      release_notes: "Staging build from Fastlane",
      apk_path: "build/app/outputs/flutter-apk/app-staging-release.apk"
    )
  end

  # Lane para producción - Google Play
  desc "Build and upload PROD to Google Play Internal Testing"
  lane :prod do
    # Build App Bundle
    gradle(
      task: "clean bundleProdRelease",
      project_dir: "android/"
    )
    
    # Upload a Google Play
    upload_to_play_store(
      track: "internal",
      aab: "build/app/outputs/bundle/prodRelease/app-prod-release.aab",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  # Lane para beta testing
  desc "Promote to beta track in Google Play"
  lane :beta do
    upload_to_play_store(
      track: "internal",
      track_promote_to: "beta",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true
    )
  end

  # Lane para producción final
  desc "Promote to production in Google Play"
  lane :release do
    upload_to_play_store(
      track: "beta",
      track_promote_to: "production",
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: false
    )
  end

  # Lane de release completo con versión
  desc "Complete release cycle"
  lane :release_full do
    # Build
    gradle(
      task: "clean bundleProdRelease",
      project_dir: "android/"
    )
    
    # Upload internal
    upload_to_play_store(
      track: "internal",
      aab: "build/app/outputs/bundle/prodRelease/app-prod-release.aab"
    )
    
    # Después de pruebas internas, promover a beta
    beta
  end

  # Error handler
  error do |lane, exception|
    puts "Error in lane #{lane}: #{exception.message}"
  end

end
