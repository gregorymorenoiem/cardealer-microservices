# Fastlane Documentation
# https://docs.fastlane.tools

default_platform(:ios)

platform :ios do
  
  # Configuración
  before_all do
    setup_ci if ENV['CI']
  end

  # Lane para desarrollo
  desc "Build and deploy DEV to Firebase App Distribution"
  lane :dev do
    build_app(
      scheme: "dev",
      export_method: "development",
      output_directory: "./build/ios/dev",
      output_name: "CarDealer-dev.ipa"
    )
    
    firebase_app_distribution(
      app: ENV['FIREBASE_APP_ID_IOS_DEV'],
      groups: "internal-testers",
      release_notes: "Development build from Fastlane"
    )
  end

  # Lane para staging
  desc "Build and deploy STAGING to Firebase App Distribution"
  lane :staging do
    build_app(
      scheme: "staging",
      export_method: "ad-hoc",
      output_directory: "./build/ios/staging",
      output_name: "CarDealer-staging.ipa"
    )
    
    firebase_app_distribution(
      app: ENV['FIREBASE_APP_ID_IOS_STAGING'],
      groups: "qa-testers",
      release_notes: "Staging build from Fastlane"
    )
  end

  # Lane para producción - TestFlight
  desc "Build and upload PROD to TestFlight"
  lane :prod do
    # Incrementar build number
    increment_build_number(
      xcodeproj: "Runner.xcodeproj"
    )
    
    # Build
    build_app(
      scheme: "prod",
      export_method: "app-store",
      output_directory: "./build/ios/prod",
      output_name: "CarDealer.ipa"
    )
    
    # Upload a TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      distribute_external: false,
      notify_external_testers: false
    )
  end

  # Lane para capturas de pantalla
  desc "Generate screenshots"
  lane :screenshots do
    capture_screenshots(scheme: "prod")
    upload_to_app_store(
      skip_binary_upload: true,
      skip_metadata: true
    )
  end

  # Lane para tests
  desc "Run tests"
  lane :test do
    run_tests(
      scheme: "prod",
      devices: ["iPhone 15 Pro", "iPad Pro (12.9-inch)"]
    )
  end

  # Lane de release completo
  desc "Complete release to App Store"
  lane :release do
    # Incrementar versión
    increment_version_number(
      bump_type: "patch"
    )
    
    # Build y upload
    prod
    
    # Metadata y screenshots
    deliver(
      submit_for_review: false,
      automatic_release: false,
      force: true
    )
  end

  # Error handler
  error do |lane, exception|
    notification(
      subtitle: "Error in lane #{lane}",
      message: exception.message,
      activate: "com.apple.Terminal"
    )
  end

end
