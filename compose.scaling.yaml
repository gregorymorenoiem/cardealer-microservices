# ============================================================================
# COMPOSE.SCALING.YAML - Docker Compose con Escalado y Resiliencia
# ============================================================================
#
# Este archivo define la configuraciÃ³n de escalado para desarrollo local
# y staging. Permite correr mÃºltiples rÃ©plicas de microservicios.
#
# USO:
#   # Escalar servicios individuales:
#   docker compose -f compose.yaml -f compose.scaling.yaml up -d --scale authservice=3 --scale vehiclessaleservice=3
#
#   # Escalar todo a configuraciÃ³n de alta disponibilidad:
#   docker compose -f compose.yaml -f compose.scaling.yaml up -d
#
#   # Ver estado de rÃ©plicas:
#   docker compose -f compose.yaml -f compose.scaling.yaml ps
#
# âš ï¸ IMPORTANTE:
#   - Los servicios escalados NO deben usar 'container_name' (se elimina aquÃ­)
#   - Los puertos fijos del host se eliminan para evitar conflictos
#   - El load balancing lo maneja Docker DNS round-robin + Nginx/Traefik
#
# ============================================================================

services:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ”µ INFRAESTRUCTURA - SIN ESCALAR (Singleton)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  # Nginx Load Balancer â€” distribuye trÃ¡fico a rÃ©plicas de microservicios
  nginx-lb:
    image: nginx:1.25-alpine
    container_name: nginx-lb
    ports:
      - "18443:80" # Gateway LB
      - "15001:15001" # Auth LB
      - "15010:15010" # Vehicles LB
    volumes:
      - ./infra/nginx/nginx-lb.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - gateway
    networks:
      - okla-net
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸ”´ SERVICIOS CRÃTICOS â€” Escalables
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  gateway:
    # Eliminar container_name para permitir mÃºltiples rÃ©plicas
    container_name: ""
    ports: [] # Manejado por nginx-lb
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: "0.5"
          memory: 384M
        reservations:
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s

  authservice:
    container_name: ""
    ports: []
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: "0.5"
          memory: 384M
        reservations:
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first

  vehiclessaleservice:
    container_name: ""
    ports: []
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: "0.5"
          memory: 384M
        reservations:
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first

  mediaservice:
    container_name: ""
    ports: []
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: "0.5"
          memory: 384M
        reservations:
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ğŸŸ  SERVICIOS IMPORTANTES â€” Escalables bajo demanda
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  userservice:
    container_name: ""
    ports: []
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: "0.5"
          memory: 384M
        reservations:
          memory: 192M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5

  notificationservice:
    container_name: ""
    ports: []
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: "0.5"
          memory: 384M
        reservations:
          memory: 192M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5

  contactservice:
    container_name: ""
    ports: []
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: "0.3"
          memory: 256M
        reservations:
          memory: 128M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  adminservice:
    container_name: ""
    ports: []
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: "0.3"
          memory: 256M
        reservations:
          memory: 128M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  errorservice:
    container_name: ""
    ports: []
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: "0.3"
          memory: 256M
        reservations:
          memory: 128M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

networks:
  okla-net:
    driver: bridge
