#!/bin/bash

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ๐ค AUTOMATIC DOCKER FIX - macOS
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Este script automรกticamente resuelve Docker Desktop atascado en macOS
# Sin requerir intervenciรณn manual
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set -e  # Exit on error

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}         ๐ค REPARACIรN AUTOMรTICA DE DOCKER PARA MACOS${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 1: Matar procesos de Docker existentes
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${YELLOW}๐ PASO 1: Deteniendo procesos de Docker...${NC}"
echo ""

# Intentar mรฉtodos progresivos de terminaciรณn
docker_pids=$(pgrep -f "Docker.app" || true)

if [ -z "$docker_pids" ]; then
  echo "โน๏ธ  Docker no estรก en ejecuciรณn"
else
  echo "Encontrados procesos Docker: $docker_pids"
  
  # Intento 1: SIGTERM (graceful)
  echo "  โข Intento 1: SIGTERM (graceful shutdown)..."
  kill -TERM $docker_pids 2>/dev/null || true
  sleep 3
  
  # Verificar si terminรณ
  docker_pids=$(pgrep -f "Docker.app" || true)
  
  if [ -z "$docker_pids" ]; then
    echo -e "${GREEN}โ Procesos terminados con SIGTERM${NC}"
  else
    echo "  โข Intento 2: SIGKILL (force kill)..."
    kill -9 $docker_pids 2>/dev/null || true
    sleep 2
    echo -e "${GREEN}โ Procesos forzosamente terminados${NC}"
  fi
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 2: Limpiar sockets y archivos de lock
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${YELLOW}๐ PASO 2: Limpiando archivos de socket y lock...${NC}"
echo ""

DOCKER_SOCK="$HOME/.docker/run/docker.sock"
if [ -e "$DOCKER_SOCK" ]; then
  echo "  โข Removiendo socket: $DOCKER_SOCK"
  rm -f "$DOCKER_SOCK" 2>/dev/null || true
  echo -e "${GREEN}โ Socket removido${NC}"
fi

# Limpiar Docker desktop caches (OPCIONAL - solo si usuario quiere)
# rm -rf ~/Library/Containers/com.docker.docker/Data/vms/0/*

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 3: Reiniciar Docker Desktop
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${YELLOW}๐ PASO 3: Reiniciando Docker Desktop...${NC}"
echo ""

# Abrir Docker Desktop
open -a Docker

echo "  โณ Esperando que Docker Desktop inicie (60 segundos)..."
sleep 60

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 4: Verificar que Docker responde
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${YELLOW}๐ PASO 4: Verificando que Docker responde...${NC}"
echo ""

max_attempts=30
attempt=1

while [ $attempt -le $max_attempts ]; do
  echo -ne "\r  Intento $attempt/$max_attempts... "
  
  if docker ps &>/dev/null; then
    echo -e "\r${GREEN}โ Docker responde correctamente!${NC}"
    echo ""
    break
  fi
  
  attempt=$((attempt + 1))
  sleep 2
done

if [ $attempt -gt $max_attempts ]; then
  echo -e "\r${RED}โ Docker no responde despuรฉs de 60 segundos${NC}"
  echo ""
  echo -e "${YELLOW}Soluciones alternativas:${NC}"
  echo "  1. Abre Activity Monitor y busca 'Docker'"
  echo "  2. Haz clic 'Force Quit'"
  echo "  3. Abre Docker Desktop nuevamente"
  exit 1
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 5: Verificar docker compose
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${YELLOW}๐ PASO 5: Verificando docker compose...${NC}"
echo ""

if docker compose version &>/dev/null; then
  echo -e "${GREEN}โ docker compose funciona correctamente${NC}"
else
  echo -e "${RED}โ docker compose no responde${NC}"
  exit 1
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 6: Mostrar estado
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}โ DOCKER REPARADO Y FUNCIONANDO CORRECTAMENTE${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

docker ps --format "table {{.Names}}\t{{.Status}}"

echo ""
echo -e "${GREEN}Estado de Docker:${NC}"
docker version --format 'Docker {{.Server.Version}}'

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PASO 7: Opciรณn de levantar servicios automรกticamente
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo -e "${YELLOW}ยฟDeseas levantar los microservicios ahora?${NC}"
echo ""
echo "  Opciones:"
echo "    1. Levantar automรกticamente (presiona Enter)"
echo "    2. Salir (presiona Ctrl+C)"
echo ""

read -t 10 response || response="1"

if [ "$response" = "1" ] || [ -z "$response" ]; then
  echo ""
  echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
  echo -e "${BLUE}         ๐ LEVANTANDO MICROSERVICIOS${NC}"
  echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
  echo ""
  
  # Ejecutar script de startup
  if [ -f "./startup-services.sh" ]; then
    chmod +x ./startup-services.sh
    ./startup-services.sh
  else
    echo -e "${RED}Error: startup-services.sh no encontrado${NC}"
    exit 1
  fi
else
  echo -e "${GREEN}โ Servicios no levantados. Ejecuta cuando estรฉs listo:${NC}"
  echo ""
  echo -e "  ${BLUE}./startup-services.sh${NC}"
  echo ""
fi

echo ""
echo -e "${GREEN}โ SCRIPT COMPLETADO${NC}"
echo ""
