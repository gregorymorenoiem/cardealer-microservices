<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üß† Auto-Learning Results Viewer</title>
    <style>
      :root {
        --bg-primary: #0d1117;
        --bg-secondary: #161b22;
        --bg-tertiary: #21262d;
        --border-color: #30363d;
        --text-primary: #c9d1d9;
        --text-secondary: #8b949e;
        --accent-green: #3fb950;
        --accent-blue: #58a6ff;
        --accent-yellow: #d29922;
        --accent-red: #f85149;
        --accent-purple: #a371f7;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial,
          sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
      }

      .header {
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-color);
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        font-size: 24px;
        font-weight: 600;
      }

      .header h1 span {
        margin-right: 10px;
      }

      .controls {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .controls select,
      .controls input {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
      }

      .controls button {
        background: var(--accent-blue);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: opacity 0.2s;
      }

      .controls button:hover {
        opacity: 0.85;
      }

      .stats-bar {
        background: var(--bg-secondary);
        padding: 15px 30px;
        display: flex;
        gap: 30px;
        border-bottom: 1px solid var(--border-color);
        flex-wrap: wrap;
      }

      .stat-item {
        display: flex;
        flex-direction: column;
      }

      .stat-value {
        font-size: 24px;
        font-weight: 600;
        color: var(--accent-blue);
      }

      .stat-value.excellent {
        color: var(--accent-green);
      }
      .stat-value.good {
        color: var(--accent-blue);
      }
      .stat-value.acceptable {
        color: var(--accent-yellow);
      }
      .stat-value.bad {
        color: var(--accent-red);
      }

      .stat-label {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 2px;
      }

      .main-content {
        display: flex;
        height: calc(100vh - 130px);
      }

      .sidebar {
        width: 300px;
        background: var(--bg-secondary);
        border-right: 1px solid var(--border-color);
        overflow-y: auto;
      }

      .image-list {
        list-style: none;
      }

      .image-item {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .image-item:hover {
        background: var(--bg-tertiary);
      }

      .image-item.active {
        background: var(--bg-tertiary);
        border-left: 3px solid var(--accent-blue);
      }

      .image-name {
        font-size: 14px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 180px;
      }

      .image-score {
        font-size: 14px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 12px;
        min-width: 50px;
        text-align: center;
      }

      .score-excellent {
        background: rgba(63, 185, 80, 0.2);
        color: var(--accent-green);
      }
      .score-good {
        background: rgba(88, 166, 255, 0.2);
        color: var(--accent-blue);
      }
      .score-acceptable {
        background: rgba(210, 153, 34, 0.2);
        color: var(--accent-yellow);
      }
      .score-bad {
        background: rgba(248, 81, 73, 0.2);
        color: var(--accent-red);
      }

      .viewer {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
      }

      .comparison-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      .image-panel {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
      }

      .panel-header {
        padding: 10px 15px;
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
        font-weight: 500;
        font-size: 14px;
      }

      .panel-content {
        padding: 15px;
        text-align: center;
      }

      .panel-content img {
        max-width: 100%;
        max-height: 400px;
        object-fit: contain;
        border-radius: 4px;
      }

      /* Checkerboard for transparency */
      .transparent-bg {
        background-image:
          linear-gradient(45deg, #333 25%, transparent 25%),
          linear-gradient(-45deg, #333 25%, transparent 25%),
          linear-gradient(45deg, transparent 75%, #333 75%),
          linear-gradient(-45deg, transparent 75%, #333 75%);
        background-size: 20px 20px;
        background-position:
          0 0,
          0 10px,
          10px -10px,
          -10px 0px;
      }

      .evaluation-panel {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .evaluation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .score-badge {
        font-size: 32px;
        font-weight: 700;
      }

      .classification {
        padding: 4px 12px;
        border-radius: 16px;
        font-size: 14px;
        font-weight: 500;
      }

      .checks-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }

      .check-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px;
        background: var(--bg-tertiary);
        border-radius: 6px;
      }

      .check-icon {
        font-size: 18px;
      }

      .check-icon.pass {
        color: var(--accent-green);
      }
      .check-icon.fail {
        color: var(--accent-red);
      }

      .issues-section,
      .suggestions-section {
        margin-top: 15px;
      }

      .section-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--text-secondary);
      }

      .issue-item,
      .suggestion-item {
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 6px;
        font-size: 14px;
      }

      .issue-item {
        background: rgba(248, 81, 73, 0.1);
        border-left: 3px solid var(--accent-red);
      }

      .suggestion-item {
        background: rgba(88, 166, 255, 0.1);
        border-left: 3px solid var(--accent-blue);
      }

      .params-panel {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
      }

      .params-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }

      .param-item {
        padding: 8px 12px;
        background: var(--bg-tertiary);
        border-radius: 6px;
      }

      .param-name {
        font-size: 11px;
        color: var(--text-secondary);
      }

      .param-value {
        font-size: 14px;
        font-weight: 500;
        color: var(--accent-purple);
      }

      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-secondary);
      }

      .empty-state span {
        font-size: 48px;
        margin-bottom: 10px;
      }

      /* File input styling */
      .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
      }

      .file-input-wrapper input[type="file"] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1><span>üß†</span>Auto-Learning Results Viewer</h1>
      <div class="controls">
        <div class="file-input-wrapper">
          <button>üìÇ Load JSON</button>
          <input type="file" id="jsonFileInput" accept=".json" />
        </div>
        <select id="sortBy">
          <option value="name">Sort by Name</option>
          <option value="score-asc">Score ‚Üë</option>
          <option value="score-desc">Score ‚Üì</option>
          <option value="time">Processing Time</option>
        </select>
        <input type="text" id="searchInput" placeholder="üîç Search images..." />
      </div>
    </div>

    <div class="stats-bar" id="statsBar">
      <div class="stat-item">
        <div class="stat-value" id="totalCount">0</div>
        <div class="stat-label">Total Images</div>
      </div>
      <div class="stat-item">
        <div class="stat-value excellent" id="avgScore">0</div>
        <div class="stat-label">Avg Score</div>
      </div>
      <div class="stat-item">
        <div class="stat-value excellent" id="excellentCount">0</div>
        <div class="stat-label">Excellent</div>
      </div>
      <div class="stat-item">
        <div class="stat-value good" id="goodCount">0</div>
        <div class="stat-label">Good</div>
      </div>
      <div class="stat-item">
        <div class="stat-value acceptable" id="acceptableCount">0</div>
        <div class="stat-label">Acceptable</div>
      </div>
      <div class="stat-item">
        <div class="stat-value bad" id="rejectedCount">0</div>
        <div class="stat-label">Rejected</div>
      </div>
    </div>

    <div class="main-content">
      <div class="sidebar">
        <ul class="image-list" id="imageList">
          <!-- Items will be populated dynamically -->
        </ul>
      </div>

      <div class="viewer" id="viewer">
        <div class="empty-state">
          <span>üìÇ</span>
          <p>Load a JSON results file to view</p>
        </div>
      </div>
    </div>

    <script>
      // Sample data structure
      let resultsData = [];
      let selectedIndex = -1;

      // DOM elements
      const imageList = document.getElementById("imageList");
      const viewer = document.getElementById("viewer");
      const searchInput = document.getElementById("searchInput");
      const sortSelect = document.getElementById("sortBy");
      const jsonFileInput = document.getElementById("jsonFileInput");

      // Load JSON file
      jsonFileInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
          const text = await file.text();
          const data = JSON.parse(text);

          // Handle different JSON structures
          if (Array.isArray(data)) {
            resultsData = data;
          } else if (data.rounds && Array.isArray(data.rounds)) {
            // Auto-optimizer format
            resultsData = [];
            data.rounds.forEach((round) => {
              if (round.results) {
                round.results.forEach((r) => {
                  resultsData.push({
                    ...r,
                    round: round.round_number,
                    params: round.params,
                  });
                });
              }
            });
          } else if (data.history) {
            resultsData = data.history;
          }

          updateStats();
          renderImageList();
        } catch (err) {
          alert("Error loading JSON: " + err.message);
        }
      });

      // Update stats
      function updateStats() {
        const total = resultsData.length;
        const scores = resultsData.map((r) => r.score || 0);
        const avg = total > 0 ? scores.reduce((a, b) => a + b, 0) / total : 0;

        document.getElementById("totalCount").textContent = total;
        document.getElementById("avgScore").textContent = avg.toFixed(1);
        document.getElementById("excellentCount").textContent = scores.filter(
          (s) => s >= 90,
        ).length;
        document.getElementById("goodCount").textContent = scores.filter(
          (s) => s >= 75 && s < 90,
        ).length;
        document.getElementById("acceptableCount").textContent = scores.filter(
          (s) => s >= 60 && s < 75,
        ).length;
        document.getElementById("rejectedCount").textContent = scores.filter(
          (s) => s < 60,
        ).length;
      }

      // Render image list
      function renderImageList() {
        const searchTerm = searchInput.value.toLowerCase();
        let filtered = resultsData.filter((r) =>
          (r.image_name || r.image || "").toLowerCase().includes(searchTerm),
        );

        // Sort
        const sortBy = sortSelect.value;
        filtered.sort((a, b) => {
          if (sortBy === "score-asc") return (a.score || 0) - (b.score || 0);
          if (sortBy === "score-desc") return (b.score || 0) - (a.score || 0);
          if (sortBy === "time")
            return (a.processing_time_ms || 0) - (b.processing_time_ms || 0);
          return (a.image_name || a.image || "").localeCompare(
            b.image_name || b.image || "",
          );
        });

        imageList.innerHTML = filtered
          .map((item, i) => {
            const name = item.image_name || item.image || `Image ${i + 1}`;
            const score = item.score || 0;
            const scoreClass =
              score >= 90
                ? "excellent"
                : score >= 75
                  ? "good"
                  : score >= 60
                    ? "acceptable"
                    : "bad";

            return `
                    <li class="image-item ${i === selectedIndex ? "active" : ""}" 
                        onclick="selectImage(${resultsData.indexOf(item)})">
                        <span class="image-name" title="${name}">${name}</span>
                        <span class="image-score score-${scoreClass}">${score.toFixed(0)}</span>
                    </li>
                `;
          })
          .join("");
      }

      // Select image
      function selectImage(index) {
        selectedIndex = index;
        renderImageList();
        renderDetail(resultsData[index]);
      }

      // Render detail view
      function renderDetail(item) {
        if (!item) {
          viewer.innerHTML = `
                    <div class="empty-state">
                        <span>üìÇ</span>
                        <p>Select an image to view details</p>
                    </div>
                `;
          return;
        }

        const score = item.score || 0;
        const scoreClass =
          score >= 90
            ? "excellent"
            : score >= 75
              ? "good"
              : score >= 60
                ? "acceptable"
                : "bad";
        const classification =
          item.classification ||
          (score >= 90
            ? "excellent"
            : score >= 75
              ? "good"
              : score >= 60
                ? "acceptable"
                : "rejected");

        // Build checks
        const checks = [
          { name: "Vehicle Complete", pass: item.vehicle_complete !== false },
          { name: "Wheels Intact", pass: item.wheels_intact !== false },
          {
            name: "No Ground Shadow",
            pass: item.no_shadows !== false && item.no_ground_shadow !== false,
          },
          { name: "Clean Edges", pass: item.clean_edges !== false },
          { name: "No Background", pass: item.no_background !== false },
          { name: "Shadow Natural", pass: item.shadow_natural !== false },
        ];

        // Build issues and suggestions
        const issues = item.issues || [];
        const suggestions = item.suggestions || [];

        // Build params
        const params = item.params || {};

        viewer.innerHTML = `
                <div class="comparison-container">
                    <div class="image-panel">
                        <div class="panel-header">üì∑ Original</div>
                        <div class="panel-content">
                            <img src="input/${item.image_name || item.image}" alt="Original" 
                                 onerror="this.parentElement.innerHTML='<p style=\\'color: var(--text-secondary)\\'>Image not found</p>'">
                        </div>
                    </div>
                    <div class="image-panel">
                        <div class="panel-header">‚ú® Result</div>
                        <div class="panel-content transparent-bg">
                            <img src="output_autolearn/shadow/${(item.image_name || item.image || "").replace(/\.[^/.]+$/, "")}_autolearn.png" 
                                 alt="Result"
                                 onerror="this.parentElement.innerHTML='<p style=\\'color: var(--text-secondary)\\'>Result not found</p>'">
                        </div>
                    </div>
                </div>
                
                <div class="evaluation-panel">
                    <div class="evaluation-header">
                        <div>
                            <span class="score-badge score-${scoreClass}">${score.toFixed(1)}</span>
                            <span style="font-size: 16px; color: var(--text-secondary)">/100</span>
                        </div>
                        <span class="classification score-${scoreClass}">${classification.toUpperCase()}</span>
                    </div>
                    
                    <div class="checks-grid">
                        ${checks
                          .map(
                            (c) => `
                            <div class="check-item">
                                <span class="check-icon ${c.pass ? "pass" : "fail"}">${c.pass ? "‚úì" : "‚úó"}</span>
                                <span>${c.name}</span>
                            </div>
                        `,
                          )
                          .join("")}
                    </div>
                    
                    ${
                      issues.length > 0
                        ? `
                        <div class="issues-section">
                            <div class="section-title">‚ö†Ô∏è Issues Detected</div>
                            ${issues.map((i) => `<div class="issue-item">${i}</div>`).join("")}
                        </div>
                    `
                        : ""
                    }
                    
                    ${
                      suggestions.length > 0
                        ? `
                        <div class="suggestions-section">
                            <div class="section-title">üí° Suggestions</div>
                            ${suggestions.map((s) => `<div class="suggestion-item">${s}</div>`).join("")}
                        </div>
                    `
                        : ""
                    }
                </div>
                
                ${
                  Object.keys(params).length > 0
                    ? `
                    <div class="params-panel">
                        <div class="section-title" style="margin-bottom: 15px;">üîß Parameters Used</div>
                        <div class="params-grid">
                            ${Object.entries(params)
                              .map(
                                ([k, v]) => `
                                <div class="param-item">
                                    <div class="param-name">${k}</div>
                                    <div class="param-value">${typeof v === "number" ? v.toFixed(2) : v}</div>
                                </div>
                            `,
                              )
                              .join("")}
                        </div>
                    </div>
                `
                    : ""
                }
            `;
      }

      // Event listeners
      searchInput.addEventListener("input", renderImageList);
      sortSelect.addEventListener("change", renderImageList);

      // Demo data for testing
      function loadDemoData() {
        resultsData = [
          {
            image_name: "car1.jpg",
            score: 94.5,
            classification: "excellent",
            vehicle_complete: true,
            wheels_intact: true,
            no_ground_shadow: true,
            clean_edges: true,
            no_background: true,
            shadow_natural: true,
            issues: [],
            suggestions: [],
            params: {
              detection_confidence: 0.25,
              edge_softness: 2.0,
              shadow_intensity: 0.45,
            },
          },
          {
            image_name: "truck1.jpg",
            score: 78.2,
            classification: "good",
            vehicle_complete: true,
            wheels_intact: true,
            no_ground_shadow: false,
            clean_edges: true,
            no_background: true,
            shadow_natural: true,
            issues: ["Ground shadow partially included"],
            suggestions: ["Increase erosion iterations"],
            params: {
              detection_confidence: 0.28,
              edge_softness: 2.5,
              shadow_intensity: 0.5,
            },
          },
        ];
        updateStats();
        renderImageList();
      }
    </script>
  </body>
</html>
