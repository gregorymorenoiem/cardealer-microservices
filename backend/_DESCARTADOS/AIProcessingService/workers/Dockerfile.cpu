# ===================================================================
# AI Workers - CPU Version (No GPU Required)
# For local development and testing without NVIDIA GPU
# ===================================================================

FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgl1 \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender1 \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Install Python dependencies (CPU versions)
# First install PyTorch CPU version
RUN pip install --no-cache-dir \
    torch==2.1.0 \
    torchvision==0.16.0 \
    --index-url https://download.pytorch.org/whl/cpu

# Then install other dependencies from PyPI
RUN pip install --no-cache-dir \
    aio-pika==9.3.0 \
    boto3==1.34.0 \
    Pillow==10.1.0 \
    numpy==1.26.2 \
    opencv-python-headless==4.8.1.78 \
    httpx==0.25.2 \
    pydantic==2.5.2 \
    python-dotenv==1.0.0 \
    scipy==1.11.4

# Install model-specific packages
ARG WORKER_TYPE=sam2
RUN if [ "$WORKER_TYPE" = "sam2" ]; then \
        pip install --no-cache-dir segment-anything-2==0.1.0 || pip install --no-cache-dir git+https://github.com/facebookresearch/segment-anything-2.git; \
        # Also install ultralytics for YOLO-based vehicle detection before SAM2 segmentation
        pip install --no-cache-dir ultralytics==8.0.200; \
    elif [ "$WORKER_TYPE" = "clip" ]; then \
        pip install --no-cache-dir git+https://github.com/openai/CLIP.git ftfy regex; \
    elif [ "$WORKER_TYPE" = "yolo" ]; then \
        pip install --no-cache-dir ultralytics==8.0.200; \
    fi

# Copy worker files
COPY *.py ./

# Set environment for CPU
ENV DEVICE=cpu
ENV PYTORCH_ENABLE_MPS_FALLBACK=1

# Health check
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
    CMD python -c "print('healthy')" || exit 1

# Default command (override in docker-compose)
CMD ["python", "-u", "sam2_worker.py"]
