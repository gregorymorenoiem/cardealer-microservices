<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üéØ Auto-Optimizer Progress</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: #fff;
        min-height: 100vh;
        padding: 20px;
      }

      .header {
        text-align: center;
        padding: 30px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .status-bar {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .stat {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px 30px;
        border-radius: 10px;
        text-align: center;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #4ecdc4;
      }

      .stat-label {
        font-size: 0.9rem;
        color: #888;
      }

      .round-container {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 30px;
      }

      .round-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .round-title {
        font-size: 1.5rem;
      }

      .round-score {
        font-size: 1.2rem;
        padding: 8px 20px;
        border-radius: 20px;
      }

      .score-excellent {
        background: linear-gradient(135deg, #00b894, #00cec9);
      }
      .score-good {
        background: linear-gradient(135deg, #0984e3, #74b9ff);
      }
      .score-acceptable {
        background: linear-gradient(135deg, #fdcb6e, #f39c12);
        color: #333;
      }
      .score-poor {
        background: linear-gradient(135deg, #e17055, #d63031);
      }

      .images-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
      }

      .image-card {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 15px;
        overflow: hidden;
        transition: transform 0.3s;
      }

      .image-card:hover {
        transform: scale(1.02);
      }

      .image-container {
        position: relative;
        background: repeating-conic-gradient(#333 0% 25%, #444 0% 50%) 50% /
          20px 20px;
        aspect-ratio: 4/3;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .image-container img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }

      .image-info {
        padding: 15px;
      }

      .image-name {
        font-weight: bold;
        margin-bottom: 8px;
      }

      .image-score {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .score-bar {
        flex: 1;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
      }

      .score-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s;
      }

      .score-number {
        font-weight: bold;
        min-width: 50px;
        text-align: right;
      }

      .issues-list {
        margin-top: 10px;
        font-size: 0.85rem;
        color: #ff7675;
      }

      .refresh-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: linear-gradient(135deg, #6c5ce7, #a29bfe);
        border: none;
        color: white;
        padding: 15px 30px;
        border-radius: 30px;
        font-size: 1rem;
        cursor: pointer;
        box-shadow: 0 5px 20px rgba(108, 92, 231, 0.4);
        transition: transform 0.2s;
      }

      .refresh-btn:hover {
        transform: scale(1.05);
      }

      .auto-refresh {
        position: fixed;
        bottom: 30px;
        left: 30px;
        background: rgba(255, 255, 255, 0.1);
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 0.9rem;
      }

      .loading {
        text-align: center;
        padding: 50px;
        color: #888;
      }

      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top: 3px solid #4ecdc4;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .comparison-toggle {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
      }

      .toggle-btn {
        padding: 10px 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: transparent;
        color: white;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .toggle-btn.active {
        background: rgba(78, 205, 196, 0.3);
        border-color: #4ecdc4;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üéØ Auto-Optimizer Progress</h1>
      <p>Optimizaci√≥n autom√°tica hacia score ‚â•95</p>
      <div class="status-bar" id="status-bar">
        <div class="stat">
          <div class="stat-value" id="current-round">-</div>
          <div class="stat-label">Ronda Actual</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="avg-score">-</div>
          <div class="stat-label">Score Promedio</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="best-score">-</div>
          <div class="stat-label">Mejor Score</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="images-passed">-</div>
          <div class="stat-label">Im√°genes ‚â•95</div>
        </div>
      </div>
    </div>

    <div class="comparison-toggle">
      <button class="toggle-btn active" onclick="showRound('latest')">
        √öltima Ronda
      </button>
      <button class="toggle-btn" onclick="showRound('all')">
        Todas las Rondas
      </button>
      <button class="toggle-btn" onclick="showRound('compare')">
        Comparar Original vs Mejor
      </button>
    </div>

    <div id="content">
      <div class="loading">
        <div class="spinner"></div>
        <p>Buscando resultados de optimizaci√≥n...</p>
      </div>
    </div>

    <div class="auto-refresh">
      <label>
        <input type="checkbox" id="auto-refresh-toggle" checked />
        Auto-refresh cada 10s
      </label>
    </div>

    <button class="refresh-btn" onclick="loadData()">üîÑ Refrescar</button>

    <script>
      let autoRefreshInterval;
      let currentView = "latest";
      let allData = null;

      // Imagen paths
      const INPUT_PATH = "input/";
      const OUTPUT_PATH = "output_optimized/";
      const OUTPUT_V2_PATH = "output_v2/";

      // Load optimization logs
      async function loadData() {
        try {
          // Try to load the latest log
          const logFiles = await fetchLogFiles();

          if (logFiles.length === 0) {
            // Check for output_optimized images
            await loadFromImages();
            return;
          }

          // Load latest log
          const latestLog = logFiles[logFiles.length - 1];
          const response = await fetch(`optimization_logs/${latestLog}`);
          allData = await response.json();

          updateUI();
        } catch (error) {
          console.error("Error loading data:", error);
          await loadFromImages();
        }
      }

      async function fetchLogFiles() {
        try {
          const response = await fetch("optimization_logs/");
          const text = await response.text();
          const matches = text.match(/optimization_\d{8}_\d{6}\.json/g);
          return matches || [];
        } catch {
          return [];
        }
      }

      async function loadFromImages() {
        // Fallback: load directly from output_optimized folder
        const content = document.getElementById("content");

        // Get list of images
        const imageNames = [
          "luxury_car_1",
          "sports_car_1",
          "suv_1",
          "pickup_1",
          "car_front_1",
          "car_side_1",
          "car_rear_1",
          "car_front_2",
          "sedan_1",
          "compact_1",
        ];

        let html = '<div class="round-container">';
        html +=
          '<div class="round-header"><h2 class="round-title">üì∏ Im√°genes Optimizadas</h2></div>';
        html += '<div class="images-grid">';

        for (const name of imageNames) {
          // Check for latest round images
          const roundImages = await findRoundImages(name);

          if (roundImages.length > 0) {
            const latestImage = roundImages[roundImages.length - 1];
            html += createImageCard(name, latestImage);
          }
        }

        html += "</div></div>";
        content.innerHTML = html;
      }

      async function findRoundImages(baseName) {
        const images = [];
        for (let round = 1; round <= 20; round++) {
          const path = `${OUTPUT_PATH}${baseName}_r${round}.png`;
          try {
            const response = await fetch(path, { method: "HEAD" });
            if (response.ok) {
              images.push({ round, path });
            }
          } catch {}
        }
        return images;
      }

      function createImageCard(name, imageInfo) {
        const score = imageInfo.score || "?";
        const scoreClass =
          score >= 95
            ? "excellent"
            : score >= 85
              ? "good"
              : score >= 70
                ? "acceptable"
                : "poor";
        const scoreColor =
          score >= 95
            ? "#00b894"
            : score >= 85
              ? "#0984e3"
              : score >= 70
                ? "#f39c12"
                : "#d63031";

        return `
                <div class="image-card">
                    <div class="image-container">
                        <img src="${imageInfo.path}" alt="${name}" onerror="this.src='${OUTPUT_V2_PATH}${name}_v2.png'">
                    </div>
                    <div class="image-info">
                        <div class="image-name">${name}</div>
                        <div class="image-score">
                            <div class="score-bar">
                                <div class="score-fill" style="width: ${score}%; background: ${scoreColor}"></div>
                            </div>
                            <div class="score-number">${score}/100</div>
                        </div>
                        ${imageInfo.issues ? `<div class="issues-list">${imageInfo.issues.slice(0, 2).join(", ")}</div>` : ""}
                    </div>
                </div>
            `;
      }

      function updateUI() {
        if (!allData) return;

        // Update status bar
        const latestRound = allData.rounds[allData.rounds.length - 1];

        document.getElementById("current-round").textContent =
          latestRound.round;
        document.getElementById("avg-score").textContent =
          latestRound.avg_score.toFixed(1);
        document.getElementById("best-score").textContent =
          allData.best_avg_score.toFixed(1);

        const passed = latestRound.results.filter((r) => r.score >= 95).length;
        document.getElementById("images-passed").textContent =
          `${passed}/${latestRound.results.length}`;

        // Update content based on view
        showRound(currentView);
      }

      function showRound(view) {
        currentView = view;
        const content = document.getElementById("content");

        // Update toggle buttons
        document
          .querySelectorAll(".toggle-btn")
          .forEach((btn) => btn.classList.remove("active"));
        event?.target?.classList.add("active");

        if (!allData || !allData.rounds || allData.rounds.length === 0) {
          loadFromImages();
          return;
        }

        let html = "";

        if (view === "latest" || view === "all") {
          const rounds =
            view === "latest"
              ? [allData.rounds[allData.rounds.length - 1]]
              : [...allData.rounds].reverse();

          for (const round of rounds) {
            const scoreClass =
              round.avg_score >= 95
                ? "excellent"
                : round.avg_score >= 85
                  ? "good"
                  : round.avg_score >= 70
                    ? "acceptable"
                    : "poor";

            html += `
                        <div class="round-container">
                            <div class="round-header">
                                <h2 class="round-title">üìç Ronda ${round.round}</h2>
                                <span class="round-score score-${scoreClass}">
                                    Promedio: ${round.avg_score.toFixed(1)}/100
                                </span>
                            </div>
                            <div class="images-grid">
                    `;

            for (const result of round.results) {
              const baseName = result.image
                .replace(".jpg", "")
                .replace(".jpeg", "")
                .replace(".png", "");
              const imagePath = `${OUTPUT_PATH}${baseName}_r${round.round}.png`;

              html += createImageCard(baseName, {
                path: imagePath,
                score: result.score,
                issues: result.issues,
              });
            }

            html += "</div></div>";
          }
        } else if (view === "compare") {
          // Compare original vs latest optimized
          html += `
                    <div class="round-container">
                        <div class="round-header">
                            <h2 class="round-title">üîÑ Original vs Optimizado</h2>
                        </div>
                        <div class="images-grid">
                `;

          const latestRound = allData.rounds[allData.rounds.length - 1];
          for (const result of latestRound.results) {
            const baseName = result.image
              .replace(".jpg", "")
              .replace(".jpeg", "")
              .replace(".png", "");

            // Original
            html += `
                        <div class="image-card">
                            <div class="image-container">
                                <img src="${INPUT_PATH}${result.image}" alt="Original">
                            </div>
                            <div class="image-info">
                                <div class="image-name">üì∑ ${baseName} (Original)</div>
                            </div>
                        </div>
                    `;

            // Optimized
            html += createImageCard(`${baseName} (Optimizado)`, {
              path: `${OUTPUT_PATH}${baseName}_r${latestRound.round}.png`,
              score: result.score,
              issues: result.issues,
            });
          }

          html += "</div></div>";
        }

        content.innerHTML = html;
      }

      // Auto-refresh
      function setupAutoRefresh() {
        const toggle = document.getElementById("auto-refresh-toggle");

        toggle.addEventListener("change", () => {
          if (toggle.checked) {
            autoRefreshInterval = setInterval(loadData, 10000);
          } else {
            clearInterval(autoRefreshInterval);
          }
        });

        // Start auto-refresh
        if (toggle.checked) {
          autoRefreshInterval = setInterval(loadData, 10000);
        }
      }

      // Initialize
      loadData();
      setupAutoRefresh();
    </script>
  </body>
</html>
