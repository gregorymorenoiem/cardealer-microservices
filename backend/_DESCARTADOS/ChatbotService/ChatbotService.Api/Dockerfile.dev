############################################
# Etapa única de desarrollo
############################################
FROM mcr.microsoft.com/dotnet/sdk:8.0

# 1) Instala herramientas
RUN apt-get update && apt-get install -y curl

WORKDIR /app

# 2) Copia y restaura el csproj de la API
COPY ChatbotService/ChatbotService.Api/ChatbotService.Api.csproj ./ChatbotService/ChatbotService.Api/
COPY ChatbotService/ChatbotService.Application/ChatbotService.Application.csproj ./ChatbotService/ChatbotService.Application/
COPY ChatbotService/ChatbotService.Domain/ChatbotService.Domain.csproj ./ChatbotService/ChatbotService.Domain/
COPY ChatbotService/ChatbotService.Infrastructure/ChatbotService.Infrastructure.csproj ./ChatbotService/ChatbotService.Infrastructure/
RUN dotnet restore "ChatbotService/ChatbotService.Api/ChatbotService.Api.csproj"

# 3) Copia el resto del código fuente
COPY . .

# 4) Variables de entorno para desarrollo
ENV ASPNETCORE_ENVIRONMENT=Development \
    ASPNETCORE_URLS="http://+:80" \
    DOTNET_BUILD_CONFIGURATION=Release \
    NUGET_XMLDOC_MODE=none

# 5) Compilar el proyecto
RUN dotnet build "ChatbotService/ChatbotService.Api/ChatbotService.Api.csproj" -c Release -o /app/build

# 6) Exponer puerto HTTP
EXPOSE 80

# 7) Ejecuta la DLL compilada directamente
ENTRYPOINT ["dotnet", "/app/build/ChatbotService.Api.dll"]
