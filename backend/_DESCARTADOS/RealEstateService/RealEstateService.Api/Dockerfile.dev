############################################
# Etapa única de desarrollo
############################################
FROM mcr.microsoft.com/dotnet/sdk:8.0

# 1) Instala herramientas
RUN apt-get update && apt-get install -y curl

WORKDIR /app

# 2) Copia proyectos compartidos primero
COPY _Shared/CarDealer.Shared/CarDealer.Shared.csproj ./_Shared/CarDealer.Shared/
COPY _Shared/CarDealer.Contracts/CarDealer.Contracts.csproj ./_Shared/CarDealer.Contracts/

# 3) Copia y restaura el csproj de la API
COPY RealEstateService/RealEstateService.Api/RealEstateService.Api.csproj ./RealEstateService/RealEstateService.Api/
COPY RealEstateService/RealEstateService.Application/RealEstateService.Application.csproj ./RealEstateService/RealEstateService.Application/
COPY RealEstateService/RealEstateService.Domain/RealEstateService.Domain.csproj ./RealEstateService/RealEstateService.Domain/
COPY RealEstateService/RealEstateService.Infrastructure/RealEstateService.Infrastructure.csproj ./RealEstateService/RealEstateService.Infrastructure/
RUN dotnet restore "RealEstateService/RealEstateService.Api/RealEstateService.Api.csproj"

# 4) Copia el resto del código fuente
COPY . .

# 5) Variables de entorno para desarrollo
ENV ASPNETCORE_ENVIRONMENT=Development \
    ASPNETCORE_URLS="http://+:80" \
    DOTNET_BUILD_CONFIGURATION=Release \
    NUGET_XMLDOC_MODE=none

# 6) Compilar el proyecto
RUN dotnet build "RealEstateService/RealEstateService.Api/RealEstateService.Api.csproj" -c Release -o /app/build

# 7) Exponer puerto HTTP
EXPOSE 80

# 8) Ejecuta la DLL compilada directamente
ENTRYPOINT ["dotnet", "/app/build/RealEstateService.Api.dll"]
