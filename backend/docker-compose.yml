services:
  # PostgreSQL Database for ErrorService
  errorservice-db:
    image: postgres:16
    container_name: errorservice-db
    environment:
      POSTGRES_DB: errorservice
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "25432:5432" # Cambiado a puerto alto
    volumes:
      - errorservice_data:/var/lib/postgresql/data
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ErrorService API
  errorservice:
    build:
      context: .
      dockerfile: ErrorService/Dockerfile
    container_name: errorservice
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    cpus: 0.50
    mem_limit: 512m
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      ConnectionStrings__DefaultConnection: "Host=errorservice-db;Database=errorservice;Username=postgres;Password=password"
    ports:
      - "15083:80"
      - "24022:4022"
    depends_on:
      errorservice-db:
        condition: service_healthy
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD-SHELL", "dotnet /app/ErrorService.Api.dll --help > /dev/null 2>&1 || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ------------------------
  # AuthService Database
  # ------------------------
  authservice-db:
    image: postgres:16
    container_name: authservice-db
    environment:
      POSTGRES_DB: authservice
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "25434:5432" # Cambiado a puerto alto
    volumes:
      - authservice_data:/var/lib/postgresql/data
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ------------------------
  # AuthService API
  # ------------------------
  authservice:
    build:
      context: .
      dockerfile: AuthService/Dockerfile
    container_name: authservice
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    cpus: 0.50
    mem_limit: 512m
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      ConnectionStrings__DefaultConnection: "Host=authservice-db;Database=authservice;Username=postgres;Password=password"
      ConnectionStrings__ErrorServiceConnection: "Host=errorservice-db;Database=errorservice;Username=postgres;Password=password"
      ConnectionStrings__Redis: "redis:6379"
      RabbitMQ__Host: "rabbitmq"
      RabbitMQ__Port: "5672"
      RabbitMQ__Username: "guest"
      RabbitMQ__Password: "guest"
      RabbitMQ__VirtualHost: "/"
      AuthService__EnableRabbitMQ: "true"
      AuthService__QueueName: "notification-queue"
      AuthService__ExchangeName: "notification-exchange"
      AuthService__RoutingKey: "notification.auth"
      AuthService__EmailQueueName: "notification-email-queue"
      AuthService__SmsQueueName: "notification-sms-queue"
      AuthService__PushQueueName: "notification-push-queue"
    ports:
      - "15085:80"
      - "24023:4022"
    depends_on:
      authservice-db:
        condition: service_healthy
      errorservice-db:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD-SHELL", "dotnet /app/AuthService.Api.dll --help > /dev/null 2>&1 || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ------------------------
  # NotificationService Database
  # ------------------------
  notificationservice-db:
    image: postgres:16
    container_name: notificationservice-db
    environment:
      POSTGRES_DB: notificationservice
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "25433:5432" # Cambiado a puerto alto
    volumes:
      - notificationservice_data:/var/lib/postgresql/data
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ------------------------
  # RabbitMQ for Message Bus
  # ------------------------
  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: cargurus_rabbitmq
    hostname: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672" # AMQP - puerto alto
      - "15672:15672" # Management UI - puerto alto
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - cargurus-net
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 30s
      retries: 3

  # ------------------------
  # NotificationService API
  # ------------------------
  notificationservice:
    build:
      context: .
      dockerfile: NotificationService/Dockerfile
    container_name: notificationservice
    restart: always
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    cpus: 0.75
    mem_limit: 1g
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: "http://+:80"
      DOTNET_USE_POLLING_FILE_WATCHER: "true"
      DOTNET_USE_POLLING_FILE_WATCHER_INTERVAL: "4000"
      ConnectionStrings__DefaultConnection: "Host=notificationservice-db;Database=notificationservice;Username=postgres;Password=password"
      RabbitMQ__Host: "rabbitmq"
      RabbitMQ__Port: "5672"
      RabbitMQ__Username: "guest"
      RabbitMQ__Password: "guest"
      RabbitMQ__VirtualHost: "/"
      NotificationService__EnableRabbitMQ: "true"
      NotificationService__QueueName: "notification-queue"
      NotificationService__ExchangeName: "notification-exchange"
      NotificationService__RoutingKey: "notification.auth"
      NotificationService__EmailQueueName: "notification-email-queue"
      NotificationService__SmsQueueName: "notification-sms-queue"
      NotificationService__PushQueueName: "notification-push-queue"
      NotificationService__RetryDelayMs: "60000"
      NotificationService__MaxRetryAttempts: "3"
      NotificationService__PrefetchCount: "10"
      NotificationSettings__SendGrid__ApiKey: "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"
      NotificationSettings__SendGrid__FromEmail: "gregorymoreno.iem@gmail.com"
      NotificationSettings__SendGrid__FromName: "CarGurus Dev"
      NotificationSettings__Twilio__AccountSid: "AC19fec9dd3df70a34f6252c9ef649a532"
      NotificationSettings__Twilio__AuthToken: "2221beebc69b7251062f2b10d7ed75e6"
      NotificationSettings__Twilio__FromNumber: "+13476622382"
      NotificationSettings__Firebase__ServiceAccountKeyPath: "/app/firebase-service-account.json"
      NotificationSettings__Firebase__ProjectId: "cargurus-dev"
      NotificationSettings__TemplatesPath: "/app/Templates"
    ports:
      - "15084:80"
      - "24026:4022"
    depends_on:
      notificationservice-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - cargurus-net
    volumes:
      - ./NotificationService/NotificationService.Infrastructure/Templates:/app/Templates:ro
      - ./firebase-dev-key.json:/app/firebase-service-account.json:ro
    healthcheck:
      test: [ "CMD-SHELL", "dotnet /app/NotificationService.Api.dll --help > /dev/null 2>&1 || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ------------------------
  # Redis for Caching
  # ------------------------
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 3

  # ------------------------
  # Seq - Centralized Logging
  # ------------------------
  seq:
    image: datalust/seq:latest
    container_name: seq
    environment:
      ACCEPT_EULA: "Y"
    ports:
      - "5341:80" # Web UI
      - "5342:5341" # Ingestion
    volumes:
      - seq_data:/data
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ------------------------
  # LoggingService API
  # ------------------------
  loggingservice:
    build:
      context: ./LoggingService
      dockerfile: Dockerfile
    container_name: loggingservice
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      Seq__Url: "http://seq:80"
    ports:
      - "5096:80"
    depends_on:
      seq:
        condition: service_healthy
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ------------------------
  # API Gateway
  # ------------------------
  gateway:
    build:
      context: .
      dockerfile: Gateway/Dockerfile
    container_name: gateway-service
    restart: always
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    cpus: 0.50
    mem_limit: 512m
    depends_on:
      - errorservice
      - authservice
      - notificationservice
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: "http://+:80"
      DOTNET_USE_POLLING_FILE_WATCHER: "true"
      DOTNET_USE_POLLING_FILE_WATCHER_INTERVAL: "4000"
    ports:
      - "18443:80"
      - "24024:4022"
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD-SHELL", "dotnet /app/Gateway.Api.dll --help > /dev/null 2>&1 || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  auditservice-db:
    image: postgres:15
    container_name: auditservice-db
    environment:
      POSTGRES_DB: auditservice
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5433:5432"
    volumes:
      - audit_db_data:/var/lib/postgresql/data
    networks:
      - cargurus-net

  auditservice:
    build:
      context: .
      dockerfile: AuditService/AuditService.Api/Dockerfile
    container_name: auditservice
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__DefaultConnection: "Host=auditservice-db;Database=auditservice;Username=postgres;Password=password"
      ConnectionStrings__Redis: "redis:6379"
      RabbitMQ__Host: "rabbitmq"
      RabbitMQ__Port: 5672
      RabbitMQ__Username: "guest"
      RabbitMQ__Password: "guest"
      RabbitMQ__VirtualHost: "/"
    ports:
      - "5084:80"
    depends_on:
      - auditservice-db
      - rabbitmq
      - redis
    networks:
      - cargurus-net

  # ------------------------
  # MessageBusService Database
  # ------------------------
  messagebus-db:
    image: postgres:15
    container_name: messagebus-db
    environment:
      POSTGRES_DB: messagebus_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "25432:5432"
    volumes:
      - messagebus_data:/var/lib/postgresql/data
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ------------------------
  # MessageBusService API
  # ------------------------
  messagebusservice:
    build:
      context: .
      dockerfile: MessageBusService/Dockerfile
    container_name: messagebusservice
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    cpus: 0.30
    mem_limit: 256m
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      ConnectionStrings__DefaultConnection: "Host=messagebus-db;Database=messagebus_db;Username=postgres;Password=password"
      RabbitMQ__Host: "rabbitmq"
      RabbitMQ__Port: "5672"
      RabbitMQ__Username: "guest"
      RabbitMQ__Password: "guest"
      RabbitMQ__VirtualHost: "/"
      Consul__Address: "http://consul:8500"
      Service__Name: "MessageBusService"
      Service__Host: "messagebusservice"
      Service__Port: "80"
    ports:
      - "5009:80"
    depends_on:
      messagebus-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      consul:
        condition: service_healthy
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD-SHELL", "dotnet /app/MessageBusService.Api.dll --help > /dev/null 2>&1 || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ------------------------
  # ConfigurationService Database
  # ------------------------
  configurationservice-db:
    image: postgres:15
    container_name: configurationservice-db
    environment:
      POSTGRES_DB: configurationservice
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "5434:5432"
    volumes:
      - configurationservice_data:/var/lib/postgresql/data
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  configurationservice:
    build:
      context: .
      dockerfile: ConfigurationService/ConfigurationService.Api/Dockerfile
    container_name: configurationservice
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    cpus: 0.30
    mem_limit: 256m
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      ConnectionStrings__DefaultConnection: "Host=configurationservice-db;Database=configurationservice;Username=postgres;Password=password"
      Encryption__Key: "SecureEncryptionKey123!ProductionKey"
      Consul__Address: "http://consul:8500"
      Service__Name: "ConfigurationService"
      Service__Host: "configurationservice"
      Service__Port: "80"
      Service__HealthCheckUrl: "http://configurationservice:80/health"
    ports:
      - "5085:80"
    depends_on:
      configurationservice-db:
        condition: service_healthy
      consul:
        condition: service_healthy
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD-SHELL", "dotnet /app/ConfigurationService.Api.dll --help > /dev/null 2>&1 || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ------------------------
  # Consul - Service Discovery
  # ------------------------
  consul:
    image: hashicorp/consul:1.18
    container_name: consul
    command: agent -server -ui -bootstrap-expect=1 -client=0.0.0.0
    environment:
      CONSUL_BIND_INTERFACE: eth0
    ports:
      - "8500:8500" # HTTP API & UI
      - "8600:8600/udp" # DNS
    volumes:
      - consul_data:/consul/data
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "consul", "members" ]
      interval: 10s
      timeout: 5s
      retries: 3

  # ------------------------
  # ServiceDiscovery API
  # ------------------------
  servicediscovery:
    build:
      context: ./ServiceDiscovery
      dockerfile: Dockerfile
    container_name: servicediscovery
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      Consul__Address: http://consul:8500
    ports:
      - "5096:80"
    depends_on:
      consul:
        condition: service_healthy
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ------------------------
  # CacheService API
  # ------------------------
  cacheservice:
    build:
      context: ./CacheService
      dockerfile: Dockerfile
    container_name: cacheservice
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      ConnectionStrings__Redis: "redis:6379"
      CacheConfiguration__DefaultTtlSeconds: "3600"
      CacheConfiguration__MaxTtlSeconds: "86400"
      CacheConfiguration__EnableStatistics: "true"
    ports:
      - "5095:80"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ------------------------
  # Jaeger - Distributed Tracing
  # ------------------------
  jaeger:
    image: jaegertracing/all-in-one:1.51
    container_name: jaeger
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    ports:
      - "5775:5775/udp" # Zipkin compact
      - "6831:6831/udp" # Jaeger compact
      - "6832:6832/udp" # Jaeger binary
      - "5778:5778" # Configs
      - "16686:16686" # Web UI
      - "14268:14268" # Jaeger collector
      - "14250:14250" # Jaeger gRPC
      - "9411:9411" # Zipkin
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:16686" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # TracingService API - Query interface for Jaeger
  tracingservice:
    build:
      context: ./TracingService
      dockerfile: TracingService.Api/Dockerfile
    container_name: tracingservice
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      Jaeger__QueryUrl: "http://jaeger:16686"
    ports:
      - "5097:80"
    depends_on:
      jaeger:
        condition: service_healthy
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80/health" ]
      interval: 30s
      timeout: 10s
      retries: 3

  # Prometheus - Metrics storage and querying
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./monitoring/prometheus/alerts:/etc/prometheus/alerts
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Grafana - Metrics visualization
  grafana:
    image: grafana/grafana:10.2.2
    container_name: grafana
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: http://localhost:3000
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards
      - grafana_data:/var/lib/grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Alertmanager - Alert handling
  alertmanager:
    image: prom/alertmanager:v0.26.0
    container_name: alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    volumes:
      - ./monitoring/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml
      - alertmanager_data:/alertmanager
    ports:
      - "9093:9093"
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "wget", "--spider", "-q", "http://localhost:9093/-/healthy" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ------------------------
  # SchedulerService Database
  # ------------------------
  schedulerservice-db:
    image: postgres:16
    container_name: schedulerservice-db
    environment:
      POSTGRES_DB: schedulerservice
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "25440:5432"
    volumes:
      - schedulerservice_data:/var/lib/postgresql/data
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ------------------------
  # SchedulerService API
  # ------------------------
  schedulerservice:
    build:
      context: ./SchedulerService
      dockerfile: Dockerfile
    container_name: schedulerservice
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      ConnectionStrings__DefaultConnection: "Host=schedulerservice-db;Database=schedulerservice;Username=postgres;Password=password"
      Hangfire__ServerName: "SchedulerService-Docker"
      Hangfire__WorkerCount: "5"
      Hangfire__DashboardPath: "/hangfire"
    ports:
      - "15091:80"
    depends_on:
      schedulerservice-db:
        condition: service_healthy
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ------------------------
  # HealthCheckService API
  # ------------------------
  healthcheckservice:
    build:
      context: ./HealthCheckService
      dockerfile: Dockerfile
    container_name: healthcheckservice
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      Services__ErrorService: "http://errorservice"
      Services__AuthService: "http://authservice"
      Services__NotificationService: "http://notificationservice"
      Services__SchedulerService: "http://schedulerservice"
      Services__AuditService: "http://auditservice"
    ports:
      - "15092:80"
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ------------------------
  # Elasticsearch
  # ------------------------
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ------------------------
  # SearchService API
  # ------------------------
  searchservice:
    build:
      context: ./SearchService
      dockerfile: Dockerfile
    container_name: searchservice
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      Elasticsearch__Url: "http://elasticsearch:9200"
      Elasticsearch__IndexPrefix: "cardealer"
      Elasticsearch__DefaultShards: "1"
      Elasticsearch__DefaultReplicas: "0"
    ports:
      - "15093:80"
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ------------------------
  # FeatureToggleService Database
  # ------------------------
  featuretoggleservice-db:
    image: postgres:16
    container_name: featuretoggleservice-db
    environment:
      POSTGRES_DB: featuretoggleservice
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "25441:5432"
    volumes:
      - featuretoggleservice_data:/var/lib/postgresql/data
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ------------------------
  # FeatureToggleService API
  # ------------------------
  featuretoggleservice:
    build:
      context: .
      dockerfile: FeatureToggleService/FeatureToggleService.Api/Dockerfile
    container_name: featuretoggleservice
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      ConnectionStrings__DefaultConnection: "Host=featuretoggleservice-db;Database=featuretoggleservice;Username=postgres;Password=password"
      ConnectionStrings__Redis: "redis:6379"
      FeatureToggle__CacheExpirationSeconds: "60"
      FeatureToggle__EnableCaching: "true"
    ports:
      - "15094:80"
    depends_on:
      featuretoggleservice-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ------------------------
  # ApiDocsService API (API Documentation Aggregator)
  # ------------------------
  apidocsservice:
    build:
      context: .
      dockerfile: ApiDocsService/Dockerfile
    container_name: apidocsservice
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      Services__0__Name: "ErrorService"
      Services__0__BaseUrl: "http://errorservice"
      Services__0__SwaggerEndpoint: "/swagger/v1/swagger.json"
      Services__1__Name: "AuthService"
      Services__1__BaseUrl: "http://authservice"
      Services__1__SwaggerEndpoint: "/swagger/v1/swagger.json"
      Services__2__Name: "NotificationService"
      Services__2__BaseUrl: "http://notificationservice"
      Services__2__SwaggerEndpoint: "/swagger/v1/swagger.json"
      Services__3__Name: "AuditService"
      Services__3__BaseUrl: "http://auditservice"
      Services__3__SwaggerEndpoint: "/swagger/v1/swagger.json"
      Services__4__Name: "ConfigurationService"
      Services__4__BaseUrl: "http://configurationservice"
      Services__4__SwaggerEndpoint: "/swagger/v1/swagger.json"
      Services__5__Name: "SchedulerService"
      Services__5__BaseUrl: "http://schedulerservice"
      Services__5__SwaggerEndpoint: "/swagger/v1/swagger.json"
      Services__6__Name: "HealthCheckService"
      Services__6__BaseUrl: "http://healthcheckservice"
      Services__6__SwaggerEndpoint: "/swagger/v1/swagger.json"
      Services__7__Name: "SearchService"
      Services__7__BaseUrl: "http://searchservice"
      Services__7__SwaggerEndpoint: "/swagger/v1/swagger.json"
      Services__8__Name: "FeatureToggleService"
      Services__8__BaseUrl: "http://featuretoggleservice"
      Services__8__SwaggerEndpoint: "/swagger/v1/swagger.json"
      Services__9__Name: "IdempotencyService"
      Services__9__BaseUrl: "http://idempotencyservice"
      Services__9__SwaggerEndpoint: "/swagger/v1/swagger.json"
      Services__10__Name: "RateLimitingService"
      Services__10__BaseUrl: "http://ratelimitingservice"
      Services__10__SwaggerEndpoint: "/swagger/v1/swagger.json"
    ports:
      - "15095:80"
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ------------------------
  # IdempotencyService API
  # ------------------------
  idempotencyservice:
    build:
      context: ./IdempotencyService
      dockerfile: Dockerfile
    container_name: idempotencyservice
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      ConnectionStrings__Redis: "redis:6379"
      Idempotency__DefaultTtlSeconds: "86400"
      Idempotency__RequireIdempotencyKey: "false"
      Idempotency__ValidateRequestHash: "true"
    ports:
      - "15096:80"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ------------------------
  # RateLimitingService API
  # ------------------------
  ratelimitingservice:
    build:
      context: ./RateLimitingService
      dockerfile: Dockerfile
    container_name: ratelimitingservice
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      ConnectionStrings__Redis: "redis:6379"
      RateLimiting__Enabled: "true"
      RateLimiting__DefaultLimit: "100"
      RateLimiting__DefaultWindowSeconds: "60"
      RateLimiting__KeyPrefix: "ratelimit:"
      RateLimiting__ClientIdHeader: "X-API-Key"
      RateLimiting__UserTierHeader: "X-User-Tier"
      RateLimiting__IncludeHeaders: "true"
    ports:
      - "15097:80"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ------------------------
  # BackupDRService API
  # ------------------------
  backupdrservice:
    build:
      context: ./BackupDRService
      dockerfile: Dockerfile
    container_name: backupdrservice
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      BackupOptions__LocalStoragePath: "/var/backups/cardealer"
      BackupOptions__DefaultRetentionDays: "30"
      BackupOptions__MaxConcurrentJobs: "3"
      BackupOptions__EnableCompressionByDefault: "true"
      BackupOptions__PgDumpPath: "pg_dump"
      BackupOptions__PgRestorePath: "pg_restore"
      ConnectionStrings__DefaultPostgreSQL: "Host=errorservice-db;Database=errorservice;Username=postgres;Password=password"
    ports:
      - "15098:80"
    volumes:
      - backupdr_data:/var/backups/cardealer
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ------------------------
  # ClamAV - Antivirus Scanner
  # ------------------------
  clamav:
    image: clamav/clamav:stable
    container_name: clamav
    restart: unless-stopped
    ports:
      - "3310:3310" # ClamD TCP port
    volumes:
      - clamav_data:/var/lib/clamav
    networks:
      - cargurus-net
    healthcheck:
      test: [ "CMD", "clamdscan", "--ping", "1" ]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 120s # ClamAV needs time to load virus definitions
    environment:
      CLAMAV_NO_FRESHCLAMD: "false" # Enable automatic updates
      FRESHCLAM_CHECKS: "1" # Check for updates once per day

volumes:
  backupdr_data:
  clamav_data:
  errorservice_data:
  authservice_data:
  notificationservice_data:
  rabbitmq_data:
  redis_data:
  audit_db_data:
  messagebus_data:
  configurationservice_data:
  seq_data:
  consul_data:
  schedulerservice_data:
  elasticsearch_data:
  prometheus_data:
  grafana_data:
  alertmanager_data:
  featuretoggleservice_data:


networks:
  cargurus-net:
    driver: bridge
