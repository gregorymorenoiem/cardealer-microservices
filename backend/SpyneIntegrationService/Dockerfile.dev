# SpyneIntegrationService - Development Dockerfile
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
EXPOSE 80
ENV ASPNETCORE_URLS=http://+:80
ENV ASPNETCORE_ENVIRONMENT=Development

# Copy project files
COPY SpyneIntegrationService.Api/SpyneIntegrationService.Api.csproj SpyneIntegrationService.Api/
COPY SpyneIntegrationService.Application/SpyneIntegrationService.Application.csproj SpyneIntegrationService.Application/
COPY SpyneIntegrationService.Domain/SpyneIntegrationService.Domain.csproj SpyneIntegrationService.Domain/
COPY SpyneIntegrationService.Infrastructure/SpyneIntegrationService.Infrastructure.csproj SpyneIntegrationService.Infrastructure/

# Restore dependencies
RUN dotnet restore SpyneIntegrationService.Api/SpyneIntegrationService.Api.csproj

# Copy source code
COPY . .

# Build
WORKDIR /src/SpyneIntegrationService.Api
RUN dotnet build -c Release -o /app/build

# Publish
RUN dotnet publish -c Release -o /app/publish /p:UseAppHost=false

# Runtime stage
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS runtime
WORKDIR /app
EXPOSE 80
ENV ASPNETCORE_URLS=http://+:80
ENV ASPNETCORE_ENVIRONMENT=Development

# Install curl for health check
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

COPY --from=build /app/publish .

HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl --fail http://localhost:80/health || exit 1

ENTRYPOINT ["dotnet", "SpyneIntegrationService.Api.dll"]
