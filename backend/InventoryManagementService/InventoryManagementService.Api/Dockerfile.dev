############################################
# Etapa única de desarrollo
############################################
FROM mcr.microsoft.com/dotnet/sdk:8.0

# 1) Instala herramientas
RUN apt-get update && apt-get install -y curl

WORKDIR /app

# 2) Copia y restaura el csproj de la API
COPY InventoryManagementService/InventoryManagementService.Api/InventoryManagementService.Api.csproj ./InventoryManagementService/InventoryManagementService.Api/
COPY InventoryManagementService/InventoryManagementService.Application/InventoryManagementService.Application.csproj ./InventoryManagementService/InventoryManagementService.Application/
COPY InventoryManagementService/InventoryManagementService.Domain/InventoryManagementService.Domain.csproj ./InventoryManagementService/InventoryManagementService.Domain/
COPY InventoryManagementService/InventoryManagementService.Infrastructure/InventoryManagementService.Infrastructure.csproj ./InventoryManagementService/InventoryManagementService.Infrastructure/
RUN dotnet restore "InventoryManagementService/InventoryManagementService.Api/InventoryManagementService.Api.csproj"

# 3) Copia el resto del código fuente
COPY . .

# 4) Variables de entorno para desarrollo
ENV ASPNETCORE_ENVIRONMENT=Development \
    ASPNETCORE_URLS="http://+:80" \
    DOTNET_BUILD_CONFIGURATION=Release \
    NUGET_XMLDOC_MODE=none

# 5) Compilar el proyecto
RUN dotnet build "InventoryManagementService/InventoryManagementService.Api/InventoryManagementService.Api.csproj" -c Release -o /app/build

# 6) Exponer puerto HTTP
EXPOSE 80

# 7) Ejecuta la DLL compilada directamente
ENTRYPOINT ["dotnet", "/app/build/InventoryManagementService.Api.dll"]
