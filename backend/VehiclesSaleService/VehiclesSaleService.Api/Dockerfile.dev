# Development Dockerfile for VehiclesSaleService
FROM mcr.microsoft.com/dotnet/sdk:8.0

WORKDIR /app

# Install wget for healthcheck
RUN apt-get update && apt-get install -y wget && rm -rf /var/lib/apt/lists/*

# Set environment
ENV ASPNETCORE_ENVIRONMENT=Development
ENV ASPNETCORE_URLS=http://+:80
ENV DOTNET_USE_POLLING_FILE_WATCHER=1

# Copy shared projects
COPY _Shared/CarDealer.Shared/ /app/_Shared/CarDealer.Shared/
COPY _Shared/CarDealer.Contracts/ /app/_Shared/CarDealer.Contracts/
COPY _Shared/CarDealer.Shared.Logging/ /app/_Shared/CarDealer.Shared.Logging/
COPY _Shared/CarDealer.Shared.ErrorHandling/ /app/_Shared/CarDealer.Shared.ErrorHandling/
COPY _Shared/CarDealer.Shared.Observability/ /app/_Shared/CarDealer.Shared.Observability/

# Copy service projects
COPY VehiclesSaleService/VehiclesSaleService.Domain/ /app/VehiclesSaleService/VehiclesSaleService.Domain/
COPY VehiclesSaleService/VehiclesSaleService.Application/ /app/VehiclesSaleService/VehiclesSaleService.Application/
COPY VehiclesSaleService/VehiclesSaleService.Infrastructure/ /app/VehiclesSaleService/VehiclesSaleService.Infrastructure/
COPY VehiclesSaleService/VehiclesSaleService.Shared/ /app/VehiclesSaleService/VehiclesSaleService.Shared/
COPY VehiclesSaleService/VehiclesSaleService.Api/ /app/VehiclesSaleService/VehiclesSaleService.Api/

WORKDIR /app/VehiclesSaleService/VehiclesSaleService.Api

# Restore and publish (publish includes all dependencies)
RUN dotnet restore
RUN dotnet publish -c Debug -o /app/publish

EXPOSE 80

HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:80/health || exit 1

ENTRYPOINT ["dotnet", "/app/publish/VehiclesSaleService.Api.dll"]
