# Docker Compose optimizado para PCs con recursos limitados
# Uso: docker-compose -f docker-compose.limited.yml up -d

services:
  # ============================================
  # INFRAESTRUCTURA BASE (Recursos m√≠nimos)
  # ============================================
  
  # PostgreSQL para AuthService
  authservice-db:
    image: postgres:16-alpine
    container_name: authservice-db
    environment:
      POSTGRES_DB: authservice
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "25434:5432"
    volumes:
      - authservice_data:/var/lib/postgresql/data
    networks:
      - cargurus-net
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # PostgreSQL para ErrorService
  errorservice-db:
    image: postgres:16-alpine
    container_name: errorservice-db
    environment:
      POSTGRES_DB: errorservice
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "25432:5432"
    volumes:
      - errorservice_data:/var/lib/postgresql/data
    networks:
      - cargurus-net
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # PostgreSQL para NotificationService
  notificationservice-db:
    image: postgres:16-alpine
    container_name: notificationservice-db
    environment:
      POSTGRES_DB: notificationservice
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "25433:5432"
    volumes:
      - notificationservice_data:/var/lib/postgresql/data
    networks:
      - cargurus-net
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # PostgreSQL para ProductService
  productservice-db:
    image: postgres:16-alpine
    container_name: productservice-db
    environment:
      POSTGRES_DB: productservice_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - "25446:5432"
    volumes:
      - productservice_data:/var/lib/postgresql/data
    networks:
      - cargurus-net
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Redis (Cache) - Muy eficiente en memoria
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - cargurus-net
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 128M
        reservations:
          memory: 64M
    command: redis-server --maxmemory 100mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # RabbitMQ (Message Broker)
  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: rabbitmq
    hostname: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - cargurus-net
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 384M
        reservations:
          memory: 256M
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 30s
      retries: 3
      start_period: 60s

  # ============================================
  # MICROSERVICIOS CORE (Limitados)
  # ============================================

  # ErrorService API
  errorservice:
    build:
      context: .
      dockerfile: ErrorService/Dockerfile
    container_name: errorservice
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      ConnectionStrings__DefaultConnection: "Host=errorservice-db;Database=errorservice;Username=postgres;Password=password"
      Database__Provider: PostgreSQL
      Database__ConnectionStrings__PostgreSQL: "Host=errorservice-db;Database=errorservice;Username=postgres;Password=password"
      RabbitMQ__Host: rabbitmq
      RabbitMQ__HostName: rabbitmq
      RabbitMQ__Port: 5672
      RabbitMQ__Username: guest
      RabbitMQ__Password: guest
      RabbitMQ__VirtualHost: /
    ports:
      - "15083:80"
    depends_on:
      errorservice-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - cargurus-net
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # AuthService API
  authservice:
    build:
      context: .
      dockerfile: AuthService/Dockerfile
    container_name: authservice
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      ConnectionStrings__DefaultConnection: "Host=authservice-db;Database=authservice;Username=postgres;Password=password"
      ConnectionStrings__Redis: "redis:6379"
      Database__Provider: PostgreSQL
      Database__ConnectionStrings__PostgreSQL: "Host=authservice-db;Database=authservice;Username=postgres;Password=password"
      RabbitMQ__Host: rabbitmq
      RabbitMQ__HostName: rabbitmq
      RabbitMQ__Port: 5672
      RabbitMQ__Username: guest
      RabbitMQ__Password: guest
      RabbitMQ__VirtualHost: /
    ports:
      - "15085:80"
    depends_on:
      authservice-db:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - cargurus-net
    deploy:
      resources:
        limits:
          cpus: '0.4'
          memory: 384M
        reservations:
          memory: 192M
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # NotificationService API
  notificationservice:
    build:
      context: .
      dockerfile: NotificationService/Dockerfile
    container_name: notificationservice
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      ConnectionStrings__DefaultConnection: "Host=notificationservice-db;Database=notificationservice;Username=postgres;Password=password"
      Database__Provider: PostgreSQL
      Database__ConnectionStrings__PostgreSQL: "Host=notificationservice-db;Database=notificationservice;Username=postgres;Password=password"
      RabbitMQ__Host: rabbitmq
      RabbitMQ__HostName: rabbitmq
      RabbitMQ__Port: 5672
      RabbitMQ__Username: guest
      RabbitMQ__Password: guest
      RabbitMQ__VirtualHost: /
      NotificationSettings__SendGrid__ApiKey: "${SENDGRID_API_KEY:-SG.test}"
      NotificationSettings__SendGrid__FromEmail: "noreply@cardealer.com"
      NotificationSettings__SendGrid__FromName: "CarDealer"
      NotificationSettings__Twilio__AccountSid: "${TWILIO_ACCOUNT_SID:-test}"
      NotificationSettings__Twilio__AuthToken: "${TWILIO_AUTH_TOKEN:-test}"
      NotificationSettings__Twilio__FromNumber: "+1234567890"
      NotificationSettings__Firebase__ProjectId: "cardealer-dev"
    ports:
      - "15084:80"
    depends_on:
      notificationservice-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - cargurus-net
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ProductService API
  productservice:
    build:
      context: .
      dockerfile: ProductService/Dockerfile
    container_name: productservice
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      ConnectionStrings__DefaultConnection: "Host=productservice-db;Database=productservice_db;Username=postgres;Password=password"
      Database__Provider: PostgreSQL
      Database__ConnectionStrings__PostgreSQL: "Host=productservice-db;Database=productservice_db;Username=postgres;Password=password"
    ports:
      - "15006:80"
    depends_on:
      productservice-db:
        condition: service_healthy
    networks:
      - cargurus-net
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Gateway API
  gateway:
    build:
      context: .
      dockerfile: Gateway/Dockerfile
    container_name: gateway
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
    ports:
      - "18443:80"
    depends_on:
      - errorservice
      - authservice
    networks:
      - cargurus-net
    deploy:
      resources:
        limits:
          cpus: '0.3'
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  authservice_data:
  errorservice_data:
  notificationservice_data:
  productservice_data:
  redis_data:
  rabbitmq_data:

networks:
  cargurus-net:
    driver: bridge
