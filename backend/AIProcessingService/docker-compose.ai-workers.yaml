# ===================================================================
# Docker Compose - AI Processing Workers with GPU Support
# Run AI workers for vehicle image processing
# ===================================================================
#
# Requirements:
# - NVIDIA GPU with CUDA support
# - nvidia-container-toolkit installed
# - Docker with GPU support
#
# Usage:
#   docker-compose -f docker-compose.ai-workers.yaml up -d
#
# ===================================================================

version: "3.8"

services:
  # ==============================================================
  # SAM2 Worker - Vehicle Segmentation
  # ==============================================================
  ai-worker-sam2:
    build:
      context: ./workers
      dockerfile: Dockerfile.sam2
    container_name: ai-worker-sam2
    restart: unless-stopped
    environment:
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=guest
      - RABBITMQ_PASS=guest
      - S3_BUCKET=${S3_BUCKET:-okla-processed-images}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_REGION=${S3_REGION:-us-east-1}
      - API_CALLBACK_URL=http://aiprocessingservice:8080
      - DEVICE=cuda
      - MODEL_PATH=/models/sam2_hiera_large.pt
    volumes:
      - ai-models:/models
    networks:
      - okla-network
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    depends_on:
      - rabbitmq

  # ==============================================================
  # CLIP Worker - Image Classification
  # ==============================================================
  ai-worker-clip:
    build:
      context: ./workers
      dockerfile: Dockerfile.clip
    container_name: ai-worker-clip
    restart: unless-stopped
    environment:
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=guest
      - RABBITMQ_PASS=guest
      - API_CALLBACK_URL=http://aiprocessingservice:8080
      - DEVICE=cuda
      - CLIP_MODEL=ViT-L/14@336px
    networks:
      - okla-network
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    depends_on:
      - rabbitmq

  # ==============================================================
  # YOLO Worker - Object Detection / License Plate Blurring
  # ==============================================================
  ai-worker-yolo:
    build:
      context: ./workers
      dockerfile: Dockerfile.yolo
    container_name: ai-worker-yolo
    restart: unless-stopped
    environment:
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=guest
      - RABBITMQ_PASS=guest
      - S3_BUCKET=${S3_BUCKET:-okla-processed-images}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_REGION=${S3_REGION:-us-east-1}
      - API_CALLBACK_URL=http://aiprocessingservice:8080
      - DEVICE=0
      - MODEL_PATH=/models/yolov8x.pt
    volumes:
      - ai-models:/models
    networks:
      - okla-network
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    depends_on:
      - rabbitmq

  # ==============================================================
  # AI Processing Service (.NET API)
  # ==============================================================
  aiprocessingservice:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aiprocessingservice
    restart: unless-stopped
    ports:
      - "5070:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Host=postgres;Database=aiprocessingservice;Username=postgres;Password=postgres
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=guest
      - RabbitMQ__Password=guest
      - S3__BucketName=${S3_BUCKET:-okla-processed-images}
      - S3__AccessKey=${S3_ACCESS_KEY}
      - S3__SecretKey=${S3_SECRET_KEY}
      - S3__Region=${S3_REGION:-us-east-1}
    networks:
      - okla-network
    depends_on:
      - postgres
      - rabbitmq
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==============================================================
  # Infrastructure Services (if not running separately)
  # ==============================================================
  postgres:
    image: postgres:16-alpine
    container_name: postgres-ai
    restart: unless-stopped
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=aiprocessingservice
    volumes:
      - postgres-ai-data:/var/lib/postgresql/data
    networks:
      - okla-network
    ports:
      - "5439:5432"

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: rabbitmq-ai
    restart: unless-stopped
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - rabbitmq-ai-data:/var/lib/rabbitmq
    networks:
      - okla-network
    ports:
      - "5679:5672"
      - "15679:15672"

networks:
  okla-network:
    driver: bridge

volumes:
  ai-models:
    driver: local
  postgres-ai-data:
    driver: local
  rabbitmq-ai-data:
    driver: local
