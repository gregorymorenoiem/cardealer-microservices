# ===================================================================
# Docker Compose - AI Workers CPU Version (No GPU Required)
# For local development and testing on Mac/Windows/Linux without GPU
# ===================================================================
#
# Usage:
#   docker-compose -f docker-compose.cpu.yaml up -d
#
# This runs all AI workers on CPU - slower but works everywhere!
# ===================================================================

services:
  # ==============================================================
  # SAM2 Worker - Vehicle Segmentation (CPU)
  # ==============================================================
  ai-worker-sam2:
    build:
      context: ./workers
      dockerfile: Dockerfile.cpu
      args:
        WORKER_TYPE: sam2
    container_name: ai-worker-sam2-cpu
    restart: unless-stopped
    command: ["python", "-u", "sam2_worker.py"]
    environment:
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=guest
      - RABBITMQ_PASS=guest
      - S3_BUCKET=${S3_BUCKET:-okla-processed-images}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY:-}
      - S3_SECRET_KEY=${S3_SECRET_KEY:-}
      - S3_REGION=${S3_REGION:-us-east-1}
      - MEDIA_SERVICE_URL=http://host.docker.internal:15020
      - API_CALLBACK_URL=http://aiprocessingservice:8080
      - DEVICE=cpu
      - MODEL_PATH=/models/sam2_hiera_base.pt
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ai-models:/models
    networks:
      - okla-network
    depends_on:
      rabbitmq:
        condition: service_healthy

  # ==============================================================
  # CLIP Worker - Image Classification (CPU)
  # ==============================================================
  ai-worker-clip:
    build:
      context: ./workers
      dockerfile: Dockerfile.cpu
      args:
        WORKER_TYPE: clip
    container_name: ai-worker-clip-cpu
    restart: unless-stopped
    command: ["python", "-u", "clip_worker.py"]
    environment:
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=guest
      - RABBITMQ_PASS=guest
      - API_CALLBACK_URL=http://aiprocessingservice:8080
      - DEVICE=cpu
      - CLIP_MODEL=ViT-B/32
    networks:
      - okla-network
    depends_on:
      rabbitmq:
        condition: service_healthy

  # ==============================================================
  # YOLO Worker - Object Detection / License Plate Blurring (CPU)
  # ==============================================================
  ai-worker-yolo:
    build:
      context: ./workers
      dockerfile: Dockerfile.cpu
      args:
        WORKER_TYPE: yolo
    container_name: ai-worker-yolo-cpu
    restart: unless-stopped
    command: ["python", "-u", "yolo_worker.py"]
    environment:
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=guest
      - RABBITMQ_PASS=guest
      - S3_BUCKET=${S3_BUCKET:-okla-processed-images}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY:-}
      - S3_SECRET_KEY=${S3_SECRET_KEY:-}
      - S3_REGION=${S3_REGION:-us-east-1}
      - API_CALLBACK_URL=http://aiprocessingservice:8080
      - DEVICE=cpu
      - MODEL_PATH=/models/yolov8n.pt
    volumes:
      - ai-models:/models
    networks:
      - okla-network
    depends_on:
      rabbitmq:
        condition: service_healthy

  # ==============================================================
  # AI Processing Service (.NET API)
  # ==============================================================
  aiprocessingservice:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aiprocessingservice
    restart: unless-stopped
    ports:
      - "5070:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Host=postgres;Database=aiprocessingservice;Username=postgres;Password=postgres
      - RabbitMQ__Host=rabbitmq
      - RabbitMQ__Username=guest
      - RabbitMQ__Password=guest
      - S3__BucketName=${S3_BUCKET:-okla-processed-images}
      - S3__AccessKey=${S3_ACCESS_KEY:-}
      - S3__SecretKey=${S3_SECRET_KEY:-}
      - S3__Region=${S3_REGION:-us-east-1}
    networks:
      - okla-network
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==============================================================
  # Infrastructure Services
  # ==============================================================
  postgres:
    image: postgres:16-alpine
    container_name: postgres-ai
    restart: unless-stopped
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=aiprocessingservice
    volumes:
      - postgres-ai-data:/var/lib/postgresql/data
    networks:
      - okla-network
    ports:
      - "5439:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: rabbitmq-ai
    restart: unless-stopped
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - rabbitmq-ai-data:/var/lib/rabbitmq
    networks:
      - okla-network
    ports:
      - "5679:5672"
      - "15679:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  okla-network:
    driver: bridge

volumes:
  ai-models:
    driver: local
  postgres-ai-data:
    driver: local
  rabbitmq-ai-data:
    driver: local
