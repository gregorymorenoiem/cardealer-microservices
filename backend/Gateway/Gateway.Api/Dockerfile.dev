############################################
# Etapa única de desarrollo con hot-reload
############################################
FROM mcr.microsoft.com/dotnet/sdk:8.0

# Instalar dotnet-watch y herramientas
RUN dotnet tool install --global dotnet-watch \
    && export PATH="$PATH:/root/.dotnet/tools" \
    && apt-get update \
    && apt-get install -y curl

WORKDIR /app

# 2) Copia y restaura sólo el csproj de la API y dependencias
COPY Gateway/Gateway.Api/Gateway.Api.csproj ./Gateway/Gateway.Api/
COPY _Shared/CarDealer.Contracts/CarDealer.Contracts.csproj ./_Shared/CarDealer.Contracts/
COPY _Shared/CarDealer.Shared/CarDealer.Shared.csproj ./_Shared/CarDealer.Shared/
COPY _Shared/CarDealer.Shared.Logging/CarDealer.Shared.Logging.csproj ./_Shared/CarDealer.Shared.Logging/
COPY _Shared/CarDealer.Shared.ErrorHandling/CarDealer.Shared.ErrorHandling.csproj ./_Shared/CarDealer.Shared.ErrorHandling/
COPY _Shared/CarDealer.Shared.Observability/CarDealer.Shared.Observability.csproj ./_Shared/CarDealer.Shared.Observability/
COPY _Shared/CarDealer.Shared.RateLimiting/CarDealer.Shared.RateLimiting.csproj ./_Shared/CarDealer.Shared.RateLimiting/
COPY _Shared/CarDealer.Shared.Resilience/CarDealer.Shared.Resilience.csproj ./_Shared/CarDealer.Shared.Resilience/
COPY _Shared/CarDealer.Shared.Audit/CarDealer.Shared.Audit.csproj ./_Shared/CarDealer.Shared.Audit/
COPY ServiceDiscovery/ServiceDiscovery.Application/ServiceDiscovery.Application.csproj ./ServiceDiscovery/ServiceDiscovery.Application/
COPY ServiceDiscovery/ServiceDiscovery.Infrastructure/ServiceDiscovery.Infrastructure.csproj ./ServiceDiscovery/ServiceDiscovery.Infrastructure/
COPY ServiceDiscovery/ServiceDiscovery.Domain/ServiceDiscovery.Domain.csproj ./ServiceDiscovery/ServiceDiscovery.Domain/
COPY Gateway/Gateway.Application/Gateway.Application.csproj ./Gateway/Gateway.Application/
COPY Gateway/Gateway.Infrastructure/Gateway.Infrastructure.csproj ./Gateway/Gateway.Infrastructure/
COPY Gateway/Gateway.Domain/Gateway.Domain.csproj ./Gateway/Gateway.Domain/

RUN dotnet restore "Gateway/Gateway.Api/Gateway.Api.csproj"

# 3) Copia el resto del código fuente
COPY Gateway/ ./Gateway/
COPY _Shared/ ./_Shared/
COPY ServiceDiscovery/ ./ServiceDiscovery/

# Variables de entorno para desarrollo
ENV ASPNETCORE_ENVIRONMENT=Development \
    ASPNETCORE_URLS="http://+:80" \
    DOTNET_USE_POLLING_FILE_WATCHER=false \
    NUGET_XMLDOC_MODE=none

# Exponer puerto HTTP
EXPOSE 80

# Arrancar con dotnet run (sin --no-build para que compile dentro del contenedor)
ENTRYPOINT ["dotnet", "run", "--project", "Gateway/Gateway.Api/Gateway.Api.csproj", "--urls", "http://0.0.0.0:80"]
