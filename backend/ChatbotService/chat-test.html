<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OKLA Chatbot â€” Test UI</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #e2e8f0;
      }

      .chat-container {
        width: 420px;
        height: 680px;
        background: #1e293b;
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
        border: 1px solid #334155;
      }

      /* Header */
      .chat-header {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        padding: 16px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .bot-avatar {
        width: 44px;
        height: 44px;
        background: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        flex-shrink: 0;
      }
      .bot-info h3 {
        font-size: 16px;
        font-weight: 600;
        color: #fff;
      }
      .bot-info .status {
        font-size: 12px;
        color: #bfdbfe;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #4ade80;
        display: inline-block;
      }
      .status-dot.offline {
        background: #f87171;
      }
      .status-dot.loading {
        background: #fbbf24;
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
      }

      /* Dealer selector */
      .dealer-selector {
        padding: 12px 20px;
        background: #0f172a;
        border-bottom: 1px solid #334155;
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .dealer-selector label {
        font-size: 13px;
        color: #94a3b8;
        white-space: nowrap;
      }
      .dealer-selector select {
        flex: 1;
        background: #1e293b;
        color: #e2e8f0;
        border: 1px solid #475569;
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 13px;
        cursor: pointer;
      }
      .dealer-selector select:focus {
        outline: none;
        border-color: #3b82f6;
      }

      /* Messages area */
      .messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        scroll-behavior: smooth;
      }
      .messages::-webkit-scrollbar {
        width: 4px;
      }
      .messages::-webkit-scrollbar-thumb {
        background: #475569;
        border-radius: 4px;
      }

      .message {
        max-width: 82%;
        padding: 10px 14px;
        border-radius: 16px;
        font-size: 14px;
        line-height: 1.5;
        animation: fadeIn 0.3s ease;
        word-wrap: break-word;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.bot {
        background: #334155;
        color: #e2e8f0;
        align-self: flex-start;
        border-bottom-left-radius: 4px;
      }
      .message.user {
        background: #3b82f6;
        color: #fff;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
      }
      .message.system {
        background: transparent;
        color: #94a3b8;
        font-size: 12px;
        text-align: center;
        align-self: center;
        font-style: italic;
      }
      .message.error {
        background: #7f1d1d;
        color: #fca5a5;
        align-self: center;
        font-size: 13px;
        text-align: center;
      }

      .message .meta {
        font-size: 11px;
        color: #94a3b8;
        margin-top: 4px;
      }
      .message.user .meta {
        color: #bfdbfe;
        text-align: right;
      }

      /* Typing indicator */
      .typing {
        display: flex;
        gap: 4px;
        padding: 12px 14px;
        align-self: flex-start;
      }
      .typing span {
        width: 8px;
        height: 8px;
        background: #64748b;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out;
      }
      .typing span:nth-child(1) {
        animation-delay: 0s;
      }
      .typing span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing span:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0.6);
        }
        40% {
          transform: scale(1);
        }
      }

      /* Quick replies */
      .quick-replies {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        padding: 0 20px 10px;
      }
      .quick-reply-btn {
        background: transparent;
        border: 1px solid #3b82f6;
        color: #60a5fa;
        border-radius: 20px;
        padding: 6px 14px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .quick-reply-btn:hover {
        background: #3b82f6;
        color: #fff;
      }

      /* Input area */
      .input-area {
        padding: 12px 16px;
        background: #0f172a;
        border-top: 1px solid #334155;
        display: flex;
        gap: 8px;
        align-items: flex-end;
      }
      .input-area textarea {
        flex: 1;
        background: #1e293b;
        border: 1px solid #475569;
        border-radius: 12px;
        color: #e2e8f0;
        padding: 10px 14px;
        font-size: 14px;
        font-family: inherit;
        resize: none;
        max-height: 100px;
        outline: none;
        transition: border-color 0.2s;
      }
      .input-area textarea:focus {
        border-color: #3b82f6;
      }
      .input-area textarea::placeholder {
        color: #64748b;
      }

      .send-btn {
        width: 42px;
        height: 42px;
        background: #3b82f6;
        border: none;
        border-radius: 12px;
        color: #fff;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        flex-shrink: 0;
      }
      .send-btn:hover {
        background: #2563eb;
      }
      .send-btn:disabled {
        background: #475569;
        cursor: not-allowed;
      }

      /* Timer */
      .timer-bar {
        padding: 4px 20px;
        background: #0f172a;
        font-size: 11px;
        color: #64748b;
        text-align: center;
        border-top: 1px solid #1e293b;
      }

      /* Info panel */
      .info-panel {
        position: fixed;
        top: 20px;
        left: 20px;
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 12px;
        padding: 16px;
        max-width: 300px;
        font-size: 13px;
        color: #94a3b8;
        line-height: 1.6;
      }
      .info-panel h4 {
        color: #e2e8f0;
        margin-bottom: 8px;
        font-size: 14px;
      }
      .info-panel code {
        background: #0f172a;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
        color: #60a5fa;
      }
      .info-panel .warn {
        color: #fbbf24;
        font-size: 12px;
        margin-top: 8px;
      }

      @media (max-width: 500px) {
        .chat-container {
          width: 100%;
          height: 100vh;
          border-radius: 0;
        }
        .info-panel {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="info-panel">
      <h4>ğŸ”§ OKLA Chatbot â€” Test Mode</h4>
      <p>Conectado a: <code>localhost:5060</code></p>
      <p>Modelo: <code>LLaMA 3 8B (Q4_K_M)</code></p>
      <p>Inferencia: CPU (Docker)</p>
      <p class="warn">âš ï¸ Las respuestas tardan 2-5 min en CPU. Paciencia.</p>
    </div>

    <div class="chat-container">
      <div class="chat-header">
        <div class="bot-avatar" id="botAvatar">ğŸš—</div>
        <div class="bot-info">
          <h3 id="botName">OKLA Chatbot</h3>
          <div class="status">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Conectando...</span>
          </div>
        </div>
      </div>

      <div class="dealer-selector">
        <label>Dealer:</label>
        <select id="dealerSelect">
          <option value="11111111-1111-1111-1111-111111111111">
            ğŸ¢ Auto Dominicana Premium (Ana)
          </option>
          <option value="22222222-2222-2222-2222-222222222222">
            ğŸ”¥ MotorMax RD (Carlos)
          </option>
        </select>
      </div>

      <div class="messages" id="messages"></div>

      <div class="quick-replies" id="quickReplies"></div>

      <div class="timer-bar" id="timerBar"></div>

      <div class="input-area">
        <textarea
          id="messageInput"
          rows="1"
          placeholder="Escribe tu mensaje..."
          disabled
        ></textarea>
        <button class="send-btn" id="sendBtn" disabled>â¤</button>
      </div>
    </div>

    <script>
      const API = "http://localhost:5060";
      let sessionId = null;
      let sessionToken = null;
      let isWaiting = false;

      const messagesEl = document.getElementById("messages");
      const inputEl = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const statusDot = document.getElementById("statusDot");
      const statusText = document.getElementById("statusText");
      const botNameEl = document.getElementById("botName");
      const botAvatar = document.getElementById("botAvatar");
      const dealerSelect = document.getElementById("dealerSelect");
      const quickRepliesEl = document.getElementById("quickReplies");
      const timerBarEl = document.getElementById("timerBar");

      // â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function addMessage(text, type = "bot", meta = "") {
        const div = document.createElement("div");
        div.className = `message ${type}`;
        div.innerHTML = text + (meta ? `<div class="meta">${meta}</div>` : "");
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return div;
      }

      function showTyping() {
        const div = document.createElement("div");
        div.className = "typing";
        div.id = "typingIndicator";
        div.innerHTML = "<span></span><span></span><span></span>";
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function hideTyping() {
        const el = document.getElementById("typingIndicator");
        if (el) el.remove();
      }

      function setStatus(status) {
        statusDot.className =
          "status-dot " +
          (status === "online"
            ? ""
            : status === "loading"
              ? "loading"
              : "offline");
        statusText.textContent =
          status === "online"
            ? "En lÃ­nea"
            : status === "loading"
              ? "Procesando..."
              : "Desconectado";
      }

      function formatTime() {
        return new Date().toLocaleTimeString("es-DO", {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      let timerInterval = null;
      function startTimer() {
        const start = Date.now();
        timerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - start) / 1000);
          const min = Math.floor(elapsed / 60);
          const sec = elapsed % 60;
          timerBarEl.textContent = `â± Esperando respuesta del modelo... ${min}:${sec.toString().padStart(2, "0")}`;
        }, 1000);
      }

      function stopTimer() {
        clearInterval(timerInterval);
        timerBarEl.textContent = "";
      }

      function showQuickReplies(replies) {
        quickRepliesEl.innerHTML = "";
        if (!replies || replies.length === 0) return;
        replies.forEach((r) => {
          const btn = document.createElement("button");
          btn.className = "quick-reply-btn";
          btn.textContent = r.text || r;
          btn.onclick = () => {
            quickRepliesEl.innerHTML = "";
            sendMessage(r.text || r);
          };
          quickRepliesEl.appendChild(btn);
        });
      }

      // â”€â”€â”€ API Calls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function startSession() {
        const dealerId = dealerSelect.value;
        setStatus("loading");
        addMessage("Iniciando sesiÃ³n...", "system");

        try {
          const res = await fetch(`${API}/api/chatbot/sessions`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              dealerId,
              channel: "WebChat",
              visitorName: "Test User",
              visitorEmail: "test@okla.com",
            }),
          });

          if (!res.ok) {
            const errText = await res.text();
            throw new Error(`HTTP ${res.status}: ${errText}`);
          }

          const data = await res.json();
          sessionId = data.sessionId;
          sessionToken = data.sessionToken;

          // Update UI with bot info
          if (data.botName) botNameEl.textContent = data.botName;
          if (data.botAvatarUrl) botAvatar.textContent = "ğŸ¤–";

          setStatus("online");
          inputEl.disabled = false;
          sendBtn.disabled = false;
          dealerSelect.disabled = true;

          // Remove "Iniciando sesiÃ³n..." message
          const msgs = messagesEl.querySelectorAll(".message.system");
          msgs.forEach((m) => {
            if (m.textContent === "Iniciando sesiÃ³n...") m.remove();
          });

          // Show welcome message
          if (data.welcomeMessage) {
            addMessage(data.welcomeMessage, "bot", formatTime());
          }

          // Show quick replies
          if (data.quickReplies) {
            showQuickReplies(data.quickReplies);
          }

          console.log("[Session started]", {
            sessionId,
            sessionToken: sessionToken?.slice(0, 8) + "...",
          });
        } catch (err) {
          setStatus("offline");
          addMessage(`âŒ Error al iniciar sesiÃ³n: ${err.message}`, "error");
          console.error(err);
        }
      }

      async function sendMessage(text) {
        if (!text.trim() || !sessionId || isWaiting) return;

        const userText = text.trim();
        inputEl.value = "";
        inputEl.style.height = "auto";
        quickRepliesEl.innerHTML = "";

        addMessage(userText, "user", formatTime());
        showTyping();
        isWaiting = true;
        setStatus("loading");
        sendBtn.disabled = true;
        inputEl.disabled = true;
        startTimer();

        try {
          const res = await fetch(
            `${API}/api/chatbot/sessions/${sessionId}/messages`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                message: userText,
                sessionToken: sessionToken,
              }),
            },
          );

          stopTimer();
          hideTyping();

          if (!res.ok) {
            const errText = await res.text();
            throw new Error(`HTTP ${res.status}: ${errText}`);
          }

          const data = await res.json();

          // Show bot response
          const responseText =
            data.response ||
            data.message ||
            data.botMessage ||
            JSON.stringify(data);
          const confidence = data.confidence
            ? ` Â· Confianza: ${(data.confidence * 100).toFixed(0)}%`
            : "";
          const intent = data.detectedIntent
            ? ` Â· Intent: ${data.detectedIntent}`
            : "";
          addMessage(responseText, "bot", formatTime() + confidence + intent);

          // Quick replies
          if (data.quickReplies) showQuickReplies(data.quickReplies);
          if (data.suggestedActions) showQuickReplies(data.suggestedActions);

          // Vehicle cards
          if (data.vehicleCards && data.vehicleCards.length > 0) {
            data.vehicleCards.forEach((v) => {
              addMessage(
                `ğŸš— <b>${v.title || v.name}</b><br>` +
                  (v.subtitle ? `${v.subtitle}<br>` : "") +
                  (v.price ? `ğŸ’° ${v.price}` : ""),
                "bot",
              );
            });
          }

          setStatus("online");
        } catch (err) {
          stopTimer();
          hideTyping();
          setStatus("online");
          addMessage(`âŒ Error: ${err.message}`, "error");
          console.error(err);
        } finally {
          isWaiting = false;
          sendBtn.disabled = false;
          inputEl.disabled = false;
          inputEl.focus();
        }
      }

      // â”€â”€â”€ Event Listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      sendBtn.onclick = () => sendMessage(inputEl.value);

      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage(inputEl.value);
        }
      });

      inputEl.addEventListener("input", () => {
        inputEl.style.height = "auto";
        inputEl.style.height = Math.min(inputEl.scrollHeight, 100) + "px";
      });

      dealerSelect.addEventListener("change", () => {
        // Reset session when changing dealer
        sessionId = null;
        sessionToken = null;
        messagesEl.innerHTML = "";
        quickRepliesEl.innerHTML = "";
        inputEl.disabled = true;
        sendBtn.disabled = true;
        dealerSelect.disabled = false;
        setStatus("offline");
      });

      // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      (async function init() {
        // Check health first
        try {
          const res = await fetch(`${API}/health`);
          const data = await res.json();
          if (data.status === "Healthy") {
            await startSession();
          } else {
            setStatus("offline");
            addMessage(
              "âš ï¸ ChatbotService no estÃ¡ saludable. Verifica que los containers estÃ©n corriendo.",
              "error",
            );
          }
        } catch (err) {
          setStatus("offline");
          addMessage(
            "âŒ No se pudo conectar a ChatbotService en <code>localhost:5060</code>. Â¿EstÃ¡ corriendo?",
            "error",
          );
        }
      })();
    </script>
  </body>
</html>
