# =============================================================================
# NetworkPolicies - OKLA Microservices
# Restricts pod-to-pod communication following least-privilege principle
#
# BFF Architecture (Gateway NOT exposed externally):
#   Internet → Ingress → frontend-web (okla.com.do) ONLY entry point
#   frontend-web → gateway (internal) → microservices (ClusterIP)
#   Gateway is NEVER directly reachable from the internet (no Ingress rule).
#   Frontend pod can ONLY reach the gateway, never microservices directly.
# =============================================================================

# Default deny all ingress AND egress - zero-trust baseline
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: okla
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress

---
# Gateway - Accept traffic ONLY from frontend-web (BFF pattern)
# Gateway is NOT exposed via Ingress — only the frontend pod can reach it
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-gateway-ingress
  namespace: okla
spec:
  podSelector:
    matchLabels:
      app: gateway
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: frontend-web
      ports:
        - protocol: TCP
          port: 8080

---
# Frontend - Accept traffic from Ingress controller only
# Frontend can ONLY be reached by the Ingress controller (external traffic)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-frontend-ingress
  namespace: okla
spec:
  podSelector:
    matchLabels:
      app: frontend-web
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8080

---
# Frontend egress - Can ONLY reach Gateway + DNS
# Frontend must NEVER talk directly to microservices in production
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-frontend-egress
  namespace: okla
spec:
  podSelector:
    matchLabels:
      app: frontend-web
  policyTypes:
    - Egress
  egress:
    # DNS resolution
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # Gateway ONLY — SSR API calls from Next.js server-side
    - to:
        - podSelector:
            matchLabels:
              app: gateway
      ports:
        - protocol: TCP
          port: 8080
    # External HTTPS for CDN assets, fonts, analytics
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443

---
# Backend services - Only accept traffic from Gateway
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-gateway-only
  namespace: okla
spec:
  podSelector:
    matchExpressions:
      - key: app
        operator: In
        values:
          - authservice
          - userservice
          - roleservice
          - vehiclessaleservice
          - mediaservice
          - billingservice
          - notificationservice
          - errorservice
          - kycservice
          - auditservice
          - idempotencyservice
          - contactservice
          - adminservice
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: gateway
      ports:
        - protocol: TCP
          port: 8080

---
# Inter-service communication - Allow services to talk to shared services
# (AuditService, IdempotencyService, ErrorService, NotificationService)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-interservice-shared
  namespace: okla
spec:
  podSelector:
    matchExpressions:
      - key: app
        operator: In
        values:
          - auditservice
          - idempotencyservice
          - errorservice
          - notificationservice
  policyTypes:
    - Ingress
  ingress:
    # Accept from gateway
    - from:
        - podSelector:
            matchLabels:
              app: gateway
      ports:
        - protocol: TCP
          port: 8080
    # Accept from any backend service (inter-service calls)
    - from:
        - podSelector:
            matchExpressions:
              - key: tier
                operator: In
                values:
                  - backend
      ports:
        - protocol: TCP
          port: 8080

---
# PostgreSQL - Only accept from backend services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-postgres-from-services
  namespace: okla
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchExpressions:
              - key: tier
                operator: In
                values:
                  - backend
      ports:
        - protocol: TCP
          port: 5432

---
# Redis - Only accept from backend services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-redis-from-services
  namespace: okla
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchExpressions:
              - key: tier
                operator: In
                values:
                  - backend
      ports:
        - protocol: TCP
          port: 6379

---
# RabbitMQ - Only accept from backend services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-rabbitmq-from-services
  namespace: okla
spec:
  podSelector:
    matchLabels:
      app: rabbitmq
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchExpressions:
              - key: tier
                operator: In
                values:
                  - backend
      ports:
        - protocol: TCP
          port: 5672
        - protocol: TCP
          port: 15672

---
# Backend services egress - Can reach internal services, databases, and external APIs
# Gateway needs to reach all microservices, Stripe, Azul, etc.
# Microservices need to reach databases, shared services, and external APIs
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-backend-egress
  namespace: okla
spec:
  podSelector:
    matchExpressions:
      - key: tier
        operator: In
        values:
          - backend
  policyTypes:
    - Egress
  egress:
    # DNS resolution
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # Allow egress to all pods within okla namespace (inter-service, DB, Redis, RabbitMQ)
    - to:
        - podSelector: {}
    # Allow egress to external services (Stripe, Azul, S3, SMTP, SendGrid, etc.)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16

---
# Gateway egress - same as backend but explicit for the gateway pod
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-gateway-egress
  namespace: okla
spec:
  podSelector:
    matchLabels:
      app: gateway
  policyTypes:
    - Egress
  egress:
    # DNS resolution
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # Route to all backend microservices within the namespace
    - to:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 8080

---
# Data tier egress restriction - Postgres, Redis, RabbitMQ should NOT reach the internet
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: restrict-data-tier-egress
  namespace: okla
spec:
  podSelector:
    matchExpressions:
      - key: app
        operator: In
        values:
          - postgres
          - redis
          - rabbitmq
  policyTypes:
    - Egress
  egress:
    # Only allow DNS resolution
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # Allow communication within the okla namespace only
    - to:
        - podSelector: {}

---
# RabbitMQ management UI - Only accessible from gateway (admin proxy) or port-forward
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: restrict-rabbitmq-management
  namespace: okla
spec:
  podSelector:
    matchLabels:
      app: rabbitmq
  policyTypes:
    - Ingress
  ingress:
    # AMQP from backend services
    - from:
        - podSelector:
            matchExpressions:
              - key: tier
                operator: In
                values:
                  - backend
      ports:
        - protocol: TCP
          port: 5672
    # Management UI only from gateway (for admin dashboard proxy)
    - from:
        - podSelector:
            matchLabels:
              app: gateway
      ports:
        - protocol: TCP
          port: 15672
