# =============================================================================
# MVP SELF-MANAGED - Deployments Optimizados
# =============================================================================
# Solo los servicios esenciales con recursos mínimos
# Réplicas: 1 para minimizar recursos (escalar después)
# =============================================================================

---
# =============================================================================
# FRONTEND WEB
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-web
  namespace: okla
  labels:
    app: frontend-web
    tier: frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend-web
  template:
    metadata:
      labels:
        app: frontend-web
    spec:
      containers:
        - name: frontend-web
          image: ghcr.io/gregorymorenoiem/cardealer-web:latest
          ports:
            - containerPort: 8080
          env:
            - name: RUNTIME_API_URL
              value: "https://api.okla.com.do"
            - name: NODE_ENV
              value: "production"
            - name: RUNTIME_APP_VERSION
              value: "1.0.0"
          resources:
            requests:
              memory: "64Mi"
              cpu: "25m"
            limits:
              memory: "128Mi"
              cpu: "100m"
          livenessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10

---
# =============================================================================
# GATEWAY
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway
  namespace: okla
  labels:
    app: gateway
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gateway
  template:
    metadata:
      labels:
        app: gateway
    spec:
      containers:
        - name: gateway
          image: ghcr.io/gregorymorenoiem/gateway:latest
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: jwt-secrets
          resources:
            requests:
              memory: "64Mi"
              cpu: "25m"
            limits:
              memory: "192Mi"
              cpu: "150m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 5
          volumeMounts:
            - name: ocelot-config
              mountPath: /app/ocelot.prod.json
              subPath: ocelot.json
      volumes:
        - name: ocelot-config
          configMap:
            name: gateway-config

---
# =============================================================================
# AUTH SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: authservice
  namespace: okla
  labels:
    app: authservice
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: authservice
  template:
    metadata:
      labels:
        app: authservice
    spec:
      containers:
        - name: authservice
          image: ghcr.io/gregorymorenoiem/authservice:latest
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: authservice-db-secret
            - secretRef:
                name: jwt-secrets
            - secretRef:
                name: redis-secrets
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "400m"
          livenessProbe:
            httpGet:
              path: /health/live
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /health/live
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

---
# =============================================================================
# USER SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: userservice
  namespace: okla
  labels:
    app: userservice
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: userservice
  template:
    metadata:
      labels:
        app: userservice
    spec:
      containers:
        - name: userservice
          image: ghcr.io/gregorymorenoiem/userservice:latest
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: userservice-db-secret
            - secretRef:
                name: jwt-secrets
            - secretRef:
                name: redis-secrets
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 90
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 45
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 5

---
# =============================================================================
# ROLE SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: roleservice
  namespace: okla
  labels:
    app: roleservice
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: roleservice
  template:
    metadata:
      labels:
        app: roleservice
    spec:
      containers:
        - name: roleservice
          image: ghcr.io/gregorymorenoiem/roleservice:latest
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: roleservice-db-secret
            - secretRef:
                name: jwt-secrets
            - secretRef:
                name: redis-secrets
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 90
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 45
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 5

---
# =============================================================================
# VEHICLES SALE SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vehiclessaleservice
  namespace: okla
  labels:
    app: vehiclessaleservice
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: vehiclessaleservice
  template:
    metadata:
      labels:
        app: vehiclessaleservice
    spec:
      containers:
        - name: vehiclessaleservice
          image: ghcr.io/gregorymorenoiem/vehiclessaleservice:latest
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: vehiclessaleservice-db-secret
            - secretRef:
                name: jwt-secrets
            - secretRef:
                name: redis-secrets
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 90
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 45
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 5

---
# =============================================================================
# MEDIA SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mediaservice
  namespace: okla
  labels:
    app: mediaservice
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mediaservice
  template:
    metadata:
      labels:
        app: mediaservice
    spec:
      containers:
        - name: mediaservice
          image: ghcr.io/gregorymorenoiem/mediaservice:latest
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: mediaservice-db-secret
            - secretRef:
                name: jwt-secrets
            - secretRef:
                name: redis-secrets
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 90
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 45
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 5

---
# =============================================================================
# BILLING SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: billingservice
  namespace: okla
  labels:
    app: billingservice
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: billingservice
  template:
    metadata:
      labels:
        app: billingservice
    spec:
      containers:
        - name: billingservice
          image: ghcr.io/gregorymorenoiem/billingservice:latest
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: billingservice-db-secret
            - secretRef:
                name: jwt-secrets
            - secretRef:
                name: redis-secrets
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 90
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 45
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 5

---
# =============================================================================
# NOTIFICATION SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: notificationservice
  namespace: okla
  labels:
    app: notificationservice
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: notificationservice
  template:
    metadata:
      labels:
        app: notificationservice
    spec:
      containers:
        - name: notificationservice
          image: ghcr.io/gregorymorenoiem/notificationservice:latest
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: notificationservice-db-secret
            - secretRef:
                name: jwt-secrets
            - secretRef:
                name: redis-secrets
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 90
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 45
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 5

---
# =============================================================================
# ERROR SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: errorservice
  namespace: okla
  labels:
    app: errorservice
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: errorservice
  template:
    metadata:
      labels:
        app: errorservice
    spec:
      containers:
        - name: errorservice
          image: ghcr.io/gregorymorenoiem/errorservice:latest
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: errorservice-db-secret
            - secretRef:
                name: jwt-secrets
            - secretRef:
                name: redis-secrets
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 90
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 45
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 5
