# =============================================================================
# MVP SELF-MANAGED - Deployments (Hardened)
# =============================================================================
# Security: securityContext, readOnlyRootFilesystem, non-root, drop ALL caps
# Image tags: Use CI/CD variable ${IMAGE_TAG} â€” never :latest in production
# Probes: Separate startup/liveness/readiness for graceful handling
# ServiceAccounts: Dedicated accounts with minimal permissions
# =============================================================================

---
# =============================================================================
# FRONTEND WEB â€” ðŸ”´ CRITICAL: minReplicas=2 para HA
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-web
  namespace: okla
  labels:
    app: frontend-web
    tier: frontend
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: frontend-web
  template:
    metadata:
      labels:
        app: frontend-web
    spec:
      serviceAccountName: okla-frontend
      automountServiceAccountToken: false
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: frontend-web
      containers:
        - name: frontend-web
          image: ghcr.io/gregorymorenoiem/cardealer-web:${IMAGE_TAG}
          ports:
            - containerPort: 8080
          env:
            # BFF pattern: INTERNAL_API_URL is the server-side-only URL for SSR â†’ Gateway calls
            # This is NOT exposed to the browser (not NEXT_PUBLIC_)
            - name: INTERNAL_API_URL
              value: "http://gateway:8080"
            - name: NODE_ENV
              value: "production"
            - name: RUNTIME_APP_VERSION
              value: "1.0.0"
          resources:
            requests:
              memory: "64Mi"
              cpu: "25m"
            limits:
              memory: "128Mi"
              cpu: "100m"
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          startupProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 12
          livenessProbe:
            httpGet:
              path: /
              port: 8080
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /
              port: 8080
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}

---
# =============================================================================
# GATEWAY â€” ðŸ”´ CRITICAL: minReplicas=2 para HA
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway
  namespace: okla
  labels:
    app: gateway
    tier: backend
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: gateway
  template:
    metadata:
      labels:
        app: gateway
    spec:
      serviceAccountName: okla-backend
      automountServiceAccountToken: false
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: gateway
      containers:
        - name: gateway
          image: ghcr.io/gregorymorenoiem/gateway:${IMAGE_TAG}
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: jwt-secrets
          resources:
            requests:
              memory: "64Mi"
              cpu: "25m"
            limits:
              memory: "192Mi"
              cpu: "150m"
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          startupProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 24
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 3
          volumeMounts:
            - name: ocelot-config
              mountPath: /app/ocelot.prod.json
              subPath: ocelot.json
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: ocelot-config
          configMap:
            name: gateway-config
        - name: tmp
          emptyDir: {}

---
# =============================================================================
# AUTH SERVICE â€” ðŸ”´ CRITICAL: minReplicas=2 para HA
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: authservice
  namespace: okla
  labels:
    app: authservice
    tier: backend
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: authservice
  template:
    metadata:
      labels:
        app: authservice
    spec:
      serviceAccountName: okla-backend
      automountServiceAccountToken: false
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: authservice
      containers:
        - name: authservice
          image: ghcr.io/gregorymorenoiem/authservice:${IMAGE_TAG}
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: authservice-db-secret
            - secretRef:
                name: jwt-secrets
            - secretRef:
                name: redis-secrets
            - secretRef:
                name: rabbitmq-secrets
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "400m"
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          startupProbe:
            httpGet:
              path: /health/live
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 24
          livenessProbe:
            httpGet:
              path: /health/live
              port: 8080
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health/ready
              port: 8080
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}

---
# =============================================================================
# USER SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: userservice
  namespace: okla
  labels:
    app: userservice
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: userservice
  template:
    metadata:
      labels:
        app: userservice
    spec:
      serviceAccountName: okla-backend
      automountServiceAccountToken: false
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: userservice
      containers:
        - name: userservice
          image: ghcr.io/gregorymorenoiem/userservice:${IMAGE_TAG}
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: userservice-db-secret
            - secretRef:
                name: jwt-secrets
            - secretRef:
                name: redis-secrets
            - secretRef:
                name: rabbitmq-secrets
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          startupProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 24
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 3
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}

---
# =============================================================================
# ROLE SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: roleservice
  namespace: okla
  labels:
    app: roleservice
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: roleservice
  template:
    metadata:
      labels:
        app: roleservice
    spec:
      serviceAccountName: okla-backend
      automountServiceAccountToken: false
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: roleservice
      containers:
        - name: roleservice
          image: ghcr.io/gregorymorenoiem/roleservice:${IMAGE_TAG}
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: roleservice-db-secret
            - secretRef:
                name: jwt-secrets
            - secretRef:
                name: redis-secrets
            - secretRef:
                name: rabbitmq-secrets
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          startupProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 24
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 3
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}

---
# =============================================================================
# VEHICLES SALE SERVICE â€” ðŸ”´ CRITICAL: minReplicas=2 para HA
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vehiclessaleservice
  namespace: okla
  labels:
    app: vehiclessaleservice
    tier: backend
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: vehiclessaleservice
  template:
    metadata:
      labels:
        app: vehiclessaleservice
    spec:
      serviceAccountName: okla-backend
      automountServiceAccountToken: false
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: vehiclessaleservice
      containers:
        - name: vehiclessaleservice
          image: ghcr.io/gregorymorenoiem/vehiclessaleservice:${IMAGE_TAG}
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: vehiclessaleservice-db-secret
            - secretRef:
                name: jwt-secrets
            - secretRef:
                name: redis-secrets
            - secretRef:
                name: rabbitmq-secrets
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          startupProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 24
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 3
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}

---
# =============================================================================
# MEDIA SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mediaservice
  namespace: okla
  labels:
    app: mediaservice
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mediaservice
  template:
    metadata:
      labels:
        app: mediaservice
    spec:
      serviceAccountName: okla-backend
      automountServiceAccountToken: false
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: mediaservice
      containers:
        - name: mediaservice
          image: ghcr.io/gregorymorenoiem/mediaservice:${IMAGE_TAG}
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
            - name: Storage__Provider
              value: "s3"
            - name: Storage__S3__BucketName
              value: "okla-media"
            - name: Storage__S3__Region
              value: "us-east-1"
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: mediaservice-db-secret
            - secretRef:
                name: jwt-secrets
            - secretRef:
                name: redis-secrets
            - secretRef:
                name: rabbitmq-secrets
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          startupProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 24
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 3
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: uploads
              mountPath: /app/uploads
      volumes:
        - name: tmp
          emptyDir: {}
        - name: uploads
          emptyDir: {}

---
# =============================================================================
# BILLING SERVICE â€” ðŸ”´ CRITICAL: minReplicas=2 para HA
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: billingservice
  namespace: okla
  labels:
    app: billingservice
    tier: backend
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: billingservice
  template:
    metadata:
      labels:
        app: billingservice
    spec:
      serviceAccountName: okla-backend
      automountServiceAccountToken: false
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: billingservice
      containers:
        - name: billingservice
          image: ghcr.io/gregorymorenoiem/billingservice:${IMAGE_TAG}
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: billingservice-db-secret
            - secretRef:
                name: jwt-secrets
            - secretRef:
                name: redis-secrets
            - secretRef:
                name: rabbitmq-secrets
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          startupProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 24
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 3
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}

---
# =============================================================================
# NOTIFICATION SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: notificationservice
  namespace: okla
  labels:
    app: notificationservice
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: notificationservice
  template:
    metadata:
      labels:
        app: notificationservice
    spec:
      serviceAccountName: okla-backend
      automountServiceAccountToken: false
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: notificationservice
      containers:
        - name: notificationservice
          image: ghcr.io/gregorymorenoiem/notificationservice:${IMAGE_TAG}
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: notificationservice-db-secret
            - secretRef:
                name: jwt-secrets
            - secretRef:
                name: redis-secrets
            - secretRef:
                name: rabbitmq-secrets
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          startupProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 24
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 3
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}

---
# =============================================================================
# ERROR SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: errorservice
  namespace: okla
  labels:
    app: errorservice
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: errorservice
  template:
    metadata:
      labels:
        app: errorservice
    spec:
      serviceAccountName: okla-backend
      automountServiceAccountToken: false
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: errorservice
      containers:
        - name: errorservice
          image: ghcr.io/gregorymorenoiem/errorservice:${IMAGE_TAG}
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: errorservice-db-secret
            - secretRef:
                name: jwt-secrets
            - secretRef:
                name: redis-secrets
            - secretRef:
                name: rabbitmq-secrets
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "200m"
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          startupProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 24
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 3
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}

---
# =============================================================================
# REVIEW SERVICE (Sprint 14)
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviewservice
  namespace: okla
  labels:
    app: reviewservice
    tier: backend
    sprint: "14"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviewservice
  template:
    metadata:
      labels:
        app: reviewservice
    spec:
      serviceAccountName: okla-backend
      automountServiceAccountToken: false
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: reviewservice
      containers:
        - name: reviewservice
          image: ghcr.io/gregorymorenoiem/cardealer-reviewservice:${IMAGE_TAG}
          ports:
            - containerPort: 8080
          env:
            - name: ASPNETCORE_URLS
              value: "http://+:8080"
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: reviewservice-db-secret
            - secretRef:
                name: jwt-secrets
            - secretRef:
                name: redis-secrets
            - secretRef:
                name: rabbitmq-secrets
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "400m"
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          startupProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 24
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}
