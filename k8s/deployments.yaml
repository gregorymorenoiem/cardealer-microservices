# =============================================================================
# DEPLOYMENTS - Backend Microservices
# =============================================================================
# Optimizado para Digital Ocean Kubernetes (DOKS)
# Recursos m√≠nimos para mantener costos bajos
# =============================================================================

---
# =============================================================================
# FRONTEND WEB
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-web
  namespace: okla
  labels:
    app: frontend-web
    tier: frontend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: frontend-web
  template:
    metadata:
      labels:
        app: frontend-web
    spec:
      containers:
        - name: frontend-web
          image: ghcr.io/gregorymorenoiem/okla-web:latest
          ports:
            - containerPort: 80
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "100m"
          livenessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 5
            periodSeconds: 10
          volumeMounts:
            - name: nginx-config
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: nginx.conf
      volumes:
        - name: nginx-config
          configMap:
            name: frontend-config
      imagePullSecrets:
        - name: registry-credentials

---
# =============================================================================
# GATEWAY (API Gateway - Ocelot)
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway
  namespace: okla
  labels:
    app: gateway
    tier: backend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: gateway
  template:
    metadata:
      labels:
        app: gateway
    spec:
      containers:
        - name: gateway
          image: ghcr.io/gregorymorenoiem/gateway:latest
          ports:
            - containerPort: 80
          envFrom:
            - configMapRef:
                name: global-config
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "250m"
          livenessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 30
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 10
            periodSeconds: 10
          volumeMounts:
            - name: ocelot-config
              mountPath: /app/ocelot.json
              subPath: ocelot.json
      volumes:
        - name: ocelot-config
          configMap:
            name: gateway-config
      imagePullSecrets:
        - name: registry-credentials

---
# =============================================================================
# AUTH SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: authservice
  namespace: okla
  labels:
    app: authservice
    tier: backend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: authservice
  template:
    metadata:
      labels:
        app: authservice
    spec:
      containers:
        - name: authservice
          image: ghcr.io/gregorymorenoiem/authservice:latest
          ports:
            - containerPort: 80
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: database-secrets
            - secretRef:
                name: jwt-secrets
          env:
            - name: ConnectionStrings__DefaultConnection
              value: "Host=$(POSTGRES_HOST);Port=$(POSTGRES_PORT);Database=authservice;Username=$(POSTGRES_USER);Password=$(POSTGRES_PASSWORD);SSL Mode=$(POSTGRES_SSL_MODE)"
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "250m"
          livenessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 30
            periodSeconds: 10
      imagePullSecrets:
        - name: registry-credentials

---
# =============================================================================
# USER SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: userservice
  namespace: okla
  labels:
    app: userservice
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: userservice
  template:
    metadata:
      labels:
        app: userservice
    spec:
      containers:
        - name: userservice
          image: ghcr.io/gregorymorenoiem/userservice:latest
          ports:
            - containerPort: 80
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: database-secrets
          env:
            - name: ConnectionStrings__DefaultConnection
              value: "Host=$(POSTGRES_HOST);Port=$(POSTGRES_PORT);Database=userservice;Username=$(POSTGRES_USER);Password=$(POSTGRES_PASSWORD);SSL Mode=$(POSTGRES_SSL_MODE)"
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "250m"
          livenessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 30
            periodSeconds: 10
      imagePullSecrets:
        - name: registry-credentials

---
# =============================================================================
# VEHICLES SALE SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vehiclessaleservice
  namespace: okla
  labels:
    app: vehiclessaleservice
    tier: backend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: vehiclessaleservice
  template:
    metadata:
      labels:
        app: vehiclessaleservice
    spec:
      containers:
        - name: vehiclessaleservice
          image: ghcr.io/gregorymorenoiem/vehiclessaleservice:latest
          ports:
            - containerPort: 80
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: database-secrets
          env:
            - name: ConnectionStrings__DefaultConnection
              value: "Host=$(POSTGRES_HOST);Port=$(POSTGRES_PORT);Database=vehiclessaleservice;Username=$(POSTGRES_USER);Password=$(POSTGRES_PASSWORD);SSL Mode=$(POSTGRES_SSL_MODE)"
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "250m"
          livenessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 30
            periodSeconds: 10
      imagePullSecrets:
        - name: registry-credentials

---
# =============================================================================
# PROPERTIES SALE SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: propertiessaleservice
  namespace: okla
  labels:
    app: propertiessaleservice
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: propertiessaleservice
  template:
    metadata:
      labels:
        app: propertiessaleservice
    spec:
      containers:
        - name: propertiessaleservice
          image: ghcr.io/gregorymorenoiem/propertiessaleservice:latest
          ports:
            - containerPort: 80
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: database-secrets
          env:
            - name: ConnectionStrings__DefaultConnection
              value: "Host=$(POSTGRES_HOST);Port=$(POSTGRES_PORT);Database=propertiessaleservice;Username=$(POSTGRES_USER);Password=$(POSTGRES_PASSWORD);SSL Mode=$(POSTGRES_SSL_MODE)"
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "250m"
          livenessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 30
            periodSeconds: 10
      imagePullSecrets:
        - name: registry-credentials

---
# =============================================================================
# MEDIA SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mediaservice
  namespace: okla
  labels:
    app: mediaservice
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mediaservice
  template:
    metadata:
      labels:
        app: mediaservice
    spec:
      containers:
        - name: mediaservice
          image: ghcr.io/gregorymorenoiem/mediaservice:latest
          ports:
            - containerPort: 80
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: database-secrets
            - secretRef:
                name: external-services-secrets
          env:
            - name: ConnectionStrings__DefaultConnection
              value: "Host=$(POSTGRES_HOST);Port=$(POSTGRES_PORT);Database=mediaservice;Username=$(POSTGRES_USER);Password=$(POSTGRES_PASSWORD);SSL Mode=$(POSTGRES_SSL_MODE)"
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          livenessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 30
            periodSeconds: 10
      imagePullSecrets:
        - name: registry-credentials

---
# =============================================================================
# NOTIFICATION SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: notificationservice
  namespace: okla
  labels:
    app: notificationservice
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: notificationservice
  template:
    metadata:
      labels:
        app: notificationservice
    spec:
      containers:
        - name: notificationservice
          image: ghcr.io/gregorymorenoiem/notificationservice:latest
          ports:
            - containerPort: 80
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: database-secrets
            - secretRef:
                name: external-services-secrets
          env:
            - name: ConnectionStrings__DefaultConnection
              value: "Host=$(POSTGRES_HOST);Port=$(POSTGRES_PORT);Database=notificationservice;Username=$(POSTGRES_USER);Password=$(POSTGRES_PASSWORD);SSL Mode=$(POSTGRES_SSL_MODE)"
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "250m"
          livenessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 30
            periodSeconds: 10
      imagePullSecrets:
        - name: registry-credentials

---
# =============================================================================
# BILLING SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: billingservice
  namespace: okla
  labels:
    app: billingservice
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: billingservice
  template:
    metadata:
      labels:
        app: billingservice
    spec:
      containers:
        - name: billingservice
          image: ghcr.io/gregorymorenoiem/billingservice:latest
          ports:
            - containerPort: 80
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: database-secrets
            - secretRef:
                name: external-services-secrets
          env:
            - name: ConnectionStrings__DefaultConnection
              value: "Host=$(POSTGRES_HOST);Port=$(POSTGRES_PORT);Database=billingservice;Username=$(POSTGRES_USER);Password=$(POSTGRES_PASSWORD);SSL Mode=$(POSTGRES_SSL_MODE)"
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "250m"
          livenessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 30
            periodSeconds: 10
      imagePullSecrets:
        - name: registry-credentials

---
# =============================================================================
# ERROR SERVICE
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: errorservice
  namespace: okla
  labels:
    app: errorservice
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: errorservice
  template:
    metadata:
      labels:
        app: errorservice
    spec:
      containers:
        - name: errorservice
          image: ghcr.io/gregorymorenoiem/errorservice:latest
          ports:
            - containerPort: 80
          envFrom:
            - configMapRef:
                name: global-config
            - secretRef:
                name: database-secrets
          env:
            - name: ConnectionStrings__DefaultConnection
              value: "Host=$(POSTGRES_HOST);Port=$(POSTGRES_PORT);Database=errorservice;Username=$(POSTGRES_USER);Password=$(POSTGRES_PASSWORD);SSL Mode=$(POSTGRES_SSL_MODE)"
          resources:
            requests:
              memory: "64Mi"
              cpu: "50m"
            limits:
              memory: "128Mi"
              cpu: "100m"
          livenessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 30
            periodSeconds: 10
      imagePullSecrets:
        - name: registry-credentials
